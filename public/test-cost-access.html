<!DOCTYPE html>
<html>
<head>
  <title>Cost Submission Access Test - FIXED</title>
  <style>
    body { font-family: monospace; padding: 20px; max-width: 900px; margin: 0 auto; background: #f5f5f5; }
    .test { margin: 15px 0; padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; }
    .success { background: #d4edda; border-color: #28a745; }
    .error { background: #f8d7da; border-color: #dc3545; }
    .warning { background: #fff3cd; border-color: #ffc107; }
    .info { background: #d1ecf1; border-color: #17a2b8; }
    h1 { color: #333; }
    h3 { margin-top: 0; }
    button { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
    button:hover { background: #0056b3; }
    button.secondary { background: #6c757d; }
    button.secondary:hover { background: #545b62; }
    pre { background: #f8f9fa; padding: 10px; overflow-x: auto; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .badge-success { background: #28a745; color: white; }
    .badge-error { background: #dc3545; color: white; }
    .loading { text-align: center; padding: 40px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>üîç Cost Submission Access Diagnostic (Corrected)</h1>
  <p><strong>Testing for:</strong> vierycalliper@gmail.com</p>
  
  <button onclick="runTests()">‚ñ∂Ô∏è Run All Tests</button>
  <button class="secondary" onclick="testSupabaseConnection()">üîå Test Supabase Connection</button>
  <button class="secondary" onclick="checkTables()">üìä Check Tables Exist</button>
  
  <div id="results"></div>

  <script>
    const SUPABASE_URL = 'https://abznugnirnlrqnnfkein.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiem51Z25pcm5scnFubmZrZWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIxNjkzOTgsImV4cCI6MjA0Nzc0NTM5OH0.1t_kYbUPbXfMf3KA0F7zOLlKpUl8B7oVrDmQmT5sKRg';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function testSupabaseConnection() {
      const results = document.getElementById('results');
      results.innerHTML = '<div class="loading">Testing Supabase connection...</div>';
      
      try {
        const response = await fetch(SUPABASE_URL + '/rest/v1/', {
          headers: {
            'apikey': SUPABASE_ANON_KEY
          }
        });
        
        results.innerHTML = `
          <div class="test ${response.ok ? 'success' : 'error'}">
            <h3>${response.ok ? '‚úÖ' : '‚ùå'} Supabase Connection</h3>
            <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
            <p><strong>URL:</strong> ${SUPABASE_URL}</p>
          </div>
        `;
      } catch (error) {
        results.innerHTML = `
          <div class="test error">
            <h3>‚ùå Connection Failed</h3>
            <pre>${error.message}</pre>
          </div>
        `;
      }
    }

    async function checkTables() {
      const results = document.getElementById('results');
      results.innerHTML = '<div class="loading">Checking tables...</div>';
      
      const tablesToCheck = [
        'profiles',
        'user_roles',
        'site_visits',
        'site_visit_cost_submissions',
        'cost_approval_history'
      ];

      let output = '<h2>üìä Table Existence Check</h2>';
      
      for (const table of tablesToCheck) {
        try {
          const { data, error } = await supabase
            .from(table)
            .select('count', { count: 'exact', head: true });
          
          if (error) {
            output += `
              <div class="test error">
                <h3>‚ùå Table: ${table}</h3>
                <p><strong>Error:</strong> ${error.message}</p>
                <p><strong>Code:</strong> ${error.code}</p>
              </div>
            `;
          } else {
            output += `
              <div class="test success">
                <h3>‚úÖ Table: ${table}</h3>
                <p>Table exists and is accessible</p>
              </div>
            `;
          }
        } catch (error) {
          output += `
            <div class="test error">
              <h3>‚ùå Table: ${table}</h3>
              <pre>${error.message}</pre>
            </div>
          `;
        }
      }
      
      results.innerHTML = output;
    }

    async function runTests() {
      const results = document.getElementById('results');
      results.innerHTML = '<div class="loading">Running comprehensive tests...</div>';
      
      let output = '';
      
      try {
        // ============================================
        // TEST 1: Authentication
        // ============================================
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !user) {
          results.innerHTML = `
            <div class="test error">
              <h3>‚ùå Authentication Failed</h3>
              <p><strong>You are not logged in.</strong></p>
              <p>Please log in to the PACT app first, then run this test again.</p>
              <pre>${authError?.message || 'No user session found'}</pre>
            </div>
          `;
          return;
        }

        output += `
          <div class="test success">
            <h3>‚úÖ Test 1: Authentication</h3>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>User ID:</strong> <code>${user.id}</code></p>
          </div>
        `;

        // ============================================
        // TEST 2: Profiles Table Access
        // ============================================
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('id, full_name, email, role')
          .eq('id', user.id)
          .single();

        if (profileError) {
          output += `
            <div class="test error">
              <h3>‚ùå Test 2: Profile Access FAILED</h3>
              <p><strong>Error:</strong> ${profileError.message}</p>
              <p><strong>Code:</strong> ${profileError.code}</p>
              <p><strong>Details:</strong> ${profileError.details || 'N/A'}</p>
            </div>
          `;
        } else {
          output += `
            <div class="test success">
              <h3>‚úÖ Test 2: Profile Access</h3>
              <p><strong>Name:</strong> ${profile?.full_name || 'N/A'}</p>
              <p><strong>Email:</strong> ${profile?.email || 'N/A'}</p>
              <p><strong>Role:</strong> ${profile?.role || 'NOT SET'}</p>
            </div>
          `;
        }

        // ============================================
        // TEST 3: Cost Submissions Table Access
        // ============================================
        const startTime = Date.now();
        const { data: submissions, error: submissionError } = await supabase
          .from('site_visit_cost_submissions')
          .select('*')
          .eq('submitted_by', user.id)
          .limit(10);
        const queryTime = Date.now() - startTime;

        if (submissionError) {
          output += `
            <div class="test error">
              <h3>‚ùå Test 3: Cost Submissions Access FAILED</h3>
              <p><strong>Error:</strong> ${submissionError.message}</p>
              <p><strong>Code:</strong> ${submissionError.code}</p>
              <p><strong>Hint:</strong> ${submissionError.hint || 'N/A'}</p>
              <p><strong>Query time:</strong> ${queryTime}ms</p>
              
              ${submissionError.code === '42P01' ? `
                <div style="margin-top:15px; padding:10px; background:#fff3cd; border:1px solid #ffc107; border-radius:4px;">
                  <strong>‚ö†Ô∏è TABLE DOES NOT EXIST</strong>
                  <p>The site_visit_cost_submissions table hasn't been created yet.</p>
                  <p>Run migration: supabase/migrations/20251123_cost_submission_system.sql</p>
                </div>
              ` : ''}
              
              ${submissionError.code === 'PGRST301' ? `
                <div style="margin-top:15px; padding:10px; background:#fff3cd; border:1px solid #ffc107; border-radius:4px;">
                  <strong>‚ö†Ô∏è RLS POLICY BLOCKING ACCESS</strong>
                  <p>Row Level Security is blocking your access.</p>
                  <p>This usually means RLS policies are not set up correctly.</p>
                </div>
              ` : ''}
            </div>
          `;
        } else {
          output += `
            <div class="test success">
              <h3>‚úÖ Test 3: Cost Submissions Access</h3>
              <p><strong>Your submissions:</strong> ${submissions?.length || 0}</p>
              <p><strong>Query time:</strong> ${queryTime}ms</p>
              ${submissions && submissions.length > 0 ? `
                <details>
                  <summary>View submissions</summary>
                  <pre>${JSON.stringify(submissions, null, 2)}</pre>
                </details>
              ` : ''}
            </div>
          `;
        }

        // ============================================
        // TEST 4: Site Visits Access
        // ============================================
        const { data: siteVisits, error: siteVisitError } = await supabase
          .from('site_visits')
          .select('id, site_name, status, assigned_to')
          .eq('assigned_to', user.id)
          .eq('status', 'completed')
          .limit(10);

        if (siteVisitError) {
          output += `
            <div class="test error">
              <h3>‚ùå Test 4: Site Visits Access FAILED</h3>
              <p><strong>Error:</strong> ${siteVisitError.message}</p>
              <p><strong>Code:</strong> ${siteVisitError.code}</p>
            </div>
          `;
        } else {
          output += `
            <div class="test ${siteVisits.length > 0 ? 'success' : 'warning'}">
              <h3>${siteVisits.length > 0 ? '‚úÖ' : '‚ö†Ô∏è'} Test 4: Site Visits Access</h3>
              <p><strong>Completed site visits assigned to you:</strong> ${siteVisits?.length || 0}</p>
              ${siteVisits.length === 0 ? `
                <div style="margin-top:10px; padding:10px; background:#fff3cd; border-radius:4px;">
                  <strong>‚ÑπÔ∏è No Completed Site Visits</strong>
                  <p>You need at least one completed site visit to submit costs.</p>
                  <p>Ask an admin to assign site visits to you.</p>
                </div>
              ` : `
                <details>
                  <summary>View site visits</summary>
                  <pre>${JSON.stringify(siteVisits, null, 2)}</pre>
                </details>
              `}
            </div>
          `;
        }

        // ============================================
        // SUMMARY
        // ============================================
        const canAccessSubmissions = !submissionError;
        const canAccessSiteVisits = !siteVisitError;
        const hasCompletedVisits = siteVisits && siteVisits.length > 0;

        output += `
          <div class="test info">
            <h3>üìä Test Summary</h3>
            <ul style="list-style: none; padding: 0;">
              <li>‚úÖ <strong>Authenticated:</strong> YES</li>
              <li>${profile ? '‚úÖ' : '‚ùå'} <strong>Profile exists:</strong> ${profile ? 'YES' : 'NO'}</li>
              <li>${canAccessSubmissions ? '‚úÖ' : '‚ùå'} <strong>Can access cost submissions:</strong> ${canAccessSubmissions ? 'YES' : 'NO'}</li>
              <li>${canAccessSiteVisits ? '‚úÖ' : '‚ùå'} <strong>Can access site visits:</strong> ${canAccessSiteVisits ? 'YES' : 'NO'}</li>
              <li>${hasCompletedVisits ? '‚úÖ' : '‚ö†Ô∏è'} <strong>Has completed site visits:</strong> ${hasCompletedVisits ? 'YES' : 'NO'}</li>
            </ul>
            
            <h4 style="margin-top: 20px;">üéØ What This Means:</h4>
            ${canAccessSubmissions && canAccessSiteVisits && hasCompletedVisits ? `
              <div style="padding:10px; background:#d4edda; border-radius:4px; margin-top:10px;">
                <strong>‚úÖ Everything is working!</strong>
                <p>You should be able to access the cost submission page without issues.</p>
                <p>If it's still timing out, check the browser console for errors.</p>
              </div>
            ` : ''}
            
            ${canAccessSubmissions && canAccessSiteVisits && !hasCompletedVisits ? `
              <div style="padding:10px; background:#fff3cd; border-radius:4px; margin-top:10px;">
                <strong>‚ö†Ô∏è Database access works, but no site visits</strong>
                <p>The page will load but show "No Completed Site Visits".</p>
                <p>This is EXPECTED and CORRECT behavior.</p>
                <p>Ask an admin to assign completed site visits to you.</p>
              </div>
            ` : ''}
            
            ${!canAccessSubmissions || !canAccessSiteVisits ? `
              <div style="padding:10px; background:#f8d7da; border-radius:4px; margin-top:10px;">
                <strong>‚ùå Database access issues detected</strong>
                <p>The tables may not exist or RLS policies are blocking access.</p>
                <p>Contact your system administrator to:</p>
                <ul>
                  <li>Run the cost submission migration scripts</li>
                  <li>Enable RLS policies correctly</li>
                  <li>Verify your account is set up properly</li>
                </ul>
              </div>
            ` : ''}
          </div>
        `;

        results.innerHTML = output;

      } catch (error) {
        results.innerHTML = `
          <div class="test error">
            <h3>‚ùå Unexpected Error</h3>
            <p><strong>Message:</strong> ${error.message}</p>
            <pre>${error.stack}</pre>
          </div>
        `;
      }
    }

    // Auto-run tests on page load if requested
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('auto') === 'true') {
      window.addEventListener('load', runTests);
    }
  </script>
</body>
</html>
