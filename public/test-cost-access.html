<!DOCTYPE html>
<html>
<head>
  <title>Cost Submission Access Test</title>
  <style>
    body { font-family: monospace; padding: 20px; max-width: 800px; margin: 0 auto; }
    .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .success { background: #d4edda; border-color: #c3e6cb; }
    .error { background: #f8d7da; border-color: #f5c6cb; }
    .info { background: #d1ecf1; border-color: #bee5eb; }
    button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>üîç Cost Submission Access Diagnostic</h1>
  <p><strong>User:</strong> vierycalliper@gmail.com</p>
  
  <button onclick="runTests()">Run All Tests</button>
  
  <div id="results"></div>

  <script>
    const supabase = window.supabase.createClient(
      'https://abznugnirnlrqnnfkein.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiem51Z25pcm5scnFubmZrZWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIxNjkzOTgsImV4cCI6MjA0Nzc0NTM5OH0.1t_kYbUPbXfMf3KA0F7zOLlKpUl8B7oVrDmQmT5sKRg'
    );

    async function runTests() {
      const results = document.getElementById('results');
      results.innerHTML = '<p>Running tests...</p>';
      
      try {
        // Test 1: Check authentication
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !user) {
          results.innerHTML = `
            <div class="test error">
              <h3>‚ùå Test 1: Authentication FAILED</h3>
              <p>You are not logged in. Please log in first.</p>
              <pre>${authError?.message || 'No user session'}</pre>
            </div>
          `;
          return;
        }

        let output = `
          <div class="test success">
            <h3>‚úÖ Test 1: Authentication SUCCESS</h3>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>User ID:</strong> ${user.id}</p>
          </div>
        `;

        // Test 2: Check profile
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', user.id)
          .single();

        if (profileError) {
          output += `
            <div class="test error">
              <h3>‚ùå Test 2: Profile Access FAILED</h3>
              <pre>${profileError.message}</pre>
            </div>
          `;
        } else {
          output += `
            <div class="test ${profile ? 'success' : 'error'}">
              <h3>${profile ? '‚úÖ' : '‚ùå'} Test 2: Profile Access</h3>
              <p><strong>Role:</strong> ${profile?.role || 'NOT SET'}</p>
              <p><strong>Classification:</strong> ${JSON.stringify(profile?.classification) || 'NOT SET'}</p>
              <pre>${JSON.stringify(profile, null, 2)}</pre>
            </div>
          `;
        }

        // Test 3: Check cost submissions access
        const { data: submissions, error: submissionError } = await supabase
          .from('site_visit_cost_submissions')
          .select('*')
          .eq('submitted_by', user.id);

        if (submissionError) {
          output += `
            <div class="test error">
              <h3>‚ùå Test 3: Cost Submissions Access FAILED</h3>
              <p><strong>Error:</strong> ${submissionError.message}</p>
              <p><strong>Hint:</strong> ${submissionError.code}</p>
              <pre>${JSON.stringify(submissionError, null, 2)}</pre>
            </div>
          `;
        } else {
          output += `
            <div class="test success">
              <h3>‚úÖ Test 3: Cost Submissions Access SUCCESS</h3>
              <p><strong>Your submissions:</strong> ${submissions?.length || 0}</p>
              <pre>${JSON.stringify(submissions, null, 2)}</pre>
            </div>
          `;
        }

        // Test 4: Check site visits access
        const { data: siteVisits, error: siteVisitError } = await supabase
          .from('site_visits')
          .select('*')
          .eq('assigned_to', user.id)
          .eq('status', 'completed');

        if (siteVisitError) {
          output += `
            <div class="test error">
              <h3>‚ùå Test 4: Site Visits Access FAILED</h3>
              <pre>${siteVisitError.message}</pre>
            </div>
          `;
        } else {
          output += `
            <div class="test success">
              <h3>‚úÖ Test 4: Site Visits Access SUCCESS</h3>
              <p><strong>Completed site visits assigned to you:</strong> ${siteVisits?.length || 0}</p>
              <pre>${JSON.stringify(siteVisits, null, 2)}</pre>
            </div>
          `;
        }

        // Summary
        const hasProfile = profile && (profile.role || profile.classification);
        const canAccessSubmissions = !submissionError;
        const canAccessSiteVisits = !siteVisitError;

        output += `
          <div class="test info">
            <h3>üìä Summary</h3>
            <ul>
              <li><strong>Authenticated:</strong> ‚úÖ YES</li>
              <li><strong>Profile Set Up:</strong> ${hasProfile ? '‚úÖ YES' : '‚ùå NO'}</li>
              <li><strong>Can Access Cost Submissions:</strong> ${canAccessSubmissions ? '‚úÖ YES' : '‚ùå NO'}</li>
              <li><strong>Can Access Site Visits:</strong> ${canAccessSiteVisits ? '‚úÖ YES' : '‚ùå NO'}</li>
            </ul>
            
            ${!hasProfile ? `
              <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7;">
                <strong>‚ö†Ô∏è ACTION REQUIRED:</strong>
                <p>Your profile is missing role/classification. An admin needs to set your classification to "data_collector" in the profiles table.</p>
              </div>
            ` : ''}
          </div>
        `;

        results.innerHTML = output;

      } catch (error) {
        results.innerHTML = `
          <div class="test error">
            <h3>‚ùå Unexpected Error</h3>
            <pre>${error.message}\n\n${error.stack}</pre>
          </div>
        `;
      }
    }
  </script>
</body>
</html>
