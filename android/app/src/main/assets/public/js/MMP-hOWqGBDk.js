import{j as e,o as ot,Y as dt,T as nt,t as lt,R as Ce,r as c,ar as ct,aG as ut,a0 as ft,N as mt,a7 as ht}from"./react-core-B8kFjp2k.js";import{V as pt,W as vt,X as xt,B as V,Y as _t,U as Oe,Z as $e,_ as gt,C as J,b as ee,L as bt,M as jt,N as wt,O as me,Q as Le,H as Ee,u as ze,D as Ue,l as We,m as qe,n as Ge,o as He,a as $,I as Ke,S as Nt,p as Ye,s as F,f as Ct,g as St,h as yt,T as Mt,i as Dt,j as Se,k as ye}from"./index-PwDgWEVM.js";import{M as At}from"./MMPStatusBadge-CjxSGCNB.js";import{F as Ft}from"./ForwardToFOMDialog-B8pCS6SJ.js";import{A as kt,a as Et,b as Pt,c as Tt,d as It,e as Bt,f as Lt,g as Vt}from"./alert-dialog-D6avgrWz.js";import{bo as Qe}from"./vendor-VlxgVHMv.js";import{o as Rt}from"./date-utils-YarVESQS.js";import{M as xe}from"./MMPSiteEntriesTable-DBUyVHQg.js";import{ae as Ot,af as $t,ag as zt,ah as Xe,ai as Ze}from"./radix-ui-C2DV4xtt.js";import{L as ve}from"./label-C4lDws8j.js";import{S as Me,a as De,b as Ae,c as Fe,d as he}from"./select-CXX5Q_V1.js";import{C as Ve}from"./checkbox-9q2dlFjr.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./router-CKy9yO3R.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./forms-CESK2FDA.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";import"./table-CZ8ZB6wW.js";function Ut({budget:_,variant:S="compact"}){if(!_)return null;const x=_.allocatedBudgetCents>0?_.spentBudgetCents/_.allocatedBudgetCents*100:0,b=()=>_.status==="exceeded"||x>=100?"destructive":x>=80?"default":"secondary",R=()=>_.status==="exceeded"||x>=100?e.jsx(dt,{className:"w-3 h-3"}):x>=80?e.jsx(nt,{className:"w-3 h-3"}):e.jsx(lt,{className:"w-3 h-3"}),g=()=>_.status==="exceeded"?"Over Budget":x>=100?"Budget Exhausted":x>=80?"Budget Warning":"Budget OK",u=k=>new Intl.NumberFormat("en-SD",{style:"currency",currency:"SDG",minimumFractionDigits:0,maximumFractionDigits:0}).format(k/100);return S==="compact"?e.jsx(pt,{children:e.jsxs(vt,{children:[e.jsx(xt,{asChild:!0,children:e.jsxs(V,{variant:b(),className:"gap-1","data-testid":"badge-budget-status",children:[R(),x.toFixed(0),"%"]})}),e.jsx(_t,{children:e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsx("p",{className:"font-semibold",children:g()}),e.jsxs("p",{children:["Spent: ",u(_.spentBudgetCents)]}),e.jsxs("p",{children:["Budget: ",u(_.allocatedBudgetCents)]}),e.jsxs("p",{children:["Remaining: ",u(_.remainingBudgetCents)]})]})})]})}):e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md","data-testid":"budget-status-detailed",children:[e.jsx(ot,{className:"w-4 h-4 text-muted-foreground"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium",children:g()}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[x.toFixed(1),"%"]})]}),e.jsx("div",{className:"flex items-center gap-2 text-xs",children:e.jsxs("span",{className:"text-muted-foreground",children:[u(_.spentBudgetCents)," / ",u(_.allocatedBudgetCents)]})})]}),e.jsxs(V,{variant:b(),className:"gap-1",children:[R(),u(_.remainingBudgetCents)," left"]})]})}const ke=({mmpFiles:_,showActions:S=!0})=>{const x=Qe(),{deleteMMPFile:b}=Oe(),{checkPermission:R,hasAnyRole:g}=$e(),{mmpBudgets:u}=gt(),[k,y]=Ce.useState(null),[r,d]=Ce.useState(null),[C,z]=c.useState(!1),[v,q]=c.useState(null),[I,U]=c.useState(new Set),w=g(["Admin","admin"]),L=g(["ICT","ict"]),D=g(["Field Operation Manager (FOM)","FOM","fom","field operation manager","Field Ops Manager","field ops manager"]),O=R("mmp","delete")||w||L,Q=R("mmp","update")||w||L,X=R("mmp","update")||w||L;Ce.useEffect(()=>{const h=new Set;_.forEach(W=>{const i=W.workflow;i!=null&&i.forwardedToFomIds&&i.forwardedToFomIds.length>0&&h.add(W.id)}),U(h)},[_]);const K=h=>{q(h),z(!0)},Z=h=>{v&&U(W=>new Set(W).add(v.id))};return _.length?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid gap-4",children:_.map(h=>{var M;const W=I.has(h.id),i=h.workflow,j=((M=i==null?void 0:i.forwardedToFomIds)==null?void 0:M.length)||0;return e.jsx(J,{className:"hover:shadow-md transition-all",children:e.jsx(ee,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsx("div",{className:"flex items-start gap-3 flex-1 cursor-pointer",onClick:()=>{D&&!(h.permits&&h.permits.federal)?x(`/mmp/${h.id}/verification`):x(`/mmp/${h.id}/view`)},children:e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsx("h3",{className:"font-semibold text-lg",children:h.name})}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[e.jsx("span",{className:"font-mono text-blue-700",children:h.mmpId}),h.projectName&&e.jsxs("span",{children:[" • Project: ",h.projectName]}),h.hub&&e.jsxs("span",{children:[" • Hub: ",h.hub]}),h.month&&e.jsxs("span",{children:[" • ",new Date(2024,parseInt(h.month)-1).toLocaleDateString("en-US",{month:"long"})]})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-4 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Uploaded ",Rt(new Date(h.uploadedAt),"MMM d, yyyy")]}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:["by ",h.uploadedBy||"Unknown"]}),e.jsx("span",{children:"•"}),e.jsxs("span",{className:"font-semibold",children:[h.entries," sites"]})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2 flex-wrap",children:[e.jsx(At,{status:h.status}),e.jsx(Ut,{budget:u.find(Y=>Y.mmpFileId===h.id)||null,variant:"compact"}),W&&e.jsxs(V,{variant:"secondary",className:"bg-green-100 text-green-800",children:["Forwarded to ",j," FOM(s)"]})]})]})}),e.jsxs(bt,{children:[e.jsx(jt,{asChild:!0,children:e.jsx("button",{className:"p-2 rounded-full hover:bg-accent/30 focus:outline-none",onClick:Y=>Y.stopPropagation(),"aria-label":"More options",children:e.jsx(ct,{className:"h-5 w-5 text-muted-foreground"})})}),e.jsxs(wt,{align:"end",onClick:Y=>Y.stopPropagation(),children:[e.jsx(me,{onClick:()=>x(`/mmp/${h.id}/view`),children:"View Details"}),(Q&&!W||D&&W)&&e.jsx(me,{onClick:()=>x(`/mmp/${h.id}/edit?tab=sites`),children:"Edit Site Entries"}),X&&!W&&e.jsx(me,{onClick:()=>K(h),children:"Forward to FOM"}),D&&!w&&!L&&!(h.permits&&h.permits.federal)&&e.jsx(me,{onClick:()=>x(`/mmp/${h.id}/verification`),children:"Upload Permits"}),(w||L)&&W&&!(h.permits&&h.permits.federal)&&e.jsxs(e.Fragment,{children:[e.jsx(Le,{}),e.jsx(me,{onClick:()=>x(`/mmp/${h.id}/verification`),children:"Upload Permits & Forward to Coordinators"})]}),O&&e.jsxs(e.Fragment,{children:[e.jsx(Le,{}),e.jsx(me,{disabled:k===h.id,onClick:Y=>{Y.stopPropagation(),d(h.id)},className:"text-destructive",children:"Delete MMP"})]})]})]})]})})},h.id)})}),v&&e.jsx(Ft,{open:C,onOpenChange:z,mmpId:v.id,mmpName:v.name,onForwarded:Z}),e.jsx(kt,{open:r!==null,onOpenChange:h=>{h||d(null)},children:e.jsxs(Et,{children:[e.jsxs(Pt,{children:[e.jsx(Tt,{children:"Delete MMP File?"}),e.jsx(It,{children:"Are you sure you want to permanently delete this MMP file and all its data? This action cannot be undone."})]}),e.jsxs(Bt,{children:[e.jsx(Lt,{onClick:()=>d(null),children:"Cancel"}),e.jsx(Vt,{disabled:k===r,onClick:async()=>{r&&(y(r),await b(r),y(null),d(null))},children:k===r?"Deleting...":"Delete"})]})]})})]}):e.jsx(J,{children:e.jsx(ee,{className:"p-6 text-center text-muted-foreground",children:"No MMP files uploaded yet."})})},Wt=Ot,Je=c.forwardRef(({className:_,...S},x)=>e.jsx($t,{ref:x,className:Ee("border-b",_),...S}));Je.displayName="AccordionItem";const et=c.forwardRef(({className:_,children:S,...x},b)=>e.jsx(zt,{className:"flex",children:e.jsxs(Xe,{ref:b,className:Ee("flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",_),...x,children:[S,e.jsx(ut,{className:"h-4 w-4 shrink-0 transition-transform duration-200"})]})}));et.displayName=Xe.displayName;const tt=c.forwardRef(({className:_,children:S,...x},b)=>e.jsx(Ze,{ref:b,className:"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down",...x,children:e.jsx("div",{className:Ee("pb-4 pt-0",_),children:S})}));tt.displayName=Ze.displayName;const qt=({open:_,onOpenChange:S})=>{const{toast:x}=ze(),[b,R]=c.useState(!1),[g,u]=c.useState([]),[k,y]=c.useState({}),[r,d]=c.useState(!0),[C,z]=c.useState(""),[v,q]=c.useState(!1);c.useEffect(()=>{if(!_)return;let w=!1;return(async()=>{R(!0);try{const{data:D,error:O}=await F.from("mmp_files").select("id,name,workflow");if(O)throw O;if(w)return;const Q=(D||[]).filter(K=>{const Z=K.workflow||{},h=Array.isArray(Z.forwardedToFomIds)&&Z.forwardedToFomIds.length>0,W=Z.forwardedToCoordinators===!0||Array.isArray(Z.forwardedToCoordinatorIds)&&Z.forwardedToCoordinatorIds.length>0;return h||W});u(Q);const X=Q.map(K=>K.id);if(X.length){const{data:K,error:Z}=await F.from("mmp_site_entries").select("id,mmp_file_id").in("mmp_file_id",X);if(Z)throw Z;const h={};for(const W of K||[])h[W.mmp_file_id]=(h[W.mmp_file_id]||0)+1;y(h)}else y({})}catch(D){x({title:"Load failed",description:D.message||"Unable to load forwarded items",variant:"destructive"})}finally{w||R(!1)}})(),()=>{w=!0}},[_,x]);const I=c.useMemo(()=>Object.values(k).reduce((w,L)=>w+L,0),[k]),U=async()=>{var w;if(C.trim().toUpperCase()==="CLEAR"){q(!0);try{let L;try{const{data:D}=await F.auth.getUser();L=(w=D==null?void 0:D.user)==null?void 0:w.id}catch{}for(const D of g){const O=D.workflow||{},Q=new Date().toISOString(),X={...O,forwardedToFomIds:[],forwardedToCoordinatorIds:[],forwardedToCoordinators:!1,coordinatorVerified:!1,clearedForwardingAt:Q};["awaitingPermits","awaitingCoordinatorVerification","coordinatorReview"].includes(String(O.currentStage))&&(X.currentStage="draft"),await F.from("mmp_files").update({workflow:X}).eq("id",D.id)}if(r&&g.length){const D=g.map(O=>O.id);await F.from("mmp_site_entries").update({status:"Pending",dispatched_by:null,dispatched_at:null,accepted_by:null,accepted_at:null}).in("mmp_file_id",D)}L&&await F.from("notifications").insert({user_id:L,title:"Forwarded sites cleared",message:`Cleared ${g.length} MMP(s); reset ${r?I:0} site entry status(es).`,type:"info",related_entity_type:"mmpFile"}),x({title:"Forwarded sites cleared",description:`Reset ${g.length} MMP(s); reset ${r?I:0} site entry status(es).`}),S(!1),z("")}catch(L){x({title:"Clear failed",description:L.message||"Unexpected error",variant:"destructive"})}finally{q(!1)}}};return e.jsx(Ue,{open:_,onOpenChange:S,children:e.jsxs(We,{className:"sm:max-w-2xl",children:[e.jsxs(qe,{children:[e.jsx(Ge,{children:"Bulk Clear Forwarded Sites"}),e.jsx(He,{children:"This action will remove forwarding flags (FOM & Coordinator) from all MMPs currently forwarded. Optionally reset their site entry statuses. Type CLEAR to confirm."})]}),b&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading forwarded MMP data…"}),!b&&e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-3 rounded-lg border bg-muted/40",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:"Forwarded MMPs"}),e.jsx("div",{className:"text-2xl font-bold",children:g.length})]}),e.jsxs("div",{className:"p-3 rounded-lg border bg-muted/40",children:[e.jsxs("div",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:["Site Entries ",r?"(will reset)":"(retain)"]}),e.jsx("div",{className:"text-2xl font-bold",children:I})]})]}),e.jsxs("div",{className:"flex items-center justify-between border rounded-md p-3",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium",children:"Reset site entry statuses"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Uncheck to only reset workflow flags"})]}),e.jsx($,{variant:r?"destructive":"outline",onClick:()=>d(w=>!w),className:r?"bg-orange-600 hover:bg-orange-700 text-white":"",children:r?"Will Reset":"Keep Status"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Type CLEAR to confirm"}),e.jsx(Ke,{value:C,onChange:w=>z(w.target.value),placeholder:"CLEAR"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-semibold mb-1",children:["Affected MMPs (",g.length,")"]}),e.jsxs(Nt,{className:"h-40 border rounded-md p-2",children:[g.length===0&&e.jsx("div",{className:"text-xs text-muted-foreground",children:"No forwarded MMPs found."}),g.map(w=>{const L=w.workflow||{},D=Array.isArray(L.forwardedToFomIds)?L.forwardedToFomIds.length:0,O=Array.isArray(L.forwardedToCoordinatorIds)?L.forwardedToCoordinatorIds.length:0;return e.jsxs("div",{className:"flex items-center justify-between text-xs py-1 border-b last:border-none",children:[e.jsx("span",{className:"truncate max-w-[12rem]",title:w.name||w.id,children:w.name||w.id}),e.jsxs("div",{className:"flex items-center gap-1",children:[D>0&&e.jsxs(V,{variant:"secondary",className:"text-[10px]",children:["FOM: ",D]}),O>0&&e.jsxs(V,{variant:"secondary",className:"text-[10px]",children:["Coord: ",O]}),k[w.id]&&e.jsxs(V,{variant:"outline",className:"text-[10px]",children:["Sites: ",k[w.id]]})]})]},w.id)})]})]})]}),e.jsxs(Ye,{children:[e.jsx($,{variant:"outline",onClick:()=>S(!1),disabled:v||b,children:"Cancel"}),e.jsx($,{variant:"destructive",disabled:v||b||C.trim().toUpperCase()!=="CLEAR"||g.length===0,onClick:U,children:v?"Clearing…":"Confirm Clear"})]})]})})},Gt=({open:_,onOpenChange:S,siteEntries:x,dispatchType:b,onDispatched:R})=>{const[g,u]=c.useState(!1),[k,y]=c.useState([]),[r,d]=c.useState(""),[C,z]=c.useState(""),[v,q]=c.useState(""),[I,U]=c.useState(new Set),[w,L]=c.useState(""),{toast:D}=ze();c.useEffect(()=>{if(!_)return;let i=!1;return(async()=>{try{const{data:M,error:Y}=await F.from("profiles").select("id, full_name, username, email, hub_id, state_id, locality_id").or("role.eq.dataCollector,role.eq.datacollector").order("full_name",{ascending:!0});i||y(Y?[]:M)}catch{i||y([])}})(),()=>{i=!0}},[_]);const O=c.useMemo(()=>{const i=new Set;return x.forEach(j=>{const M=j.state||j.state_name;M&&M.trim()!==""&&i.add(M.trim())}),Array.from(i).filter(j=>j&&j.trim()!=="").sort()},[x]),Q=c.useMemo(()=>{const i=new Set;return x.forEach(j=>{const M=j.locality||j.locality_name;M&&M.trim()!==""&&(!r||j.state===r)&&i.add(M.trim())}),Array.from(i).filter(j=>j&&j.trim()!=="").sort()},[x,r]),X=c.useMemo(()=>{let i=k;if(b==="state"&&r?i=i.filter(j=>j.state_id===r):b==="locality"&&C&&(i=i.filter(j=>j.locality_id===C)),w.trim()){const j=w.toLowerCase();i=i.filter(M=>(M.full_name||"").toLowerCase().includes(j)||(M.username||"").toLowerCase().includes(j)||(M.email||"").toLowerCase().includes(j))}return i},[k,b,r,C,w]),K=c.useMemo(()=>b==="state"&&r?x.filter(i=>{const j=i.state||i.state_name;return j&&j.trim()===r}):b==="locality"&&C?x.filter(i=>{const j=i.locality||i.locality_name;return j&&j.trim()===C}):x,[x,b,r,C]),Z=()=>{I.size===K.length?U(new Set):U(new Set(K.map(i=>i.id)))},h=i=>{U(j=>{const M=new Set(j);return M.has(i)?M.delete(i):M.add(i),M})},W=async()=>{var i,j,M;if(I.size===0){D({title:"No sites selected",description:"Please select at least one site to dispatch.",variant:"destructive"});return}if(b==="individual"&&!v){D({title:"No collector selected",description:"Please select a data collector.",variant:"destructive"});return}if(b==="state"&&!r){D({title:"No state selected",description:"Please select a state.",variant:"destructive"});return}if(b==="locality"&&!C){D({title:"No locality selected",description:"Please select a locality.",variant:"destructive"});return}u(!0);try{const Y=K.filter(G=>I.has(G.id)),se=b==="individual"?[v]:X.map(G=>G.id);if(se.length===0){D({title:"No collectors found",description:`No data collectors found for the selected ${b==="state"?"state":"locality"}.`,variant:"destructive"}),u(!1);return}const{data:{user:oe}}=await F.auth.getUser(),_e=oe==null?void 0:oe.id,pe=[];for(const G of Y){const re=G.additional_data||{},ae=G.enumerator_fee||re.enumerator_fee||20,A=G.transport_fee||re.transport_fee||10,P=G.cost||ae+A;for(const N of se)pe.push({user_id:N,title:b==="individual"?"Site Visit Assigned":"New Site Visit Available",message:`Site "${G.site_name||G.siteName}" ${b==="individual"?"has been assigned to you":"is available"}. Fee: ${P} SDG (Enumerator: ${ae} SDG, Transport: ${A} SDG)`,type:"info",link:`/mmp?entry=${G.id}`,related_entity_id:G.id,related_entity_type:"mmpFile"})}if(pe.length>0){const{error:G}=await F.from("notifications").insert(pe)}const ge=Array.from(I),be=new Date().toISOString(),{data:{user:de}}=await F.auth.getUser(),ie=de?await F.from("profiles").select("full_name, username, email").eq("id",de.id).single():null,ne=((i=ie==null?void 0:ie.data)==null?void 0:i.full_name)||((j=ie==null?void 0:ie.data)==null?void 0:j.username)||((M=ie==null?void 0:ie.data)==null?void 0:M.email)||"System";for(const G of ge){const{data:re}=await F.from("mmp_site_entries").select("additional_data").eq("id",G).single(),ae=(re==null?void 0:re.additional_data)||{};ae.dispatched_at=be,ae.dispatched_by=ne;const{error:A}=await F.from("mmp_site_entries").update({status:"Dispatched",dispatched_at:be,dispatched_by:ne,additional_data:ae}).eq("id",G)}D({title:"Sites Dispatched",description:`Successfully dispatched ${I.size} site(s) to ${se.length} data collector(s).`,variant:"default"}),R==null||R(),S(!1),U(new Set),d(""),z(""),q("")}catch(Y){D({title:"Dispatch Failed",description:Y.message||"Failed to dispatch sites. Please try again.",variant:"destructive"})}finally{u(!1)}};return e.jsx(Ue,{open:_,onOpenChange:S,children:e.jsxs(We,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(qe,{children:[e.jsxs(Ge,{children:["Dispatch Sites ",b==="state"?"by State":b==="locality"?"by Locality":"to Data Collector"]}),e.jsxs(He,{children:[b==="state"&&"Select a state to dispatch sites to all data collectors in that state.",b==="locality"&&"Select a locality to dispatch sites. All data collectors in that locality will see these sites and can claim them.",b==="individual"&&"Select a data collector to dispatch sites directly to them."]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[b==="state"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{children:"Select State"}),e.jsxs(Me,{value:r,onValueChange:d,children:[e.jsx(De,{children:e.jsx(Ae,{placeholder:"Select a state"})}),e.jsx(Fe,{children:O.length>0?O.map(i=>e.jsx(he,{value:i,children:i},i)):e.jsx(he,{value:"no-states",disabled:!0,children:"No states found"})})]}),r&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[X.length," data collector(s) found in ",r]})]}),b==="locality"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{children:"Select State (optional)"}),e.jsxs(Me,{value:r||"__ALL__",onValueChange:i=>d(i==="__ALL__"?"":i),children:[e.jsx(De,{children:e.jsx(Ae,{placeholder:"All states"})}),e.jsxs(Fe,{children:[e.jsx(he,{value:"__ALL__",children:"All states"}),O.map(i=>e.jsx(he,{value:i,children:i},i))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{children:"Select Locality"}),e.jsxs(Me,{value:C,onValueChange:z,children:[e.jsx(De,{children:e.jsx(Ae,{placeholder:"Select a locality"})}),e.jsx(Fe,{children:Q.length>0?Q.map(i=>e.jsx(he,{value:i,children:i},i)):e.jsx(he,{value:"no-localities",disabled:!0,children:"No localities found"})})]}),C&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[X.length," data collector(s) found in ",C]})]})]}),b==="individual"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{children:"Search Data Collector"}),e.jsx(Ke,{placeholder:"Search by name, username, or email...",value:w,onChange:i=>L(i.target.value)}),e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded-md p-2 space-y-2",children:X.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No data collectors found"}):X.map(i=>e.jsxs("div",{className:`flex items-center space-x-2 p-2 rounded cursor-pointer hover:bg-muted ${v===i.id?"bg-muted":""}`,onClick:()=>q(i.id),children:[e.jsx(Ve,{checked:v===i.id,onCheckedChange:()=>q(i.id)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:i.full_name||i.username||i.email}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[i.state_id&&`State: ${i.state_id}`,i.locality_id&&` | Locality: ${i.locality_id}`]})]})]},i.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ve,{children:"Select Sites to Dispatch"}),e.jsx($,{variant:"outline",size:"sm",onClick:Z,children:I.size===K.length?"Deselect All":"Select All"})]}),e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded-md p-2 space-y-2",children:K.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:r||C?"No sites found for the selected criteria":"No sites available"}):K.map(i=>{const j=i.additional_data||{},M=j.enumerator_fee||20,Y=j.transport_fee||10,se=i.cost||M+Y;return e.jsxs("div",{className:`flex items-center space-x-2 p-2 rounded cursor-pointer hover:bg-muted ${I.has(i.id)?"bg-muted":""}`,onClick:()=>h(i.id),children:[e.jsx(Ve,{checked:I.has(i.id),onCheckedChange:()=>h(i.id)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:i.site_name||i.siteName||"Unknown Site"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[i.locality&&`Locality: ${i.locality}`,i.state&&` | State: ${i.state}`,` | Fee: ${se} SDG`]})]})]},i.id)})}),I.size>0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[I.size," site(s) selected"]})]})]}),e.jsxs(Ye,{children:[e.jsx($,{variant:"outline",onClick:()=>S(!1),disabled:g,children:"Cancel"}),e.jsx($,{onClick:W,disabled:g||I.size===0,children:g?e.jsxs(e.Fragment,{children:[e.jsx(ft,{className:"mr-2 h-4 w-4 animate-spin"}),"Dispatching..."]}):`Dispatch ${I.size} Site(s)`})]})]})})},Re=({siteRows:_,mmpId:S,editable:x=!0,title:b})=>{const[R,g]=c.useState([]),[u,k]=c.useState(!0);return c.useEffect(()=>{(async()=>{if(_.length===0){g([]),k(!1);return}try{const r=S?[S]:[...new Set(_.map(v=>v.mmpId).filter(Boolean))];if(r.length===0){g([]),k(!1);return}const{data:d,error:C}=await F.from("mmp_site_entries").select("*").in("mmp_file_id",r);if(C)throw C;const z=(d||[]).map(v=>({...v,verified_by:v.verified_by||void 0,verified_at:v.verified_at||void 0,verification_notes:v.verification_notes||void 0,status:v.status||"Pending",siteName:v.site_name,siteCode:v.site_code,hubOffice:v.hub_office,cpName:v.cp_name,siteActivity:v.activity_at_site,monitoringBy:v.monitoring_by,surveyTool:v.survey_tool,useMarketDiversion:v.use_market_diversion,useWarehouseMonitoring:v.use_warehouse_monitoring,visitDate:v.visit_date,comments:v.comments,cost:v.cost,additionalData:v.additional_data||{}}));g(z)}catch{g([])}finally{k(!1)}})()},[_,S]),u?e.jsx("div",{className:"mt-6",children:e.jsx(J,{children:e.jsx(ee,{className:"py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"Loading sites..."})})})}):R.length===0?e.jsx("div",{className:"mt-6",children:e.jsx(J,{children:e.jsx(ee,{className:"py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"No sites found."})})})}):e.jsxs("div",{className:"mt-6",children:[b&&e.jsx("div",{className:"mb-4",children:e.jsx("h3",{className:"text-lg font-semibold",children:b})}),e.jsx(xe,{siteEntries:R,editable:x,onUpdateSites:async y=>{try{for(const r of y){const d=r.enumerator_fee??r.enumeratorFee,C=r.transport_fee??r.transportFee;let z;d!==void 0&&C!==void 0&&(z=Number(d)+Number(C));const v=z??r.cost,I={...r.additionalData||r.additional_data||{},enumerator_fee:d,transport_fee:C,cost:v},U={site_name:r.siteName||r.site_name,site_code:r.siteCode||r.site_code,hub_office:r.hubOffice||r.hub_office,state:r.state,locality:r.locality,cp_name:r.cpName||r.cp_name,activity_at_site:r.siteActivity||r.activity_at_site,monitoring_by:r.monitoringBy||r.monitoring_by,survey_tool:r.surveyTool||r.survey_tool,use_market_diversion:r.useMarketDiversion||r.use_market_diversion,use_warehouse_monitoring:r.useWarehouseMonitoring||r.use_warehouse_monitoring,visit_date:r.visitDate||r.visit_date,comments:r.comments,cost:v,enumerator_fee:d,transport_fee:C,status:r.status,verification_notes:r.verification_notes||r.verificationNotes,verified_by:r.verified_by||r.verifiedBy,verified_at:r.verified_at||r.verifiedAt,additional_data:I};Object.keys(U).forEach(w=>{U[w]===void 0&&delete U[w]}),r.id&&await F.from("mmp_site_entries").update(U).eq("id",r.id)}return g(y),!0}catch{return!1}}})]})},Ht=({verifiedSites:_})=>{const[S,x]=c.useState([]),[b,R]=c.useState(!0);return c.useEffect(()=>{(async()=>{if(_.length===0){x([]),R(!1);return}try{const u=[...new Set(_.map(d=>d.mmpId).filter(Boolean))];if(u.length===0){x([]),R(!1);return}const{data:k,error:y}=await F.from("mmp_site_entries").select("*").in("mmp_file_id",u).eq("status","Verified");if(y)throw y;const r=(k||[]).map(d=>({...d,verified_by:d.verified_by||void 0,verified_at:d.verified_at||void 0,verification_notes:d.verification_notes||void 0,siteName:d.site_name,siteCode:d.site_code,hubOffice:d.hub_office,cpName:d.cp_name,siteActivity:d.activity_at_site,monitoringBy:d.monitoring_by,surveyTool:d.survey_tool,useMarketDiversion:d.use_market_diversion,useWarehouseMonitoring:d.use_warehouse_monitoring,visitDate:d.visit_date,comments:d.comments,cost:d.cost,additionalData:d.additional_data||{}}));x(r)}catch{x([])}finally{R(!1)}})()},[_]),b?e.jsx("div",{className:"mt-6",children:e.jsx(J,{children:e.jsx(ee,{className:"py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"Loading verified sites..."})})})}):S.length===0?e.jsx("div",{className:"mt-6",children:e.jsx(J,{children:e.jsx(ee,{className:"py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"No verified sites found."})})})}):e.jsx("div",{className:"mt-6",children:e.jsx(xe,{siteEntries:S,editable:!0,onUpdateSites:async g=>{try{for(const u of g){const k=u.enumerator_fee??u.enumeratorFee,y=u.transport_fee??u.transportFee;let r;k!==void 0&&y!==void 0&&(r=Number(k)+Number(y));const d=r??u.cost,z={...u.additionalData||u.additional_data||{},enumerator_fee:k,transport_fee:y,cost:d},v={site_name:u.siteName||u.site_name,site_code:u.siteCode||u.site_code,hub_office:u.hubOffice||u.hub_office,state:u.state,locality:u.locality,cp_name:u.cpName||u.cp_name,activity_at_site:u.siteActivity||u.activity_at_site,monitoring_by:u.monitoringBy||u.monitoring_by,survey_tool:u.surveyTool||u.survey_tool,use_market_diversion:u.useMarketDiversion||u.use_market_diversion,use_warehouse_monitoring:u.useWarehouseMonitoring||u.use_warehouse_monitoring,visit_date:u.visitDate||u.visit_date,comments:u.comments,cost:d,status:u.status,verification_notes:u.verification_notes||u.verificationNotes,verified_by:u.verified_by||u.verifiedBy,verified_at:u.verified_at||u.verifiedAt,additional_data:z};Object.keys(v).forEach(q=>{v[q]===void 0&&delete v[q]}),u.id&&await F.from("mmp_site_entries").update(v).eq("id",u.id)}return x(g),!0}catch{return!1}}})})},xs=()=>{var Ie,Be;const _=Qe(),{mmpFiles:S,loading:x,updateMMP:b}=Oe(),{checkPermission:R,currentUser:g}=$e(),[u,k]=c.useState("new"),[y,r]=c.useState("pending"),[d,C]=c.useState("newSites"),[z,v]=c.useState("pending"),[q,I]=c.useState({}),[U,w]=c.useState([]),[L,D]=c.useState(!1),[O,Q]=c.useState([]),[X,K]=c.useState(!1),[Z,h]=c.useState(0),[W,i]=c.useState([]),[j,M]=c.useState(!1),[Y,se]=c.useState(0),[oe,_e]=c.useState([]),[pe,ge]=c.useState(!1),[be,de]=c.useState(0),[ie,ne]=c.useState(!1),[G,re]=c.useState("state"),ae=m=>{var s;if(!g)return!1;const l=((s=g.role)==null?void 0:s.toLowerCase())||"",n=(g.roles||[]).map(t=>t.toLowerCase());return m.some(t=>{const o=t.toLowerCase();return l===o||n.includes(o)})},A=ae(["Admin","admin"]),P=ae(["ICT","ict"]),N=ae(["Field Operation Manager (FOM)","fom","field operation manager"]),T=ae(["Coordinator","coordinator"]),st=R("mmp","read")||A||N||T||P,Pe=A||P;c.useEffect(()=>{},[g,A,P,N,T,Pe]),c.useEffect(()=>{k(T?"verified":"new")},[T]);const B=c.useMemo(()=>{let m=S;N&&g&&(m=S.filter(t=>{const o=t.workflow;return((o==null?void 0:o.forwardedToFomIds)||[]).includes(g.id)||t.type==="verified-template"})),T&&g&&(m=S.filter(t=>{var o,a;return t.type==="verified-template"||t.status==="approved"||((o=t.workflow)==null?void 0:o.currentStage)&&["permitsVerified","cpVerification","completed"].includes((a=t.workflow)==null?void 0:a.currentStage)}));const l=m.filter(t=>{var o,a;if(N){const f=t.workflow;return((f==null?void 0:f.forwardedToFomIds)||[]).includes((g==null?void 0:g.id)||"")&&(f==null?void 0:f.forwardedToCoordinators)!==!0}else{if(T)return!1;if(A||P)return t.status==="pending"&&(!((o=t.workflow)!=null&&o.forwardedToFomIds)||((a=t.workflow)==null?void 0:a.forwardedToFomIds.length)===0)}return!1}),n=m.filter(t=>{var o,a;if(N){const f=t.workflow;return(f==null?void 0:f.forwardedToCoordinators)===!0||(f==null?void 0:f.currentStage)==="coordinatorReview"}else{if(T)return!1;if(A||P)return((o=t.workflow)==null?void 0:o.forwardedToFomIds)&&((a=t.workflow)==null?void 0:a.forwardedToFomIds.length)>0}return!1}),s=m.filter(t=>{var o,a,f,p,E;return T?((o=t.workflow)==null?void 0:o.forwardedToCoordinators)===!0:N?t.type==="verified-template"||t.status==="approved"||((a=t.workflow)==null?void 0:a.currentStage)&&["permitsVerified","cpVerification","completed"].includes((f=t.workflow)==null?void 0:f.currentStage):t.status==="approved"||t.type==="verified-template"||((p=t.workflow)==null?void 0:p.currentStage)&&["permitsVerified","cpVerification","completed"].includes((E=t.workflow)==null?void 0:E.currentStage)});return{new:l,forwarded:n,verified:s}},[S,N,g]),le=c.useMemo(()=>{const m=B.forwarded||[],l=m.filter(s=>!!!(s.permits&&s.permits.federal)&&s.status!=="approved"&&s.status!=="rejected"),n=m.filter(s=>s.status==="approved");return{pending:l,verified:n}},[B.forwarded]),je=c.useMemo(()=>{if(!N)return{pending:[],verified:[]};const m=B.new||[],l=m.filter(s=>s.status!=="approved"&&s.status!=="rejected"),n=m.filter(s=>s.status==="approved");return{pending:l,verified:n}},[N,B.new]);c.useEffect(()=>{(async()=>{try{const{count:l,error:n}=await F.from("mmp_site_entries").select("*",{count:"exact",head:!0}).ilike("status","verified");if(n)throw n;h(l||0)}catch{h(0)}})()},[S]),c.useEffect(()=>{(async()=>{try{const{count:l,error:n}=await F.from("mmp_site_entries").select("*",{count:"exact",head:!0}).or("status.ilike.dispatched,dispatched_at.not.is.null").not("status","ilike","accepted").is("accepted_by",null);if(n)throw n;se(l||0)}catch{se(0)}})()},[S]),c.useEffect(()=>{(async()=>{try{const{count:l,error:n}=await F.from("mmp_site_entries").select("*",{count:"exact",head:!0}).or("status.ilike.accepted,accepted_by.not.is.null");if(n)throw n;de(l||0)}catch{de(0)}})()},[S]),c.useEffect(()=>{(async()=>{if(d!=="approvedCosted"){Q([]);return}K(!0);try{const{data:l,error:n}=await F.from("mmp_site_entries").select("*").ilike("status","verified").order("created_at",{ascending:!1}).limit(1e3);if(n)throw n;let s=l||[];const t=[];for(const a of s){const f=a.cost,p=a.additional_data||{},E=p==null?void 0:p.enumerator_fee,H=p==null?void 0:p.transport_fee;if(!f||f===0||f===null)t.push({id:a.id,cost:30,additional_data:{...p,enumerator_fee:20,transport_fee:10}});else if((!E||E===0)&&(!H||H===0)){let te=20,ue=10;f===30?(te=20,ue=10):f&&(te=f-10,ue=10),t.push({id:a.id,additional_data:{...p,enumerator_fee:te,transport_fee:ue}})}}if(t.length>0){for(const a of t)await F.from("mmp_site_entries").update({cost:a.cost||a.additional_data.enumerator_fee+a.additional_data.transport_fee,enumerator_fee:a.additional_data.enumerator_fee,transport_fee:a.additional_data.transport_fee,additional_data:a.additional_data}).eq("id",a.id);s=s.map(a=>{const f=t.find(p=>p.id===a.id);return f?{...a,cost:f.cost||f.additional_data.enumerator_fee+f.additional_data.transport_fee,enumerator_fee:f.additional_data.enumerator_fee,transport_fee:f.additional_data.transport_fee,additional_data:f.additional_data}:a})}s=s.filter(a=>Number(a.cost||0)>0);const o=s.map(a=>{const f=a.additional_data||{},p=a.enumerator_fee??f.enumerator_fee,E=a.transport_fee??f.transport_fee;return{...a,siteName:a.site_name,siteCode:a.site_code,hubOffice:a.hub_office,cpName:a.cp_name,siteActivity:a.activity_at_site,monitoringBy:a.monitoring_by,surveyTool:a.survey_tool,useMarketDiversion:a.use_market_diversion,useWarehouseMonitoring:a.use_warehouse_monitoring,visitDate:a.visit_date,comments:a.comments,enumerator_fee:p,enumeratorFee:p,transport_fee:E,transportFee:E,cost:a.cost,status:a.status,additionalData:f}});Q(o),h(o.length)}catch{Q([])}finally{K(!1)}})()},[d]),c.useEffect(()=>{(async()=>{if(d!=="dispatched"){i([]);return}M(!0);try{const{data:l,error:n}=await F.from("mmp_site_entries").select("*").or("status.ilike.dispatched,dispatched_at.not.is.null").not("status","ilike","accepted").is("accepted_by",null).order("dispatched_at",{ascending:!1}).limit(1e3);if(n)throw n;const s=l.map(t=>{const o=t.additional_data||{},a=t.enumerator_fee??o.enumerator_fee,f=t.transport_fee??o.transport_fee;return{...t,siteName:t.site_name,siteCode:t.site_code,hubOffice:t.hub_office,cpName:t.cp_name,siteActivity:t.activity_at_site,monitoringBy:t.monitoring_by,surveyTool:t.survey_tool,useMarketDiversion:t.use_market_diversion,useWarehouseMonitoring:t.use_warehouse_monitoring,visitDate:t.visit_date,comments:t.comments,enumerator_fee:a,enumeratorFee:a,transport_fee:f,transportFee:f,cost:t.cost,status:t.status,verified_by:t.verified_by,verified_at:t.verified_at,dispatched_by:t.dispatched_by,dispatched_at:t.dispatched_at,updated_at:t.updated_at,additionalData:o}});i(s),se(s.length)}catch{i([]),se(0)}finally{M(!1)}})()},[d]),c.useEffect(()=>{(async()=>{if(d!=="accepted"){_e([]);return}ge(!0);try{const{data:l,error:n}=await F.from("mmp_site_entries").select("*").or("status.ilike.accepted,accepted_by.not.is.null").order("accepted_at",{ascending:!1}).limit(1e3);if(n)throw n;const s=l.map(t=>{const o=t.additional_data||{},a=t.enumerator_fee??o.enumerator_fee,f=t.transport_fee??o.transport_fee;return{...t,siteName:t.site_name,siteCode:t.site_code,hubOffice:t.hub_office,cpName:t.cp_name,siteActivity:t.activity_at_site,monitoringBy:t.monitoring_by,surveyTool:t.survey_tool,useMarketDiversion:t.use_market_diversion,useWarehouseMonitoring:t.use_warehouse_monitoring,visitDate:t.visit_date,comments:t.comments,enumerator_fee:a,enumeratorFee:a,transport_fee:f,transportFee:f,cost:t.cost,status:t.status,verified_by:t.verified_by,verified_at:t.verified_at,dispatched_by:t.dispatched_by,dispatched_at:t.dispatched_at,accepted_by:t.accepted_by,accepted_at:t.accepted_at,updated_at:t.updated_at,additionalData:o}});_e(s),de(s.length)}catch{_e([]),de(0)}finally{ge(!1)}})()},[d]);const ce=c.useMemo(()=>{const m=B.verified||[];return{newSites:m.filter(l=>{var f,p;const n=(f=l.workflow)==null?void 0:f.currentStage,s=q[l.id],o=!!((p=l.workflow)!=null&&p.coordinatorVerified)&&(n==="verified"||n==="draft")&&l.status==="pending"&&!(s!=null&&s.hasCosted||s!=null&&s.hasInProgress||s!=null&&s.hasCompleted||s!=null&&s.hasRejected),a=l.type==="verified-template"&&!(s!=null&&s.hasCosted||s!=null&&s.hasInProgress||s!=null&&s.hasCompleted||s!=null&&s.hasRejected);return o||a}),approvedCosted:m.filter(l=>{const n=q[l.id];return!!(n!=null&&n.allApprovedAndCosted)}),dispatched:m.filter(l=>{const n=q[l.id];return!!(n!=null&&n.hasAssigned||n!=null&&n.hasDispatched)}),accepted:m.filter(l=>{const n=q[l.id];return!!(n!=null&&n.hasAccepted)}),ongoing:m.filter(l=>{const n=q[l.id];return!!(n!=null&&n.hasInProgress)}),completed:m.filter(l=>{var s;const n=q[l.id];return!!(n!=null&&n.hasCompleted)||((s=l.workflow)==null?void 0:s.currentStage)==="completed"})}},[B.verified,q]),fe=(m,l)=>{const n=[],s=new Set(U.map(o=>o.mmpId));for(const o of m)if(!s.has(o.id)&&Array.isArray(o.siteEntries))for(const a of o.siteEntries){const f={id:a.id||`${o.id}-site-${n.length}`,mmpId:o.id,siteName:a.siteName||a.siteCode||a.state||"Site",siteCode:a.siteCode,state:a.state,locality:a.locality,status:a.status||"pending",feesTotal:0,assignedAt:void 0,completedAt:void 0,rejectionReason:void 0};(!l||l(f))&&n.push(f)}return[...U.filter(o=>m.find(f=>f.id===o.mmpId)?!l||l(o):!1),...n]},it=c.useMemo(()=>{const m=B.verified||[];return m.length===0?0:fe(m,n=>{var t;return(((t=n.status)==null?void 0:t.toLowerCase())||"")==="verified"}).length},[B.verified,U]),we=c.useMemo(()=>{const m=d;if(m==="newSites"){const n=B.verified||[];return n.length===0?[]:fe(n,t=>{var a;return(((a=t.status)==null?void 0:a.toLowerCase())||"")==="verified"})}if(m==="dispatched"){const n=ce[m]||[];return n.length===0?[]:fe(n,t=>{var a;return(((a=t.status)==null?void 0:a.toLowerCase())||"")==="dispatched"||t.dispatched_at!==void 0})}const l=ce[m]||[];return l.length===0?[]:fe(l)},[d,ce,B.verified,U]),Ne=c.useMemo(()=>{if(d==="newSites"){const m=we,l=new Set(m.map(s=>s.mmpId));return(B.verified||[]).filter(s=>l.has(s.id))}return A||P||N||T?ce[d]||[]:B.verified||[]},[A,P,N,T,d,ce,B.verified,we]),at=c.useMemo(()=>{const m=d==="newSites"?l=>{var s;return(((s=l.status)==null?void 0:s.toLowerCase())||"")==="verified"}:void 0;return Ne.map(l=>({mmp:l,rows:fe([l],m)}))},[Ne,d,U]),Te=c.useMemo(()=>{if(!N)return[];const m=le[y]||[];return m.length===0?[]:fe(m)},[N,y,le,U]);return c.useMemo(()=>{const m=A||P||N?le[y]||[]:B.forwarded||[],l=[];for(const n of m){const s=n.siteEntries||[];Array.isArray(s)&&s.forEach((t,o)=>{l.push({...t,__mmpId:n.id,__siteIndex:o,_key:(t==null?void 0:t.id)||(t==null?void 0:t.siteCode)||`${n.id}-site-${o}`})})}return l},[A,P,N,y,le,B.forwarded]),c.useEffect(()=>{(async()=>{if(!(A||P||N||T))return;let l=[];if(N?l=[...B.verified||[],...B.forwarded||[]]:(A||P||T)&&(l=[...B.verified||[]]),l.length===0){I({});return}const n=l.map(s=>s.id);try{const{data:s,error:t}=await F.from("mmp_site_entries").select("id,mmp_file_id,status,site_code,state,locality,site_name,verification_notes,cost,verified_by,verified_at,dispatched_at,accepted_by,accepted_at").in("mmp_file_id",n);if(t)throw t;const o={},a=[];for(const p of n)o[p]||(o[p]={exists:!1,hasCosted:!1,hasAssigned:!1,hasInProgress:!1,hasAccepted:!1,hasCompleted:!1,hasRejected:!1,hasDispatched:!1,allApprovedAndCosted:!1});const f=new Map;for(const p of s||[]){const E=p.mmp_file_id;f.has(E)||f.set(E,[]),f.get(E).push(p),o[E]||(o[E]={exists:!1,hasCosted:!1,hasAssigned:!1,hasInProgress:!1,hasAccepted:!1,hasCompleted:!1,hasRejected:!1,hasDispatched:!1,allApprovedAndCosted:!1}),o[E].exists=!0;const H=String(p.status||"").toLowerCase();H==="assigned"&&(o[E].hasAssigned=!0),(H==="accepted"||p.accepted_by)&&(o[E].hasAccepted=!0),(H==="inprogress"||H==="in_progress")&&(o[E].hasInProgress=!0),H==="completed"&&(o[E].hasCompleted=!0),(H==="rejected"||H==="declined")&&(o[E].hasRejected=!0),(H==="dispatched"||p.dispatched_at)&&(o[E].hasDispatched=!0);const te=Number(p.cost||0);te>0&&(o[E].hasCosted=!0);const ue={id:p.id||`${p.mmp_file_id}-${p.site_code}`,mmpId:p.mmp_file_id,siteName:p.site_name||p.site_code||"Site",siteCode:p.site_code||void 0,state:p.state||void 0,locality:p.locality||void 0,status:p.status||"Pending",feesTotal:te,verifiedBy:p.verified_by||void 0,verifiedAt:p.verified_at||void 0};a.push(ue)}for(const[p,E]of f.entries())if(o[p]||(o[p]={exists:!1,hasCosted:!1,hasAssigned:!1,hasInProgress:!1,hasAccepted:!1,hasCompleted:!1,hasRejected:!1,hasDispatched:!1,allApprovedAndCosted:!1}),E.length>0){const H=E.every(te=>{const ue=Number(te.cost||0),rt=String(te.status||"").toLowerCase();return ue>0&&rt==="verified"});o[p].allApprovedAndCosted=H}I(o),w(a)}catch{I({}),w([])}})()},[A,P,(Ie=B.verified)==null?void 0:Ie.length]),st?e.jsxs("div",{className:"space-y-10 min-h-screen bg-slate-50 dark:bg-gray-900 py-8 px-2 md:px-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 bg-blue-600 dark:bg-blue-900 p-7 rounded-2xl shadow-xl border border-blue-100 dark:border-blue-900",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx($,{variant:"ghost",size:"icon",onClick:()=>_("/dashboard"),className:"hover:bg-blue-100 dark:hover:bg-blue-900/40",children:e.jsx(mt,{className:"h-5 w-5 text-white dark:text-blue-200"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-extrabold text-white tracking-tight",children:"MMP Management"}),e.jsx("p",{className:"text-blue-100 dark:text-blue-200/80 font-medium",children:A||P?"Upload, validate, and forward MMPs to Field Operations Managers":N?"Process MMPs, attach permits, and assign sites to coordinators":T?"Review and verify site assignments":"Manage your MMP files and site visits"})]})]}),Pe&&e.jsxs($,{className:"bg-blue-700 hover:bg-blue-800 text-white shadow-lg hover:shadow-xl transition-all duration-300 px-6 py-2 rounded-full font-semibold",onClick:()=>_("/mmp/upload"),children:[e.jsx(ht,{className:"h-5 w-5 mr-2"}),"Upload MMP"]})]}),e.jsx("div",{className:"bg-white dark:bg-gray-900 rounded-2xl shadow-lg p-6",children:x?e.jsx("div",{className:"text-center text-muted-foreground py-8",children:"Loading MMP files..."}):e.jsxs(Mt,{value:u,onValueChange:k,className:"w-full",children:[e.jsxs(Dt,{className:`grid w-full mb-6 ${T?"grid-cols-1":"grid-cols-3"}`,children:[!T&&e.jsxs(Se,{value:"new",className:"flex items-center gap-2 data-[state=active]:bg-blue-200 data-[state=active]:text-blue-900 data-[state=active]:shadow-none",children:["New MMPs",e.jsx(V,{variant:"secondary",children:B.new.length})]}),!T&&e.jsxs(Se,{value:"forwarded",className:"flex items-center gap-2 data-[state=active]:bg-blue-200 data-[state=active]:text-blue-900 data-[state=active]:shadow-none",children:[N?"Forwarded Sites":"Forwarded MMPs",e.jsx(V,{variant:"secondary",children:B.forwarded.length})]}),e.jsxs(Se,{value:"verified",className:"flex items-center gap-2 data-[state=active]:bg-blue-200 data-[state=active]:text-blue-900 data-[state=active]:shadow-none",children:[T?"MMPs to Review":"Verified Sites",e.jsx(V,{variant:"secondary",children:B.verified.length})]})]}),!T&&e.jsxs(ye,{value:"new",children:[N&&e.jsxs("div",{className:"mb-4 flex flex-nowrap gap-2 items-center overflow-x-auto whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground mr-2",children:"Subcategory:"}),e.jsxs($,{variant:z==="pending"?"default":"outline",size:"sm",onClick:()=>v("pending"),className:z==="pending"?"bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-300":"",children:["MMPs Pending Verification",e.jsx(V,{variant:"secondary",className:"ml-2",children:je.pending.length})]}),e.jsxs($,{variant:z==="verified"?"default":"outline",size:"sm",onClick:()=>v("verified"),className:z==="verified"?"bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-300":"",children:["Verified MMPs",e.jsx(V,{variant:"secondary",className:"ml-2",children:je.verified.length})]})]}),e.jsx(ke,{mmpFiles:N?je[z]:B.new})]}),!T&&e.jsxs(ye,{value:"forwarded",children:[(A||P||N)&&e.jsxs("div",{className:"mb-4 flex flex-nowrap gap-2 items-center overflow-x-auto whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground mr-2",children:"Subcategory:"}),e.jsxs($,{variant:y==="pending"?"default":"outline",size:"sm",onClick:()=>r("pending"),className:y==="pending"?"bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-300":"",children:[N?"Sites Pending Verification":"MMPs Pending Verification",e.jsx(V,{variant:"secondary",className:"ml-2",children:le.pending.length})]}),e.jsxs($,{variant:y==="verified"?"default":"outline",size:"sm",onClick:()=>r("verified"),className:y==="verified"?"bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-300":"",children:[N?"Verified Sites":"Verified MMPs",e.jsx(V,{variant:"secondary",className:"ml-2",children:le.verified.length})]})]}),e.jsx(ke,{mmpFiles:A||P||N?le[y]:B.forwarded}),N&&e.jsx(Re,{siteRows:Te,editable:!0,title:`Site Entries (${Te.length}) - Forwarded subcategory: ${y}`})]}),e.jsxs(ye,{value:"verified",children:[(A||P||N||T)&&e.jsxs("div",{className:"mb-4 flex flex-nowrap gap-2 items-center overflow-x-auto whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground mr-2",children:"Subcategory:"}),e.jsxs($,{variant:d==="newSites"?"default":"outline",size:"sm",onClick:()=>C("newSites"),className:d==="newSites"?"bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-300":"",children:["New Sites",e.jsx(V,{variant:"secondary",className:"ml-2",children:it})]}),e.jsxs($,{variant:d==="approvedCosted"?"default":"outline",size:"sm",onClick:()=>C("approvedCosted"),className:d==="approvedCosted"?"bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-300":"",children:["Approved & Costed",e.jsx(V,{variant:"secondary",className:"ml-2",children:Z})]}),e.jsxs($,{variant:d==="dispatched"?"default":"outline",size:"sm",onClick:()=>C("dispatched"),className:d==="dispatched"?"bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-300":"",children:["Dispatched",e.jsx(V,{variant:"secondary",className:"ml-2",children:Y})]}),(A||P||N)&&e.jsxs(e.Fragment,{children:[e.jsxs($,{variant:d==="accepted"?"default":"outline",size:"sm",onClick:()=>C("accepted"),className:d==="accepted"?"bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-300":"",children:["Accepted",e.jsx(V,{variant:"secondary",className:"ml-2",children:be})]}),e.jsxs($,{variant:d==="ongoing"?"default":"outline",size:"sm",onClick:()=>C("ongoing"),className:d==="ongoing"?"bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-300":"",children:["Ongoing",e.jsx(V,{variant:"secondary",className:"ml-2",children:((Be=ce.ongoing)==null?void 0:Be.length)||0})]})]}),e.jsxs($,{variant:d==="completed"?"default":"outline",size:"sm",onClick:()=>C("completed"),className:d==="completed"?"bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-300":"",children:["Completed",e.jsx(V,{variant:"secondary",className:"ml-2",children:ce.completed.length})]})]}),d!=="approvedCosted"&&d!=="dispatched"&&e.jsx(ke,{mmpFiles:Ne}),(A||P||N||T)&&d==="newSites"&&e.jsx(Ht,{verifiedSites:we}),(A||P||N||T)&&d==="approvedCosted"&&e.jsx("div",{className:"mt-6",children:X?e.jsx(J,{children:e.jsx(ee,{className:"py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"Loading approved and costed site entries..."})})}):O.length===0?e.jsx(J,{children:e.jsx(ee,{className:"py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"No approved and costed site entries found."})})}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Approved & Costed Site Entries"}),e.jsxs(V,{variant:"secondary",children:[O.length," entries"]})]}),(A||P)&&O.length>0&&e.jsxs("div",{className:"mb-4 flex flex-wrap gap-2",children:[e.jsx($,{variant:"outline",size:"sm",onClick:()=>{re("state"),ne(!0)},className:"bg-blue-50 hover:bg-blue-100",children:"Bulk Dispatch by State"}),e.jsx($,{variant:"outline",size:"sm",onClick:()=>{re("locality"),ne(!0)},className:"bg-blue-50 hover:bg-blue-100",children:"Bulk Dispatch by Locality"}),e.jsx($,{variant:"outline",size:"sm",onClick:()=>{re("individual"),ne(!0)},className:"bg-blue-50 hover:bg-blue-100",children:"Individual Dispatch"})]}),e.jsx(xe,{siteEntries:O,editable:!0,onUpdateSites:async m=>{try{for(const s of m){const t=s.enumerator_fee??s.enumeratorFee,o=s.transport_fee??s.transportFee;let a;t!==void 0&&o!==void 0&&(a=Number(t)+Number(o));const f=a??s.cost,E={...s.additionalData||s.additional_data||{},enumerator_fee:t,transport_fee:o,cost:f},H={site_name:s.siteName||s.site_name,site_code:s.siteCode||s.site_code,hub_office:s.hubOffice||s.hub_office,state:s.state,locality:s.locality,cp_name:s.cpName||s.cp_name,activity_at_site:s.siteActivity||s.activity_at_site,monitoring_by:s.monitoringBy||s.monitoring_by,survey_tool:s.surveyTool||s.survey_tool,use_market_diversion:s.useMarketDiversion||s.use_market_diversion,use_warehouse_monitoring:s.useWarehouseMonitoring||s.use_warehouse_monitoring,visit_date:s.visitDate||s.visit_date,comments:s.comments,cost:f,enumerator_fee:t!==void 0?Number(t):void 0,transport_fee:o!==void 0?Number(o):void 0,status:s.status,verification_notes:s.verification_notes||s.verificationNotes,verified_by:s.verified_by||s.verifiedBy,verified_at:s.verified_at||s.verifiedAt,additional_data:E};Object.keys(H).forEach(te=>{H[te]===void 0&&delete H[te]}),s.id&&await F.from("mmp_site_entries").update(H).eq("id",s.id)}const{data:l,error:n}=await F.from("mmp_site_entries").select("*").ilike("status","verified").gt("cost",0).order("created_at",{ascending:!1}).limit(1e3);if(!n&&l){const s=l.map(t=>{const o=t.additional_data||{},a=t.enumerator_fee??o.enumerator_fee,f=t.transport_fee??o.transport_fee;return{...t,siteName:t.site_name,siteCode:t.site_code,hubOffice:t.hub_office,cpName:t.cp_name,siteActivity:t.activity_at_site,monitoringBy:t.monitoring_by,surveyTool:t.survey_tool,useMarketDiversion:t.use_market_diversion,useWarehouseMonitoring:t.use_warehouse_monitoring,visitDate:t.visit_date,comments:t.comments,enumerator_fee:a,enumeratorFee:a,transport_fee:f,transportFee:f,cost:t.cost,status:t.status,verified_by:t.verified_by,verified_at:t.verified_at,dispatched_by:t.dispatched_by,dispatched_at:t.dispatched_at,updated_at:t.updated_at,additionalData:o}});Q(s),h(s.length)}return!0}catch{return!1}}})]})}),(A||P||N||T)&&d==="dispatched"&&e.jsx("div",{className:"mt-6",children:j?e.jsx(J,{children:e.jsx(ee,{className:"py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"Loading dispatched site entries..."})})}):W.length===0?e.jsx(J,{children:e.jsx(ee,{className:"py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"No dispatched site entries found."})})}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Dispatched Site Entries"}),e.jsxs(V,{variant:"secondary",children:[W.length," entries"]})]}),e.jsx(xe,{siteEntries:W,editable:!1})]})}),(A||P||N||T)&&d==="accepted"&&e.jsx("div",{className:"mt-6",children:pe?e.jsx(J,{children:e.jsx(ee,{className:"py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"Loading accepted site entries..."})})}):oe.length===0?e.jsx(J,{children:e.jsx(ee,{className:"py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"No accepted site entries found."})})}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Accepted Site Entries"}),e.jsxs(V,{variant:"secondary",children:[oe.length," entries"]})]}),e.jsx(xe,{siteEntries:oe,editable:!1})]})}),(A||P||N||T)&&d!=="newSites"&&d!=="approvedCosted"&&d!=="dispatched"&&d!=="accepted"&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Sites by MMP"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Verified subcategory: ",d]})]}),e.jsx(Wt,{type:"multiple",className:"w-full",children:at.map(({mmp:m,rows:l})=>e.jsxs(Je,{value:m.id,children:[e.jsx(et,{children:e.jsxs("div",{className:"flex items-center gap-3 text-left",children:[e.jsx("span",{className:"font-medium",children:m.name}),e.jsxs(V,{variant:"secondary",children:[l.length," sites"]})]})}),e.jsx(tt,{children:e.jsx(Re,{siteRows:l,mmpId:m.id,editable:!0,title:`Sites for ${m.name}`})})]},m.id))})]})]})]})}),(A||P)&&e.jsxs(e.Fragment,{children:[e.jsx(qt,{open:L,onOpenChange:D}),e.jsx(Gt,{open:ie,onOpenChange:ne,siteEntries:O,dispatchType:G,onDispatched:async()=>{if(d==="dispatched"){const{data:m,error:l}=await F.from("mmp_site_entries").select("*").or("status.ilike.dispatched,dispatched_at.not.is.null").not("status","ilike","accepted").is("accepted_by",null).order("dispatched_at",{ascending:!1}).limit(1e3);if(!l&&m){const n=m.map(s=>{const t=s.additional_data||{},o=s.enumerator_fee??t.enumerator_fee,a=s.transport_fee??t.transport_fee;return{...s,siteName:s.site_name,siteCode:s.site_code,hubOffice:s.hub_office,cpName:s.cp_name,siteActivity:s.activity_at_site,monitoringBy:s.monitoring_by,surveyTool:s.survey_tool,useMarketDiversion:s.use_market_diversion,useWarehouseMonitoring:s.use_warehouse_monitoring,visitDate:s.visit_date,comments:s.comments,enumerator_fee:o,enumeratorFee:o,transport_fee:a,transportFee:a,cost:s.cost,status:s.status,verified_by:s.verified_by,verified_at:s.verified_at,dispatched_by:s.dispatched_by,dispatched_at:s.dispatched_at,updated_at:s.updated_at,additionalData:t}});i(n),se(n.length)}}if(d==="approvedCosted"){const{data:m,error:l}=await F.from("mmp_site_entries").select("*").ilike("status","verified").gt("cost",0).order("created_at",{ascending:!1}).limit(1e3);if(!l&&m){const s=m.map(t=>{const o=t.additional_data||{};return{...t,siteName:t.site_name,siteCode:t.site_code,hubOffice:t.hub_office,cpName:t.cp_name,siteActivity:t.activity_at_site,monitoringBy:t.monitoring_by,surveyTool:t.survey_tool,useMarketDiversion:t.use_market_diversion,useWarehouseMonitoring:t.use_warehouse_monitoring,visitDate:t.visit_date,comments:t.comments,enumerator_fee:o.enumerator_fee,enumeratorFee:o.enumerator_fee,transport_fee:o.transport_fee,transportFee:o.transport_fee,cost:t.cost,status:t.status,verified_by:t.verified_by,verified_at:t.verified_at,dispatched_by:t.dispatched_by,dispatched_at:t.dispatched_at,updated_at:t.updated_at,additionalData:o}});Q(s),h(s.length)}}}})]})]}):e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs(J,{className:"w-full max-w-md",children:[e.jsxs(Ct,{children:[e.jsx(St,{className:"text-destructive",children:"Access Denied"}),e.jsx(yt,{children:"You don't have permission to access this page."})]}),e.jsx(ee,{children:e.jsx($,{variant:"outline",onClick:()=>_("/dashboard"),className:"w-full",children:"Return to Dashboard"})})]})})};export{xs as default};
