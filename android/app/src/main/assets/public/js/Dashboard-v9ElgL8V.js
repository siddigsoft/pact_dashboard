import{j as e,B as ze,Y as We,q,r as w,ah as Cs,M as Y,u as Ce,v as ms,U as he,ai as Ss,aj as ks,X as xs,i as J,ak as Ds,al as As,h as Se,l as Z,m as _e,T as He,a0 as Ms,am as Ts,ag as Ls,o as hs,a3 as z,an as Vs,R as fe,ao as Ps,t as ve,p as ue,a4 as ye,ap as us,aq as $s,a1 as ps,ar as Rs,c as ke,n as gs,a8 as Is,as as Fs,at as Os,au as Es,av as zs,y as Ue,aw as Us,ax as Xe,I as Bs,ay as Ws,az as _s,aA as Hs,a2 as js,aB as Qs,b as es,ae as Zs,aC as Gs,aD as De,aE as qs,aF as Ys,J as ss}from"./react-core-B8kFjp2k.js";import{C as L,f as U,g as B,B as S,h as Js,b as R,a as V,t as Ks,v as Qe,w as Xs,T as te,i as ae,j as O,I as fs,k as _,S as Ae,A as Te,x as et,y as st,z as tt,E as Ze,u as Le,D as Ve,l as Pe,m as $e,n as Re,o as Ie,p as at,F as Ge,G as ge,e as ne,H as oe,J as ie,r as Fe,s as Me,K as nt,L as rt,M as lt,N as it,O as ts,Q as ct,R as dt,c as qe,d as Ye,U as Ns}from"./index-PwDgWEVM.js";import{bo as pe}from"./vendor-VlxgVHMv.js";import{o as H,L as ce,g as Oe,h as Be,p as as,J as bs,K as ot,I as ns,H as rs,B as mt,s as ws,M as xt}from"./date-utils-YarVESQS.js";import{C as ht}from"./ChatWindow-BJzXkqLX.js";import{C as ut}from"./CallInterface-CeQ4eL66.js";import{G as je}from"./gradient-stat-card-CWH4umO5.js";import{T as Ne,a as be,b as G,c as A,d as we,e as M}from"./table-CZ8ZB6wW.js";import{S as K,a as X,b as ee,c as se,d as E}from"./select-CXX5Q_V1.js";import{P as me}from"./progress-vMwTbqUI.js";import{L as de}from"./router-CKy9yO3R.js";import{C as pt}from"./calendar-DEyRSxJX.js";import{m as xe}from"./animations-BiLmE0Io.js";import{S as gt}from"./switch-DFAHzttT.js";import{L as jt}from"./label-C4lDws8j.js";import{L as re,M as ft,T as Nt,a as ls,P as is,u as bt,l as Je}from"./maps-BzFQ_kYT.js";import{F as wt}from"./FraudPreventionDashboard-DeXNzUdp.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";import"./textarea-BpQMf5eL.js";const vt=({dueSoon:t,overdue:h,onClose:a})=>{const c=pe(),r=o=>{c(`/site-visits/${o}`),a()},l=()=>{c("/site-visits"),a()};return t.length>0||h.length>0?e.jsxs(L,{className:"w-full max-w-md mx-auto",children:[e.jsxs(U,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ze,{className:"h-5 w-5 text-amber-500"}),e.jsx(B,{children:"Site Visit Reminders"})]}),e.jsxs(S,{variant:"outline",children:[h.length+t.length," Total"]})]}),e.jsxs(Js,{children:[h.length>0?`${h.length} overdue, `:"",t.length>0?`${t.length} upcoming`:""]})]}),e.jsxs(R,{className:"space-y-4",children:[h.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-sm font-semibold text-destructive flex items-center gap-2",children:[e.jsx(We,{className:"h-4 w-4"}),"Overdue"]}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:h.map(o=>e.jsxs("div",{className:"p-2 border rounded-md flex items-center justify-between bg-red-50",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:o.siteName}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Due: ",H(new Date(o.dueDate),"PPP")]})]}),e.jsx(V,{variant:"ghost",size:"sm",onClick:()=>r(o.id),children:"View"})]},o.id))})]}),t.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-sm font-semibold text-amber-600 flex items-center gap-2",children:[e.jsx(q,{className:"h-4 w-4"}),"Due Soon"]}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:t.map(o=>e.jsxs("div",{className:"p-2 border rounded-md flex items-center justify-between bg-amber-50",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:o.siteName}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Due: ",H(new Date(o.dueDate),"PPP")]})]}),e.jsx(V,{variant:"ghost",size:"sm",onClick:()=>r(o.id),children:"View"})]},o.id))})]}),e.jsx("div",{className:"flex justify-end pt-2",children:e.jsxs("div",{className:"space-x-2",children:[e.jsx(V,{variant:"outline",size:"sm",onClick:a,children:"Dismiss"}),e.jsx(V,{size:"sm",onClick:l,children:"View All Visits"})]})})]})]}):null},yt=()=>{const{showDueReminders:t,dueSoonVisits:h,overdueVisits:a,showRemindersModal:c,setShowRemindersModal:r}=Ks();return{SiteVisitRemindersDialog:c?e.jsx(vt,{dueSoon:h,overdue:a,onClose:()=>r(!1)}):null,showDueReminders:t,dueSoonVisits:h,overdueVisits:a,showRemindersModal:c,setShowRemindersModal:r}},Ct=()=>{const{chats:t,setActiveChat:h,activeChat:a,getUnreadMessagesCount:c}=Qe(),{notifications:r}=Xs(),l=pe(),[n,o]=w.useState(""),[i,d]=w.useState(!1),u=c(),s=r.filter(g=>!g.isRead).length,x=n?t.filter(g=>g.name.toLowerCase().includes(n.toLowerCase())):t,m=g=>{h(g),d(!0)},b=()=>{d(!1),h(null)},j=()=>{l("/calls")};return w.useEffect(()=>{a&&d(!0)},[a]),i&&a?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"py-2 px-3 border-b flex items-center",children:[e.jsx(V,{variant:"ghost",size:"sm",onClick:b,className:"mr-2",children:e.jsx(Cs,{size:18})}),e.jsx("span",{className:"font-medium",children:a.name})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(ht,{})})]}):e.jsx("div",{className:"flex flex-col h-full",children:e.jsxs(te,{defaultValue:"chats",className:"w-full h-full flex flex-col",children:[e.jsx("div",{className:"border-b px-2",children:e.jsxs(ae,{className:"w-full grid grid-cols-3 h-12",children:[e.jsxs(O,{value:"chats",className:"relative",children:[e.jsx(Y,{className:"h-4 w-4 mr-1"}),e.jsx("span",{children:"Chats"}),u>0&&e.jsx(S,{variant:"destructive",className:"absolute -top-1 -right-1 h-5 w-5 p-0 flex items-center justify-center",children:u>9?"9+":u})]}),e.jsxs(O,{value:"calls",children:[e.jsx(Ce,{className:"h-4 w-4 mr-1"}),e.jsx("span",{children:"Calls"})]}),e.jsxs(O,{value:"notifications",className:"relative",children:[e.jsx(ze,{className:"h-4 w-4 mr-1"}),e.jsx("span",{children:"Alerts"}),s>0&&e.jsx(S,{variant:"destructive",className:"absolute -top-1 -right-1 h-5 w-5 p-0 flex items-center justify-center",children:s>9?"9+":s})]})]})}),e.jsx("div",{className:"py-2 px-3",children:e.jsxs("div",{className:"relative",children:[e.jsx(ms,{className:"h-4 w-4 absolute left-2.5 top-2.5 text-muted-foreground"}),e.jsx(fs,{type:"search",placeholder:"Search communications...",className:"pl-9 bg-background",value:n,onChange:g=>o(g.target.value)})]})}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsxs(_,{value:"chats",className:"mt-0 h-full",children:[e.jsx(Ae,{className:"h-full",children:e.jsxs("div",{className:"p-3 space-y-2",children:[x.map(g=>e.jsx(L,{className:`p-3 cursor-pointer hover:bg-accent transition-colors ${g.unreadCount>0?"border-l-4 border-l-primary":""}`,onClick:()=>m(g),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Te,{className:"h-10 w-10 mt-0.5",children:e.jsx("div",{className:`${g.type==="group"?"bg-secondary/20":"bg-primary/20"} w-full h-full rounded-full flex items-center justify-center`,children:g.type==="group"?e.jsx(he,{size:16}):g.name.charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-medium text-sm line-clamp-1",children:g.name}),e.jsx("span",{className:"text-xs text-muted-foreground whitespace-nowrap",children:new Date(g.createdAt).toLocaleDateString()})]}),g.lastMessage?e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-1 mt-0.5",children:g.lastMessage.content}):e.jsx("p",{className:"text-xs text-muted-foreground italic mt-0.5",children:"No messages yet"}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[g.relatedEntityType&&e.jsx("span",{className:"text-xs bg-accent text-accent-foreground rounded-sm px-1.5 py-0.5",children:g.relatedEntityType==="mmpFile"?"MMP":g.relatedEntityType==="siteVisit"?"Site Visit":g.relatedEntityType==="project"?"Project":"Chat"}),g.unreadCount>0&&e.jsx(S,{className:"ml-auto",children:g.unreadCount})]})]})]})},g.id)),x.length===0&&e.jsxs("div",{className:"py-8 text-center",children:[e.jsx(Y,{className:"h-8 w-8 mx-auto text-muted-foreground/50"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"No chats found"})]})]})}),e.jsx("div",{className:"p-3 border-t bg-background",children:e.jsxs(V,{className:"w-full",onClick:()=>l("/chat"),children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Open Full Chat"]})})]}),e.jsx(_,{value:"calls",className:"mt-0 h-full",children:e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-6 text-center",children:[e.jsx("div",{className:"bg-primary/10 rounded-full p-6",children:e.jsx(Ce,{className:"h-12 w-12 text-primary"})}),e.jsx("h3",{className:"text-xl font-medium mt-6",children:"In-App Calling"}),e.jsx("p",{className:"text-muted-foreground max-w-sm mt-2",children:"Initiate voice calls directly to team members and site coordinators without leaving the app"}),e.jsx(V,{className:"mt-6",onClick:j,children:"Open Call Center"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-4",children:"Calls are recorded and stored for audit purposes"})]})}),e.jsxs(_,{value:"notifications",className:"mt-0 h-full",children:[e.jsx(Ae,{className:"h-full",children:e.jsxs("div",{className:"p-3 space-y-2",children:[r.slice(0,10).map(g=>e.jsx(L,{className:`p-3 border-l-4 ${g.type==="error"?"border-l-destructive":g.type==="warning"?"border-l-amber-500":g.type==="success"?"border-l-green-500":"border-l-blue-500"} ${g.isRead?"opacity-75":""}`,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h4",{className:"font-medium text-sm",children:g.title}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(g.createdAt).toLocaleDateString()})]}),e.jsx("p",{className:"text-xs mt-1",children:g.message}),g.link&&e.jsx(V,{variant:"link",size:"sm",className:"mt-1 h-auto p-0 justify-start text-xs",onClick:()=>l(g.link),children:"View details"})]})},g.id)),r.length===0&&e.jsxs("div",{className:"py-8 text-center",children:[e.jsx(ze,{className:"h-8 w-8 mx-auto text-muted-foreground/50"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"No notifications"})]})]})}),e.jsx("div",{className:"p-3 border-t bg-background",children:e.jsx(V,{variant:"outline",className:"w-full",onClick:()=>l("/notifications"),children:"View All Notifications"})})]})]})]})})},St=()=>{const[t,h]=w.useState(!1),[a,c]=w.useState(!1),{callState:r,endCall:l}=et(),n=r.status!=="idle";return e.jsxs(e.Fragment,{children:[!a&&e.jsx("div",{className:"fixed bottom-4 right-4 z-50 flex flex-col gap-2",children:e.jsxs(V,{onClick:()=>c(!0),className:"rounded-full h-14 w-14 shadow-lg bg-primary hover:bg-primary/90 transition-all",children:[e.jsx(Y,{className:"h-6 w-6"}),e.jsx(S,{variant:"destructive",className:"absolute -top-2 -right-2",children:"3"})]})}),e.jsx(st,{open:a,onOpenChange:c,children:e.jsx(tt,{side:"right",className:`w-[380px] p-0 ${t?"h-[70px]":"h-[600px]"}`,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[n?e.jsx(Ce,{className:"h-5 w-5 text-primary animate-pulse"}):e.jsx(Y,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:n?"Active Call":"Messages"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>h(!t),children:t?e.jsx(Ss,{className:"h-4 w-4"}):e.jsx(ks,{className:"h-4 w-4"})}),e.jsx(V,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>{n&&l(),c(!1)},children:e.jsx(xs,{className:"h-4 w-4"})})]})]}),!t&&e.jsx("div",{className:"flex-1 overflow-hidden",children:n&&r.recipient?e.jsx(ut,{recipient:r.recipient,callType:r.status,duration:r.duration,onEnd:l,minimized:!1}):e.jsx(Ct,{})})]})})})]})},cs="PACT__location_prompt_dismissed_until",kt=24*60*60*1e3,Dt=t=>{var h,a;return!!((h=t==null?void 0:t.location)!=null&&h.latitude&&((a=t==null?void 0:t.location)!=null&&a.longitude))},At=()=>{const{currentUser:t,updateUserLocation:h}=Ze(),{toast:a}=Le(),[c,r]=w.useState(!1),[l,n]=w.useState(!1),o=w.useMemo(()=>{try{const u=localStorage.getItem(cs);return u?parseInt(u,10):0}catch{return 0}},[]);w.useEffect(()=>{if(!t||Dt(t))return;const u=Date.now();o&&u<o||r(!0)},[t,o]);const i=async()=>{if(!("geolocation"in navigator)){a({title:"Geolocation unavailable",description:"Your browser does not support geolocation.",variant:"destructive"});return}n(!0),navigator.geolocation.getCurrentPosition(async u=>{const{latitude:s,longitude:x}=u.coords;try{await h(s,x)?(a({title:"Location saved",description:`We saved your location (${s.toFixed(4)}, ${x.toFixed(4)}).`}),r(!1)):a({title:"Failed to save location",description:"We could not save your location. Please try again later.",variant:"destructive"})}catch{a({title:"Failed to save location",description:"We could not save your location. Please try again later.",variant:"destructive"})}finally{n(!1)}},u=>{a({title:"Permission required",description:"Please allow location access to appear on the team map and receive nearby assignments.",variant:"destructive"}),n(!1)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})},d=()=>{try{localStorage.setItem(cs,(Date.now()+kt).toString())}catch{}r(!1)};return c?e.jsx(Ve,{open:c,onOpenChange:r,children:e.jsxs(Pe,{children:[e.jsxs($e,{children:[e.jsx(Re,{children:"Share your location"}),e.jsx(Ie,{children:"Enable location sharing so supervisors can assign you nearby site visits and your team can see your live position on the map. You can change this later in Settings → Location."})]}),e.jsxs(at,{children:[e.jsx(V,{variant:"outline",onClick:d,disabled:l,children:"Not now"}),e.jsx(V,{onClick:i,disabled:l,children:l?"Saving...":"Allow location"})]})]})}):null},Mt=({isConnected:t,channelCount:h=0})=>{const[a,c]=w.useState(new Date);return w.useEffect(()=>{t&&c(new Date)},[t]),w.useEffect(()=>{const r=setInterval(()=>{t&&c(new Date)},3e4);return()=>clearInterval(r)},[t]),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{variant:t?"default":"destructive",className:"flex items-center gap-2 px-3 py-1","data-testid":"badge-connection-status",children:t?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"h-3 w-3 animate-pulse"}),e.jsx("span",{children:"Live"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"h-3 w-3"}),e.jsx("span",{children:"Disconnected"})]})}),t&&e.jsxs("span",{className:"text-xs text-muted-foreground hidden sm:inline","data-testid":"text-last-update",children:["Updated ",ce(a,{addSuffix:!0})]})]})},Tt=()=>{const{fetchProjects:t}=Ge(),{toast:h}=Le(),[a,c]=w.useState(!1),[r,l]=w.useState(0),n=w.useCallback((o,i)=>{o==="projects"&&i==="INSERT"?(t(),h({title:"New Project Created",description:"Dashboard has been updated automatically.",duration:2e3})):o==="mmp_files"?i==="INSERT"?h({title:"New MMP Uploaded",description:"Click Refresh to see the latest changes.",duration:3e3}):i==="UPDATE"&&h({title:"MMP Updated",description:"Click Refresh to see the latest changes.",duration:3e3}):o==="mmp_site_entries"&&(i==="INSERT"?h({title:"New Site Entry Created",description:"Click Refresh to see the latest changes.",duration:3e3}):i==="UPDATE"&&h({title:"Site Entry Updated",description:"Click Refresh to see the latest changes.",duration:3e3}))},[t,h]);return w.useEffect(()=>{const o=ge.channel("dashboard_mmp_changes").on("postgres_changes",{event:"*",schema:"public",table:"mmp_files"},u=>n("mmp_files",u.eventType)).subscribe(u=>{c(u==="SUBSCRIBED")}),i=ge.channel("dashboard_site_changes").on("postgres_changes",{event:"*",schema:"public",table:"mmp_site_entries"},u=>n("mmp_site_entries",u.eventType)).subscribe(u=>{c(u==="SUBSCRIBED")}),d=ge.channel("dashboard_project_changes").on("postgres_changes",{event:"*",schema:"public",table:"projects"},u=>n("projects",u.eventType)).subscribe(u=>{c(u==="SUBSCRIBED")});return l(3),()=>{ge.removeChannel(o),ge.removeChannel(i),ge.removeChannel(d)}},[n]),{isConnected:a,channels:r}},Lt=({onQuickAction:t})=>{const{isConnected:h}=Tt();return e.jsx("div",{className:"bg-card border-b border-border/50",children:e.jsx("div",{className:"px-4 py-2",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsxs(V,{variant:"ghost",size:"sm",onClick:()=>window.location.reload(),"data-testid":"button-refresh",className:"gap-2",children:[e.jsx(As,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden md:inline",children:"Refresh"})]}),e.jsx(Mt,{isConnected:h})]})})})},Vt=[{id:"operations",label:"Operations",icon:Se,description:"Field operations",color:"text-blue-500",roles:["admin","fom","supervisor","coordinator"]},{id:"team",label:"Team",icon:he,description:"Team coordination",color:"text-purple-500",roles:["admin","fom","supervisor","coordinator"]},{id:"planning",label:"Planning",icon:Z,description:"Strategic planning",color:"text-green-500",roles:["admin","fom","ict"]},{id:"compliance",label:"Compliance",icon:_e,description:"Risk & compliance",color:"text-orange-500",roles:["admin","ict","reviewer"]},{id:"performance",label:"Performance",icon:He,description:"Analytics & goals",color:"text-indigo-500",roles:["admin","fom","financialadmin"]}],Pt=({activeZone:t,onZoneChange:h,children:a})=>{const{roles:c}=ne(),r=n=>c!=null&&c.some(o=>o.toLowerCase()==="admin")?!0:c==null?void 0:c.some(o=>n.includes(o.toLowerCase())),l=Vt.filter(n=>r(n.roles));return e.jsxs("div",{className:"flex flex-col min-h-screen",children:[e.jsx("div",{className:"sticky top-0 z-50 border-b border-border/50",children:e.jsx(Lt,{})}),e.jsx("nav",{className:"sticky top-[49px] z-40 bg-gradient-to-r from-card via-background to-card border-b border-border/50 backdrop-blur-sm shadow-sm",children:e.jsxs("div",{className:"flex items-center gap-1 px-3 py-2 overflow-x-auto scrollbar-hide",children:[e.jsx("div",{className:"flex-shrink-0 mr-2 hidden md:block",children:e.jsx("span",{className:"text-[10px] font-bold text-muted-foreground uppercase tracking-wider",children:"Zones:"})}),l.map(n=>{const o=n.icon,i=t===n.id;return e.jsxs("button",{onClick:()=>h(n.id),"data-testid":`button-zone-${n.id}`,className:oe("group relative flex items-center gap-2 px-3 py-1.5 rounded-md transition-all duration-200 flex-shrink-0","border border-transparent hover:border-border/50",i?"bg-gradient-to-r from-primary/20 to-primary/10 border-primary/30 shadow-sm":"hover:bg-muted/50 hover-elevate"),children:[i&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent via-primary to-transparent rounded-full"}),e.jsx("div",{className:oe("flex items-center justify-center w-7 h-7 rounded-md transition-all",i?"bg-background shadow-sm ring-1 ring-primary/20":"bg-muted/50 group-hover:bg-background"),children:e.jsx(o,{className:oe("h-3.5 w-3.5 transition-colors",i?n.color:"text-muted-foreground group-hover:text-foreground")})}),e.jsx("div",{className:"hidden sm:flex flex-col items-start",children:e.jsx("span",{className:oe("text-xs font-semibold whitespace-nowrap",i?"text-foreground":"text-muted-foreground group-hover:text-foreground"),children:n.label})}),i&&e.jsx("div",{className:"flex-shrink-0 hidden sm:block",children:e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-primary animate-pulse"})})]},n.id)})]})}),e.jsx("main",{className:"flex-1 p-4 lg:p-6",children:a})]})},$t=({currentUserId:t,isAdmin:h=!1})=>{const{siteVisits:a,loading:c}=ie(),{pendingVisits:r,assignedVisits:l,completedVisits:n,totalCount:o,completionRate:i}=w.useMemo(()=>{const d=h?a:a.filter(j=>j.assignedTo===t),u=d.filter(j=>["pending","permitVerified"].includes(j.status)),s=d.filter(j=>["assigned","inProgress"].includes(j.status)),x=d.filter(j=>j.status==="completed"),m=d.length,b=m>0?Math.round(x.length/m*100):0;return{pendingVisits:u,assignedVisits:s,completedVisits:x,totalCount:m,completionRate:b}},[a,h,t]);return c?e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(Ms,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("span",{className:"ml-2 text-muted-foreground",children:"Loading site visits..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(L,{children:[e.jsxs(U,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(B,{className:"text-sm font-medium",children:"Pending Visits"}),e.jsx(q,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(R,{children:[e.jsx("div",{className:"text-2xl font-bold",children:r.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Visits awaiting assignment"})]})]}),e.jsxs(L,{children:[e.jsxs(U,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(B,{className:"text-sm font-medium",children:"Assigned Visits"}),e.jsx(Ts,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(R,{children:[e.jsx("div",{className:"text-2xl font-bold",children:l.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Visits currently assigned"})]})]}),e.jsxs(L,{children:[e.jsxs(U,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(B,{className:"text-sm font-medium",children:"Completed Visits"}),e.jsx(Ls,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(R,{children:[e.jsx("div",{className:"text-2xl font-bold",children:n.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Successfully completed visits"})]})]}),e.jsxs(L,{children:[e.jsxs(U,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(B,{className:"text-sm font-medium",children:"Completion Rate"}),e.jsx(hs,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(R,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[i,"%"]}),e.jsx(me,{value:i,className:"h-2"})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Pending Visits"}),r.length>0?e.jsxs(L,{children:[e.jsx(R,{className:"p-0",children:e.jsxs(Ne,{children:[e.jsx(be,{children:e.jsxs(G,{children:[e.jsx(A,{children:"MMP Name"}),e.jsx(A,{children:"Site Name"}),e.jsx(A,{children:"Location"}),e.jsx(A,{children:"Due Date"}),e.jsx(A,{children:"Status"}),e.jsx(A,{className:"text-right",children:"Action"})]})}),e.jsx(we,{children:r.map(d=>{var u;return e.jsxs(G,{children:[e.jsx(M,{children:e.jsx("div",{className:"text-xs font-medium text-primary",children:((u=d.mmpDetails)==null?void 0:u.mmpId)||d.projectName||"N/A"})}),e.jsxs(M,{className:"font-medium",children:[e.jsx("div",{className:"font-medium",children:d.siteName}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Hub: ",d.hub||"N/A"," • Type: ",d.visitTypeRaw||d.visitType||"N/A"]}),d.cpName&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["CP: ",d.cpName]})]}),e.jsxs(M,{children:[d.locality,", ",d.state]}),e.jsx(M,{children:H(new Date(d.dueDate),"MMM d, yyyy")}),e.jsx(M,{children:e.jsx(S,{variant:"secondary",children:d.status==="pending"?"Pending":"Permit Verified"})}),e.jsx(M,{className:"text-right",children:e.jsx(V,{asChild:!0,size:"sm",variant:"outline",children:e.jsx(de,{to:`/site-visits/${d.id}`,children:"View"})})})]},d.id)})})]})}),e.jsx(Fe,{className:"flex justify-end p-4",children:e.jsx(V,{asChild:!0,variant:"ghost",size:"sm",children:e.jsx(de,{to:"/site-visits?status=pending",children:"View All"})})})]}):e.jsx(L,{children:e.jsx(R,{className:"py-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No pending visits found"})})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Assigned Visits"}),l.length>0?e.jsxs(L,{children:[e.jsx(R,{className:"p-0",children:e.jsxs(Ne,{children:[e.jsx(be,{children:e.jsxs(G,{children:[e.jsx(A,{children:"MMP Name"}),e.jsx(A,{children:"Site Name"}),e.jsx(A,{children:"Location"}),e.jsx(A,{children:"Due Date"}),e.jsx(A,{children:"Status"}),e.jsx(A,{className:"text-right",children:"Action"})]})}),e.jsx(we,{children:l.map(d=>{var u;return e.jsxs(G,{children:[e.jsx(M,{children:e.jsx("div",{className:"text-xs font-medium text-primary",children:((u=d.mmpDetails)==null?void 0:u.mmpId)||d.projectName||"N/A"})}),e.jsxs(M,{className:"font-medium",children:[e.jsx("div",{className:"font-medium",children:d.siteName}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Hub: ",d.hub||"N/A"," • Type: ",d.visitTypeRaw||d.visitType||"N/A"]}),d.cpName&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["CP: ",d.cpName]})]}),e.jsxs(M,{children:[d.locality,", ",d.state]}),e.jsx(M,{children:H(new Date(d.dueDate),"MMM d, yyyy")}),e.jsx(M,{children:e.jsx(S,{variant:d.status==="inProgress"?"default":"outline",children:d.status==="inProgress"?"In Progress":"Assigned"})}),e.jsx(M,{className:"text-right",children:e.jsx(V,{asChild:!0,size:"sm",children:e.jsx(de,{to:`/site-visits/${d.id}`,children:d.status==="assigned"?"Start Visit":"Continue Visit"})})})]},d.id)})})]})}),e.jsx(Fe,{className:"flex justify-end p-4",children:e.jsx(V,{asChild:!0,variant:"ghost",size:"sm",children:e.jsx(de,{to:"/site-visits?status=assigned",children:"View All"})})})]}):e.jsx(L,{children:e.jsx(R,{className:"py-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No assigned visits found"})})})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Completed Visits"}),n.length>0?e.jsxs(L,{children:[e.jsx(R,{className:"p-0",children:e.jsxs(Ne,{children:[e.jsx(be,{children:e.jsxs(G,{children:[e.jsx(A,{children:"MMP Name"}),e.jsx(A,{children:"Site Name"}),e.jsx(A,{children:"Location"}),e.jsx(A,{children:"Completed Date"}),e.jsx(A,{children:"Rating"}),e.jsx(A,{className:"text-right",children:"Action"})]})}),e.jsx(we,{children:n.map(d=>{var u;return e.jsxs(G,{children:[e.jsx(M,{children:e.jsx("div",{className:"text-xs font-medium text-primary",children:((u=d.mmpDetails)==null?void 0:u.mmpId)||d.projectName||"N/A"})}),e.jsxs(M,{className:"font-medium",children:[e.jsx("div",{className:"font-medium",children:d.siteName}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Hub: ",d.hub||"N/A"," • Type: ",d.visitTypeRaw||d.visitType||"N/A"]}),d.cpName&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["CP: ",d.cpName]})]}),e.jsxs(M,{children:[d.locality,", ",d.state]}),e.jsx(M,{children:d.completedAt?H(new Date(d.completedAt),"MMM d, yyyy"):"N/A"}),e.jsx(M,{children:d.rating?`${d.rating}/5`:"Not rated"}),e.jsx(M,{className:"text-right",children:e.jsx(V,{asChild:!0,size:"sm",variant:"outline",children:e.jsx(de,{to:`/site-visits/${d.id}`,children:h&&!d.rating?"Rate Visit":"View Details"})})})]},d.id)})})]})}),e.jsx(Fe,{className:"flex justify-end p-4",children:e.jsx(V,{asChild:!0,variant:"ghost",size:"sm",children:e.jsx(de,{to:"/site-visits?status=completed",children:"View All"})})})]}):e.jsx(L,{children:e.jsx(R,{className:"py-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No completed visits found"})})})]})]})]})},Rt=({siteVisits:t})=>{const h=a=>{switch(a.toLowerCase()){case"high":return"bg-red-100 text-red-800 border-red-200";case"medium":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"low":return"bg-green-100 text-green-800 border-green-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}};return e.jsxs(L,{className:"border-t-4 border-t-purple-500 overflow-hidden",children:[e.jsx(U,{className:"bg-gradient-to-r from-purple-50 to-transparent",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5 text-purple-500"}),e.jsx(B,{children:"Upcoming Site Visits"})]}),t.length>0&&e.jsxs(S,{variant:"outline",className:"bg-white",children:[t.length," visits"]})]})}),e.jsx(R,{children:t.length>0?e.jsx("div",{className:"space-y-3",children:t.map(a=>e.jsx("div",{className:"p-3 rounded-lg border bg-white hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-sm truncate",children:a.siteName}),e.jsxs("div",{className:"flex items-center gap-2 mt-1 text-sm text-gray-500",children:[e.jsx(z,{className:"h-4 w-4"}),e.jsxs("span",{className:"truncate",children:[a.locality,", ",a.state]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsxs(S,{variant:"outline",className:h(a.priority),children:[a.priority," priority"]}),e.jsx(S,{variant:"outline",className:"bg-purple-50",children:H(new Date(a.dueDate),"MMM dd")})]})]}),e.jsx(V,{asChild:!0,size:"sm",variant:"outline",className:"shrink-0",children:e.jsxs(de,{to:`/site-visits/${a.id}`,children:[e.jsx(Vs,{className:"h-4 w-4 mr-1"}),"View"]})})]})},a.id))}):e.jsxs("div",{className:"text-center py-6 text-gray-500",children:[e.jsx(Z,{className:"h-12 w-12 mx-auto mb-3 text-gray-400"}),e.jsx("p",{children:"No upcoming site visits"})]})})]})},It=()=>{const{siteVisits:t}=ie(),h=(t||[]).reduce((r,l)=>{var n;return r+(((n=l.fees)==null?void 0:n.total)||0)},0),a=(t||[]).filter(r=>r.status==="completed").reduce((r,l)=>{var n;return r+(((n=l.fees)==null?void 0:n.total)||0)},0),c=(t||[]).filter(r=>["assigned","inProgress"].includes(r.status)).reduce((r,l)=>{var n;return r+(((n=l.fees)==null?void 0:n.total)||0)},0);return e.jsxs(L,{children:[e.jsx(U,{children:e.jsx(B,{children:"Site Visit Costs"})}),e.jsx(R,{children:e.jsxs("div",{className:"flex gap-8",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-bold text-lg",children:["SDG ",h.toLocaleString()]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Total Cost"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-bold text-green-700",children:["SDG ",a.toLocaleString()]}),e.jsx("div",{className:"text-xs text-green-700",children:"Completed"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-bold text-blue-700",children:["SDG ",c.toLocaleString()]}),e.jsx("div",{className:"text-xs text-blue-700",children:"Ongoing"})]})]})})]})},vs=()=>{const{siteVisits:t}=ie(),[h,a]=fe.useState(new Date),c=pe(),r=fe.useMemo(()=>t.filter(n=>Oe(new Date(n.dueDate),h)),[t,h]),l=n=>t.some(o=>Oe(new Date(o.dueDate),n));return e.jsxs(L,{className:"transition-all duration-300 hover:shadow-lg border-t-4 border-t-indigo-500",children:[e.jsxs(U,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ps,{className:"h-5 w-5 text-indigo-500"}),e.jsx(B,{className:"text-lg font-semibold",children:"Schedule"})]}),e.jsxs(S,{variant:"outline",className:"bg-background",children:[r.length," Events"]})]}),e.jsx(R,{children:e.jsxs(xe.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:"flex flex-col gap-4",children:[e.jsx(pt,{mode:"single",selected:h,onSelect:n=>{const o=n||new Date;t.some(d=>Oe(new Date(d.dueDate),o))?a(o):c("/calendar")},className:"rounded-md border shadow-sm",modifiers:{withVisits:n=>l(n)},modifiersStyles:{withVisits:{backgroundColor:"rgba(99, 102, 241, 0.1)",fontWeight:"bold",color:"#4F46E5"}}}),r.length>0&&e.jsxs(xe.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"space-y-3",children:[e.jsxs("h4",{className:"text-sm font-medium flex items-center gap-2 text-muted-foreground",children:[e.jsx(z,{className:"h-4 w-4"}),"Scheduled for ",H(h,"MMMM d, yyyy")]}),e.jsx("div",{className:"space-y-2",children:r.map((n,o)=>e.jsxs(xe.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:.1*o},className:"flex items-center justify-between p-3 bg-accent/50 rounded-lg border border-border/50 hover:bg-accent/70 transition-colors",children:[e.jsx("span",{className:"font-medium",children:n.siteName}),e.jsx(S,{variant:n.status==="completed"?"secondary":"outline",className:"capitalize",children:n.status})]},n.id))})]})]})})]})},ds=()=>{const{siteVisits:t}=ie(),[h,a]=w.useState("overview"),[c,r]=w.useState(null),[l,n]=w.useState({hub:"",state:"",locality:"",coordinator:"",enumerator:"",status:""}),o=t.filter(p=>{const N=new Date(p.dueDate),T=new Date,D=Be(T,14);return as(N,T)&&as(D,N)}).sort((p,N)=>new Date(p.dueDate).getTime()-new Date(N.dueDate).getTime()).slice(0,5),i=t.length,d=t.filter(p=>p.status==="completed").length,u=t.filter(p=>p.status==="pending"||p.status==="permitVerified").length,s=t.filter(p=>p.status==="assigned"||p.status==="inProgress").length,x=t.filter(p=>new Date(p.dueDate)<new Date&&p.status!=="completed").length,m=i>0?Math.round(d/i*100):0,b=p=>{switch(p){case"total":return t;case"completed":return t.filter(N=>N.status==="completed");case"assigned":return t.filter(N=>N.status==="assigned"||N.status==="inProgress");case"pending":return t.filter(N=>N.status==="pending"||N.status==="permitVerified");case"overdue":return t.filter(N=>new Date(N.dueDate)<new Date&&N.status!=="completed");case"performance":return t.filter(N=>N.status==="completed");default:return[]}},j=p=>{switch(p){case"total":return"All Operations";case"completed":return"Completed Visits";case"assigned":return"Active Operations";case"pending":return"Pending Queue";case"overdue":return"Overdue Alerts";case"performance":return"Performance Metrics";default:return""}},g=b(c),v=w.useMemo(()=>[...new Set(g.map(N=>N.hub).filter(Boolean))].map(N=>({value:N,count:g.filter(T=>T.hub===N).length})).sort((N,T)=>N.value.localeCompare(T.value)),[g]),f=w.useMemo(()=>[...new Set(g.map(N=>N.state).filter(Boolean))].map(N=>({value:N,count:g.filter(T=>T.state===N).length})).sort((N,T)=>N.value.localeCompare(T.value)),[g]),y=w.useMemo(()=>[...new Set(g.map(N=>N.locality).filter(Boolean))].map(N=>({value:N,count:g.filter(T=>T.locality===N).length})).sort((N,T)=>N.value.localeCompare(T.value)),[g]),C=w.useMemo(()=>[...new Set(g.map(N=>{var T;return(T=N.team)==null?void 0:T.coordinator}).filter(Boolean))].map(N=>({value:N,count:g.filter(T=>{var D;return((D=T.team)==null?void 0:D.coordinator)===N}).length})).sort((N,T)=>N.value.localeCompare(T.value)),[g]),k=w.useMemo(()=>[...new Set(g.map(N=>N.assignedTo).filter(Boolean))].map(N=>({value:N,count:g.filter(T=>T.assignedTo===N).length})).sort((N,T)=>N.value.localeCompare(T.value)),[g]),I=w.useMemo(()=>[...new Set(g.map(N=>N.status).filter(Boolean))].map(N=>({value:N,count:g.filter(T=>T.status===N).length})).sort((N,T)=>N.value.localeCompare(T.value)),[g]),P=w.useMemo(()=>g.filter(p=>{var N;return!(l.hub&&p.hub!==l.hub||l.state&&p.state!==l.state||l.locality&&p.locality!==l.locality||l.coordinator&&((N=p.team)==null?void 0:N.coordinator)!==l.coordinator||l.enumerator&&p.assignedTo!==l.enumerator||l.status&&p.status!==l.status)}),[g,l]),W=p=>{r(p),n({hub:"",state:"",locality:"",coordinator:"",enumerator:"",status:""})},F=()=>{n({hub:"",state:"",locality:"",coordinator:"",enumerator:"",status:""})},$=Object.values(l).filter(p=>p!=="").length;return e.jsxs("div",{className:"p-4 md:p-8 space-y-6",children:[e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-lg bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center",children:e.jsx(Se,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Operations Center"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Field operations command and control"})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsx(je,{title:"Total Operations",value:i,subtitle:"All site visits",icon:J,color:"blue",onClick:()=>W("total"),"data-testid":"card-metric-total"}),e.jsx(je,{title:"Completed Visits",value:d,subtitle:`${m}% completion rate`,icon:ve,color:"green",onClick:()=>W("completed"),"data-testid":"card-metric-completed"}),e.jsx(je,{title:"Active Operations",value:s,subtitle:"In progress now",icon:he,color:"cyan",onClick:()=>W("assigned"),"data-testid":"card-metric-assigned"}),e.jsx(je,{title:"Pending Queue",value:u,subtitle:"Awaiting assignment",icon:q,color:"orange",onClick:()=>W("pending"),"data-testid":"card-metric-pending"}),e.jsx(je,{title:"Overdue Alerts",value:x,subtitle:x>0?"Requires attention":"All on schedule",icon:ue,color:"orange",onClick:()=>W("overdue"),"data-testid":"card-metric-overdue"}),e.jsx(je,{title:"Performance Score",value:`${m}%`,subtitle:m>=75?"Excellent efficiency":"Room for improvement",icon:ye,color:"purple",onClick:()=>W("performance"),"data-testid":"card-metric-performance"})]}),e.jsx(L,{className:"border-border/50 bg-gradient-to-r from-muted/30 via-background to-muted/30",children:e.jsx(R,{className:"p-2",children:e.jsxs(te,{value:h,onValueChange:a,className:"w-full",children:[e.jsxs(ae,{className:"grid w-full grid-cols-4 h-auto p-0.5 bg-transparent border border-border/30",children:[e.jsxs(O,{value:"overview",className:"gap-1 px-2 py-1.5 data-[state=active]:bg-primary/10 data-[state=active]:border-primary/20 data-[state=active]:shadow-sm border border-transparent","data-testid":"tab-overview",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-primary/10 flex items-center justify-center",children:e.jsx(Se,{className:"h-3 w-3 text-primary"})}),e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-wide",children:"Overview"})]}),e.jsxs(O,{value:"upcoming",className:"gap-1 px-2 py-1.5 data-[state=active]:bg-blue-500/10 data-[state=active]:border-blue-500/20 data-[state=active]:shadow-sm border border-transparent","data-testid":"tab-upcoming",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-blue-500/10 flex items-center justify-center",children:e.jsx(Z,{className:"h-3 w-3 text-blue-600 dark:text-blue-400"})}),e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-wide",children:"Upcoming"})]}),e.jsxs(O,{value:"calendar",className:"gap-1 px-2 py-1.5 data-[state=active]:bg-green-500/10 data-[state=active]:border-green-500/20 data-[state=active]:shadow-sm border border-transparent","data-testid":"tab-calendar",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-green-500/10 flex items-center justify-center",children:e.jsx(z,{className:"h-3 w-3 text-green-600 dark:text-green-400"})}),e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-wide",children:"Calendar"})]}),e.jsxs(O,{value:"costs",className:"gap-1 px-2 py-1.5 data-[state=active]:bg-orange-500/10 data-[state=active]:border-orange-500/20 data-[state=active]:shadow-sm border border-transparent","data-testid":"tab-costs",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-orange-500/10 flex items-center justify-center",children:e.jsx(hs,{className:"h-3 w-3 text-orange-600 dark:text-orange-400"})}),e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-wide",children:"Costs"})]})]}),e.jsx(_,{value:"overview",className:"mt-3 space-y-3",children:e.jsx($t,{})}),e.jsx(_,{value:"upcoming",className:"mt-3",children:e.jsx(Rt,{siteVisits:o})}),e.jsx(_,{value:"calendar",className:"mt-3",children:e.jsx(vs,{})}),e.jsx(_,{value:"costs",className:"mt-3",children:e.jsx(It,{})})]})})}),e.jsx(Ve,{open:c!==null,onOpenChange:p=>!p&&r(null),children:e.jsxs(Pe,{className:"max-w-4xl max-h-[80vh] overflow-hidden flex flex-col",children:[e.jsxs($e,{children:[e.jsxs(Re,{className:"flex items-center gap-2",children:[c==="total"&&e.jsx(J,{className:"h-5 w-5 text-primary"}),c==="completed"&&e.jsx(ve,{className:"h-5 w-5 text-green-600 dark:text-green-400"}),c==="assigned"&&e.jsx(he,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"}),c==="pending"&&e.jsx(q,{className:"h-5 w-5 text-orange-600 dark:text-orange-400"}),c==="overdue"&&e.jsx(ue,{className:"h-5 w-5 text-red-600 dark:text-red-400"}),c==="performance"&&e.jsx(ye,{className:"h-5 w-5 text-purple-600 dark:text-purple-400"}),e.jsx("span",{children:j(c)}),e.jsxs(S,{variant:"outline",className:"ml-auto",children:[P.length," ",P.length===1?"visit":"visits"]})]}),e.jsxs(Ie,{children:["Detailed breakdown of ",j(c).toLowerCase()]})]}),e.jsxs("div",{className:"space-y-2 border-b pb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(us,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Filters"}),$>0&&e.jsxs(S,{variant:"secondary",className:"h-5 text-[10px]",children:[$," active"]}),$>0&&e.jsxs(V,{variant:"ghost",size:"sm",onClick:F,className:"ml-auto h-7 px-2 text-xs","data-testid":"button-clear-filters",children:[e.jsx(xs,{className:"h-3 w-3 mr-1"}),"Clear all"]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2",children:[e.jsxs(K,{value:l.hub,onValueChange:p=>n(N=>({...N,hub:p==="all"?"":p})),children:[e.jsx(X,{className:"h-8 text-xs","data-testid":"select-filter-hub",children:e.jsx(ee,{placeholder:"Hub"})}),e.jsxs(se,{children:[e.jsxs(E,{value:"all",children:["All Hubs (",g.length,")"]}),v.map(p=>e.jsxs(E,{value:p.value,children:[p.value," (",p.count,")"]},p.value))]})]}),e.jsxs(K,{value:l.state,onValueChange:p=>n(N=>({...N,state:p==="all"?"":p})),children:[e.jsx(X,{className:"h-8 text-xs","data-testid":"select-filter-state",children:e.jsx(ee,{placeholder:"State"})}),e.jsxs(se,{children:[e.jsxs(E,{value:"all",children:["All States (",g.length,")"]}),f.map(p=>e.jsxs(E,{value:p.value,children:[p.value," (",p.count,")"]},p.value))]})]}),e.jsxs(K,{value:l.locality,onValueChange:p=>n(N=>({...N,locality:p==="all"?"":p})),children:[e.jsx(X,{className:"h-8 text-xs","data-testid":"select-filter-locality",children:e.jsx(ee,{placeholder:"Locality"})}),e.jsxs(se,{children:[e.jsxs(E,{value:"all",children:["All Localities (",g.length,")"]}),y.map(p=>e.jsxs(E,{value:p.value,children:[p.value," (",p.count,")"]},p.value))]})]}),e.jsxs(K,{value:l.coordinator,onValueChange:p=>n(N=>({...N,coordinator:p==="all"?"":p})),children:[e.jsx(X,{className:"h-8 text-xs","data-testid":"select-filter-coordinator",children:e.jsx(ee,{placeholder:"Coordinator"})}),e.jsxs(se,{children:[e.jsxs(E,{value:"all",children:["All Coordinators (",g.length,")"]}),C.map(p=>e.jsxs(E,{value:p.value,children:[p.value," (",p.count,")"]},p.value))]})]}),e.jsxs(K,{value:l.enumerator,onValueChange:p=>n(N=>({...N,enumerator:p==="all"?"":p})),children:[e.jsx(X,{className:"h-8 text-xs","data-testid":"select-filter-enumerator",children:e.jsx(ee,{placeholder:"Enumerator"})}),e.jsxs(se,{children:[e.jsxs(E,{value:"all",children:["All Enumerators (",g.length,")"]}),k.map(p=>e.jsxs(E,{value:p.value,children:[p.value," (",p.count,")"]},p.value))]})]}),e.jsxs(K,{value:l.status,onValueChange:p=>n(N=>({...N,status:p==="all"?"":p})),children:[e.jsx(X,{className:"h-8 text-xs","data-testid":"select-filter-status",children:e.jsx(ee,{placeholder:"Status"})}),e.jsxs(se,{children:[e.jsxs(E,{value:"all",children:["All Statuses (",g.length,")"]}),I.map(p=>e.jsxs(E,{value:p.value,children:[p.value," (",p.count,")"]},p.value))]})]})]})]}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-md",children:P.length>0?e.jsxs(Ne,{children:[e.jsx(be,{className:"sticky top-0 bg-background z-10",children:e.jsxs(G,{children:[e.jsx(A,{children:"MMP Name"}),e.jsx(A,{className:"w-[200px]",children:"Site Name"}),e.jsx(A,{children:"Location"}),e.jsx(A,{children:"Due Date"}),e.jsx(A,{children:"Status"}),e.jsx(A,{children:"Assigned To"}),e.jsx(A,{className:"text-right",children:"Action"})]})}),e.jsx(we,{children:P.map(p=>{var D,Q;const N=new Date(p.dueDate),T=N<new Date&&p.status!=="completed";return e.jsxs(G,{className:"hover:bg-muted/50",children:[e.jsx(M,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs font-medium text-primary",children:((D=p.mmpDetails)==null?void 0:D.mmpId)||p.projectName||"N/A"}),((Q=p.mmpDetails)==null?void 0:Q.projectName)&&p.mmpDetails.mmpId&&e.jsx("span",{className:"text-[10px] text-muted-foreground truncate max-w-[120px]",children:p.mmpDetails.projectName})]})}),e.jsx(M,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm",children:p.siteName}),p.siteCode&&e.jsx("span",{className:"text-xs text-muted-foreground",children:p.siteCode})]})}),e.jsx(M,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("span",{className:"text-xs",children:[p.locality,", ",p.state]})]})}),e.jsx(M,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:`text-xs ${T?"text-red-600 dark:text-red-400 font-semibold":""}`,children:H(N,"MMM dd, yyyy")}),T&&e.jsx("span",{className:"text-[10px] text-red-600 dark:text-red-400",children:"Overdue"})]})}),e.jsx(M,{children:e.jsx(S,{variant:p.status==="completed"?"default":p.status==="assigned"||p.status==="inProgress"?"secondary":"outline",className:"text-[10px]",children:p.status})}),e.jsx(M,{children:e.jsx("span",{className:"text-xs text-muted-foreground",children:p.assignedTo||"Unassigned"})}),e.jsx(M,{className:"text-right",children:e.jsx(V,{size:"sm",variant:"ghost",className:"h-7 px-2",onClick:()=>window.location.href=`/site-visits/${p.id}`,"data-testid":`button-view-visit-${p.id}`,children:e.jsx($s,{className:"h-3 w-3"})})})]},p.id)})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4",children:e.jsx(J,{className:"h-8 w-8 text-muted-foreground"})}),e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"No visits found"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"There are no site visits in this category"})]})})]})})]})},Ft=()=>{const{chats:t,setActiveChat:h}=Qe(),a=pe(),c=[...t].sort((n,o)=>{var i,d;return new Date(((i=o.lastMessage)==null?void 0:i.timestamp)||o.createdAt).getTime()-new Date(((d=n.lastMessage)==null?void 0:d.timestamp)||n.createdAt).getTime()}).slice(0,3),r=t.reduce((n,o)=>n+(o.unreadCount||0),0),l=n=>{h(n),a("/chat")};return e.jsxs(L,{children:[e.jsx(U,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(B,{className:"text-lg font-semibold",children:"Messages"}),r>0&&e.jsxs("span",{className:"bg-primary text-white text-xs rounded-full px-2 py-0.5",children:[r," new"]})]})}),e.jsx(R,{className:"pt-0",children:c.length>0?e.jsxs("div",{className:"space-y-3",children:[c.map(n=>{var o,i;return e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-md hover:bg-muted cursor-pointer",onClick:()=>l(n),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-9 h-9 rounded-full flex items-center justify-center ${n.type==="private"?"bg-primary/20":"bg-secondary/20"}`,children:e.jsx(Y,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-sm",children:[n.name,n.unreadCount>0&&e.jsx("span",{className:"ml-2 bg-primary text-white text-xs rounded-full px-1.5 py-0.5",children:n.unreadCount})]}),e.jsx("p",{className:"text-xs text-muted-foreground truncate max-w-[180px]",children:((o=n.lastMessage)==null?void 0:o.content)||`${n.participants.length} participants`})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:ce(new Date(((i=n.lastMessage)==null?void 0:i.timestamp)||n.createdAt),{addSuffix:!0})})]},n.id)}),e.jsxs(V,{variant:"outline",size:"sm",className:"w-full mt-2",onClick:()=>a("/chat"),children:["View All Messages",e.jsx(ps,{className:"ml-2 h-4 w-4"})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-6",children:[e.jsx(Y,{className:"h-8 w-8 text-muted-foreground/50"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"No recent messages"}),e.jsx(V,{variant:"outline",size:"sm",className:"mt-4",onClick:()=>a("/chat"),children:"Start a conversation"})]})})]})},Ot=({isEnabled:t,onToggle:h,label:a,className:c=""})=>e.jsxs("div",{className:`fixed bottom-20 right-4 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 shadow-lg rounded-full p-3 flex items-center gap-2 border ${c}`,children:[e.jsx(gt,{id:"floating-toggle",checked:t,onCheckedChange:h,className:"data-[state=checked]:bg-primary"}),e.jsx(jt,{htmlFor:"floating-toggle",className:"text-sm font-medium",children:a})]}),Et=()=>{const{currentUser:t,updateUserLocation:h,updateUserAvailability:a,toggleLocationSharing:c}=Ze(),[r,l]=w.useState((t==null?void 0:t.availability)==="online"),[n,o]=w.useState(!1),{toast:i}=Le();w.useEffect(()=>{t&&l(t.availability==="online")},[t]);const d=async()=>{o(!0);const u=r?"offline":"online";try{if(t){const{data:s,error:x}=await Me.from("profiles").update({availability:u}).eq("id",t.id);if(x)throw x;await a(u)&&(l(!r),i({title:u==="online"?"You are now online":"You are now offline",description:u==="online"?"You will now receive site visit assignments":"You will not receive any new assignments",variant:u==="online"?"success":"default"}))}}catch{i({title:"Failed to update availability",description:"There was a problem updating your status. Please try again.",variant:"destructive"})}finally{o(!1)}};return!t||!["dataCollector","datacollector","coordinator"].includes(t.role.toLowerCase())?null:e.jsx(Ot,{isEnabled:r,onToggle:d,label:r?"Online":"Offline",className:`${n?"opacity-50 cursor-not-allowed":""} ${r?"border-green-500":"border-gray-200"}`})},zt=()=>{const{currentUser:t}=ne(),[h,a]=w.useState(!1);return w.useEffect(()=>{(async()=>{if(t)try{const{data:l,error:n}=await Me.from("profiles").select("location_sharing").eq("id",t.id).single();if(n)throw n;a(l.location_sharing||!1)}catch{}})()},[t]),t&&["dataCollector","datacollector","coordinator"].includes((t.role||"").toLowerCase())?e.jsx("div",{className:"col-span-12 md:col-span-4 lg:col-span-3",children:e.jsxs(L,{className:"h-full hover-scale",children:[e.jsxs(U,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(B,{className:"text-sm font-medium",children:"Location Sharing"}),e.jsx(z,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(R,{children:[e.jsx(Et,{}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:h?"Your location is being shared with supervisors":"Enable location sharing to receive nearby assignments"})]})]})}):null},Ut=()=>{const[t,h]=w.useState("chat");return e.jsxs(L,{className:"border-t-4 border-t-violet-500 hover:shadow-md transition-all duration-300",children:[e.jsxs(U,{className:"bg-gradient-to-r from-violet-50 to-transparent flex flex-row justify-between items-center",children:[e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-5 w-5 text-violet-500"}),"Team Communication"]}),e.jsx(te,{defaultValue:"chat",className:"w-auto",onValueChange:h,children:e.jsxs(ae,{className:"grid grid-cols-2 h-7",children:[e.jsx(O,{value:"chat",className:"text-xs px-2",children:"Chat"}),e.jsx(O,{value:"location",className:"text-xs px-2",children:"Location"})]})})]}),e.jsx(R,{className:"p-0 overflow-hidden",children:e.jsxs(xe.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2},className:"p-4",children:[t==="chat"&&e.jsx(Ft,{}),t==="location"&&e.jsx(zt,{})]},t)})]})},le=t=>{var c,r,l,n;if(t.availability==="online"||((c=t.location)==null?void 0:c.isSharing)&&((r=t.location)==null?void 0:r.latitude)&&((l=t.location)==null?void 0:l.longitude))return{type:"online",color:"bg-green-500",badgeVariant:"default",label:"Online"};const a=((n=t.location)==null?void 0:n.lastUpdated)||t.lastActive;if(a)try{const o=bs(a);if(ot(o))return{type:"same-day",color:"bg-orange-500",badgeVariant:"secondary",label:"Active Today"}}catch{}return{type:"offline",color:"bg-gray-400 dark:bg-gray-600",badgeVariant:"outline",label:"Offline"}},Bt=({users:t,siteVisits:h=[]})=>{const a=w.useRef(null),c=w.useRef(null);w.useEffect(()=>{if(!c.current)return;a.current||(a.current=re.map(c.current).setView([15.5527,32.5599],6),re.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors",maxZoom:19}).addTo(a.current));const x=a.current,m=re.latLngBounds([]);let b=!1;return x.eachLayer(j=>{j instanceof re.Marker&&x.removeLayer(j)}),t.forEach(j=>{var g,v,f,y,C;if((g=j.location)!=null&&g.latitude&&((v=j.location)!=null&&v.longitude)){const k=le(j),P={"bg-green-500":"#22c55e","bg-orange-500":"#f97316","bg-gray-400 dark:bg-gray-600":"#9ca3af"}[k.color]||"#9ca3af",W=k.type==="online",F=re.divIcon({className:"custom-marker",html:`
            <div style="position: relative;">
              <svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 0C7.163 0 0 7.163 0 16c0 12 16 24 16 24s16-12 16-24c0-8.837-7.163-16-16-16z" 
                  fill="${P}" 
                  stroke="#fff" 
                  stroke-width="2"/>
                <circle cx="16" cy="16" r="6" fill="#fff"/>
              </svg>
              ${W?'<div style="position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; background: #10b981; border: 2px solid #fff; border-radius: 50%;"></div>':""}
            </div>
          `,iconSize:[32,40],iconAnchor:[16,40],popupAnchor:[0,-40]}),$=re.marker([j.location.latitude,j.location.longitude],{icon:F}).addTo(x),p=((f=j.location)==null?void 0:f.lastUpdated)||j.lastActive,N=p?ce(new Date(p),{addSuffix:!0}):"Never",T=k.type==="online"?"🟢":k.type==="same-day"?"🟠":"⚫",D=`
          <div style="min-width: 220px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <div style="width: 8px; height: 8px; background: ${P}; border-radius: 50%;"></div>
              <strong style="font-size: 14px;">${j.name}</strong>
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
              <strong>Role:</strong> ${((y=j.roles)==null?void 0:y[0])||j.role||"N/A"}
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
              <strong>Status:</strong> ${T} ${k.label}
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
              <strong>Last Seen:</strong> ${N}
            </div>
            ${(C=j.location)!=null&&C.address?`
              <div style="font-size: 12px; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                📍 ${j.location.address}
              </div>
            `:""}
            <div style="font-size: 11px; color: #999; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-style: italic;">
              💬 Click card/table row for messaging & assignment options
            </div>
          </div>
        `;$.bindPopup(D),m.extend([j.location.latitude,j.location.longitude]),b=!0}}),h.forEach(j=>{var g,v,f,y;if((g=j.location)!=null&&g.latitude&&((v=j.location)!=null&&v.longitude)){const C=()=>j.status==="completed"?"#10b981":j.status==="inProgress"?"#3b82f6":j.priority==="high"?"#ef4444":j.priority==="medium"?"#f59e0b":"#6366f1",k=re.divIcon({className:"custom-marker",html:`
            <div>
              <svg width="28" height="36" viewBox="0 0 28 36" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 0C6.268 0 0 6.268 0 14c0 10.5 14 22 14 22s14-11.5 14-22c0-7.732-6.268-14-14-14z" 
                  fill="${C()}" 
                  stroke="#fff" 
                  stroke-width="2"/>
                <text x="14" y="17" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">S</text>
              </svg>
            </div>
          `,iconSize:[28,36],iconAnchor:[14,36],popupAnchor:[0,-36]}),I=re.marker([j.location.latitude,j.location.longitude],{icon:k}).addTo(x),P=`
          <div style="min-width: 200px;">
            <strong style="font-size: 14px; display: block; margin-bottom: 8px;">
              🏢 ${j.siteName||"Site Visit"}
            </strong>
            ${j.siteCode?`
              <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
                <strong>Code:</strong> ${j.siteCode}
              </div>
            `:""}
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
              <strong>Status:</strong> <span style="text-transform: capitalize;">${((f=j.status)==null?void 0:f.replace(/([A-Z])/g," $1").trim())||"N/A"}</span>
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
              <strong>Priority:</strong> <span style="text-transform: capitalize;">${j.priority||"Normal"}</span>
            </div>
            ${j.scheduledDate?`
              <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
                <strong>Scheduled:</strong> ${new Date(j.scheduledDate).toLocaleDateString()}
              </div>
            `:""}
            ${j.assignedTo?`
              <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
                <strong>Assigned To:</strong> ${typeof j.assignedTo=="string"?j.assignedTo:"Assigned"}
              </div>
            `:""}
            ${(y=j.location)!=null&&y.address?`
              <div style="font-size: 12px; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                📍 ${j.location.address}
              </div>
            `:""}
          </div>
        `;I.bindPopup(P),m.extend([j.location.latitude,j.location.longitude]),b=!0}}),b&&x.fitBounds(m,{padding:[50,50],maxZoom:15}),()=>{a.current&&(a.current.remove(),a.current=null)}},[t,h]);const r=t.filter(x=>{var m,b;return((m=x.location)==null?void 0:m.latitude)&&((b=x.location)==null?void 0:b.longitude)}),l=h.filter(x=>{var m,b;return((m=x.location)==null?void 0:m.latitude)&&((b=x.location)==null?void 0:b.longitude)}),n=r.filter(x=>le(x).type==="online"),o=r.filter(x=>le(x).type==="same-day"),i=r.filter(x=>le(x).type==="offline"),d=n.length,u=o.length,s=i.length;return e.jsxs("div",{className:"space-y-3",children:[e.jsx(L,{className:"bg-muted/30 border-border/50",children:e.jsx(R,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-3",children:[e.jsxs("div",{className:"flex items-center gap-4 text-xs flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full border-2 border-white"}),e.jsxs("span",{children:["Online (",d,")"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded-full border-2 border-white"}),e.jsxs("span",{children:["Active Today (",u,")"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 bg-gray-400 rounded-full border-2 border-white"}),e.jsxs("span",{children:["Offline (",s,")"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 bg-indigo-500 rounded-full border-2 border-white"}),e.jsxs("span",{children:["Site Visits (",l.length,")"]})]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[r.length," team member",r.length!==1?"s":""," | ",l.length," site visit",l.length!==1?"s":""]})]})})}),e.jsx(L,{className:"overflow-hidden",children:e.jsx(R,{className:"p-0",children:e.jsx("div",{ref:c,style:{height:"500px",width:"100%"},"data-testid":"team-location-map"})})}),r.length===0&&l.length===0&&e.jsx(L,{children:e.jsxs(R,{className:"flex flex-col items-center justify-center py-12 text-muted-foreground",children:[e.jsx(z,{className:"h-12 w-12 mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No team members or site visits with location data"}),e.jsx("p",{className:"text-xs mt-1",children:"Enable location sharing to see team positions on the map"})]})})]})},os=({user:t,isOpen:h,onClose:a,onOpenChange:c,onAssignmentComplete:r})=>{const{siteVisits:l,assignSiteVisit:n}=ie(),[o,i]=w.useState(""),[d,u]=w.useState([]),[s,x]=w.useState(null);w.useEffect(()=>{var y,C;if(!h)return;const v=l.filter(k=>k.status==="pending"||k.status==="permitVerified");if(!((y=t.location)!=null&&y.latitude)||!((C=t.location)!=null&&C.longitude)){u(v);return}const f=v.map(k=>{const I=k.coordinates||k.location;let P=1/0;return I!=null&&I.latitude&&(I!=null&&I.longitude)&&(P=nt(t.location.latitude,t.location.longitude,I.latitude,I.longitude)),{...k,distance:P}});f.sort((k,I)=>k.distance===1/0&&I.distance===1/0?k.priority==="high"?-1:1:k.distance===1/0?1:I.distance===1/0?-1:k.distance-I.distance),u(f)},[l,t,h]);const m=d.filter(v=>{var f,y,C;return v.siteName.toLowerCase().includes(o.toLowerCase())||((f=v.siteCode)==null?void 0:f.toLowerCase().includes(o.toLowerCase()))||((y=v.locality)==null?void 0:y.toLowerCase().includes(o.toLowerCase()))||((C=v.state)==null?void 0:C.toLowerCase().includes(o.toLowerCase()))}),b=async v=>{x(v.id);try{await n(v.id,t.id)&&r()}catch{}finally{x(null)}},j=v=>{switch(v){case"high":return"bg-gradient-to-r from-red-500 to-red-600 text-white";case"medium":return"bg-gradient-to-r from-orange-500 to-orange-600 text-white";default:return"bg-gradient-to-r from-blue-500 to-indigo-600 text-white"}},g=v=>{switch(v){case"permitVerified":return"bg-gradient-to-r from-green-500 to-green-600 text-white";default:return"bg-gradient-to-r from-gray-500 to-gray-600 text-white"}};return e.jsx(Ve,{open:h,onOpenChange:c,children:e.jsxs(Pe,{className:"max-w-3xl max-h-[85vh] flex flex-col p-0",children:[e.jsxs($e,{className:"p-4 pb-3 border-b",children:[e.jsxs(Re,{className:"flex items-center gap-2",children:[e.jsx(z,{className:"h-5 w-5 text-primary"}),"Assign Site Visit to ",t.name]}),e.jsxs(Ie,{children:["Select a site visit to assign. Sites are sorted by distance from ",t.name,"'s current location."]})]}),e.jsx("div",{className:"p-4 pb-3 border-b bg-muted/30",children:e.jsxs("div",{className:"relative",children:[e.jsx(ms,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(fs,{placeholder:"Search sites by name, code, locality, or state...",value:o,onChange:v=>i(v.target.value),className:"pl-9","data-testid":"input-search-sites"})]})}),e.jsx(Ae,{className:"flex-1 px-4",children:e.jsx("div",{className:"space-y-2 py-3",children:m.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ue,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"font-medium",children:"No assignable sites found"}),e.jsx("p",{className:"text-sm",children:o?"Try adjusting your search":"No pending sites available"})]}):m.map(v=>{const f=v.distance,y=v.dueDate?bs(v.dueDate):null;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover-elevate bg-card","data-testid":`site-item-${v.id}`,children:[e.jsxs("div",{className:"flex-1 min-w-0 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("h4",{className:"font-semibold text-sm",children:v.siteName}),v.siteCode&&e.jsx(S,{variant:"outline",className:"text-[10px] h-5",children:v.siteCode})]}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"h-3 w-3"}),v.locality,", ",v.state]}),y&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Z,{className:"h-3 w-3"}),H(y,"MMM dd, yyyy")]}),f!==1/0&&e.jsxs(S,{variant:"secondary",className:"text-[10px] h-5",children:[f.toFixed(1)," km away"]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(S,{className:`text-[10px] h-5 ${g(v.status)}`,children:v.status}),v.priority&&e.jsxs(S,{className:`text-[10px] h-5 ${j(v.priority)}`,children:[v.priority," Priority"]})]})]}),e.jsx(V,{size:"sm",onClick:()=>b(v),disabled:s===v.id,className:"ml-3 gap-1","data-testid":`button-assign-site-${v.id}`,children:s===v.id?e.jsx(e.Fragment,{children:"Assigning..."}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"h-3 w-3"}),"Assign"]})})]},v.id)})})}),e.jsx("div",{className:"p-4 pt-3 border-t bg-muted/30 flex justify-end",children:e.jsx(V,{variant:"outline",onClick:a,"data-testid":"button-close-dialog",children:"Close"})})]})})},ys=({user:t,variant:h="buttons",size:a="sm",onActionComplete:c})=>{const r=pe(),{createChat:l}=Qe(),{toast:n}=Le(),[o,i]=w.useState(!1),[d,u]=w.useState(!1),s=async b=>{b.stopPropagation(),u(!0);try{await l([t.id],void 0,"private")?(r("/chat"),n({title:"Chat Opened",description:`Opening conversation with ${t.name}`,variant:"success"})):n({title:"Error",description:"Failed to open chat. Please try again.",variant:"destructive"})}catch{n({title:"Error",description:"Failed to open chat. Please try again.",variant:"destructive"})}finally{u(!1)}},x=b=>{b.stopPropagation(),i(!0)},m=()=>{i(!1),c==null||c(),n({title:"Site Visit Assigned",description:`Site visit successfully assigned to ${t.name}`,variant:"success"})};return h==="dropdown"?e.jsxs(e.Fragment,{children:[e.jsxs(rt,{children:[e.jsx(lt,{asChild:!0,onClick:b=>b.stopPropagation(),children:e.jsx(V,{variant:"ghost",size:"icon",className:"h-8 w-8","data-testid":`button-actions-${t.id}`,children:e.jsx(Rs,{className:"h-4 w-4"})})}),e.jsxs(it,{align:"end",className:"w-48",children:[e.jsxs(ts,{onClick:s,disabled:d,"data-testid":`action-message-${t.id}`,children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Send Message"]}),e.jsx(ct,{}),e.jsxs(ts,{onClick:x,"data-testid":`action-assign-${t.id}`,children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Assign Site Visit"]})]})]}),e.jsx(os,{user:t,isOpen:o,onClose:()=>i(!1),onOpenChange:i,onAssignmentComplete:m})]}):e.jsxs("div",{className:"flex items-center gap-1",onClick:b=>b.stopPropagation(),children:[e.jsxs(V,{variant:"outline",size:a,onClick:s,disabled:d,className:"gap-1","data-testid":`button-message-${t.id}`,children:[e.jsx(Y,{className:"h-3 w-3"}),e.jsx("span",{className:"hidden sm:inline",children:"Message"})]}),e.jsxs(V,{variant:"outline",size:a,onClick:x,className:"gap-1","data-testid":`button-assign-${t.id}`,children:[e.jsx(z,{className:"h-3 w-3"}),e.jsx("span",{className:"hidden sm:inline",children:"Assign"})]}),e.jsx(os,{user:t,isOpen:o,onClose:()=>i(!1),onOpenChange:i,onAssignmentComplete:m})]})},Wt=({user:t,workload:h,onClick:a})=>{var b,j,g,v,f;const{userClassifications:c}=dt(),r=le(t),l=((b=t.location)==null?void 0:b.lastUpdated)||t.lastActive,n=l?ce(new Date(l),{addSuffix:!0}):"Never",o=((j=t.name)==null?void 0:j.split(" ").map(y=>y[0]).join("").toUpperCase().slice(0,2))||"??",i=((g=t.roles)==null?void 0:g[0])||t.role,d=h.active+h.pending,u=Math.min(Math.round(d/20*100),100),s=()=>u>=80?"text-red-600 dark:text-red-400":u>=50?"text-orange-600 dark:text-orange-400":"text-green-600 dark:text-green-400",x=c.find(y=>y.userId===t.id),m=y=>{switch(y){case"A":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 border-green-300 dark:border-green-700";case"B":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 border-blue-300 dark:border-blue-700";case"C":return"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200 border-orange-300 dark:border-orange-700";default:return"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200 border-gray-300 dark:border-gray-700"}};return e.jsx(L,{className:"relative overflow-hidden hover-elevate cursor-pointer transition-all hover:shadow-md hover:scale-[1.02]",onClick:a,"data-testid":`card-team-member-${t.id}`,children:e.jsxs(R,{className:"p-3",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(Te,{className:"h-12 w-12 border-2 border-background",children:[e.jsx(qe,{src:t.avatar,alt:t.name}),e.jsx(Ye,{className:"text-sm font-semibold bg-primary/10",children:o})]}),e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5",children:e.jsx(ke,{className:`h-4 w-4 ${r.color} border-2 border-background rounded-full`,fill:"currentColor","data-testid":`status-indicator-${t.id}`})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-sm truncate",children:t.name}),e.jsx("p",{className:"text-[10px] text-muted-foreground uppercase tracking-wide",children:i})]}),e.jsx(S,{variant:r.badgeVariant,className:"text-[10px] h-5 px-1.5",children:r.label})]}),e.jsxs("div",{className:"flex items-center gap-1 text-[10px] text-muted-foreground",children:[e.jsx(q,{className:"h-3 w-3"}),e.jsxs("span",{children:["Last seen ",n]})]})]})]}),((v=t.location)==null?void 0:v.isSharing)&&((f=t.location)==null?void 0:f.address)&&e.jsxs("div",{className:"flex items-center gap-1 mb-2 px-2 py-1 bg-blue-500/5 border border-blue-500/10 rounded text-[10px] text-blue-600 dark:text-blue-400",children:[e.jsx(z,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate",children:t.location.address})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-wide text-muted-foreground",children:"Workload"}),e.jsxs("span",{className:`text-xs font-bold tabular-nums ${s()}`,children:[u,"%"]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-1",children:[e.jsxs("div",{className:"flex flex-col items-center p-1.5 bg-blue-500/5 border border-blue-500/10 rounded",children:[e.jsx(ye,{className:"h-3 w-3 text-blue-600 dark:text-blue-400 mb-0.5"}),e.jsx("span",{className:"text-xs font-bold tabular-nums text-blue-600 dark:text-blue-400",children:h.active}),e.jsx("span",{className:"text-[9px] text-muted-foreground uppercase",children:"Active"})]}),e.jsxs("div",{className:"flex flex-col items-center p-1.5 bg-green-500/5 border border-green-500/10 rounded",children:[e.jsx(ve,{className:"h-3 w-3 text-green-600 dark:text-green-400 mb-0.5"}),e.jsx("span",{className:"text-xs font-bold tabular-nums text-green-600 dark:text-green-400",children:h.completed}),e.jsx("span",{className:"text-[9px] text-muted-foreground uppercase",children:"Done"})]}),e.jsxs("div",{className:"flex flex-col items-center p-1.5 bg-orange-500/5 border border-orange-500/10 rounded",children:[e.jsx(q,{className:"h-3 w-3 text-orange-600 dark:text-orange-400 mb-0.5"}),e.jsx("span",{className:"text-xs font-bold tabular-nums text-orange-600 dark:text-orange-400",children:h.pending}),e.jsx("span",{className:"text-[9px] text-muted-foreground uppercase",children:"Queue"})]}),e.jsxs("div",{className:"flex flex-col items-center p-1.5 bg-red-500/5 border border-red-500/10 rounded",children:[e.jsx(ue,{className:"h-3 w-3 text-red-600 dark:text-red-400 mb-0.5"}),e.jsx("span",{className:"text-xs font-bold tabular-nums text-red-600 dark:text-red-400",children:h.overdue}),e.jsx("span",{className:"text-[9px] text-muted-foreground uppercase",children:"Late"})]})]})]}),e.jsx("div",{className:"mt-3 pt-3 border-t",onClick:y=>y.stopPropagation(),children:e.jsx(ys,{user:t,variant:"buttons",size:"sm"})}),t.performance&&e.jsx("div",{className:"mt-2 pt-2 border-t border-border/50",children:e.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[e.jsx("span",{className:"text-muted-foreground uppercase tracking-wide",children:"Performance"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex",children:[...Array(5)].map((y,C)=>e.jsx(ke,{className:`h-2 w-2 ${C<Math.round(t.performance.rating)?"text-yellow-500 fill-yellow-500":"text-gray-300 dark:text-gray-700"}`},C))}),e.jsx("span",{className:"font-semibold ml-1",children:t.performance.rating.toFixed(1)})]})]})}),x&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground uppercase tracking-wide",children:[e.jsx(gs,{className:"h-3 w-3"}),e.jsx("span",{children:"Classification"})]}),e.jsxs(S,{className:`text-[10px] h-5 px-1.5 border ${m(x.classificationLevel)}`,"data-testid":`badge-classification-${t.id}`,children:["Level ",x.classificationLevel]})]}),x.hasRetainer&&e.jsxs("div",{className:"mt-1 text-[9px] text-right text-muted-foreground",children:["Retainer: SDG ",((x.retainerAmountCents||0)/100).toFixed(2),"/mo"]})]})]})})},_t=({users:t,workloads:h,onRowClick:a})=>{const c=n=>(n==null?void 0:n.split(" ").map(o=>o[0]).join("").toUpperCase().slice(0,2))||"??",r=n=>{var i;const o=((i=n.location)==null?void 0:i.lastUpdated)||n.lastActive;return o?ce(new Date(o),{addSuffix:!0}):"Never"},l=n=>{var i;const o=((i=n.location)==null?void 0:i.lastUpdated)||n.lastActive;return o?H(new Date(o),"MMM dd, yyyy HH:mm"):null};return e.jsx("div",{className:"rounded-lg border border-border bg-card",children:e.jsxs(Ne,{children:[e.jsx(be,{children:e.jsxs(G,{className:"bg-muted/30",children:[e.jsx(A,{className:"w-12",children:"Status"}),e.jsx(A,{children:"Team Member"}),e.jsx(A,{children:"Role"}),e.jsx(A,{children:"Last Login"}),e.jsx(A,{children:"Location"}),e.jsx(A,{className:"text-center",children:"Active"}),e.jsx(A,{className:"text-center",children:"Completed"}),e.jsx(A,{className:"text-center",children:"Pending"}),e.jsx(A,{className:"text-center",children:"Overdue"}),e.jsx(A,{className:"text-right",children:"Workload"}),e.jsx(A,{className:"text-right",children:"Actions"})]})}),e.jsx(we,{children:t.map(n=>{var x,m,b;const o=h.get(n.id)||{active:0,completed:0,pending:0,overdue:0},i=o.active+o.pending,d=Math.min(Math.round(i/20*100),100),u=le(n),s=((x=n.roles)==null?void 0:x[0])||n.role;return e.jsxs(G,{className:"cursor-pointer hover-elevate",onClick:()=>a(n),"data-testid":`row-team-member-${n.id}`,children:[e.jsx(M,{children:e.jsx(ke,{className:`h-3 w-3 ${u.color.replace("bg-","text-")}`,fill:"currentColor","data-testid":`status-indicator-${n.id}`})}),e.jsx(M,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Te,{className:"h-8 w-8 border border-border",children:[e.jsx(qe,{src:n.avatar,alt:n.name}),e.jsx(Ye,{className:"text-xs font-semibold bg-primary/10",children:c(n.name||"")})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium text-sm",children:n.name}),e.jsx(S,{variant:u.badgeVariant,className:"w-fit text-[9px] h-4 px-1",children:u.label})]})]})}),e.jsx(M,{children:e.jsx(S,{variant:"secondary",className:"text-xs",children:s})}),e.jsx(M,{children:e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(q,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{children:r(n)})]}),l(n)&&e.jsx("span",{className:"text-xs text-muted-foreground",children:l(n)})]})}),e.jsx(M,{children:(m=n.location)!=null&&m.isSharing&&((b=n.location)!=null&&b.address)?e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[e.jsx(z,{className:"h-3 w-3 text-blue-500"}),e.jsx("span",{className:"truncate max-w-[200px]",children:n.location.address})]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"No location"})}),e.jsx(M,{className:"text-center",children:e.jsx(S,{className:"bg-gradient-to-br from-blue-500/10 to-blue-600/5 border-blue-500/20 text-blue-600 dark:text-blue-400 text-xs tabular-nums",children:o.active})}),e.jsx(M,{className:"text-center",children:e.jsx(S,{className:"bg-gradient-to-br from-green-500/10 to-green-600/5 border-green-500/20 text-green-600 dark:text-green-400 text-xs tabular-nums",children:o.completed})}),e.jsx(M,{className:"text-center",children:e.jsx(S,{className:"bg-gradient-to-br from-orange-500/10 to-orange-600/5 border-orange-500/20 text-orange-600 dark:text-orange-400 text-xs tabular-nums",children:o.pending})}),e.jsx(M,{className:"text-center",children:e.jsx(S,{className:"bg-gradient-to-br from-red-500/10 to-red-600/5 border-red-500/20 text-red-600 dark:text-red-400 text-xs tabular-nums",children:o.overdue})}),e.jsx(M,{className:"text-right",children:e.jsxs("span",{className:`font-bold tabular-nums text-sm ${d>=80?"text-red-600 dark:text-red-400":d>=50?"text-orange-600 dark:text-orange-400":"text-green-600 dark:text-green-400"}`,children:[d,"%"]})}),e.jsx(M,{className:"text-right",onClick:j=>j.stopPropagation(),children:e.jsx(ys,{user:n,variant:"dropdown"})})]},n.id)})})]})})},Ht=({open:t,onOpenChange:h,user:a,userTasks:c})=>{var x,m,b,j,g,v;if(!a)return null;const r=w.useMemo(()=>{const f=new Date,y=c.filter($=>$.status==="completed"),C=c.filter($=>$.status==="assigned"||$.status==="inProgress"),k=c.filter($=>$.status==="pending"||$.status==="permitVerified"),I=c.filter($=>new Date($.dueDate)<f&&$.status!=="completed"),P=y.filter($=>{if(!$.completedAt)return!1;const p=new Date($.completedAt),N=new Date($.dueDate);return p<=N}),W=c.length>0?Math.round(y.length/c.length*100):0,F=y.length>0?Math.round(P.length/y.length*100):0;return{total:c.length,completed:y.length,active:C.length,pending:k.length,overdue:I.length,onTime:P.length,completionRate:W,onTimeRate:F}},[c]),l=a.availability==="online"||((x=a.location)==null?void 0:x.isSharing)&&((m=a.location)==null?void 0:m.latitude)&&((b=a.location)==null?void 0:b.longitude),n=l?"bg-green-500":"bg-gray-400 dark:bg-gray-600",o=((j=a.location)==null?void 0:j.lastUpdated)||a.lastActive,i=o?ce(new Date(o),{addSuffix:!0}):"Never",d=((g=a.name)==null?void 0:g.split(" ").map(f=>f[0]).join("").toUpperCase().slice(0,2))||"??",u=w.useMemo(()=>[...c].sort((f,y)=>new Date(y.dueDate).getTime()-new Date(f.dueDate).getTime()),[c]),s=w.useMemo(()=>{const f=new Date;return f.setDate(f.getDate()-30),c.filter(y=>new Date(y.createdAt||y.dueDate)>=f).sort((y,C)=>{const k=new Date(y.completedAt||y.createdAt||y.dueDate);return new Date(C.completedAt||C.createdAt||C.dueDate).getTime()-k.getTime()}).slice(0,10)},[c]);return e.jsx(Ve,{open:t,onOpenChange:h,children:e.jsxs(Pe,{className:"max-w-6xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsx($e,{children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(Te,{className:"h-16 w-16 border-2 border-background",children:[e.jsx(qe,{src:a.avatar,alt:a.name}),e.jsx(Ye,{className:"text-lg font-semibold bg-primary/10",children:d})]}),e.jsx("div",{className:"absolute -bottom-1 -right-1",children:e.jsx(ke,{className:`h-5 w-5 ${n} border-2 border-background rounded-full`,fill:"currentColor"})})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Re,{className:"text-xl",children:a.name}),e.jsxs(Ie,{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(S,{variant:"outline",className:"text-xs",children:((v=a.roles)==null?void 0:v[0])||a.role}),e.jsx(S,{variant:l?"default":"outline",className:"text-xs",children:l?"Online":"Offline"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Last seen ",i]})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-muted-foreground mt-2",children:[a.email&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Is,{className:"h-3 w-3"}),e.jsx("span",{children:a.email})]}),a.phone&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ce,{className:"h-3 w-3"}),e.jsx("span",{children:a.phone})]}),a.employeeId&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-semibold",children:"ID:"}),e.jsx("span",{children:a.employeeId})]})]})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 py-3 border-y",children:[e.jsxs("div",{className:"flex flex-col items-center p-2 bg-blue-500/5 border border-blue-500/10 rounded",children:[e.jsx(ye,{className:"h-5 w-5 text-blue-600 dark:text-blue-400 mb-1"}),e.jsx("span",{className:"text-2xl font-bold tabular-nums text-blue-600 dark:text-blue-400",children:r.total}),e.jsx("span",{className:"text-[10px] text-muted-foreground uppercase tracking-wide",children:"Total Tasks"})]}),e.jsxs("div",{className:"flex flex-col items-center p-2 bg-green-500/5 border border-green-500/10 rounded",children:[e.jsx(ve,{className:"h-5 w-5 text-green-600 dark:text-green-400 mb-1"}),e.jsxs("span",{className:"text-2xl font-bold tabular-nums text-green-600 dark:text-green-400",children:[r.completionRate,"%"]}),e.jsx("span",{className:"text-[10px] text-muted-foreground uppercase tracking-wide",children:"Completion"})]}),e.jsxs("div",{className:"flex flex-col items-center p-2 bg-purple-500/5 border border-purple-500/10 rounded",children:[e.jsx(Fs,{className:"h-5 w-5 text-purple-600 dark:text-purple-400 mb-1"}),e.jsxs("span",{className:"text-2xl font-bold tabular-nums text-purple-600 dark:text-purple-400",children:[r.onTimeRate,"%"]}),e.jsx("span",{className:"text-[10px] text-muted-foreground uppercase tracking-wide",children:"On-Time"})]}),e.jsxs("div",{className:"flex flex-col items-center p-2 bg-orange-500/5 border border-orange-500/10 rounded",children:[e.jsx(J,{className:"h-5 w-5 text-orange-600 dark:text-orange-400 mb-1"}),e.jsx("span",{className:"text-2xl font-bold tabular-nums text-orange-600 dark:text-orange-400",children:r.active}),e.jsx("span",{className:"text-[10px] text-muted-foreground uppercase tracking-wide",children:"Active"})]})]}),e.jsxs(te,{defaultValue:"tasks",className:"flex-1 overflow-hidden flex flex-col",children:[e.jsxs(ae,{className:"grid w-full grid-cols-3",children:[e.jsxs(O,{value:"tasks",className:"text-xs",children:["All Tasks (",r.total,")"]}),e.jsx(O,{value:"activity",className:"text-xs",children:"Recent Activity"}),e.jsx(O,{value:"performance",className:"text-xs",children:"Performance"})]}),e.jsx(_,{value:"tasks",className:"flex-1 overflow-auto mt-3",children:u.length>0?e.jsxs(Ne,{children:[e.jsx(be,{className:"sticky top-0 bg-background z-10",children:e.jsxs(G,{children:[e.jsx(A,{children:"MMP Name"}),e.jsx(A,{className:"w-[200px]",children:"Site Name"}),e.jsx(A,{children:"Location"}),e.jsx(A,{children:"Due Date"}),e.jsx(A,{children:"Status"}),e.jsx(A,{children:"Priority"})]})}),e.jsx(we,{children:u.map(f=>{var k;const y=new Date(f.dueDate),C=y<new Date&&f.status!=="completed";return e.jsxs(G,{children:[e.jsx(M,{children:e.jsx("div",{className:"text-xs font-medium text-primary",children:((k=f.mmpDetails)==null?void 0:k.mmpId)||f.projectName||"N/A"})}),e.jsx(M,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm",children:f.siteName}),f.siteCode&&e.jsx("span",{className:"text-xs text-muted-foreground",children:f.siteCode})]})}),e.jsx(M,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("span",{className:"text-xs",children:[f.locality,", ",f.state]})]})}),e.jsx(M,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:`text-xs ${C?"text-red-600 dark:text-red-400 font-semibold":""}`,children:H(y,"MMM dd, yyyy")}),C&&e.jsx("span",{className:"text-[10px] text-red-600 dark:text-red-400",children:"Overdue"})]})}),e.jsx(M,{children:e.jsx(S,{variant:f.status==="completed"?"default":f.status==="assigned"||f.status==="inProgress"?"secondary":"outline",className:"text-[10px]",children:f.status})}),e.jsx(M,{children:e.jsx(S,{variant:f.priority==="high"?"destructive":f.priority==="medium"?"secondary":"outline",className:"text-[10px]",children:f.priority})})]},f.id)})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-muted-foreground",children:[e.jsx(J,{className:"h-12 w-12 mb-3 opacity-50"}),e.jsx("p",{children:"No tasks assigned to this team member"})]})}),e.jsx(_,{value:"activity",className:"flex-1 overflow-auto mt-3",children:e.jsx("div",{className:"space-y-2",children:s.length>0?s.map(f=>e.jsx(L,{className:"hover-elevate",children:e.jsx(R,{className:"p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[f.status==="completed"&&e.jsx(ve,{className:"h-4 w-4 text-green-600 dark:text-green-400"}),f.status==="assigned"&&e.jsx(q,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"}),f.status==="pending"&&e.jsx(ue,{className:"h-4 w-4 text-orange-600 dark:text-orange-400"}),e.jsx("span",{className:"font-medium text-sm",children:f.siteName})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(Z,{className:"h-3 w-3"}),e.jsx("span",{children:H(new Date(f.completedAt||f.createdAt||f.dueDate),"MMM dd, yyyy HH:mm")})]})]}),e.jsx(S,{variant:"outline",className:"text-[10px]",children:f.status})]})})},f.id)):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-muted-foreground",children:[e.jsx(J,{className:"h-12 w-12 mb-3 opacity-50"}),e.jsx("p",{children:"No recent activity in the last 30 days"})]})})}),e.jsx(_,{value:"performance",className:"flex-1 overflow-auto mt-3",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(L,{children:[e.jsx(U,{children:e.jsxs(B,{className:"text-sm flex items-center gap-2",children:[e.jsx(He,{className:"h-4 w-4"}),"Performance Metrics"]})}),e.jsxs(R,{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Completion Rate"}),e.jsxs("span",{className:"text-sm font-semibold tabular-nums",children:[r.completionRate,"%"]})]}),e.jsx(me,{value:r.completionRate,className:"h-2"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"On-Time Delivery"}),e.jsxs("span",{className:"text-sm font-semibold tabular-nums",children:[r.onTimeRate,"%"]})]}),e.jsx(me,{value:r.onTimeRate,className:"h-2"})]}),a.performance&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Overall Rating"}),e.jsxs("span",{className:"text-sm font-semibold tabular-nums",children:[a.performance.rating.toFixed(1),"/5.0"]})]}),e.jsx(me,{value:a.performance.rating/5*100,className:"h-2"})]})]})]}),e.jsxs(L,{children:[e.jsx(U,{children:e.jsxs(B,{className:"text-sm flex items-center gap-2",children:[e.jsx(gs,{className:"h-4 w-4"}),"Task Breakdown"]})}),e.jsx(R,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 bg-green-500/5 border border-green-500/10 rounded",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Completed"}),e.jsx("span",{className:"text-lg font-bold tabular-nums text-green-600 dark:text-green-400",children:r.completed})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-blue-500/5 border border-blue-500/10 rounded",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Active"}),e.jsx("span",{className:"text-lg font-bold tabular-nums text-blue-600 dark:text-blue-400",children:r.active})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-orange-500/5 border border-orange-500/10 rounded",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Pending"}),e.jsx("span",{className:"text-lg font-bold tabular-nums text-orange-600 dark:text-orange-400",children:r.pending})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-red-500/5 border border-red-500/10 rounded",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Overdue"}),e.jsx("span",{className:"text-lg font-bold tabular-nums text-red-600 dark:text-red-400",children:r.overdue})]})]})})]}),a.performance&&e.jsxs(L,{children:[e.jsx(U,{children:e.jsxs(B,{className:"text-sm flex items-center gap-2",children:[e.jsx(ye,{className:"h-4 w-4"}),"Historical Summary"]})}),e.jsxs(R,{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Completed Tasks"}),e.jsx("span",{className:"font-semibold tabular-nums",children:a.performance.totalCompletedTasks||r.completed})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"On-Time Completions"}),e.jsx("span",{className:"font-semibold tabular-nums",children:a.performance.onTimeCompletion||r.onTime})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Current Workload"}),e.jsx("span",{className:"font-semibold tabular-nums",children:a.performance.currentWorkload||r.active+r.pending})]})]})]})]})})]})]})})},Qt=()=>{const[t,h]=w.useState("overview"),[a,c]=w.useState("cards"),[r,l]=w.useState(null),[n,o]=w.useState(!1),i=pe(),{users:d}=Ze(),{siteVisits:u}=ie(),s=w.useMemo(()=>d?d.filter(y=>{var C;return(C=y.roles)==null?void 0:C.some(k=>{const I=k.toLowerCase();return I==="coordinator"||I==="datacollector"})}).sort((y,C)=>{var F,$,p,N,T,D,Q,Ke;const k=y.availability==="online"||((F=y.location)==null?void 0:F.isSharing)&&(($=y.location)==null?void 0:$.latitude)&&((p=y.location)==null?void 0:p.longitude),I=C.availability==="online"||((N=C.location)==null?void 0:N.isSharing)&&((T=C.location)==null?void 0:T.latitude)&&((D=C.location)==null?void 0:D.longitude);if(k&&!I)return-1;if(!k&&I)return 1;const P=new Date(((Q=y.location)==null?void 0:Q.lastUpdated)||y.lastActive||0).getTime();return new Date(((Ke=C.location)==null?void 0:Ke.lastUpdated)||C.lastActive||0).getTime()-P}):[],[d]),x=s.length,m=s.filter(f=>{var y,C;return f.availability==="online"||((y=f.location)==null?void 0:y.latitude)&&((C=f.location)==null?void 0:C.longitude)}).length,b=w.useMemo(()=>{if(!d||!u)return new Map;const f=new Map;return d.forEach(y=>{const C=u.filter($=>$.assignedTo===y.id||$.assignedTo===y.name),k=new Date,I=C.filter($=>$.status==="assigned"||$.status==="inProgress").length,P=C.filter($=>$.status==="completed").length,W=C.filter($=>$.status==="pending"||$.status==="permitVerified").length,F=C.filter($=>new Date($.dueDate)<k&&$.status!=="completed").length;f.set(y.id,{active:I,completed:P,pending:W,overdue:F})}),f},[d,u]),j=w.useMemo(()=>!r||!u?[]:u.filter(f=>f.assignedTo===r.id||f.assignedTo===r.name),[r,u]),g=f=>{l(f),o(!0)},v=()=>{o(!1),l(null)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-lg border border-border/50 bg-gradient-to-r from-green-500/5 via-blue-500/5 to-background p-4 shadow-sm",children:[e.jsxs("div",{className:"relative z-10 flex items-center justify-between flex-wrap gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 rounded-lg bg-green-500/10 border border-green-500/20",children:e.jsx(he,{className:"h-6 w-6 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:"Team Coordination"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase tracking-wide",children:"Field team locations and communication"})]})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs(S,{variant:"secondary",className:"gap-2 text-xs h-7",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),m,"/",x," Online"]}),e.jsx(V,{variant:"outline",size:"sm",onClick:()=>i("/field-team"),"data-testid":"button-view-full-team",className:"h-7 text-xs",children:"View Full Team"})]})]}),e.jsx("div",{className:"absolute inset-0 bg-grid-pattern opacity-5"})]}),e.jsxs(te,{value:t,onValueChange:h,className:"w-full",children:[e.jsxs(ae,{className:"grid w-full grid-cols-3 max-w-2xl h-auto p-1 bg-muted/30",children:[e.jsxs(O,{value:"overview",className:"gap-1.5 data-[state=active]:bg-background data-[state=active]:shadow-sm",children:[e.jsx(Os,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-xs",children:"Team Overview"})]}),e.jsxs(O,{value:"map",className:"gap-1.5 data-[state=active]:bg-background data-[state=active]:shadow-sm",children:[e.jsx(z,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-xs",children:"Live Map"})]}),e.jsxs(O,{value:"communication",className:"gap-1.5 data-[state=active]:bg-background data-[state=active]:shadow-sm",children:[e.jsx(Y,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-xs",children:"Communication"})]})]}),e.jsx(_,{value:"overview",className:"mt-4 space-y-3",children:s&&s.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-semibold text-muted-foreground uppercase tracking-wide",children:["Team Members (",s.length,")"]}),e.jsxs("div",{className:"flex gap-1 bg-muted/30 p-1 rounded-lg",children:[e.jsxs(V,{variant:a==="cards"?"default":"ghost",size:"sm",onClick:()=>c("cards"),"data-testid":"button-view-cards",className:"h-7 text-xs gap-1.5",children:[e.jsx(Es,{className:"h-3.5 w-3.5"}),"Cards"]}),e.jsxs(V,{variant:a==="table"?"default":"ghost",size:"sm",onClick:()=>c("table"),"data-testid":"button-view-table",className:"h-7 text-xs gap-1.5",children:[e.jsx(zs,{className:"h-3.5 w-3.5"}),"Table"]})]})]}),a==="cards"?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:s.map(f=>e.jsx(Wt,{user:f,workload:b.get(f.id)||{active:0,completed:0,pending:0,overdue:0},onClick:()=>g(f)},f.id))}):e.jsx(_t,{users:s,workloads:b,onRowClick:g})]}):e.jsx(L,{children:e.jsxs(R,{className:"flex flex-col items-center justify-center py-12 text-muted-foreground",children:[e.jsx(he,{className:"h-12 w-12 mb-3 opacity-50"}),e.jsx("p",{children:"No assignable team members found"}),e.jsx("p",{className:"text-xs mt-1",children:"Only Coordinators and Data Collectors are shown"})]})})}),e.jsx(_,{value:"map",className:"mt-4",children:e.jsx(Bt,{users:s,siteVisits:u||[]})}),e.jsx(_,{value:"communication",className:"mt-4",children:e.jsx(Ut,{})})]}),e.jsx(Ht,{open:n,onOpenChange:v,user:r,userTasks:j})]})},Zt=()=>{const{mmpFiles:t}=Ns(),h=pe(),a=new Date,c=new Date(a.getFullYear(),a.getMonth()-2,1),r=(t||[]).filter(n=>new Date(n.uploadedAt||0)>=c),l=r.reduce((n,o)=>{const i=new Date(o.uploadedAt||0),d=H(i,"yyyy-MM");return n[d]||(n[d]=[]),n[d].push(o),n},{});return e.jsxs(L,{children:[e.jsx(U,{children:e.jsx(B,{children:"Recent MMPs (Last 3 Months)"})}),e.jsxs(R,{children:[Object.entries(l).map(([n,o])=>e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"font-semibold",children:H(new Date(n+"-01"),"MMMM yyyy")}),e.jsx("ul",{className:"ml-4 mt-1",children:o.map(i=>e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm",children:i.name||i.mmpId}),e.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${i.status==="approved"?"bg-green-100 text-green-800":i.status==="pending"?"bg-amber-100 text-amber-800":"bg-gray-100 text-gray-800"}`,children:i.status}),e.jsx(V,{size:"sm",variant:"link",onClick:()=>h(`/mmp/${i.id}`),children:"View"})]},i.id))})]},n)),r.length===0&&e.jsx("div",{className:"text-muted-foreground text-sm",children:"No MMPs uploaded in the last 3 months."})]})]})},Gt=()=>{const{currentUser:t}=ne(),[h,a]=fe.useState([]),[c,r]=fe.useState(!1);return fe.useEffect(()=>{let l=!1;const n=async()=>{if(t!=null&&t.id){r(!0);try{const{data:i,error:d}=await Me.from("mmp_files").select(`
            id, name, mmp_id, status, workflow, uploaded_at,
            project:projects(name)
          `).contains("workflow",{forwardedToFomIds:[t.id]}).order("created_at",{ascending:!1}).limit(10);if(!l)if(d){const{data:u}=await Me.from("mmp_files").select("*").contains("workflow",{forwardedToFomIds:[t.id]}).order("created_at",{ascending:!1}).limit(10);a(u||[])}else a(i||[])}finally{l||r(!1)}}};n();const o=setInterval(n,6e4);return()=>{l=!0,clearInterval(o)}},[t==null?void 0:t.id]),e.jsxs(L,{className:"p-0 overflow-hidden",children:[e.jsx(U,{className:"pb-2",children:e.jsx(B,{className:"text-lg",children:"Forwarded to You"})}),e.jsxs(R,{className:"pt-0",children:[c&&e.jsx("div",{className:"text-sm text-muted-foreground py-4",children:"Loading forwarded MMPs…"}),!c&&h.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground py-4",children:"No MMPs forwarded to you yet."}),!c&&h.length>0&&e.jsx("div",{className:"-mx-2",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-muted-foreground",children:[e.jsx("th",{className:"px-2 py-2 text-left font-medium",children:"MMP"}),e.jsx("th",{className:"px-2 py-2 text-left font-medium",children:"Project"}),e.jsx("th",{className:"px-2 py-2 text-left font-medium",children:"Forwarded"}),e.jsx("th",{className:"px-2 py-2 text-left font-medium",children:"Status"}),e.jsx("th",{className:"px-2 py-2"})]})}),e.jsx("tbody",{children:h.map(l=>{var d,u;const n=l.status||"",o=(d=l.workflow)!=null&&d.forwardedAt?new Date(l.workflow.forwardedAt).toLocaleString():"-",i=((u=l.project)==null?void 0:u.name)||l.project_name||"";return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-2 py-2 font-medium",children:l.name||l.mmp_id||l.id}),e.jsx("td",{className:"px-2 py-2",children:i||"-"}),e.jsx("td",{className:"px-2 py-2",children:o}),e.jsx("td",{className:"px-2 py-2",children:e.jsx(S,{variant:n.toLowerCase()==="approved"?"success":"outline",children:n||"pending"})}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx(V,{size:"sm",variant:"outline",onClick:()=>window.location.assign(`/mmp/${l.id}/verification`),children:"Open"})})]},l.id)})})]})})]})]})},qt=({visits:t,teamMembers:h})=>{const a=bt();return fe.useEffect(()=>{const c=[];if(t.filter(r=>{var l,n;return((l=r.coordinates)==null?void 0:l.latitude)&&((n=r.coordinates)==null?void 0:n.longitude)}).forEach(r=>c.push([r.coordinates.latitude,r.coordinates.longitude])),h.filter(r=>{var l,n;return((l=r.location)==null?void 0:l.latitude)&&((n=r.location)==null?void 0:n.longitude)}).forEach(r=>c.push([r.location.latitude,r.location.longitude])),c.length>0){const r=new Je.LatLngBounds(c);r.isValid()&&a.fitBounds(r,{padding:[50,50],maxZoom:12})}},[t,h,a]),null},Yt=(t,h)=>{let a="#3b82f6";return t==="pending"?a="#f97316":t==="assigned"?a="#06b6d4":t==="completed"?a="#10b981":h==="high"&&(a="#ef4444"),new Je.Icon({iconUrl:`data:image/svg+xml;base64,${btoa(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${a}" stroke="white" stroke-width="1.5">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
      </svg>
    `)}`,iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]})},Jt=(t,h)=>{let a="#22c55e";h==="same-day"&&(a="#f97316"),h==="offline"&&(a="#9ca3af");let c="E";return t.toLowerCase().includes("coordinator")&&(c="C"),(t.toLowerCase().includes("supervisor")||t.toLowerCase().includes("fom"))&&(c="S"),new Je.Icon({iconUrl:`data:image/svg+xml;base64,${btoa(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
        <circle cx="16" cy="16" r="14" fill="${a}" stroke="white" stroke-width="2"/>
        <text x="16" y="21" text-anchor="middle" font-size="16" font-weight="bold" fill="white">${c}</text>
      </svg>
    `)}`,iconSize:[28,28],iconAnchor:[14,28],popupAnchor:[0,-28]})},Kt=({siteVisits:t,teamMembers:h=[]})=>{const a=w.useMemo(()=>t.filter(i=>{var d,u;return((d=i.coordinates)==null?void 0:d.latitude)&&((u=i.coordinates)==null?void 0:u.longitude)}),[t]),c=w.useMemo(()=>h.filter(i=>{var d,u;return((d=i.location)==null?void 0:d.latitude)&&((u=i.location)==null?void 0:u.longitude)}),[h]),r=w.useMemo(()=>{const i=c.filter(s=>{var x;return(x=s.roles)==null?void 0:x.some(m=>m.toLowerCase().includes("datacollector")||m.toLowerCase().includes("enumerator"))}),d=c.filter(s=>{var x;return(x=s.roles)==null?void 0:x.some(m=>m.toLowerCase().includes("coordinator"))}),u=c.filter(s=>{var x;return(x=s.roles)==null?void 0:x.some(m=>m.toLowerCase().includes("supervisor")||m.toLowerCase().includes("fom"))});return{enumerators:i,coordinators:d,supervisors:u}},[c]),l=a.length>0||c.length>0,n=a.length>0?[a[0].coordinates.latitude,a[0].coordinates.longitude]:c.length>0?[c[0].location.latitude,c[0].location.longitude]:[12.8628,30.2176];if(!l)return e.jsx("div",{className:"h-[500px] w-full rounded-lg border flex items-center justify-center bg-muted/20",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx(z,{className:"h-16 w-16 mx-auto mb-4 text-muted-foreground/50"}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:"No Location Data Available"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Site visits and team members will appear once location data is available"})]})});const o=i=>{var u,s,x;const d=new Set;return i.assignedTo&&d.add(i.assignedTo),(u=i.team)!=null&&u.coordinator&&d.add(i.team.coordinator),(s=i.team)!=null&&s.supervisor&&d.add(i.team.supervisor),(x=i.team)!=null&&x.fieldOfficer&&d.add(i.team.fieldOfficer),d.size===0?[]:c.filter(m=>m.id&&d.has(m.id)||m.email&&d.has(m.email)||m.fullName&&d.has(m.fullName))};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-3 items-center justify-between p-3 rounded-lg border bg-card",children:[e.jsxs("div",{className:"flex items-center gap-4 text-xs flex-wrap",children:[e.jsx("div",{className:"font-semibold text-foreground",children:"Sites:"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(z,{className:"h-4 w-4 text-orange-500"}),e.jsxs("span",{children:["Pending (",a.filter(i=>i.status==="pending").length,")"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(z,{className:"h-4 w-4 text-cyan-500"}),e.jsxs("span",{children:["Assigned (",a.filter(i=>i.status==="assigned").length,")"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(z,{className:"h-4 w-4 text-green-500"}),e.jsxs("span",{children:["Completed (",a.filter(i=>i.status==="completed").length,")"]})]}),e.jsx("div",{className:"h-4 border-l mx-1"}),e.jsx("div",{className:"font-semibold text-foreground",children:"Team:"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-5 h-5 rounded-full bg-green-500 border-2 border-white flex items-center justify-center text-[10px] font-bold text-white",children:"E"}),e.jsxs("span",{children:["Data Collectors (",r.enumerators.length,")"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-5 h-5 rounded-full bg-green-500 border-2 border-white flex items-center justify-center text-[10px] font-bold text-white",children:"C"}),e.jsxs("span",{children:["Coordinators (",r.coordinators.length,")"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-5 h-5 rounded-full bg-green-500 border-2 border-white flex items-center justify-center text-[10px] font-bold text-white",children:"S"}),e.jsxs("span",{children:["Supervisors (",r.supervisors.length,")"]})]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[a.length," sites | ",c.length," team members"]})]}),e.jsx("div",{className:"h-[500px] w-full rounded-lg overflow-hidden border shadow-sm",children:e.jsxs(ft,{center:n,zoom:6,scrollWheelZoom:!0,className:"h-full w-full",children:[e.jsx(Nt,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),e.jsx(qt,{visits:a,teamMembers:c}),a.map(i=>{var u;const d=o(i);return e.jsx(ls,{position:[i.coordinates.latitude,i.coordinates.longitude],icon:Yt(i.status,i.priority),children:e.jsx(is,{children:e.jsxs("div",{className:"p-2 min-w-[280px] max-w-[350px]",children:[e.jsxs("h4",{className:"font-semibold text-sm mb-2 flex items-center gap-2",children:[e.jsx(z,{className:"h-4 w-4"}),i.siteName]}),e.jsxs("div",{className:"space-y-1.5 text-xs",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Site Code:"}),e.jsx("span",{className:"font-mono font-medium",children:i.siteCode})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Status:"}),e.jsx(S,{variant:i.status==="completed"?"default":i.status==="assigned"?"secondary":"outline",className:"text-xs h-5",children:i.status})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Priority:"}),e.jsx(S,{variant:i.priority==="high"?"destructive":i.priority==="medium"?"default":"outline",className:"text-xs h-5",children:i.priority})]}),i.scheduledDate&&e.jsxs("div",{className:"flex items-center justify-between gap-2 pt-1 border-t",children:[e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1",children:[e.jsx(Z,{className:"h-3 w-3"}),"Scheduled:"]}),e.jsx("span",{className:"font-medium",children:H(new Date(i.scheduledDate),"MMM dd, yyyy")})]}),d.length>0&&e.jsxs("div",{className:"pt-2 border-t space-y-2",children:[e.jsxs("div",{className:"font-semibold text-xs flex items-center gap-1",children:[e.jsx(Ue,{className:"h-3 w-3"}),"Assigned Team (",d.length,"):"]}),d.map(s=>{var m,b,j,g;const x=le(s);return e.jsxs("div",{className:"pl-4 space-y-1 border-l-2 border-primary/20",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"font-medium",children:s.fullName}),e.jsx(S,{variant:"outline",className:`text-[10px] h-4 ${x.type==="online"?"bg-green-500/10 border-green-500":x.type==="same-day"?"bg-orange-500/10 border-orange-500":""}`,children:x.label})]}),e.jsxs("div",{className:"text-[10px] text-muted-foreground",children:[e.jsx(Us,{className:"h-3 w-3 inline mr-1"}),((m=s.roles)==null?void 0:m[0])||"Team Member"]}),((b=s.location)==null?void 0:b.address)&&e.jsxs("div",{className:"text-[10px] flex items-start gap-1",children:[e.jsx(Xe,{className:"h-3 w-3 flex-shrink-0 mt-0.5"}),e.jsxs("span",{className:"text-muted-foreground",children:["GPS: ",s.location.address]})]}),s.location&&e.jsxs("div",{className:"text-[10px] text-muted-foreground font-mono",children:[(j=s.location.latitude)==null?void 0:j.toFixed(6),", ",(g=s.location.longitude)==null?void 0:g.toFixed(6)]})]},s.id)})]}),((u=i.location)==null?void 0:u.address)&&e.jsxs("div",{className:"pt-1 border-t",children:[e.jsx("span",{className:"text-muted-foreground",children:"Site Location:"}),e.jsx("p",{className:"text-xs mt-0.5",children:i.location.address})]})]})]})})},`site-${i.id}`)}),c.map(i=>{var s,x,m,b;let d;try{d=le(i)}catch{d={type:"offline",color:"bg-gray-400 dark:bg-gray-600",badgeVariant:"outline",label:"Offline"}}const u=((s=i.roles)==null?void 0:s[0])||"Team Member";return e.jsx(ls,{position:[i.location.latitude,i.location.longitude],icon:Jt(u,d.type),children:e.jsx(is,{children:e.jsxs("div",{className:"p-2 min-w-[250px]",children:[e.jsxs("h4",{className:"font-semibold text-sm mb-2 flex items-center gap-2",children:[e.jsx(Ue,{className:"h-4 w-4"}),i.fullName]}),e.jsxs("div",{className:"space-y-1.5 text-xs",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Role:"}),e.jsx(S,{variant:"outline",className:"text-xs h-5",children:u})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Status:"}),e.jsx(S,{variant:d.type==="online"?"default":"outline",className:`text-xs h-5 ${d.type==="online"?"bg-green-500 hover:bg-green-600":d.type==="same-day"?"bg-orange-500 hover:bg-orange-600 text-white":""}`,children:d.label})]}),i.email&&e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Email:"}),e.jsx("span",{className:"font-mono text-[10px]",children:i.email})]}),((x=i.location)==null?void 0:x.address)&&e.jsxs("div",{className:"pt-1 border-t",children:[e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1",children:[e.jsx(Xe,{className:"h-3 w-3"}),"GPS Location:"]}),e.jsx("p",{className:"text-xs mt-0.5",children:i.location.address}),e.jsxs("p",{className:"text-[10px] text-muted-foreground font-mono mt-1",children:[(m=i.location.latitude)==null?void 0:m.toFixed(6),", ",(b=i.location.longitude)==null?void 0:b.toFixed(6)]})]}),i.location&&typeof i.location.isSharing=="boolean"&&e.jsxs("div",{className:"flex items-center justify-between gap-2 pt-1 border-t",children:[e.jsx("span",{className:"text-muted-foreground",children:"Location Sharing:"}),e.jsx(S,{variant:i.location.isSharing?"default":"outline",className:"text-xs h-5",children:i.location.isSharing?"Active":"Inactive"})]})]})]})})},`team-${i.id}`)})]})})]})},Xt=({siteVisits:t})=>{const[h,a]=w.useState("all"),[c,r]=w.useState("all"),[l,n]=w.useState("all"),o=w.useMemo(()=>{let s=[...t];if(h!=="all"&&(s=s.filter(x=>x.status===h)),c!=="all"&&(s=s.filter(x=>x.priority===c)),l!=="all"){const x=new Date;s=s.filter(m=>{if(!m.scheduledDate)return!1;const b=new Date(m.scheduledDate);switch(l){case"week":return rs(b,{start:x,end:Be(x,7)});case"month":return rs(b,{start:x,end:Be(x,30)});case"overdue":return ns(b)&&m.status!=="completed";default:return!0}})}return s.sort((x,m)=>x.scheduledDate?m.scheduledDate?new Date(x.scheduledDate).getTime()-new Date(m.scheduledDate).getTime():-1:1)},[t,h,c,l]),i=s=>({pending:"bg-orange-500/10 text-orange-700 dark:text-orange-400 border-orange-500/20",assigned:"bg-cyan-500/10 text-cyan-700 dark:text-cyan-400 border-cyan-500/20",inProgress:"bg-blue-500/10 text-blue-700 dark:text-blue-400 border-blue-500/20",completed:"bg-green-500/10 text-green-700 dark:text-green-400 border-green-500/20",permitVerified:"bg-purple-500/10 text-purple-700 dark:text-purple-400 border-purple-500/20"})[s]||"bg-muted",d=s=>({high:"bg-red-500/10 text-red-700 dark:text-red-400 border-red-500/20",medium:"bg-yellow-500/10 text-yellow-700 dark:text-yellow-400 border-yellow-500/20",low:"bg-gray-500/10 text-gray-700 dark:text-gray-400 border-gray-500/20"})[s]||"bg-muted",u=s=>!s.scheduledDate||s.status==="completed"?!1:ns(new Date(s.scheduledDate));return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 items-center p-3 bg-muted/30 rounded-lg border",children:[e.jsx(us,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wide",children:"Filters:"}),e.jsxs(K,{value:h,onValueChange:a,children:[e.jsx(X,{className:"w-[140px] h-8 text-xs","data-testid":"select-status-filter",children:e.jsx(ee,{placeholder:"Status"})}),e.jsxs(se,{children:[e.jsx(E,{value:"all",children:"All Status"}),e.jsx(E,{value:"pending",children:"Pending"}),e.jsx(E,{value:"assigned",children:"Assigned"}),e.jsx(E,{value:"inProgress",children:"In Progress"}),e.jsx(E,{value:"completed",children:"Completed"})]})]}),e.jsxs(K,{value:c,onValueChange:r,children:[e.jsx(X,{className:"w-[140px] h-8 text-xs","data-testid":"select-priority-filter",children:e.jsx(ee,{placeholder:"Priority"})}),e.jsxs(se,{children:[e.jsx(E,{value:"all",children:"All Priority"}),e.jsx(E,{value:"high",children:"High"}),e.jsx(E,{value:"medium",children:"Medium"}),e.jsx(E,{value:"low",children:"Low"})]})]}),e.jsxs(K,{value:l,onValueChange:n,children:[e.jsx(X,{className:"w-[160px] h-8 text-xs","data-testid":"select-date-filter",children:e.jsx(ee,{placeholder:"Time Frame"})}),e.jsxs(se,{children:[e.jsx(E,{value:"all",children:"All Dates"}),e.jsx(E,{value:"week",children:"Next 7 Days"}),e.jsx(E,{value:"month",children:"Next 30 Days"}),e.jsx(E,{value:"overdue",children:"Overdue"})]})]}),e.jsxs("div",{className:"ml-auto text-xs text-muted-foreground tabular-nums",children:[o.length," of ",t.length," visits"]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-3",children:o.length===0?e.jsx(L,{children:e.jsxs(R,{className:"flex flex-col items-center justify-center py-12 text-muted-foreground",children:[e.jsx(Z,{className:"h-12 w-12 mb-3 opacity-50"}),e.jsx("p",{children:"No site visits found matching your filters"})]})}):o.map(s=>e.jsx(L,{className:"hover-elevate active-elevate-2 transition-all","data-testid":`card-site-visit-${s.id}`,children:e.jsxs(R,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("h4",{className:"font-semibold text-sm truncate",children:s.siteName}),u(s)&&e.jsxs(S,{variant:"destructive",className:"text-xs h-5 gap-1",children:[e.jsx(ue,{className:"h-3 w-3"}),"Overdue"]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-muted-foreground",children:[e.jsx(z,{className:"h-3.5 w-3.5 shrink-0"}),e.jsxs("span",{className:"truncate",children:[s.locality,", ",s.state]})]}),s.scheduledDate&&e.jsxs("div",{className:"flex items-center gap-1.5 text-muted-foreground",children:[e.jsx(Z,{className:"h-3.5 w-3.5 shrink-0"}),e.jsx("span",{className:"tabular-nums",children:H(new Date(s.scheduledDate),"MMM dd, yyyy")})]}),e.jsxs("div",{className:"flex items-center gap-1.5 text-muted-foreground",children:[e.jsx(Ue,{className:"h-3.5 w-3.5 shrink-0"}),e.jsx("span",{className:"truncate",children:s.assignedTo||"Unassigned"})]}),e.jsx("div",{className:"flex items-center gap-1.5 text-muted-foreground",children:e.jsx("span",{className:"font-mono font-medium",children:s.siteCode})})]})]}),e.jsxs("div",{className:"flex gap-2 items-center flex-wrap",children:[e.jsx(S,{className:`text-xs h-6 ${i(s.status)}`,children:s.status}),e.jsx(S,{className:`text-xs h-6 ${d(s.priority)}`,children:s.priority})]})]}),s.description&&e.jsx("p",{className:"text-xs text-muted-foreground mt-3 line-clamp-2",children:s.description})]})},s.id))})]})},ea=()=>{const[t,h]=w.useState("calendar"),[a,c]=w.useState(!0),{siteVisits:r}=ie(),{users:l}=ne();return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between pb-4 border-b",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 rounded-lg bg-purple-500/10 border border-purple-500/20",children:e.jsx(Z,{className:"h-5 w-5 text-purple-600 dark:text-purple-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold",children:"Planning & Scheduling"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Strategic field operations planning"})]})]})}),e.jsxs(te,{value:t,onValueChange:h,className:"w-full",children:[e.jsxs(ae,{className:"grid w-full grid-cols-4 max-w-3xl h-auto p-1 bg-muted/30",children:[e.jsxs(O,{value:"calendar",className:"gap-1.5 data-[state=active]:bg-background data-[state=active]:shadow-sm",children:[e.jsx(Z,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-xs",children:"Calendar"})]}),e.jsxs(O,{value:"site-visits",className:"gap-1.5 data-[state=active]:bg-background data-[state=active]:shadow-sm",children:[e.jsx(z,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-xs",children:"Site Visits"})]}),e.jsxs(O,{value:"mmps",className:"gap-1.5 data-[state=active]:bg-background data-[state=active]:shadow-sm",children:[e.jsx(Bs,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-xs",children:"MMPs"})]}),e.jsxs(O,{value:"forwarded",className:"gap-1.5 data-[state=active]:bg-background data-[state=active]:shadow-sm",children:[e.jsx(Ws,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-xs",children:"Forwarded"})]})]}),e.jsx(_,{value:"calendar",className:"mt-4",children:e.jsx(vs,{})}),e.jsxs(_,{value:"site-visits",className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Planned Site Visits"}),e.jsxs(V,{variant:"outline",size:"sm",onClick:()=>c(!a),"data-testid":"button-toggle-map",className:"h-8 text-xs gap-1.5",children:[e.jsx(z,{className:"h-3.5 w-3.5"}),a?"Hide Map":"Show Map"]})]}),a&&e.jsx(Kt,{siteVisits:r||[],teamMembers:l||[]}),e.jsx(Xt,{siteVisits:r||[]})]}),e.jsx(_,{value:"mmps",className:"mt-4",children:e.jsx(Zt,{})}),e.jsx(_,{value:"forwarded",className:"mt-4",children:e.jsx(Gt,{})})]})]})},sa=({recentTransactions:t,unusualPatterns:h,highValueTransactions:a})=>{const[c,r]=w.useState(!1),[l,n]=w.useState(0);w.useEffect(()=>{let d=20;h&&(d+=30),a&&(d+=40);const u=setInterval(()=>{n(s=>s<d?s+1:s)},30);return()=>clearInterval(u)},[h,a]),w.useEffect(()=>{if(h||a){r(!0);const d=setTimeout(()=>r(!1),2e3);return()=>clearTimeout(d)}},[h,a]);const o=()=>l>60?"text-red-500":l>30?"text-amber-500":"text-green-500",i=()=>l>60?"border-t-red-500":l>30?"border-t-amber-500":"border-t-green-500";return e.jsxs(L,{className:`overflow-hidden border-t-4 transition-all hover:shadow-md ${i()} ${c?"shadow-lg":""}`,children:[e.jsx(U,{className:"bg-slate-50 pb-2",children:e.jsxs(B,{className:"flex items-center gap-2 text-xl",children:[e.jsx(_e,{className:`h-5 w-5 ${o()}`}),"Fraud Detection Monitor"]})}),e.jsx(R,{className:"pt-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"Risk Score"}),e.jsx("span",{className:`text-sm font-bold ${o()}`,children:l})]}),e.jsx(me,{value:l,max:100,className:"h-2",indicatorClassName:l>60?"bg-red-500":l>30?"bg-amber-500":"bg-green-500"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[e.jsx("span",{children:"Low"}),e.jsx("span",{children:"Medium"}),e.jsx("span",{children:"High"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-slate-50 p-2 rounded-md",children:[e.jsx(J,{className:"h-4 w-4 text-blue-500"}),e.jsxs("span",{className:"font-medium",children:["Recent Transactions: ",t]})]}),h&&e.jsxs("div",{className:`flex items-center gap-2 bg-amber-50 p-2 rounded-md ${c?"animate-pulse":""}`,children:[e.jsx(We,{className:"h-4 w-4 text-amber-500"}),e.jsx("span",{className:"font-medium",children:"Unusual transaction patterns detected"})]}),a&&e.jsxs("div",{className:`flex items-center gap-2 bg-red-50 p-2 rounded-md ${c?"animate-pulse":""}`,children:[e.jsx(_s,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium",children:"High-value transactions requiring review"})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-blue-50 p-2 rounded-md",children:[e.jsx(Hs,{className:"h-4 w-4 text-blue-600"}),e.jsxs("span",{className:"font-medium",children:["Fraud trend: ",h||a?"↑ Increasing":"↓ Decreasing"]})]}),e.jsxs(V,{variant:"outline",className:"w-full group",children:["View Detailed Analysis",e.jsx(ps,{className:"h-4 w-4 ml-1 transition-transform group-hover:translate-x-1"})]})]})})]})},ta=({className:t})=>{const{transactions:h}=ne(),{recentCount:a,hasUnusualPatterns:c,hasHighValue:r}=w.useMemo(()=>{const n=Date.now()-24*60*60*1e3,o=(h||[]).filter(x=>{const m=new Date(x.createdAt).getTime();return!Number.isNaN(m)&&m>=n}),i=o.some(x=>(x.amount||0)>=1e3),d={};o.forEach(x=>{const m=new Date(x.createdAt).getTime();d[x.userId]||(d[x.userId]=[]),d[x.userId].push(m)});const u=Object.values(d).some(x=>{x.sort((m,b)=>m-b);for(let m=0;m+2<x.length;m++)if(x[m+2]-x[m]<=10*60*1e3)return!0;return!1}),s=o.length>0?o.filter(x=>x.status==="disputed"||x.status==="failed").length/o.length:0;return{recentCount:o.length,hasUnusualPatterns:u||s>=.1,hasHighValue:i}},[h]);return e.jsx("div",{className:oe("w-full",t),children:e.jsx(sa,{recentTransactions:a,unusualPatterns:c,highValueTransactions:r})})},aa=({className:t})=>e.jsx("div",{className:oe("w-full",t),children:e.jsx(wt,{suspiciousTransactionsCount:8,blockedTransactionsCount:3,highRiskAccountsCount:2})}),na=()=>{const[t,h]=w.useState("detection"),{mmpFiles:a}=Ns(),c=(a==null?void 0:a.length)||0,r=(a==null?void 0:a.filter(o=>o.status==="approved").length)||0,l=(a==null?void 0:a.filter(o=>o.status==="pending").length)||0,n=c>0?Math.round(r/c*100):0;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-lg border border-border/50 bg-gradient-to-r from-red-500/5 via-orange-500/5 to-background p-4 shadow-sm",children:[e.jsxs("div",{className:"relative z-10 flex items-center justify-between flex-wrap gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 rounded-lg bg-red-500/10 border border-red-500/20",children:e.jsx(_e,{className:"h-6 w-6 text-red-600 dark:text-red-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:"Compliance & Risk"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase tracking-wide",children:"Fraud detection and compliance monitoring"})]})]}),e.jsxs(S,{variant:n>=80?"default":"destructive",className:"gap-2 h-7 text-xs",children:[e.jsx(js,{className:"h-3 w-3"}),n,"% Compliance"]})]}),e.jsx("div",{className:"absolute inset-0 bg-grid-pattern opacity-5"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(L,{children:[e.jsx(U,{className:"pb-2",children:e.jsx(B,{className:"text-sm font-medium text-muted-foreground",children:"Approved MMPs"})}),e.jsxs(R,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600 dark:text-green-400",children:r}),e.jsx(me,{value:n,className:"mt-2"})]})]}),e.jsxs(L,{children:[e.jsx(U,{className:"pb-2",children:e.jsx(B,{className:"text-sm font-medium text-muted-foreground",children:"Pending Review"})}),e.jsxs(R,{children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600 dark:text-orange-400",children:l}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Awaiting approval"})]})]}),e.jsxs(L,{children:[e.jsx(U,{className:"pb-2",children:e.jsx(B,{className:"text-sm font-medium text-muted-foreground",children:"Total MMPs"})}),e.jsxs(R,{children:[e.jsx("div",{className:"text-2xl font-bold",children:c}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"All monitoring plans"})]})]})]}),e.jsxs(te,{value:t,onValueChange:h,className:"w-full",children:[e.jsxs(ae,{className:"grid w-full grid-cols-2 max-w-md",children:[e.jsxs(O,{value:"detection",className:"gap-2",children:[e.jsx(We,{className:"h-4 w-4"}),"Detection"]}),e.jsxs(O,{value:"prevention",className:"gap-2",children:[e.jsx(Qs,{className:"h-4 w-4"}),"Prevention"]})]}),e.jsx(_,{value:"detection",className:"mt-4",children:e.jsx(ta,{})}),e.jsx(_,{value:"prevention",className:"mt-4",children:e.jsx(aa,{})})]})]})},Ee=({title:t,progress:h,target:a,unit:c="",category:r="Default"})=>{const l=Math.min(Math.round(h/a*100),100),o=(i=>{switch(i.toLowerCase()){case"visits":return{bg:"bg-emerald-500",light:"bg-emerald-100"};case"compliance":return{bg:"bg-blue-500",light:"bg-blue-100"};case"team":return{bg:"bg-violet-500",light:"bg-violet-100"};case"fraud":return{bg:"bg-amber-500",light:"bg-amber-100"};default:return{bg:"bg-primary",light:"bg-primary/20"}}})(r);return e.jsxs("div",{className:"space-y-2 py-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:`h-6 w-6 rounded-full ${o.light} flex items-center justify-center`,children:[r.toLowerCase()==="visits"&&e.jsx(z,{className:"h-3 w-3 text-emerald-600"}),r.toLowerCase()==="compliance"&&e.jsx(es,{className:"h-3 w-3 text-blue-600"}),r.toLowerCase()==="team"&&e.jsx(he,{className:"h-3 w-3 text-violet-600"}),r.toLowerCase()==="fraud"&&e.jsx(Zs,{className:"h-3 w-3 text-amber-600"}),!["visits","compliance","team","fraud"].includes(r.toLowerCase())&&e.jsx(Gs,{className:"h-3 w-3 text-primary"})]}),e.jsx("span",{className:"text-sm font-medium",children:t})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[l>=80&&e.jsx(De,{className:"h-4 w-4 text-amber-400"}),l>=50&&l<80&&e.jsx(qs,{className:"h-4 w-4 text-emerald-500"}),e.jsxs("span",{className:"text-sm font-medium",children:[h,c," / ",a,c]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(me,{value:l,className:"h-2",indicatorClassName:o.bg}),l>=100&&e.jsx(xe.div,{initial:{scale:0},animate:{scale:[0,1.2,1]},transition:{duration:.5},className:"absolute -right-1 -top-1 bg-amber-400 rounded-full h-4 w-4 flex items-center justify-center",children:e.jsx(es,{className:"h-2.5 w-2.5 text-white"})})]})]})},ra=()=>{const[t,h]=w.useState("weekly"),{siteVisits:a,mmpFiles:c,users:r}=ne(),{projects:l}=Ge(),n=m=>m==="weekly"?mt(new Date):m==="monthly"?ws(new Date):xt(new Date),o=(m,b)=>{if(!m||!b)return!1;const j=new Date(m);return!isNaN(j.getTime())&&j>=b},i=m=>Math.max(0,Math.min(100,Math.round(m))),d=w.useMemo(()=>{const m=[];(a||[]).forEach(j=>{var g;[j.createdAt,j.assignedAt,j.completedAt,j.dueDate,(g=j==null?void 0:j.permitDetails)==null?void 0:g.verifiedAt].filter(Boolean).forEach(v=>m.push(new Date(v).getTime()))}),(c||[]).forEach(j=>{[j.createdAt,j.uploadedAt,j.modifiedAt,j.approvedAt].filter(Boolean).forEach(g=>m.push(new Date(g).getTime()))}),(l||[]).forEach(j=>{[j.createdAt,j.updatedAt].filter(Boolean).forEach(g=>m.push(new Date(g).getTime())),(j.activities||[]).forEach(g=>{[g.startDate,g.endDate].filter(Boolean).forEach(v=>m.push(new Date(v).getTime()))})});const b=m.length?new Date(Math.max(...m)):void 0;return b?ce(b,{addSuffix:!0}):"just now"},[a,c,l]),u=w.useMemo(()=>{const m=n("weekly"),b=(a||[]).filter(P=>o(P.completedAt,m)).length,j=(a||[]).filter(P=>o(P.dueDate,m)).length,g=Math.max(j||0,b||0,1),v=(c||[]).filter(P=>o(P.createdAt||P.uploadedAt,m)),f=v.filter(P=>!!P.approvedAt||String(P.status||"").toLowerCase()==="approved"),y=v.length>0?i(f.length/v.length*100):(()=>{const P=(c||[]).length,W=(c||[]).filter(F=>String(F.status||"").toLowerCase()==="approved").length;return P>0?i(W/P*100):0})(),C=(r||[]).length||1,k=(r||[]).filter(P=>P.availability!=="offline"&&o(P.lastActive,m)).length,I=i(k/C*100);return[{title:"Site Visits Completed",progress:b,target:g,category:"visits"},{title:"Compliance Rate",progress:y,target:100,unit:"%",category:"compliance"},{title:"Team Activity Rate",progress:I,target:100,unit:"%",category:"team"}]},[a,c,r]),s=w.useMemo(()=>{const m=n("monthly"),b=(a||[]).filter(F=>o(F.completedAt,m)).length,j=(a||[]).filter(F=>o(F.dueDate,m)).length,g=Math.max(j||0,b||0,1),v=(c||[]).filter(F=>o(F.createdAt||F.uploadedAt,m)),f=v.filter(F=>!!F.approvedAt||String(F.status||"").toLowerCase()==="approved").length,y=v.filter(F=>String(F.status||"").toLowerCase()==="rejected").length,C=v.length>0?i(f/v.length*100):0,k=v.length>0?i(y/v.length*100):0,I=(r||[]).length||1,P=(r||[]).filter(F=>F.availability!=="offline"&&o(F.lastActive,m)).length,W=i(P/I*100);return[{title:"Site Visits Completed",progress:b,target:g,category:"visits"},{title:"Compliance Rate",progress:C,target:100,unit:"%",category:"compliance"},{title:"Rejection Rate",progress:k,target:100,unit:"%",category:"fraud"},{title:"Team Activity Rate",progress:W,target:100,unit:"%",category:"team"}]},[a,c,r]),x=w.useMemo(()=>{const m=n("quarterly");let b=0,j=0;(l||[]).forEach(D=>{(D.activities||[]).forEach(Q=>{o(Q.endDate||Q.startDate,m)&&(j+=1,String(Q.status||"").toLowerCase()==="completed"&&(b+=1))})});const g=Math.max(j||0,b||0,1),v=(a||[]).filter(D=>o(D.createdAt||D.dueDate,m)),f=v.filter(D=>{var Q;return o((Q=D==null?void 0:D.permitDetails)==null?void 0:Q.verifiedAt,m)}).length,y=Math.max(v.length||0,1),C=i(f/y*100),k=(c||[]).filter(D=>o(D.createdAt||D.uploadedAt,m)),I=k.filter(D=>String(D.status||"").toLowerCase()==="rejected").length,P=k.length>0?i(100-I/k.length*100):100,W=(a||[]).filter(D=>o(D.completedAt,m)&&typeof D.rating=="number"),F=W.length?W.reduce((D,Q)=>D+(Q.rating||0),0)/W.length:0,$=i(F/5*100),p=(a||[]).filter(D=>o(D.completedAt,m)),N=p.filter(D=>(D==null?void 0:D.attachments)&&D.attachments.length>0||(D==null?void 0:D.notes)&&String(D.notes).trim().length>0).length,T=p.length>0?i(N/p.length*100):0;return[{title:"Project Completion",progress:b,target:g,category:"visits"},{title:"Compliance Audits",progress:C,target:100,unit:"%",category:"compliance"},{title:"Fraud Prevention Score",progress:P,target:100,unit:"%",category:"fraud"},{title:"Team Performance",progress:$,target:100,unit:"%",category:"team"},{title:"Documentation Quality",progress:T,target:100,unit:"%",category:"compliance"}]},[l,a,c]);return e.jsxs(L,{className:"border-t-4 border-t-amber-500 hover:shadow-md transition-all duration-300",children:[e.jsxs(U,{className:"bg-gradient-to-r from-amber-50 to-transparent flex flex-row items-center justify-between",children:[e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(De,{className:"h-5 w-5 text-amber-500"}),"Achievement Tracker"]}),e.jsx(te,{defaultValue:"weekly",value:t,onValueChange:h,className:"w-auto",children:e.jsxs(ae,{className:"grid grid-cols-3 h-7",children:[e.jsx(O,{value:"weekly",className:"text-xs px-2",children:"Weekly"}),e.jsx(O,{value:"monthly",className:"text-xs px-2",children:"Monthly"}),e.jsx(O,{value:"quarterly",className:"text-xs px-2",children:"Quarterly"})]})})]}),e.jsx(R,{className:"p-4",children:e.jsxs(xe.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Z,{className:"h-3.5 w-3.5"}),e.jsxs("span",{children:[t==="weekly"&&"This Week",t==="monthly"&&"This Month",t==="quarterly"&&"This Quarter"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ys,{className:"h-3.5 w-3.5"}),e.jsxs("span",{children:["Updated ",d]})]})]}),e.jsxs("div",{className:"space-y-4",children:[t==="weekly"&&u.map((m,b)=>e.jsx(Ee,{title:m.title,progress:m.progress,target:m.target,unit:m.unit,category:m.category},`weekly-${b}`)),t==="monthly"&&s.map((m,b)=>e.jsx(Ee,{title:m.title,progress:m.progress,target:m.target,unit:m.unit,category:m.category},`monthly-${b}`)),t==="quarterly"&&x.map((m,b)=>e.jsx(Ee,{title:m.title,progress:m.progress,target:m.target,unit:m.unit,category:m.category},`quarterly-${b}`))]})]},t)})]})},la=({className:t})=>{const{mmpFiles:h,siteVisits:a,users:c}=ne(),{projects:r}=Ge(),l=u=>{if(!u)return;const s=(c||[]).find(x=>x.id===u);return(s==null?void 0:s.name)||(s==null?void 0:s.fullName)||(s==null?void 0:s.username)||u},n=u=>{if(!u)return;const s=String(u).toLowerCase();return["approved","completed","archived","verified"].includes(s)?"completed":["rejected","critical","error","failed"].includes(s)?"critical":"pending"},o=w.useMemo(()=>{const u=[];try{(h||[]).forEach(s=>{const x=(s==null?void 0:s.uploadedAt)||(s==null?void 0:s.createdAt)||(s==null?void 0:s.modifiedAt);x&&u.push({id:`mmp-upload-${s.id}`,title:`MMP Upload: ${(s==null?void 0:s.name)||(s==null?void 0:s.originalFilename)||(s==null?void 0:s.mmpId)||(s==null?void 0:s.id)}`,description:`Status: ${(s==null?void 0:s.status)||"pending"}`,type:"upload",timestamp:x,status:n(s==null?void 0:s.status),user:(s==null?void 0:s.uploadedBy)||void 0}),s!=null&&s.approvedAt&&u.push({id:`mmp-approval-${s.id}`,title:`MMP Approved: ${(s==null?void 0:s.name)||(s==null?void 0:s.mmpId)||(s==null?void 0:s.id)}`,description:s!=null&&s.approvedBy?`Approved by ${l(s.approvedBy)}`:"Approved",type:"approval",timestamp:s.approvedAt,status:"completed",user:l(s==null?void 0:s.approvedBy)})}),(a||[]).forEach(s=>{const x=[s==null?void 0:s.completedAt,s==null?void 0:s.assignedAt,s==null?void 0:s.createdAt,s==null?void 0:s.dueDate].filter(Boolean);if(x.length===0)return;const m=x.sort((y,C)=>new Date(C).getTime()-new Date(y).getTime())[0];let b=`Site Visit: ${(s==null?void 0:s.siteName)||(s==null?void 0:s.siteCode)||"Unknown"}`,j=`${(s==null?void 0:s.state)||""}${s!=null&&s.state&&(s!=null&&s.locality)?", ":""}${(s==null?void 0:s.locality)||""}`.trim(),g=n(s==null?void 0:s.status),v="visit",f;s!=null&&s.completedAt&&m===s.completedAt?(b=`Site Visit Completed: ${(s==null?void 0:s.siteName)||(s==null?void 0:s.siteCode)||"Unknown"}`,g="completed",f=l(s==null?void 0:s.assignedTo)):s!=null&&s.assignedAt&&m===s.assignedAt?(b=`Site Visit Assigned: ${(s==null?void 0:s.siteName)||(s==null?void 0:s.siteCode)||"Unknown"}`,j=`Assigned to ${l(s==null?void 0:s.assignedTo)||"team"}`,g="pending",f=l(s==null?void 0:s.assignedTo)):s!=null&&s.createdAt&&m===s.createdAt?(b=`Site Visit Created: ${(s==null?void 0:s.siteName)||(s==null?void 0:s.siteCode)||"Unknown"}`,g="pending"):s!=null&&s.dueDate&&m===s.dueDate&&(b=`Scheduled Site Visit: ${(s==null?void 0:s.siteName)||(s==null?void 0:s.siteCode)||"Unknown"}`,v="reminder",g="pending"),u.push({id:`site-visit-${s==null?void 0:s.id}`,title:b,description:j,type:v,timestamp:m,status:g,user:f})}),(r||[]).forEach(s=>{((s==null?void 0:s.activities)||[]).forEach(x=>{const m=(x==null?void 0:x.startDate)||(x==null?void 0:x.endDate);if(!m)return;const b=(x==null?void 0:x.status)==="completed"?"completed":(x==null?void 0:x.status)==="cancelled"?"critical":"pending";u.push({id:`project-activity-${x==null?void 0:x.id}`,title:`Project Activity: ${(x==null?void 0:x.name)||"Activity"}`,description:`${(s==null?void 0:s.name)||"Project"} • Status: ${(x==null?void 0:x.status)||"pending"}`,type:"reminder",timestamp:m,status:b,user:void 0})})})}catch{}return u.filter(s=>!!s.timestamp).sort((s,x)=>new Date(x.timestamp).getTime()-new Date(s.timestamp).getTime()).slice(0,30)},[h,a,r,c]),i=(u,s)=>{switch(u){case"approval":return e.jsx(js,{className:"h-5 w-5 text-blue-500"});case"upload":return e.jsx(Se,{className:"h-5 w-5 text-purple-500"});case"visit":return e.jsx(z,{className:"h-5 w-5 text-green-500"});case"reminder":return e.jsx(Z,{className:"h-5 w-5 text-amber-500"});case"alert":return e.jsx(ue,{className:"h-5 w-5 text-red-500"});default:return e.jsx(q,{className:"h-5 w-5 text-gray-500"})}},d=u=>{if(!u)return null;switch(u){case"pending":return e.jsx(S,{className:"bg-amber-100 text-amber-800 hover:bg-amber-200",children:"Pending"});case"completed":return e.jsx(S,{className:"bg-green-100 text-green-800 hover:bg-green-200",children:"Completed"});case"critical":return e.jsx(S,{className:"bg-red-100 text-red-800 hover:bg-red-200 animate-pulse",children:"Critical"});default:return null}};return e.jsxs(L,{className:oe("border-t-4 border-t-blue-500 overflow-hidden transition-all hover:shadow-md",t),children:[e.jsx(U,{className:"bg-slate-50 pb-2",children:e.jsxs(B,{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2 text-xl",children:[e.jsx(q,{className:"h-5 w-5 text-primary"}),"Activity Feed"]}),e.jsx(V,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full",children:e.jsx(ss,{className:"h-4 w-4"})})]})}),e.jsx(R,{className:"p-0",children:e.jsx(Ae,{className:"h-[350px]",children:e.jsx("div",{className:"p-4 space-y-4",children:o.map((u,s)=>e.jsxs(xe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:s*.1},className:"flex gap-3 group hover:bg-slate-50 p-2 rounded-md transition-colors",children:[e.jsx("div",{className:"mt-0.5",children:e.jsx("div",{className:"h-10 w-10 rounded-full bg-blue-50 flex items-center justify-center",children:i(u.type,u.status)})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h4",{className:"font-medium text-sm",children:u.title}),d(u.status)]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:u.description}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(q,{className:"h-3 w-3"}),e.jsx("span",{children:u.timestamp?ce(new Date(u.timestamp),{addSuffix:!0}):""}),u.user&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsx("span",{children:u.user})]})]})]}),e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(V,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full",children:e.jsx(ss,{className:"h-4 w-4"})})})]},u.id))})})})]})},ia=()=>{const[t,h]=w.useState(["all"]);return e.jsx(R,{className:"p-4 h-[350px] ",children:e.jsx(la,{})})},ca=()=>{const[t,h]=w.useState("achievements"),{roles:a}=ne(),{siteVisits:c}=ie();a==null||a.some(l=>l.toLowerCase()==="admin"||l.toLowerCase()==="financialadmin");const r=(c==null?void 0:c.filter(l=>{const n=l.completedAt?new Date(l.completedAt):null;return n&&n>=ws(new Date)}).length)||0;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-lg border border-border/50 bg-gradient-to-r from-purple-500/5 via-pink-500/5 to-background p-4 shadow-sm",children:[e.jsxs("div",{className:"relative z-10 flex items-center justify-between flex-wrap gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 rounded-lg bg-purple-500/10 border border-purple-500/20",children:e.jsx(He,{className:"h-6 w-6 text-purple-600 dark:text-purple-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:"Performance & Analytics"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase tracking-wide",children:"Goals, achievements, and activity tracking"})]})]}),e.jsxs(S,{variant:"secondary",className:"gap-2 h-7 text-xs",children:[e.jsx(De,{className:"h-3 w-3"}),r," This Month"]})]}),e.jsx("div",{className:"absolute inset-0 bg-grid-pattern opacity-5"})]}),e.jsxs(te,{value:t,onValueChange:h,className:"w-full",children:[e.jsxs(ae,{className:"grid w-full grid-cols-2 max-w-md h-auto p-1 bg-muted/30",children:[e.jsxs(O,{value:"achievements",className:"gap-1.5 data-[state=active]:bg-background data-[state=active]:shadow-sm",children:[e.jsx(De,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-xs",children:"Achievements"})]}),e.jsxs(O,{value:"activity",className:"gap-1.5 data-[state=active]:bg-background data-[state=active]:shadow-sm",children:[e.jsx(J,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-xs",children:"Activity Feed"})]})]}),e.jsx(_,{value:"achievements",className:"mt-4",children:e.jsx(ra,{})}),e.jsx(_,{value:"activity",className:"mt-4",children:e.jsxs(L,{children:[e.jsx(U,{children:e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-5 w-5 text-primary"}),"Recent Activity"]})}),e.jsx(ia,{})]})})]})]})},Fa=()=>{const{SiteVisitRemindersDialog:t,showDueReminders:h}=yt(),{roles:a}=ne(),c=w.useMemo(()=>"operations",[a]),[r,l]=w.useState(c);w.useEffect(()=>{h()},[h]);const n=()=>{switch(r){case"operations":return e.jsx(ds,{});case"team":return e.jsx(Qt,{});case"planning":return e.jsx(ea,{});case"compliance":return e.jsx(na,{});case"performance":return e.jsx(ca,{});default:return e.jsx(ds,{})}};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(Pt,{activeZone:r,onZoneChange:l,children:n()}),t,e.jsx(At,{}),e.jsx(St,{})]})};export{Fa as default};
