import{r as o,j as e,R as S,ah as Te,v as Pe,aM as Ae,b6 as ke,I as Ee,q as W,Y as Le,ae as Ve}from"./react-core-B8kFjp2k.js";import{E as Fe,J as Ie,u as Re,U as Oe,Z as Ue,C as h,f as u,g as j,h as f,b as p,a as D,T as Be,i as Ke,j as O,k as U,I as _e,B as k}from"./index-PwDgWEVM.js";import{S as ee,a as se,b as te,c as ae,d as g}from"./select-CXX5Q_V1.js";import{T as $e,a as ze,b as ne,c,d as He,e as d}from"./table-CZ8ZB6wW.js";import{P as b}from"./progress-vMwTbqUI.js";import{P as Ye,a as Qe,b as w,c as Xe,d as B,f as Ge,e as qe}from"./pagination-wW-pUaO1.js";import"./docs-D2Yi4cpO.js";import{D as Je}from"./DynamicFieldTeamMap-CKDMcIOA.js";import{bo as Ze}from"./vendor-VlxgVHMv.js";import{R as ie,B as We,b as le,X as re,Y as ce,T as de,L as es,c as K,S as ss,r as ts,C as as}from"./charts-B79l2W3h.js";import{o as C}from"./date-utils-YarVESQS.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./router-CKy9yO3R.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";import"./maps-BzFQ_kYT.js";import"./locationUtils-B4o8Dh43.js";import"./sudanStates-CkkbYUnU.js";const Is=()=>{const{currentUser:ns,users:M,refreshUsers:_}=Fe(),{siteVisits:v}=Ie(),[oe,me]=o.useState("integrated-view"),{toast:E}=Re(),[is,ls]=o.useState(0),[m,xe]=o.useState(v||[]),[$,z]=o.useState(!1),[H,Y]=o.useState(null),{mmpFiles:N}=Oe(),[rs,cs]=o.useState("all"),[he,ue]=o.useState("all"),[L,je]=o.useState("all"),[V,pe]=o.useState(""),[ds,os]=o.useState(!0),fe=Ze(),{checkPermission:ge,hasAnyRole:Ne}=Ue();if(!(ge("reports","read")||Ne(["admin"])))return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs(h,{className:"w-full max-w-md",children:[e.jsxs(u,{children:[e.jsx(j,{className:"text-destructive",children:"Access Denied"}),e.jsx(f,{children:"You don't have permission to access this page."})]}),e.jsx(p,{children:e.jsx(D,{variant:"outline",onClick:()=>window.history.back(),className:"w-full",children:"Go Back"})})]})});o.useEffect(()=>{v&&v.length>0&&xe(v)},[v]),o.useEffect(()=>{let s=!0;return(async()=>{try{z(!0),Y(null),await _()}catch(t){if(!s)return;Y((t==null?void 0:t.message)||"Failed to load users")}finally{if(!s)return;z(!1)}})(),()=>{s=!1}},[_]);const Q=s=>{const t=s==null?void 0:s.latitude,a=s==null?void 0:s.longitude;return typeof t=="number"&&typeof a=="number"&&Number.isFinite(t)&&Number.isFinite(a)&&!(t===0&&a===0)},ve=S.useMemo(()=>{const s=t=>{const a=((t==null?void 0:t.role)||"").toString(),i=a==="dataCollector"||a.toLowerCase()==="datacollector",n=Array.isArray(t==null?void 0:t.roles)&&t.roles.some(l=>l==="dataCollector"||typeof l=="string"&&l.toLowerCase()==="datacollector");return i||n};return(M||[]).filter(t=>s(t)&&Q(t.location))},[M]),X=S.useCallback(s=>{if(!s)return"—";const t=(M||[]).find(a=>a.id===s);return(t==null?void 0:t.name)||(t==null?void 0:t.fullName)||(t==null?void 0:t.username)||s},[M]),G=m.filter(s=>{const t=s.siteName.toLowerCase().includes(V.toLowerCase())||s.location.address.toLowerCase().includes(V.toLowerCase()),a=L==="all"||s.status===L;return t&&a}),ye=S.useMemo(()=>{const s={},t=new Date;return(m||[]).forEach(a=>{var x;const i=(x=a==null?void 0:a.mmpDetails)==null?void 0:x.mmpId,n=(N||[]).find(y=>y.id===i),l=(n==null?void 0:n.projectName)||(n==null?void 0:n.name)||"Unassigned";if(s[l]||(s[l]={name:l,complete:0,pending:0,overdue:0}),a.status==="completed")s[l].complete+=1;else{const y=a.dueDate?new Date(a.dueDate):void 0;!!(y&&y.getTime()<t.getTime())?s[l].overdue+=1:s[l].pending+=1}}),Object.values(s).sort((a,i)=>i.complete+i.pending+i.overdue-(a.complete+a.pending+a.overdue)).slice(0,8)},[m,N]),q=S.useMemo(()=>{const s=new Map;(m||[]).forEach(a=>{const i=a.state||"Unknown",n=s.get(i)||{name:i,visits:0,completed:0};n.visits+=1,a.status==="completed"&&(n.completed+=1),s.set(i,n)});const t=["#10b981","#a3e635","#fbbf24","#f87171","#60a5fa","#f472b6","#34d399","#f59e0b","#ef4444","#6366f1"];return Array.from(s.values()).map((a,i)=>{const n=a.visits?Math.round(a.completed/a.visits*100):0;return{name:a.name,value:n,visits:a.visits,completed:a.completed,x:a.visits,y:a.completed,color:t[i%t.length]}})},[m]),T=S.useMemo(()=>{const s=m.length||0,t=m.filter(r=>r.status==="completed"),a=t.length,i=t.filter(r=>r.dueDate&&r.completedAt&&new Date(r.completedAt)<=new Date(r.dueDate)).length,n=a>0?Math.round(i/a*100):0,l=s>0?Math.round(a/s*100):0,x=m.filter(r=>{const P=!!(r.notes&&r.notes.trim().length>0),A=Array.isArray(r.attachments)&&r.attachments.length>0,R=Q(r.coordinates);return P||A||R}).length,y=s>0?Math.round(x/s*100):0,Z=m.filter(r=>{var A;const P=(A=r==null?void 0:r.mmpDetails)==null?void 0:A.mmpId;return P?(N||[]).some(R=>R.id===P):!1}).length,Me=s>0?Math.round(Z/s*100):0;return{onTimeRate:n,siteCoverage:l,dataQuality:y,projectAlignment:Me}},[m,N]),J=(s,t=[])=>{t.length===0&&s.length>0&&(t=Object.keys(s[0]));let a=t.join(",")+`
`;return s.forEach(i=>{const n=t.map(l=>{const x=i[l]||"";return typeof x=="string"&&(x.includes(",")||x.includes('"'))?`"${x.replace(/"/g,'""')}"`:x}).join(",");a+=n+`
`}),a},F=(s,t,a)=>{const i=new Blob([s],{type:a}),n=URL.createObjectURL(i),l=document.createElement("a");l.href=n,l.download=t,document.body.appendChild(l),l.click(),setTimeout(()=>{document.body.removeChild(l),URL.revokeObjectURL(n)},100)},be=s=>J(s),we=s=>{let t=`PDF EXPORT

`;if(s.length>0){const a=Object.keys(s[0]);t+=a.join("	")+`
`,s.forEach(i=>{t+=a.map(n=>i[n]||"").join("	")+`
`})}return t},I=()=>G.map(s=>{var t;return{siteName:s.siteName,linkedMMP:((t=(N||[]).find(a=>a.id===s.mmpDetails.mmpId))==null?void 0:t.projectName)||"-",location:s.location.address,status:s.status,assignedTo:X(s.assignedTo),scheduledDate:C(new Date(s.scheduledDate),"yyyy-MM-dd"),dueDate:C(new Date(s.dueDate),"yyyy-MM-dd")}}),Ce=()=>{const s=`integrated_module_data_${C(new Date,"yyyy-MM-dd")}.xlsx`,t=I(),a=be(t);F(a,s,"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"),E({title:"Export Successful",description:`Data has been exported to ${s}`})},Se=()=>{const s=`integrated_module_data_${C(new Date,"yyyy-MM-dd")}.pdf`,t=I(),a=we(t);F(a,s,"application/pdf"),E({title:"Export Successful",description:`Data has been exported to ${s}`})},De=()=>{const s=`integrated_module_data_${C(new Date,"yyyy-MM-dd")}.csv`,t=I(),a=J(t);F(a,s,"text/csv"),E({title:"Export Successful",description:`Data has been exported to ${s}`})};return e.jsxs("div",{className:"container mx-auto p-4 space-y-6 max-w-full overflow-x-hidden min-w-0",children:[e.jsx("div",{className:"flex items-center mb-6",children:e.jsxs(D,{variant:"outline",size:"sm",className:"mr-4",onClick:()=>fe("/dashboard"),children:[e.jsx(Te,{className:"h-4 w-4 mr-2"}),"Back"]})}),e.jsxs(Be,{value:oe,onValueChange:me,className:"w-full overflow-x-hidden min-w-0",children:[e.jsxs(Ke,{className:"grid grid-cols-1 md:grid-cols-3",children:[e.jsx(O,{value:"integrated-view",children:"Integrated Module View"}),e.jsx(O,{value:"reporting",children:"Reporting & Trends"}),e.jsx(O,{value:"compliance",children:"Audit & Compliance"})]}),e.jsxs(U,{value:"integrated-view",className:"space-y-4",children:[e.jsxs(h,{className:"overflow-hidden min-w-0",children:[e.jsxs(u,{children:[e.jsx(j,{children:"Site Visits & Data Collectors Map"}),e.jsx(f,{children:"Interactive map showing site visits and active data collectors"})]}),e.jsxs(p,{className:"p-0 overflow-hidden",children:[e.jsx(Je,{siteVisits:v,eligibleCollectors:ve,height:"500px"}),($||H)&&e.jsx("div",{className:"px-4 py-2 text-xs text-muted-foreground",children:$?"Loading team locations…":H})]})]}),e.jsxs(h,{className:"min-w-0",children:[e.jsxs(u,{children:[e.jsx(j,{children:"Site Visits & MMP Integration"}),e.jsx(f,{children:"View relationship between site visits and MMPs projects in real-time"})]}),e.jsxs(p,{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"grid flex-1 items-center gap-1.5",children:[e.jsx("label",{htmlFor:"search",className:"text-sm text-muted-foreground",children:"Search"}),e.jsxs("div",{className:"relative",children:[e.jsx(Pe,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(_e,{id:"search",placeholder:"Search sites, projects...",className:"pl-8",value:V,onChange:s=>pe(s.target.value)})]})]}),e.jsxs("div",{className:"grid flex-1 items-center gap-1.5",children:[e.jsx("label",{htmlFor:"region",className:"text-sm text-muted-foreground",children:"Region"}),e.jsxs(ee,{value:he,onValueChange:ue,children:[e.jsx(se,{id:"region",children:e.jsx(te,{placeholder:"All regions"})}),e.jsxs(ae,{children:[e.jsx(g,{value:"all",children:"All regions"}),e.jsx(g,{value:"south-darfur",children:"South Darfur"}),e.jsx(g,{value:"north-kordofan",children:"North Kordofan"}),e.jsx(g,{value:"khartoum",children:"Khartoum"})]})]})]}),e.jsxs("div",{className:"grid flex-1 items-center gap-1.5",children:[e.jsx("label",{htmlFor:"status",className:"text-sm text-muted-foreground",children:"Status"}),e.jsxs(ee,{value:L,onValueChange:je,children:[e.jsx(se,{id:"status",children:e.jsx(te,{placeholder:"All statuses"})}),e.jsxs(ae,{children:[e.jsx(g,{value:"all",children:"All statuses"}),e.jsx(g,{value:"completed",children:"Completed"}),e.jsx(g,{value:"inProgress",children:"In progress"}),e.jsx(g,{value:"pending",children:"Pending"})]})]})]})]}),e.jsx("div",{className:"rounded-lg border overflow-x-auto",children:e.jsxs($e,{children:[e.jsx(ze,{children:e.jsxs(ne,{children:[e.jsx(c,{children:"Site Visit Title"}),e.jsx(c,{children:"Hub"}),e.jsx(c,{children:"State"}),e.jsx(c,{children:"Locality"}),e.jsx(c,{children:"CP Name"}),e.jsx(c,{children:"Main Activity"}),e.jsx(c,{children:"Activity"}),e.jsx(c,{children:"Visit Type"}),e.jsx(c,{children:"Visit Date"}),e.jsx(c,{children:"Linked MMP"}),e.jsx(c,{children:"Status"}),e.jsx(c,{children:"Assigned To"}),e.jsx(c,{children:"Comments"})]})}),e.jsx(He,{children:G.map(s=>{var t;return e.jsxs(ne,{children:[e.jsx(d,{className:"font-medium",children:s.siteName}),e.jsx(d,{children:s.hub||"-"}),e.jsx(d,{children:s.state||"-"}),e.jsx(d,{children:s.locality||"-"}),e.jsx(d,{children:s.cpName||"-"}),e.jsx(d,{children:s.mainActivity||"-"}),e.jsx(d,{children:s.activity||"-"}),e.jsx(d,{children:s.visitTypeRaw||s.visitType||"-"}),e.jsx(d,{children:s.dueDate?C(new Date(s.dueDate),"yyyy-MM-dd"):"-"}),e.jsx(d,{children:((t=(N||[]).find(a=>a.id===s.mmpDetails.mmpId))==null?void 0:t.projectName)||"-"}),e.jsx(d,{children:e.jsx(k,{variant:s.status==="completed"?"default":s.status==="inProgress"?"secondary":"outline",children:s.status==="inProgress"?"In Progress":s.status==="completed"?"Completed":"Pending"})}),e.jsx(d,{children:X(s.assignedTo)}),e.jsx(d,{className:"max-w-[260px] truncate",title:s.notes||"",children:s.notes||"—"})]},s.id)})})]})}),e.jsx(Ye,{children:e.jsxs(Qe,{children:[e.jsx(w,{children:e.jsx(Xe,{href:"#"})}),e.jsx(w,{children:e.jsx(B,{href:"#",isActive:!0,children:"1"})}),e.jsx(w,{children:e.jsx(B,{href:"#",children:"2"})}),e.jsx(w,{children:e.jsx(B,{href:"#",children:"3"})}),e.jsx(w,{children:e.jsx(Ge,{})}),e.jsx(w,{children:e.jsx(qe,{href:"#"})})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsxs(D,{variant:"outline",size:"sm",className:"flex items-center gap-1",onClick:Ce,children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsx("span",{children:"Export Excel"})]}),e.jsxs(D,{variant:"outline",size:"sm",className:"flex items-center gap-1",onClick:Se,children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx("span",{children:"Export PDF"})]}),e.jsxs(D,{variant:"outline",size:"sm",className:"flex items-center gap-1",onClick:De,children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx("span",{children:"Export CSV"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(h,{className:"min-w-0",children:[e.jsxs(u,{children:[e.jsx(j,{children:"Linked Modules"}),e.jsx(f,{children:"Connected data across modules"})]}),e.jsx(p,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-medium",children:"Site Visits"}),e.jsx(k,{variant:"outline",children:m.length})]}),e.jsx(b,{value:100,className:"h-2"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-medium",children:"MMPs"}),e.jsx(k,{variant:"outline",children:(N||[]).length})]}),e.jsx(b,{value:75,className:"h-2"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-medium",children:"Financial Tracking"}),e.jsx(k,{variant:"outline",children:"8"})]}),e.jsx(b,{value:50,className:"h-2"})]})})]}),e.jsxs(h,{children:[e.jsxs(u,{children:[e.jsx(j,{children:"Activity Timeline"}),e.jsx(f,{children:"Recent data updates"})]}),e.jsx(p,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(W,{className:"h-4 w-4 mt-0.5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Site visit completed"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"2 hours ago"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(W,{className:"h-4 w-4 mt-0.5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"New MMP uploaded"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Yesterday"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Le,{className:"h-4 w-4 mt-0.5 text-amber-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Overdue site visit flagged"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"2 days ago"})]})]})]})})]}),e.jsxs(h,{children:[e.jsxs(u,{children:[e.jsx(j,{children:"Data Health"}),e.jsx(f,{children:"Quality metrics"})]}),e.jsx(p,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Completeness"}),e.jsx("span",{children:"94%"})]}),e.jsx(b,{value:94,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Consistency"}),e.jsx("span",{children:"88%"})]}),e.jsx(b,{value:88,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Timeliness"}),e.jsx("span",{children:"76%"})]}),e.jsx(b,{value:76,className:"h-2"})]})]})})]})]})]}),e.jsx(U,{value:"reporting",className:"space-y-4",children:e.jsxs(h,{children:[e.jsxs(u,{children:[e.jsx(j,{children:"Project Execution Overview"}),e.jsx(f,{children:"Comparative analysis of project execution status"})]}),e.jsxs(p,{className:"space-y-6",children:[e.jsx("div",{className:"h-[400px] w-full",children:e.jsx(ie,{width:"100%",height:"100%",children:e.jsxs(We,{data:ye,margin:{top:20,right:30,left:20,bottom:5},children:[e.jsx(le,{strokeDasharray:"3 3"}),e.jsx(re,{dataKey:"name"}),e.jsx(ce,{}),e.jsx(de,{}),e.jsx(es,{}),e.jsx(K,{dataKey:"complete",stackId:"a",fill:"#10b981",name:"Complete"}),e.jsx(K,{dataKey:"pending",stackId:"a",fill:"#f59e0b",name:"Pending"}),e.jsx(K,{dataKey:"overdue",stackId:"a",fill:"#ef4444",name:"Overdue"})]})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold",children:"Key Performance Indicators"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"border rounded p-3",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"On-time Completion"}),e.jsxs("div",{className:"text-2xl font-bold",children:[T.onTimeRate,"%"]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Live"})]}),e.jsxs("div",{className:"border rounded p-3",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Site Coverage"}),e.jsxs("div",{className:"text-2xl font-bold",children:[T.siteCoverage,"%"]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Live"})]}),e.jsxs("div",{className:"border rounded p-3",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Data Quality"}),e.jsxs("div",{className:"text-2xl font-bold",children:[T.dataQuality,"%"]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Live"})]}),e.jsxs("div",{className:"border rounded p-3",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Project Alignment"}),e.jsxs("div",{className:"text-2xl font-bold",children:[T.projectAlignment,"%"]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Live"})]})]})]}),e.jsxs(h,{children:[e.jsx(u,{className:"py-3",children:e.jsx(j,{className:"text-sm font-medium",children:"Site Coverage Analysis"})}),e.jsx(p,{className:"p-0",children:e.jsx("div",{className:"h-[400px] w-full",children:e.jsx(ie,{width:"100%",height:"100%",children:e.jsxs(ss,{margin:{top:20,right:20,bottom:20,left:20},children:[e.jsx(le,{}),e.jsx(re,{type:"number",dataKey:"x",name:"x"}),e.jsx(ce,{type:"number",dataKey:"y",name:"y"}),e.jsx(de,{cursor:{strokeDasharray:"3 3"},content:({active:s,payload:t})=>{if(s&&t&&t.length){const a=t[0].payload;return e.jsxs("div",{className:"bg-white p-2 border rounded shadow-sm",children:[e.jsx("p",{className:"font-medium",children:a.name}),e.jsxs("p",{className:"text-xs",children:["Coverage: ",a.value,"%"]}),e.jsxs("p",{className:"text-xs",children:["Site Visits: ",a.visits]}),e.jsxs("p",{className:"text-xs",children:["Completed: ",a.completed]})]})}return null}}),e.jsx(ts,{name:"Sites",data:q,fill:"#8884d8",children:q.map((s,t)=>e.jsx(as,{fill:s.color},`cell-${t}`))})]})})})})]})]})]})}),e.jsx(U,{value:"compliance",className:"space-y-4",children:e.jsxs(h,{className:"min-w-0",children:[e.jsxs(u,{children:[e.jsx(j,{children:"Compliance & Audit Overview"}),e.jsx(f,{children:"Monitor compliance metrics and audit trail"})]}),e.jsx(p,{children:e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Ve,{className:"h-12 w-12 mx-auto mb-2"}),e.jsx("p",{children:"Compliance monitoring dashboard is available here"})]})})]})})]})]})};export{Is as default};
