import{r as l,j as t,ah as $,aG as W,C as X}from"./react-core-B8kFjp2k.js";import{u as Y,U as Z,e as U,a as _,C as K,f as ee,g as te,h as se,b as ae,s as D}from"./index-PwDgWEVM.js";import{S as ie,a as ne,b as re,c as de,d as oe}from"./select-CXX5Q_V1.js";import{C as ce}from"./checkbox-9q2dlFjr.js";import{s as b}from"./sudanStates-CkkbYUnU.js";import{bI as le,bo as me}from"./vendor-VlxgVHMv.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./router-CKy9yO3R.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./date-utils-YarVESQS.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";const Ee=()=>{const{id:C}=le(),p=me(),{toast:u}=Y(),{getMmpById:k}=Z(),{users:T,currentUser:h}=U(),[a,y]=l.useState(null),[F,O]=l.useState(!0),[S,q]=l.useState({}),[j,M]=l.useState({}),[E,w]=l.useState({}),[g,G]=l.useState({}),[A,z]=l.useState({});if(l.useEffect(()=>{if(C){const e=k(C);e?(y(e),O(!1)):(u({title:"MMP Not Found",description:"The requested MMP file could not be found.",variant:"destructive"}),p("/mmp"))}},[C,k,p,u]),F)return t.jsx("div",{className:"container mx-auto px-4 py-8",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),t.jsx("p",{className:"mt-4 text-muted-foreground",children:"Loading MMP file..."})]})});if(!a)return t.jsx("div",{className:"container mx-auto px-4 py-8",children:t.jsxs("div",{className:"text-center",children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"MMP File Not Found"}),t.jsx("p",{className:"text-gray-600 mb-6",children:"The requested MMP file could not be found."}),t.jsxs(_,{onClick:()=>p("/mmp"),children:[t.jsx($,{className:"h-4 w-4 mr-2"}),"Back to MMP Files"]})]})});let V=Array.isArray(a==null?void 0:a.siteEntries)&&a.siteEntries.length>0?a.siteEntries:[];const B=new Map;for(const e of b)B.set(e.name.toLowerCase(),e.id);const L=new Map;for(const e of b){const d=new Map;e.localities.forEach(n=>d.set(n.name.toLowerCase(),n.id)),L.set(e.id,d)}const x={};V.forEach(e=>{const d=String(e.state||"").trim().toLowerCase(),n=B.get(d);if(!n)return;const o=String(e.locality||"").trim().toLowerCase(),i=L.get(n),m=o&&i&&i.get(o)||"",f=`${n}|${m}`;x[f]||(x[f]=[]),x[f].push(e)});const P=T.filter(e=>e.role==="coordinator");function H(e,d){return P.find(n=>n.stateId===e&&(n.localityId===d||!d))}const J=async e=>{var d,n;w(o=>({...o,[e]:!0}));try{const o=(a==null?void 0:a.id)||(a==null?void 0:a.mmpId),i=S[e],m=Array.from(j[e]||[]);if(!i||m.length===0){u({title:"Select sites and coordinator",description:"Please select at least one site and a coordinator.",variant:"destructive"}),w(r=>({...r,[e]:!1}));return}const N=(((d=x[e])==null?void 0:d.filter(r=>m.includes(r.id)))||[]).map(async r=>{const v=r.additional_data||{},{data:s,error:c}=await D.from("mmp_site_entries").update({status:"Dispatched",dispatched_by:(h==null?void 0:h.id)||null,dispatched_at:new Date().toISOString(),additional_data:{...v,assigned_to:i,assigned_by:(h==null?void 0:h.id)||null,assigned_at:new Date().toISOString(),notes:`Forwarded from MMP ${(a==null?void 0:a.name)||(a==null?void 0:a.mmpId)} for CP verification`}}).eq("id",r.id).select().single();if(c)throw c;return s});await Promise.all(N),await D.from("notifications").insert([{user_id:i,title:"Sites forwarded for CP verification",message:`${(a==null?void 0:a.name)||"MMP"}: ${m.length} site(s) have been forwarded for your CP review`,type:"info",link:"/coordinator/sites",related_entity_id:o,related_entity_type:"mmpFile"}]),u({title:"Batch Forwarded",description:`Sites were forwarded to ${((n=P.find(r=>r.id===i))==null?void 0:n.fullName)||"Coordinator"}.`,variant:"default"}),w(r=>({...r,[e]:!1})),G(r=>({...r,[e]:!0})),M(r=>({...r,[e]:new Set}))}catch{u({title:"Forwarding failed",description:"Could not forward to coordinator. Please try again.",variant:"destructive"}),w(i=>({...i,[e]:!1}))}};return t.jsxs("div",{className:"container mx-auto px-4 py-8",children:[t.jsx("div",{className:"mb-6",children:t.jsxs(_,{variant:"outline",onClick:()=>p(`/mmp/${a.id}`),className:"flex items-center gap-2",children:[t.jsx($,{className:"h-4 w-4"}),"Back to MMP Details"]})}),t.jsxs(K,{className:"max-w-4xl mx-auto",children:[t.jsxs(ee,{children:[t.jsx(te,{children:"Review & Assign Coordinators"}),t.jsx(se,{children:"Review the MMP sites and assign them to coordinators for verification. Sites are grouped by state and locality for efficient assignment."})]}),t.jsx(ae,{children:t.jsx("div",{className:"space-y-6",children:Object.entries(x).length===0?t.jsx("div",{className:"text-center text-muted-foreground py-8",children:"No site groups found for this MMP."}):Object.entries(x).map(([e,d])=>{var f,N,r,v;const[n,o]=e.split("|"),i=H(n,o),m=S[e]||(i==null?void 0:i.id)||"";return j[e]||M(s=>({...s,[e]:new Set(d.map(c=>c.id))})),t.jsxs("div",{className:"border rounded-lg p-4 bg-gray-50",children:[t.jsxs("div",{className:"flex items-center mb-3 font-medium cursor-pointer select-none",onClick:()=>z(s=>({...s,[e]:!s[e]})),children:[A[e]?t.jsx(W,{className:"w-4 h-4 mr-2"}):t.jsx(X,{className:"w-4 h-4 mr-2"}),d.length," site(s) in ",t.jsx("span",{className:"text-blue-700 ml-1",children:((f=b.find(s=>s.id===n))==null?void 0:f.name)||n}),o&&t.jsxs("span",{children:[" / ",t.jsx("span",{className:"text-green-700",children:((r=(N=b.find(s=>s.id===n))==null?void 0:N.localities.find(s=>s.id===o))==null?void 0:r.name)||o})]})]}),t.jsxs("div",{className:"mb-3 text-sm text-muted-foreground",children:["Recommended: ",i?`${i.fullName||i.name||i.email}`:"None"]}),t.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[t.jsxs(ie,{value:m,onValueChange:s=>q(c=>({...c,[e]:s})),children:[t.jsx(ne,{className:"max-w-md",children:t.jsx(re,{placeholder:"Select coordinator..."})}),t.jsx(de,{children:P.map(s=>t.jsxs(oe,{value:s.id,children:[s.fullName||s.name||s.email,(i==null?void 0:i.id)===s.id?" (Recommended)":""]},s.id))})]}),t.jsx(_,{size:"sm",onClick:()=>J(e),disabled:E[e]||g[e]||!S[e]||!(((v=j[e])==null?void 0:v.size)>0),variant:g[e]?"secondary":"default",children:g[e]?"Forwarded":E[e]?"Forwarding...":"Forward Selected"})]}),A[e]&&t.jsxs("div",{className:"mt-3",children:[t.jsx("div",{className:"font-medium text-sm mb-2",children:"Select sites to forward:"}),t.jsx("div",{className:"max-h-40 overflow-y-auto border rounded p-3 bg-white",children:t.jsx("div",{className:"space-y-2",children:d.map(s=>{var c;return t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded",children:[t.jsx(ce,{checked:((c=j[e])==null?void 0:c.has(s.id))||!1,onCheckedChange:Q=>{M(R=>{const I=new Set(R[e]||[]);return Q?I.add(s.id):I.delete(s.id),{...R,[e]:I}})}}),t.jsx("span",{className:"text-sm",children:s.siteName||s.name||s.id})]},s.id)})})})]})]},e)})})})]})]})};export{Ee as default};
