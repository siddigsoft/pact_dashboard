import{r as o,j as e,ax as B,a3 as $,N as W,b8 as q,q as U}from"./react-core-B8kFjp2k.js";import{u as H,a as x,C as j,b as N,f as k,g as A,B as S,h as D,E as Z,J as _,a6 as J,Z as Y,a7 as I}from"./index-PwDgWEVM.js";import{bo as M}from"./vendor-VlxgVHMv.js";import{L as K}from"./LeafletMapContainer-DFENE1lH.js";import{i as V,g as R}from"./locationUtils-B4o8Dh43.js";import"./maps-BzFQ_kYT.js";import{o as G}from"./date-utils-YarVESQS.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./router-CKy9yO3R.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";import"./sudanStates-CkkbYUnU.js";const Q=({user:a,onLocationCapture:r,className:i=""})=>{const[c,t]=o.useState(!1),[u,l]=o.useState(null),{toast:g}=H(),h=()=>{if(t(!0),l(null),!navigator.geolocation){l("Geolocation is not supported by your browser"),t(!1),g({title:"GPS Error",description:"Geolocation is not supported by your browser",variant:"destructive"});return}navigator.geolocation.getCurrentPosition(m=>{const{latitude:n,longitude:v}=m.coords;r(n,v),t(!1),g({title:"Location Updated",description:`GPS coordinates captured: ${n.toFixed(6)}, ${v.toFixed(6)}`,variant:"default"})},m=>{let n="Unknown error capturing location";switch(m.code){case m.PERMISSION_DENIED:n="User denied the request for geolocation";break;case m.POSITION_UNAVAILABLE:n="Location information is unavailable";break;case m.TIMEOUT:n="The request to get user location timed out";break}l(n),t(!1),g({title:"GPS Error",description:n,variant:"destructive"})},{timeout:1e4,maximumAge:6e4,enableHighAccuracy:!0})};return e.jsxs("div",{className:`${i}`,children:[e.jsx(x,{variant:"outline",size:"sm",onClick:h,disabled:c,className:"flex items-center gap-2",children:c?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin mr-1",children:e.jsx(B,{className:"h-4 w-4"})}),"Capturing..."]}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"h-4 w-4"}),"Update GPS Location"]})}),u&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:u})]})},X=({currentUser:a})=>{const r=M();return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 bg-gradient-to-r from-background to-muted p-6 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>r("/dashboard"),className:"hover:bg-background/50",children:e.jsx(W,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Field Team"}),e.jsx("p",{className:"text-muted-foreground",children:"Monitor and manage your field team in real-time"})]})]}),a&&e.jsx(Q,{user:a,onLocationCapture:(i,c)=>{}})]})},ee=({users:a,siteVisits:r,filteredUsers:i,dataCollectors:c,collectorRecommendations:t,activeTab:u,setActiveTab:l,searchTerm:g,setSearchTerm:h,roleFilter:m,setRoleFilter:n,statusFilter:v,setStatusFilter:T,onAssign:F,height:b="600px"})=>{M();const[P,E]=o.useState(!1);o.useEffect(()=>{E(!0)},[]);const f=a.filter(s=>V(s.location)),p=r.filter(s=>R(s)!==null),w=f.map(s=>{var d;return{id:s.id,name:s.name||s.fullName||"Unknown",latitude:s.location.latitude,longitude:s.location.longitude,type:"user",status:s.availability||"offline",phone:s.phone,lastActive:s.lastActive,workload:(d=s.performance)==null?void 0:d.currentWorkload,avatar:s.avatar}}),C=p.map(s=>{const d=R(s);return d?{id:s.id,name:s.siteName,latitude:d.latitude,longitude:d.longitude,type:"site",status:s.status,isFallbackLocation:!V(s.location),locality:s.locality,state:s.state}:null}).filter(Boolean),y=[...w,...C];return y.length===0?e.jsx(j,{children:e.jsxs(N,{className:"p-4 flex flex-col items-center justify-center min-h-[600px]",children:[e.jsx(q,{className:"h-16 w-16 mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"No Location Data Available"}),e.jsx("p",{className:"text-muted-foreground text-center max-w-md",children:"There is no location data available for team members or site visits. Ask team members to share their location to see them here."})]})}):e.jsxs(j,{className:"w-full",children:[e.jsx(k,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(A,{className:"text-lg flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5 text-primary"}),"Field Team & Site Locations"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(S,{variant:"outline",className:"bg-background",children:[f.length," Team Members"]}),e.jsxs(S,{variant:"outline",className:"bg-background",children:[p.length," Sites"]})]})]})}),e.jsx(N,{className:"p-0",children:e.jsx("div",{style:{height:b},className:"w-full",children:P&&e.jsx(K,{locations:y,height:b,defaultCenter:[20,0],defaultZoom:3,onLocationClick:s=>{}})})})]})},se=({activeSiteVisits:a,pendingSiteVisits:r,users:i})=>{const c=M();return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(j,{children:[e.jsxs(k,{children:[e.jsx(A,{children:"Active Site Visits"}),e.jsx(D,{children:"Ongoing and assigned site visits"})]}),e.jsx(N,{children:a.length>0?e.jsxs("div",{className:"space-y-3",children:[a.slice(0,5).map(t=>{var u;return e.jsxs("div",{className:"flex justify-between items-center border-b pb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.siteName}),e.jsx("div",{className:"text-sm text-muted-foreground",children:t.location.address}),e.jsx(S,{variant:t.status==="inProgress"?"secondary":"outline",className:"mt-1",children:t.status==="inProgress"?"In Progress":"Assigned"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm",children:((u=i.find(l=>l.id===t.assignedTo))==null?void 0:u.name)||"Unassigned"}),e.jsxs("div",{className:"text-xs text-muted-foreground flex items-center justify-end",children:[e.jsx(U,{className:"h-3 w-3 mr-1"}),"Due ",G(new Date(t.dueDate),"MMM d")]}),e.jsx(x,{variant:"link",size:"sm",className:"p-0 h-auto text-xs",onClick:()=>c(`/site-visits/${t.id}`),children:"View Details"})]})]},t.id)}),a.length>5&&e.jsxs(x,{variant:"ghost",className:"w-full",onClick:()=>c("/site-visits?status=inProgress"),children:["View All (",a.length,")"]})]}):e.jsx("div",{className:"text-center py-8",children:e.jsx("div",{className:"text-muted-foreground",children:"No active site visits found"})})})]}),e.jsxs(j,{children:[e.jsxs(k,{children:[e.jsx(A,{children:"Pending Assignments"}),e.jsx(D,{children:"Site visits that need to be assigned"})]}),e.jsx(N,{children:r.length>0?e.jsxs("div",{className:"space-y-3",children:[r.slice(0,5).map(t=>e.jsxs("div",{className:"flex justify-between items-center border-b pb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.siteName}),e.jsx("div",{className:"text-sm text-muted-foreground",children:t.location.address}),e.jsx(S,{variant:"destructive",className:"mt-1",children:"Needs Assignment"})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xs text-muted-foreground flex items-center justify-end",children:[e.jsx(U,{className:"h-3 w-3 mr-1"}),"Due ",G(new Date(t.dueDate),"MMM d")]}),e.jsx(x,{variant:"default",size:"sm",className:"mt-1",onClick:()=>c(`/site-visits/${t.id}`),children:"Assign"})]})]},t.id)),r.length>5&&e.jsxs(x,{variant:"ghost",className:"w-full",onClick:()=>c("/site-visits?status=pending"),children:["View All (",r.length,")"]})]}):e.jsx("div",{className:"text-center py-8",children:e.jsx("div",{className:"text-muted-foreground",children:"No pending assignments"})})})]})]})},be=()=>{const{users:a,currentUser:r}=Z(),{siteVisits:i,assignSiteVisit:c}=_(),[t,u]=o.useState("map"),[l,g]=o.useState(""),[h,m]=o.useState("all"),[n,v]=o.useState("all"),T=M(),F=J(),{checkPermission:b,hasAnyRole:P}=Y();if(!(b("users","read")||P(["admin"])))return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs(j,{className:"w-full max-w-md",children:[e.jsxs(k,{children:[e.jsx(A,{className:"text-destructive",children:"Access Denied"}),e.jsx(D,{children:"You don't have permission to access this page."})]}),e.jsx(N,{children:e.jsx(x,{variant:"outline",onClick:()=>T("/dashboard"),className:"w-full",children:"Return to Dashboard"})})]})});const f=o.useMemo(()=>a.filter(s=>{if(!["coordinator","dataCollector","datacollector"].includes(s.role.toLowerCase()))return!1;const L=s.name.toLowerCase().includes(l.toLowerCase())||s.email.toLowerCase().includes(l.toLowerCase())||s.phone&&s.phone.includes(l),O=h==="all"||s.role.toLowerCase()===h.toLowerCase(),z=n==="all"||s.availability===n;return L&&O&&z}),[a,l,h,n]),p=o.useMemo(()=>f.filter(s=>s.role.toLowerCase()==="datacollector"||s.role.toLowerCase()==="dataCollector"),[f]);o.useMemo(()=>p.map(s=>{var d,L;return{user:s,distance:(d=s.location)!=null&&d.latitude&&((L=s.location)!=null&&L.longitude)?0:null,workload:I(s.id,i),isNearby:!1,isOverloaded:I(s.id,i)>=20,isLocalityMatch:!1}}),[p,i]);const w=o.useMemo(()=>i.filter(s=>s.status==="assigned"||s.status==="inProgress"),[i]),C=o.useMemo(()=>i.filter(s=>s.status==="pending"||s.status==="permitVerified"),[i]),y=s=>{T(`/site-visits/${s}`)};return e.jsxs("div",{className:`space-y-6 animate-fade-in ${F?"px-2":""}`,children:[e.jsx(X,{currentUser:r}),e.jsx(ee,{users:a,siteVisits:[...w,...C],onAssign:y,height:F?"300px":"500px"}),e.jsx(se,{activeSiteVisits:w,pendingSiteVisits:C,users:a})]})};export{be as default};
