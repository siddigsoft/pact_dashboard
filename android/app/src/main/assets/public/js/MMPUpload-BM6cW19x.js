import{r as o,j as e,o as Ee,Y as Tt,Z as Vt,ag as Fe,a7 as Xe,X as ke,_ as Bt,aH as Qe,b as Ut,aI as Et,aJ as Ot}from"./react-core-B8kFjp2k.js";import{_ as rt,D as it,$ as Lt,l as nt,m as ot,n as lt,I as S,u as Rt,e as $t,Z as Yt,F as zt,U as Ht,C as _e,f as Ae,g as Te,h as Ve,b as Be,a as f,r as Gt,o as Wt,p as It,a0 as qt,a1 as Kt}from"./index-PwDgWEVM.js";import{L as M}from"./label-C4lDws8j.js";import{P as Jt}from"./progress-vMwTbqUI.js";import{F as Xt,a as de,b as ue,e as me,c as pe,f as Ue,d as he}from"./form-BT_tmI7p.js";import{S as xe,a as fe,b as je,c as ve,d as p}from"./select-CXX5Q_V1.js";import{T as Qt}from"./textarea-BpQMf5eL.js";import{u as Zt,t as es,o as ts,b as E,i as ss,s as ge}from"./forms-CESK2FDA.js";import{M as as}from"./MMPFileManagement-CII7tC-1.js";import{T as rs,a as is,b as Ze,c as et,d as ns,e as tt}from"./table-CZ8ZB6wW.js";import{bo as os}from"./vendor-VlxgVHMv.js";import{o as I,F as st,G as at}from"./date-utils-YarVESQS.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./router-CKy9yO3R.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";import"./alert-dialog-D6avgrWz.js";function ls({mmpFileId:N,mmpName:q,projectId:te,totalSites:j,onSuccess:P,trigger:se}){const{createMMPBudget:ae,projectBudgets:ye}=rt(),[Oe,F]=o.useState(!1),[U,re]=o.useState(!1),[h,ie]=o.useState(""),[k,x]=o.useState("project_allocation"),[K,y]=o.useState(""),[O,ne]=o.useState(""),[_,L]=o.useState(""),[A,J]=o.useState(""),[T,C]=o.useState(""),[V,R]=o.useState(""),[B,D]=o.useState(""),w=te?ye.filter(c=>c.projectId===te&&c.status==="active"):[];o.useEffect(()=>{w.length===1&&y(w[0].id)},[w]);const $=async()=>{if(!(!h||parseFloat(h)<=0)){re(!0);try{const c=Math.round(parseFloat(h)*100),X={site_visit_fees:_?Math.round(parseFloat(_)*100):0,transportation:A?Math.round(parseFloat(A)*100):0,accommodation:T?Math.round(parseFloat(T)*100):0,meals:V?Math.round(parseFloat(V)*100):0,other:B?Math.round(parseFloat(B)*100):0},oe=await ae({mmpFileId:N,projectBudgetId:k==="project_allocation"?K:void 0,allocatedBudgetCents:c,totalSites:j,categoryBreakdown:X,sourceType:k,budgetNotes:O});oe&&(F(!1),Y(),P==null||P(oe))}finally{re(!1)}}},Y=()=>{ie(""),x("project_allocation"),y(""),ne(""),L(""),J(""),C(""),R(""),D("")},z=[_,A,T,V,B].reduce((c,X)=>c+(parseFloat(X)||0),0),be=h&&j>0?parseFloat(h)/j:0;return e.jsxs(it,{open:Oe,onOpenChange:F,children:[e.jsx(Lt,{asChild:!0,children:se||e.jsxs("button",{type:"button",className:"px-4 py-2 rounded-md bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white border border-purple-400/50 shadow-[0_0_15px_rgba(168,85,247,0.3)] focus:outline-none focus:ring-2 focus:ring-purple-400/70 focus:ring-offset-2 focus:ring-offset-slate-950 transition inline-flex items-center","data-testid":"button-create-mmp-budget",children:[e.jsx(Ee,{className:"w-4 h-4 mr-2"}),"Allocate Budget"]})}),e.jsxs(nt,{className:"max-w-2xl max-h-[90vh] overflow-y-auto bg-gradient-to-br from-slate-900 via-purple-950 to-blue-950 border-purple-500/30 shadow-[0_0_50px_rgba(168,85,247,0.3)]",children:[e.jsx(ot,{children:e.jsxs(lt,{className:"text-purple-100",children:["Allocate Budget: ",q]})}),e.jsxs("div",{className:"grid gap-4 cyber-dialog-form",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(M,{htmlFor:"allocated-budget",children:"Total Budget for MMP (SDG)"}),e.jsx(S,{id:"allocated-budget",type:"number",min:"0",step:"0.01",value:h,onChange:c=>ie(c.target.value),placeholder:"100000.00","data-testid":"input-allocated-budget"}),h&&j>0&&e.jsxs("p",{className:"text-sm text-purple-300/70",children:["Average per site: SDG ",be.toFixed(2)," (",j," sites)"]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(M,{htmlFor:"source-type",children:"Budget Source"}),e.jsxs(xe,{value:k,onValueChange:c=>x(c),children:[e.jsx(fe,{id:"source-type","data-testid":"select-source-type",children:e.jsx(je,{})}),e.jsxs(ve,{children:[e.jsx(p,{value:"project_allocation",children:"Project Allocation"}),e.jsx(p,{value:"top_up",children:"Top-Up"}),e.jsx(p,{value:"additional_funding",children:"Additional Funding"}),e.jsx(p,{value:"reallocation",children:"Reallocation"})]})]})]}),k==="project_allocation"&&w.length>0&&e.jsxs("div",{className:"grid gap-2",children:[e.jsx(M,{htmlFor:"project-budget",children:"Project Budget"}),e.jsxs(xe,{value:K,onValueChange:y,children:[e.jsx(fe,{id:"project-budget","data-testid":"select-project-budget",children:e.jsx(je,{placeholder:"Select project budget"})}),e.jsx(ve,{children:w.map(c=>e.jsxs(p,{value:c.id,children:["FY ",c.fiscalYear," - Remaining: SDG ",(c.remainingBudgetCents/100).toLocaleString()]},c.id))})]})]}),k==="project_allocation"&&w.length===0&&e.jsx("div",{className:"p-3 bg-yellow-50 dark:bg-yellow-950 border border-yellow-200 dark:border-yellow-800 rounded-md",children:e.jsx("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:"No active project budgets available. Please create a project budget first."})}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-medium mb-3",children:"Category Breakdown (Optional)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(M,{htmlFor:"cat-site-visits",children:"Site Visit Fees (SDG)"}),e.jsx(S,{id:"cat-site-visits",type:"number",min:"0",step:"0.01",value:_,onChange:c=>L(c.target.value),placeholder:"0.00","data-testid":"input-category-site-visits"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(M,{htmlFor:"cat-transportation",children:"Transportation (SDG)"}),e.jsx(S,{id:"cat-transportation",type:"number",min:"0",step:"0.01",value:A,onChange:c=>J(c.target.value),placeholder:"0.00","data-testid":"input-category-transportation"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(M,{htmlFor:"cat-accommodation",children:"Accommodation (SDG)"}),e.jsx(S,{id:"cat-accommodation",type:"number",min:"0",step:"0.01",value:T,onChange:c=>C(c.target.value),placeholder:"0.00","data-testid":"input-category-accommodation"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(M,{htmlFor:"cat-meals",children:"Meals (SDG)"}),e.jsx(S,{id:"cat-meals",type:"number",min:"0",step:"0.01",value:V,onChange:c=>R(c.target.value),placeholder:"0.00","data-testid":"input-category-meals"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(M,{htmlFor:"cat-other",children:"Other Costs (SDG)"}),e.jsx(S,{id:"cat-other",type:"number",min:"0",step:"0.01",value:B,onChange:c=>D(c.target.value),placeholder:"0.00","data-testid":"input-category-other"})]})]}),z>0&&e.jsxs("div",{className:"mt-3 p-3 bg-gradient-to-r from-purple-900/20 to-cyan-900/20 backdrop-blur-sm border border-purple-500/30 rounded-md shadow-[0_0_15px_rgba(168,85,247,0.2)]",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-purple-200",children:"Category Total:"}),e.jsxs("span",{className:"text-sm font-bold text-purple-100",children:["SDG ",z.toLocaleString("en-SD",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),h&&z>parseFloat(h)&&e.jsxs("p",{className:"text-sm text-red-300 mt-1",children:["Category total exceeds budget by SDG ",(z-parseFloat(h)).toFixed(2)]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(M,{htmlFor:"notes",children:"Budget Notes"}),e.jsx(Qt,{id:"notes",value:O,onChange:c=>ne(c.target.value),placeholder:"Additional notes about this MMP budget...",rows:3,"data-testid":"textarea-budget-notes"})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end pt-4 border-t border-purple-500/20",children:[e.jsx("button",{type:"button",onClick:()=>F(!1),disabled:U,className:"px-4 py-2 rounded-md bg-transparent border border-purple-500/30 text-purple-200 hover:bg-purple-900/20 shadow-[0_0_12px_rgba(168,85,247,0.25)] focus:outline-none focus:ring-2 focus:ring-purple-400/70 focus:ring-offset-2 focus:ring-offset-slate-950 transition disabled:opacity-50 disabled:cursor-not-allowed","data-testid":"button-cancel",children:"Cancel"}),e.jsx("button",{type:"button",onClick:$,disabled:!h||parseFloat(h)<=0||U||k==="project_allocation"&&!K,className:"px-4 py-2 rounded-md bg-gradient-to-r from-purple-600 to-cyan-600 hover:from-purple-700 hover:to-cyan-700 text-white border border-purple-400/50 shadow-[0_0_18px_rgba(168,85,247,0.35)] focus:outline-none focus:ring-2 focus:ring-purple-400/70 focus:ring-offset-2 focus:ring-offset-slate-950 transition disabled:opacity-60 disabled:cursor-not-allowed","data-testid":"button-submit",children:U?"Allocating...":"Allocate Budget"})]})]})]})}const cs=ts({name:ge({required_error:"MMP name is required"}).min(3,{message:"MMP name must be at least 3 characters."}),project:ge({required_error:"Project selection is required"}),month:ge({required_error:"Month selection is required"}),hub:ge().optional(),file:ss(File,{message:"Please select a file"}),includeDistributionByCP:E().default(!0),includeVisitStatus:E().default(!0),includeSubmissionStatus:E().default(!0),includeQuestions:E().default(!0),includeFindings:E().default(!0),includeFlagged:E().default(!0),includeComments:E().default(!0)}),Vs=()=>{const{toast:N}=Rt(),q=os(),{uploadMMP:te,currentUser:j}=$t(),{checkPermission:P,hasAnyRole:se}=Yt(),{projects:ae,loading:ye}=zt(),{projectBudgets:Oe}=rt(),[F,U]=o.useState(!1),[re,h]=o.useState(!1),[ie,k]=o.useState(!1),[x,K]=o.useState(null),[y,O]=o.useState(null),[ne,_]=o.useState(!1),[L,A]=o.useState(0),[J,T]=o.useState(""),[C,V]=o.useState(null),[R,B]=o.useState(null),[D,w]=o.useState(null),$=o.useRef(null),Y=se(["admin"]),z=(P("mmp","create")||Y)&&se(["admin","ict"]),{getMMPById:be,archiveMMP:c,approveMMP:X,deleteMMP:oe,resetMMP:ct}=Ht(),[Le,Ne]=o.useState(!1),[g,H]=o.useState([]),[le,we]=o.useState([]),[G,Q]=o.useState([]),[W,Z]=o.useState([]),[Me,dt]=o.useState(!1),[Re,ce]=o.useState(new Set),[ut,Se]=o.useState({}),$e=["Hub Office","State","Locality","Site Name","Site Code","CP Name","Activity at Site","Activity Details","Monitoring By","Survey Tool","Use Market Diversion Monitoring","Use Warehouse Monitoring","Visit Date","Comments"],Ye=t=>{const s=new Set;t.forEach(a=>Object.keys(a).forEach(i=>{i!=="OriginalDate"&&s.add(i)}));const r=Array.from(s).filter(a=>!$e.includes(a));return $e.filter(a=>s.has(a)).concat(r)},Ce=t=>t+2,ze=(t,s)=>{if(!t||!s)return null;if(t in s)return t;if(t==="Site ID"&&"Site Code"in s)return"Site Code";if(t==="Visit by"&&"Monitoring By"in s)return"Monitoring By";if(t==="Tool to be used"){if("Survey Tool"in s)return"Survey Tool";if("Survey under Master tool"in s)return"Survey under Master tool"}return null},De=t=>String(t||"").toLowerCase().replace(/[^a-z0-9]+/g,""),He={hubOffice:["huboffice","hub","office","hubofficename","hub office"],state:["state","statename","region","stateprovince"],locality:["locality","localityname","district","county","lga"],siteName:["sitename","site","facilityname","distributionpoint","site name"],siteCode:["sitecode","siteid","code","site code","site id"],cpName:["cpname","cp","partner","partnername","implementingpartner","ipname","cp name"],siteActivity:["activityatsite","siteactivity","activitysite","activityatthesite","activity at site"],mainActivity:["mainactivity","activity","activitydetails","activity details"],monitoringBy:["monitoringby","monitoringby:","monitoring by","monitoredby","visitby","visit by"],surveyTool:["surveytool","surveyundermastertool","survey under master tool","tooltobeused","tool","survey tool"]},mt=(t,s)=>{const r={};Object.entries(t).forEach(([a,i])=>{r[De(a)]=String(i??"")});for(const a of He[s]){const i=r[a];if(i&&i.trim()!=="")return i}return""},Ge=(t,s)=>{const r=[],a=[],i={};if(Object.entries(t).forEach(([n,u])=>{i[De(n)]=String(u??"")}),[{label:"Hub Office",key:"hubOffice"},{label:"State",key:"state"},{label:"Locality",key:"locality"},{label:"Site Name",key:"siteName"},{label:"Site ID",key:"siteCode"},{label:"CP Name",key:"cpName"},{label:"Activity at Site",key:"siteActivity"},{label:"Activity Details",key:"mainActivity"},{label:"Visit by",key:"monitoringBy"},{label:"Tool to be used",key:"surveyTool"}].forEach(n=>{mt(t,n.key)||r.push({type:"error",message:`Missing ${n.label}`,row:s,column:n.label,category:"missing_field"})}),t["Visit Date"]===void 0||String(t["Visit Date"]).trim()===""){const n=new Date;t.OriginalDate=I(n,"yyyy-MM-dd"),t["Visit Date"]=I(n,"dd-MM-yyyy"),a.push({type:"warning",message:"No visit date provided, using today's date",row:s,column:"Visit Date",category:"missing_date"})}else{let n=st(String(t["Visit Date"]),"dd-MM-yyyy",new Date);if(at(n)||(n=st(String(t["Visit Date"]),"yyyy-MM-dd",new Date)),at(n))t.OriginalDate=I(n,"yyyy-MM-dd"),t["Visit Date"]=I(n,"dd-MM-yyyy");else{const u=new Date;t.OriginalDate=I(u,"yyyy-MM-dd"),t["Visit Date"]=I(u,"dd-MM-yyyy"),a.push({type:"warning",message:"Invalid Visit Date format, using today's date",row:s,column:"Visit Date",category:"invalid_date_format"})}}if(t["Site Code"]){const n=String(t["Site Code"]);Kt(n)||a.push({type:"warning",message:"Site Code must follow pattern [HH][SS][YYMMDD]-[0001] (e.g., KOKH230524-0001)",row:s,column:"Site Code",category:"invalid_site_code"})}const m=["yes","no","true","false","1","0",""];if(t["Use Market Diversion Monitoring"]!==void 0){const n=String(t["Use Market Diversion Monitoring"]).toLowerCase().trim();m.includes(n)||a.push({type:"warning",message:"Use Market Diversion Monitoring should be Yes/No",row:s,column:"Use Market Diversion Monitoring",category:"invalid_boolean"})}if(t["Use Warehouse Monitoring"]!==void 0){const n=String(t["Use Warehouse Monitoring"]).toLowerCase().trim();m.includes(n)||a.push({type:"warning",message:"Use Warehouse Monitoring should be Yes/No",row:s,column:"Use Warehouse Monitoring",category:"invalid_boolean"})}return{errors:r,warnings:a}},We=t=>{const s=new Map,r=[],a=(i,l)=>{const m={};Object.entries(i).forEach(([n,u])=>{m[De(n)]=String(u??"")});for(const n of He[l]){const u=m[n];if(u&&u.trim()!=="")return u}return""};for(let i=0;i<t.length;i++){const l=t[i],m=Ce(i),n=a(l,"siteCode"),u=n||[a(l,"hubOffice"),a(l,"state"),a(l,"locality"),a(l,"siteName"),a(l,"cpName")].map(b=>b.trim().toLowerCase()).join("|");if(u.trim()!=="")if(s.has(u)){const b=s.get(u);r.push({type:"error",message:`Duplicate site found (matches row ${b})`,row:m,column:n?"Site ID":"Composite Site Fields",category:"duplicate_site"})}else s.set(u,m)}return r},pt=(t,s,r)=>{H(a=>{const i=[...a],l={...i[t]||{}};return l[s]=r,i[t]=l,i})},ht=t=>{Se(s=>({...s,[t]:{...g[t]||{}}})),ce(s=>{const r=new Set(s);return r.add(t),r})},gt=t=>{const s=ut[t];if(!s){ce(r=>{const a=new Set(r);return a.delete(t),a});return}H(r=>{const a=[...r];a[t]={...s};const i=Ce(t),{errors:l,warnings:m}=Ge(a[t],i);return Q(n=>{const u=n.filter(ee=>ee.row!==i&&ee.category!=="duplicate_site"),b=We(a);return[...u,...l,...b]}),Z(n=>[...n.filter(b=>b.row!==i),...m]),a}),ce(r=>{const a=new Set(r);return a.delete(t),a}),Se(r=>{const{[t]:a,...i}=r;return i})},xt=t=>{Ie(t),ce(s=>{const r=new Set(s);return r.delete(t),r}),Se(s=>{const{[t]:r,...a}=s;return a})},Ie=t=>{H(s=>{const r=[...s],a=r[t],i=Ce(t),{errors:l,warnings:m}=Ge(a,i);return Q(n=>{const u=n.filter(ee=>ee.row!==i&&ee.category!=="duplicate_site"),b=We(r);return[...u,...l,...b]}),Z(n=>[...n.filter(b=>b.row!==i),...m]),r})},qe=o.useMemo(()=>{const t=new Set,s=new Set;return G.forEach(r=>{if(!r.row||!r.column)return;const a=r.row-2,i=g[a],l=ze(r.column,i);l&&t.add(`${a}:${l}`)}),W.forEach(r=>{if(!r.row||!r.column)return;const a=r.row-2,i=g[a],l=ze(r.column,i);l&&s.add(`${a}:${l}`)}),{errorSet:t,warningSet:s}},[G,W,g]);if(!z)return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs(_e,{className:"w-full max-w-md",children:[e.jsxs(Ae,{children:[e.jsx(Te,{className:"text-destructive",children:"Access Denied"}),e.jsx(Ve,{children:"You don't have permission to upload MMP files."})]}),e.jsx(Be,{children:e.jsx(f,{variant:"outline",onClick:()=>q("/mmp"),className:"w-full",children:"Back to MMP"})})]})});const v=Zt({resolver:es(cs),defaultValues:{name:"",project:"",month:"",hub:"",includeDistributionByCP:!0,includeVisitStatus:!0,includeSubmissionStatus:!0,includeQuestions:!0,includeFindings:!0,includeFlagged:!0,includeComments:!0}}),d=new Date().getMonth()+1,ft=t=>{t.preventDefault(),_(!0)},jt=t=>{t.preventDefault(),_(!1)},vt=t=>{t.preventDefault(),_(!1);const s=t.dataTransfer.files;if(s.length>0){const r=s[0];r.type==="text/csv"||r.name.endsWith(".xlsx")||r.name.endsWith(".xls")?(v.setValue("file",r),Ke(r)):N({title:"Invalid File Type",description:"Please select a CSV, XLSX, or XLS file.",variant:"destructive"})}},yt=()=>{var t;(t=$.current)==null||t.click()},Ke=async t=>{Ne(!0);try{const s=await qt(t),r=s.data;H(r),we(Ye(r)),Q(s.errors||[]),Z(s.warnings||[])}catch{H([]),we([]),Q([]),Z([]),N({title:"Failed to parse file",description:"Please check the file format and try again.",variant:"destructive"})}finally{Ne(!1)}},Pe=()=>{U(!1),A(0),T(""),y&&(clearTimeout(y),O(null))};o.useEffect(()=>()=>{y&&clearTimeout(y)},[y]);const bt=()=>{h(!0)},Nt=()=>{N({title:"Progress Saved",description:"Your MMP import has been saved for later editing."}),h(!1),q("/mmp")},wt=()=>{const t=(le.length>0?le:Ye(g)).filter(n=>n!=="OriginalDate"),s=n=>String(n??"").replace(/\r?\n/g," ").replace(/,/g,";"),r=t.join(","),a=g.map(n=>t.map(u=>s(n[u])).join(",")),i=[r,...a].join(`\r
`),l=`${(v.getValues().name||"edited_mmp").toString().trim()||"edited_mmp"}.csv`,m=new Blob([i],{type:"text/csv;charset=utf-8"});return new File([m],l,{type:"text/csv"})},Mt=async t=>{U(!0);const s=setTimeout(()=>{Pe(),N({title:"Upload Timeout",description:"The upload is taking longer than expected. Please refresh the page and try again.",variant:"destructive"})},3e5);O(s);try{const r=g.length>0?wt():t.file,a=await te(r,{name:t.name,month:t.month,projectId:t.project,...t.hub?{hub:t.hub}:{}},i=>{A(i.current),T(i.stage)});if(y&&(clearTimeout(y),O(null)),a&&a.success){const i=a.id||`mmp-${Date.now().toString(36)}`;K(i),k(!0),N({title:"MMP file uploaded successfully",description:"Your file has been uploaded and is now ready for review."})}else{const i=(a==null?void 0:a.error)||"Upload failed for unknown reason";if(N({title:"Upload failed",description:i,variant:"destructive"}),a!=null&&a.validationReport)try{const l=new Blob([a.validationReport],{type:"text/csv"}),m=URL.createObjectURL(l);V(m),B(a.validationErrors||[]),w(a.validationWarnings||[])}catch{}}}catch(r){const a=r instanceof Error?r.message:"Unknown error occurred";N({title:"Upload failed",description:`There was a problem uploading your file: ${a}`,variant:"destructive"})}finally{Pe()}},Je=x?be(x):void 0,St=P("mmp","approve")||Y,Ct=P("mmp","archive")||Y,Dt=P("mmp","delete")||Y,Pt=async()=>{x&&(j!=null&&j.id)&&await X(x,j.id)},Ft=async()=>{x&&(j!=null&&j.id)&&await c(x,j.id)},kt=async()=>{x&&(await oe(x),q("/mmp"))},_t=async()=>{x&&await ct(x)},At=()=>{if(v.reset(),H([]),we([]),Q([]),Z([]),Ne(!1),C){try{URL.revokeObjectURL(C)}catch{}V(null)}if(B(null),w(null),$.current)try{$.current.value=""}catch{}A(0),T(""),U(!1)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Upload MMP"}),e.jsx("p",{className:"text-muted-foreground",children:"Upload a new Monthly Monitoring Plan with detailed site information"})]}),C&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Tt,{className:"h-5 w-5 text-red-600 mt-0.5"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-red-700",children:"Validation failed. Fix the errors and re-upload."}),e.jsx("div",{className:"text-sm text-red-700",children:e.jsxs("p",{children:[(R==null?void 0:R.length)||0," errors",D!=null&&D.length?`, ${D==null?void 0:D.length} warnings`:""," detected."]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("a",{href:C,download:"mmp_validation_report.csv",children:e.jsxs(f,{size:"sm",className:"bg-red-600 hover:bg-red-700",children:[e.jsx(Vt,{className:"mr-2 h-4 w-4"}),"Download error report (CSV)"]})}),e.jsx(f,{variant:"outline",size:"sm",onClick:()=>{C&&URL.revokeObjectURL(C),V(null),B(null),w(null)},children:"Dismiss"})]})]})]})}),ie?e.jsxs(_e,{children:[e.jsxs(Ae,{children:[e.jsx(Te,{className:"text-green-600",children:"Upload Successful"}),e.jsx(Ve,{children:"Your Monthly Monitoring Plan has been successfully uploaded and is now ready for review."})]}),e.jsxs(Be,{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border-l-4 border-green-500 p-4 rounded-md",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Fe,{className:"h-6 w-6 text-green-500 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"MMP Upload Complete"}),e.jsx("p",{className:"text-sm mt-1",children:"Your file has been processed and is now available in the MMP management system. You can view the details or return to the MMP list."})]})]})}),x&&g.length>0&&e.jsx("div",{className:"bg-blue-50 border-l-4 border-blue-500 p-4 rounded-md",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ee,{className:"w-5 h-5 text-blue-600 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Optional: Allocate Budget"}),e.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["You can now allocate a budget for this MMP to track costs for ",g.length," site visits."]}),e.jsx("div",{className:"mt-3",children:e.jsx(ls,{mmpFileId:x,mmpName:v.getValues().name||"Uploaded MMP",projectId:v.getValues().project,totalSites:g.length,onSuccess:()=>{N({title:"Budget Allocated",description:"Budget has been successfully allocated to this MMP"})},trigger:e.jsxs(f,{variant:"outline",size:"sm","data-testid":"button-allocate-budget-mmp",children:[e.jsx(Ee,{className:"w-4 h-4 mr-2"}),"Allocate Budget"]})})})]})]})}),e.jsxs("div",{className:"border rounded-md p-4 bg-slate-50",children:[e.jsx("h3",{className:"font-medium mb-2",children:"What happens next?"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-2 text-sm",children:[e.jsx("li",{children:"Your MMP is now available for team members to view and review"}),e.jsx("li",{children:"Site visits will be scheduled based on the information provided"}),e.jsx("li",{children:"You can track progress and status updates in the MMP details view"}),e.jsx("li",{children:"Reports and analytics will reflect the newly added sites"})]})]}),Je&&e.jsx("div",{className:"mt-2",children:e.jsx(as,{mmpFile:Je,canArchive:Ct,canDelete:Dt,canApprove:St,onArchive:Ft,onDelete:kt,onResetApproval:_t,onApprove:Pt})})]})]}):e.jsx(Xt,{...v,children:e.jsx("form",{onSubmit:v.handleSubmit(Mt),className:"space-y-6",children:e.jsxs(_e,{children:[e.jsxs(Ae,{children:[e.jsx(Te,{children:"MMP File Upload"}),e.jsx(Ve,{children:"Enter MMP details and upload an Excel or CSV file containing site visit information"})]}),e.jsxs(Be,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(de,{control:v.control,name:"name",render:({field:t})=>e.jsxs(ue,{children:[e.jsx(me,{children:"MMP Name"}),e.jsx(pe,{children:e.jsx(S,{placeholder:"Enter MMP name",...t})}),e.jsx(Ue,{children:"Provide a descriptive name for this MMP"}),e.jsx(he,{})]})}),e.jsx(de,{control:v.control,name:"project",render:({field:t})=>e.jsxs(ue,{children:[e.jsx(me,{children:"Project"}),e.jsxs(xe,{onValueChange:t.onChange,defaultValue:t.value,children:[e.jsx(pe,{children:e.jsx(fe,{children:e.jsx(je,{placeholder:"Select a project"})})}),e.jsx(ve,{children:ye?e.jsx(p,{value:"__LOADING__",disabled:!0,children:"Loading projects..."}):ae.length===0?e.jsx(p,{value:"__NONE__",disabled:!0,children:"No projects available"}):ae.map(s=>e.jsx(p,{value:s.id,children:s.name},s.id))})]}),e.jsx(Ue,{children:"Select the project this MMP belongs to"}),e.jsx(he,{})]})}),e.jsx(de,{control:v.control,name:"month",render:({field:t})=>e.jsxs(ue,{children:[e.jsx(me,{children:"Month"}),e.jsxs(xe,{onValueChange:t.onChange,defaultValue:t.value,children:[e.jsx(pe,{children:e.jsx(fe,{children:e.jsx(je,{placeholder:"Select a month"})})}),e.jsxs(ve,{children:[e.jsx(p,{value:"1",disabled:1<d,className:1<d?"opacity-50 cursor-not-allowed":"",children:"January"}),e.jsx(p,{value:"2",disabled:2<d,className:2<d?"opacity-50 cursor-not-allowed":"",children:"February"}),e.jsx(p,{value:"3",disabled:3<d,className:3<d?"opacity-50 cursor-not-allowed":"",children:"March"}),e.jsx(p,{value:"4",disabled:4<d,className:4<d?"opacity-50 cursor-not-allowed":"",children:"April"}),e.jsx(p,{value:"5",disabled:5<d,className:5<d?"opacity-50 cursor-not-allowed":"",children:"May"}),e.jsx(p,{value:"6",disabled:6<d,className:6<d?"opacity-50 cursor-not-allowed":"",children:"June"}),e.jsx(p,{value:"7",disabled:7<d,className:7<d?"opacity-50 cursor-not-allowed":"",children:"July"}),e.jsx(p,{value:"8",disabled:8<d,className:8<d?"opacity-50 cursor-not-allowed":"",children:"August"}),e.jsx(p,{value:"9",disabled:9<d,className:9<d?"opacity-50 cursor-not-allowed":"",children:"September"}),e.jsx(p,{value:"10",disabled:10<d,className:10<d?"opacity-50 cursor-not-allowed":"",children:"October"}),e.jsx(p,{value:"11",disabled:11<d,className:11<d?"opacity-50 cursor-not-allowed":"",children:"November"}),e.jsx(p,{value:"12",disabled:12<d,className:12<d?"opacity-50 cursor-not-allowed":"",children:"December"})]})]}),e.jsx(Ue,{children:"Select the month for this MMP"}),e.jsx(he,{})]})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(de,{control:v.control,name:"file",render:({field:{onChange:t,value:s,...r},fieldState:a})=>e.jsxs(ue,{children:[e.jsx(me,{children:"MMP File (Excel/CSV)"}),e.jsx(pe,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{...r,ref:$,type:"file",accept:".xlsx,.xls,.csv",onChange:i=>{var m;const l=(m=i.target.files)==null?void 0:m[0];l&&(t(l),Ke(l))},style:{display:"none"}}),e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ${ne?"border-primary bg-primary/5":"border-muted-foreground/25 hover:bg-muted/50"}`,onDragOver:ft,onDragLeave:jt,onDrop:vt,onClick:yt,children:[e.jsx(Xe,{className:"h-8 w-8 mx-auto text-muted-foreground mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Drag and drop your Excel or CSV file here, or click to browse"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Supported formats: .xlsx, .xls, .csv"})]})]})}),s&&e.jsxs("div",{className:"text-sm p-2 bg-green-50 border border-green-100 rounded flex items-center",children:[e.jsx(Fe,{className:"h-4 w-4 text-green-500 mt-1"}),e.jsxs("span",{children:["Ready to upload: ",e.jsx("strong",{children:s.name})," (",(s.size/1024).toFixed(2)," KB)"]}),e.jsx(f,{variant:"ghost",size:"icon",className:"ml-auto h-6 w-6",onClick:()=>{t(void 0)},children:e.jsx(ke,{className:"h-4 w-4"})})]}),e.jsx(he,{})]})}),e.jsxs("div",{className:"bg-blue-50 border-l-4 border-blue-500 p-4 text-sm",children:[e.jsxs("p",{className:"font-medium text-blue-700 flex items-center gap-1",children:[e.jsx(Bt,{className:"h-4 w-4"}),"MMP File Requirements"]}),e.jsxs("ul",{className:"list-disc list-inside mt-2 text-blue-600 space-y-1 pl-5",children:[e.jsx("li",{children:"Excel or CSV file (.xlsx, .xls, or .csv format)"}),e.jsx("li",{children:"Must include columns for Site Name, Location, Activities"}),e.jsx("li",{children:"Include dates for planned visits"}),e.jsx("li",{children:"For joint visits, specify participating organizations"}),e.jsx("li",{children:"Maximum file size: 10MB"})]})]}),(Le||g.length>0||G.length>0||W.length>0)&&e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium",children:"Preview & Validation"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:Le?"Parsing fileâ€¦":`${g.length} row(s)`}),g.length>0&&e.jsx(f,{type:"button",variant:Me?"secondary":"outline",size:"sm",onClick:()=>dt(t=>!t),children:Me?e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"mr-2 h-4 w-4"}),"Done"]}):e.jsxs(e.Fragment,{children:[e.jsx(Qe,{className:"mr-2 h-4 w-4"}),"Edit Entries"]})})]})]}),(G.length>0||W.length>0)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded p-3 text-red-800 text-sm",children:[e.jsxs("div",{className:"font-medium",children:[G.length," error(s)"]}),e.jsx("ul",{className:"mt-1 list-disc list-inside space-y-1 max-h-40 overflow-auto",children:G.slice(0,10).map((t,s)=>e.jsxs("li",{children:[t.message,t.row?` (Row ${t.row}${t.column?`, ${t.column}`:""})`:""]},`e-${s}`))})]}),e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded p-3 text-amber-900 text-sm",children:[e.jsxs("div",{className:"font-medium",children:[W.length," warning(s)"]}),e.jsx("ul",{className:"mt-1 list-disc list-inside space-y-1 max-h-40 overflow-auto",children:W.slice(0,10).map((t,s)=>e.jsxs("li",{children:[t.message,t.row?` (Row ${t.row}${t.column?`, ${t.column}`:""})`:""]},`w-${s}`))})]})]}),g.length>0&&e.jsxs("div",{className:"rounded-md border w-full",children:[e.jsxs(rs,{wrapperClassName:"max-h-[640px] overflow-auto",className:"min-w-[1200px]",children:[e.jsx(is,{children:e.jsxs(Ze,{className:"bg-muted/50",children:[le.map(t=>e.jsx(et,{className:"sticky top-0 bg-blue-50 z-10",children:t},t)),e.jsx(et,{className:"w-[160px] sticky top-0 bg-blue-50 z-10",children:"Actions"})]})}),e.jsx(ns,{children:g.map((t,s)=>e.jsxs(Ze,{className:"hover:bg-muted/30",children:[le.map(r=>{const a=qe.errorSet.has(`${s}:${r}`),i=qe.warningSet.has(`${s}:${r}`),l=Me||Re.has(s),m=l?"":a?"bg-red-50":i?"bg-amber-50":"";return e.jsx(tt,{className:`text-xs align-top ${m}`,children:l?e.jsx(S,{value:t[r]??"",onChange:n=>pt(s,r,n.target.value),onBlur:()=>Ie(s),className:`h-7 px-2 py-1 text-xs ${a?"bg-red-50 border-red-300 focus-visible:ring-red-300":i?"bg-amber-50 border-amber-300 focus-visible:ring-amber-300":""}`}):e.jsx("div",{className:"min-h-[28px] leading-6 px-1",children:t[r]??""})},`${s}-${r}`)}),e.jsx(tt,{className:"text-xs align-top",children:Re.has(s)?e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(f,{size:"sm",onClick:()=>xt(s),children:[e.jsx(Ut,{className:"h-4 w-4 mr-1"})," Save"]}),e.jsxs(f,{size:"sm",variant:"outline",onClick:()=>gt(s),children:[e.jsx(ke,{className:"h-4 w-4 mr-1"})," Cancel"]})]}):e.jsxs(f,{size:"sm",variant:"outline",onClick:()=>ht(s),children:[e.jsx(Qe,{className:"h-4 w-4 mr-1"})," Edit"]})})]},s))})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-2",children:["Scroll down to view more (",g.length," total entries.)"]})]})]})]})]}),e.jsxs(Gt,{className:"flex justify-between",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{variant:"outline",onClick:At,children:"Cancel"}),e.jsxs(f,{type:"button",variant:"outline",onClick:bt,children:[e.jsx(Et,{className:"mr-2 h-4 w-4"}),"Save for Later"]})]}),e.jsxs("div",{className:"flex gap-2",children:[F&&e.jsxs(f,{type:"button",variant:"outline",onClick:Pe,className:"text-red-600 hover:text-red-700",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),"Cancel Validate"]}),e.jsxs("div",{className:"space-y-2",children:[F&&L>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:J}),e.jsxs("span",{children:[L,"%"]})]}),e.jsx(Jt,{value:L,className:"h-2"})]}),e.jsx(f,{type:"submit",disabled:!v.formState.isValid||F,className:"w-full",children:F?e.jsxs(e.Fragment,{children:[e.jsx(Ot,{className:"mr-2 h-4 w-4 animate-spin"}),J||"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"mr-2 h-4 w-4"}),"Validate MMP"]})})]})]})]})]})})}),e.jsx(it,{open:re,onOpenChange:h,children:e.jsxs(nt,{children:[e.jsxs(ot,{children:[e.jsx(lt,{children:"Save Progress for Later"}),e.jsx(Wt,{children:"Your MMP file and settings will be saved as a draft. You can continue editing it later."})]}),e.jsxs("div",{className:"py-4",children:[e.jsx(M,{htmlFor:"draftName",className:"mb-2 block",children:"Draft Name (optional)"}),e.jsx(S,{id:"draftName",placeholder:"My MMP Upload Draft"})]}),e.jsxs(It,{children:[e.jsx(f,{variant:"outline",onClick:()=>h(!1),children:"Cancel"}),e.jsx(f,{onClick:Nt,children:"Save Draft"})]})]})})]})};export{Vs as default};
