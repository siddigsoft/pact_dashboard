import{R as i,j as t}from"./react-core-B8kFjp2k.js";import{u as L,D as O,l as $,m as q,n as A,o as E,I as R,p as U,a as C,s as l}from"./index-PwDgWEVM.js";import{C as z}from"./checkbox-9q2dlFjr.js";const Y=({open:m,onOpenChange:u,mmpId:r,mmpName:y,onForwarded:w})=>{const[o,d]=i.useState(!1),[h,j]=i.useState([]),[x,b]=i.useState(""),[c,M]=i.useState(new Set),{toast:_}=L();i.useEffect(()=>{if(!m)return;let e=!1;return(async()=>{d(!0);try{const{data:a,error:f}=await l.from("profiles").select("id, full_name, username, email, hub_id, state_id, locality_id").eq("role","fom").order("full_name",{ascending:!0});e||j(f?[]:a)}finally{e||d(!1)}})(),()=>{e=!0}},[m]);const F=i.useMemo(()=>{const e=x.trim().toLowerCase();return e?h.filter(s=>(s.full_name||"").toLowerCase().includes(e)||(s.username||"").toLowerCase().includes(e)||(s.email||"").toLowerCase().includes(e)):h},[h,x]),k=e=>{M(s=>{const a=new Set(s);return a.has(e)?a.delete(e):a.add(e),a})},D=async()=>{var e;if(c.size!==0){d(!0);try{const s=Array.from(c),a=s.map(n=>({user_id:n,title:"MMP forwarded to you",message:`${y||"MMP"} has been forwarded to you for permits attachment`,type:"info",link:`/mmp/${r}`,related_entity_id:r,related_entity_type:"mmpFile"})),{error:f}=await l.from("notifications").insert(a);if(f)throw f;try{const{data:n}=await l.auth.getUser(),v=(e=n==null?void 0:n.user)==null?void 0:e.id;v&&await l.from("notifications").insert({user_id:v,title:"MMP forwarded",message:`You forwarded ${y||"MMP"} to ${s.length} FOM(s)`,type:"success",link:`/mmp/${r}`,related_entity_id:r,related_entity_type:"mmpFile"})}catch{}const{data:g}=await l.from("mmp_files").select("workflow").eq("id",r).single(),S=new Date().toISOString(),p=(g==null?void 0:g.workflow)||{},N=Array.isArray(p.forwardedToFomIds)?p.forwardedToFomIds:[],P=Array.from(new Set([...N,...s])),T={...p,currentStage:"awaitingPermits",forwardedToFomIds:P,forwardedAt:S,lastUpdated:S};await l.from("mmp_files").update({workflow:T}).eq("id",r),_({title:"MMP forwarded",description:`Forwarded to ${s.length} FOM(s)`});try{w==null||w(s)}catch{}u(!1),M(new Set)}catch(s){_({title:"Forward failed",description:(s==null?void 0:s.message)||"Unexpected error",variant:"destructive"})}finally{d(!1)}}};return t.jsx(O,{open:m,onOpenChange:u,children:t.jsxs($,{className:"sm:max-w-lg",children:[t.jsxs(q,{children:[t.jsx(A,{children:"Forward to Field Operations Managers"}),t.jsx(E,{children:"Select one or more FOMs to forward this MMP. They will get a notification to attach permits."})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsx(R,{placeholder:"Search by name, username, or email",value:x,onChange:e=>b(e.target.value)}),t.jsxs("div",{className:"max-h-64 overflow-auto border rounded-md p-2",children:[o&&t.jsx("div",{className:"text-sm text-muted-foreground p-2",children:"Loading FOMs…"}),!o&&F.length===0&&t.jsx("div",{className:"text-sm text-muted-foreground p-2",children:"No FOMs found"}),!o&&F.map(e=>t.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-muted cursor-pointer",children:[t.jsx(z,{checked:c.has(e.id),onCheckedChange:()=>k(e.id)}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{className:"text-sm font-medium",children:e.full_name||e.username||e.email||e.id}),t.jsx("span",{className:"text-xs text-muted-foreground",children:e.email})]})]},e.id))]})]}),t.jsxs(U,{children:[t.jsx(C,{variant:"outline",onClick:()=>u(!1),disabled:o,children:"Cancel"}),t.jsx(C,{onClick:D,disabled:o||c.size===0,children:o?"Forwarding…":"Forward"})]})]})})};export{Y as F};
