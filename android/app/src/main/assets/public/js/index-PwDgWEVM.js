const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/Index-EpS42w__.js","js/react-core-B8kFjp2k.js","js/vendor-VlxgVHMv.js","js/docs-D2Yi4cpO.js","js/react-dom-BLwj5vIO.js","js/date-utils-YarVESQS.js","js/jspdf-rld7HkB6.js","js/router-CKy9yO3R.js","js/query-CJ0Bt4ph.js","js/supabase-CwPDIVMD.js","js/xlsx-CBxwqXDA.js","js/forms-CESK2FDA.js","js/radix-ui-C2DV4xtt.js","js/radix-dialogs-CnlmQBMC.js","js/radix-menus-CPezQVZk.js","js/Auth-BQzLj073.js","js/select-CXX5Q_V1.js","js/sudanStates-CkkbYUnU.js","js/Register-Byw0Ejaq.js","js/label-C4lDws8j.js","js/alert-BXWNuJnD.js","js/radio-group-CC4lGE1V.js","js/RegistrationSuccess-DOQuj4Nz.js","js/ForgotPassword-BnuBQnlJ.js","js/form-BT_tmI7p.js","js/Dashboard-v9ElgL8V.js","js/ChatWindow-BJzXkqLX.js","js/textarea-BpQMf5eL.js","js/CallInterface-CeQ4eL66.js","js/gradient-stat-card-CWH4umO5.js","js/table-CZ8ZB6wW.js","js/progress-vMwTbqUI.js","js/calendar-DEyRSxJX.js","js/animations-BiLmE0Io.js","js/switch-DFAHzttT.js","js/maps-BzFQ_kYT.js","assets/maps-Dgihpmma.css","js/FraudPreventionDashboard-DeXNzUdp.js","js/MMP-hOWqGBDk.js","js/MMPStatusBadge-CjxSGCNB.js","js/ForwardToFOMDialog-B8pCS6SJ.js","js/checkbox-9q2dlFjr.js","js/alert-dialog-D6avgrWz.js","js/MMPSiteEntriesTable-DBUyVHQg.js","js/MMPUpload-BM6cW19x.js","js/MMPFileManagement-CII7tC-1.js","js/MMPDetail-C3InfdHM.js","js/MMPComprehensiveVerification-E3LCHbkI.js","js/MMPPermitVerification-CyCVrban.js","js/popover-BSK_FA51.js","js/PermitPreviewDialog-B2XKKnFF.js","js/AuditLogViewer-BpgeBMsl.js","js/hover-card-BltHYp3k.js","js/MMPVersionHistory-CbgVhy2G.js","js/MMPOverallInformation-CT39nI2-.js","js/MMPSiteInformation-Bke1UQxS.js","js/MMPDetailView-BjkoTVcY.js","js/ComplianceTracker-C7U1JwwF.js","js/mmpUtils-CTST1Zxt.js","js/MMPVerification-CauQ_bcY.js","js/FieldTeamMapPermissions-Rk88jEyR.js","js/MMPVerificationHeader-BpTrG5gu.js","js/pagination-wW-pUaO1.js","js/MMPDetailedVerification-Dc0LHvgH.js","js/MMPVerificationPage-CJOcXSS-.js","js/MMPPermitMessagePage-CpVw4iNZ.js","js/EditMMP-CCUYgyyF.js","js/ActivityManager-lZ-YmBoR.js","js/collapsible-DNmzDQGQ.js","js/ActivityForm-DxwKkf_I.js","js/toggle-DVFO8bcr.js","js/NotFound-DM8CFhAM.js","js/ReviewAssignCoordinators-DoyAAwSB.js","js/SitesForVerification-CBmdlnLr.js","js/CoordinatorSites-CeEdqgMl.js","js/Calls-BrT-AjR7.js","js/Chat-B4uCYOKt.js","js/FieldTeam-CEs3n55A.js","js/LeafletMapContainer-DFENE1lH.js","js/locationUtils-B4o8Dh43.js","js/Finance-BTQ41GZN.js","js/charts-B79l2W3h.js","js/Reports-D2DbiN2L.js","js/date-range-picker-sQlSgQMW.js","js/Projects-D1gJR6I4.js","js/CreateProject-C37Y1WXb.js","js/ProjectForm-DvLk3ngM.js","js/TeamCompositionManager-DL5fiHxh.js","js/CreateProjectActivity-D9deBytP.js","js/ProjectActivityDetail-d0PeX5GM.js","js/ProjectDetail-BYM63hUZ.js","js/EditProject-CrDiw484.js","js/ProjectTeamManagement-Dmdri8Xa.js","js/Settings-DphP3fCJ.js","js/UserClassificationBadge-nu7nDiDQ.js","js/ClassificationBadge-CQcKQdLP.js","js/SiteVisits-B9TjmM_w.js","js/siteVisitUtils-D0TAkk25.js","js/DynamicFieldTeamMap-CKDMcIOA.js","js/SiteVisitDetail-BTXcaQsD.js","js/EditSiteVisit-Buu6Wth5.js","js/CreateSiteVisit-CepA2DtN.js","js/CreateSiteVisitMMP-B-r-X36Q.js","js/CreateSiteVisitMMPDetail-nGXNdVSj.js","js/CreateSiteVisitUrgent-BibhL0Li.js","js/AdvancedMap-BfGW6yrq.js","js/DataVisibility-CZf5fJ27.js","js/Users-BjXneWci.js","js/UserDetail-CKGKRkrT.js","js/AuditCompliance-BCMsdIl2.js","js/Archive--k5_vFpd.js","js/Calendar-B2Mptkdf.js","js/RoleManagement-CleIT7b5.js","js/MonitoringPlanPage-C2O-jEkx.js","js/FieldOperationManager-CNOeZyYk.js","js/GlobalSearchPage-hvPutsjx.js","js/Wallet-yqJ6_spG.js","js/AdminWallets-CT_At_Lr.js","js/AdminWalletDetail-EKnZzvhw.js","js/WithdrawalApproval-D1S2j4_i.js","js/WalletReports-DzTg0ArL.js","js/Budget-DZN_XryC.js","js/Classifications-w_UAy-y1.js","js/CostSubmission-Cl5VQ6Xe.js","js/FinancialOperations-CqL_B5qx.js"])))=>i.map(i=>d[i]);
import{r as o,j as a,R as zt,X as ft,P as Pa,C as Ta,b as ka,c as Oa,d as Ra,S as Le,L as Wt,e as Fa,f as jt,g as Gt,F as Ba,D as Va,h as et,A as Kt,i as qa,k as La,l as Ht,U as Yt,m as $a,n as Ua,T as za,o as Jt,B as Ie,p as Be,q as Wa,s as Ga,t as pt,M as Ve,u as Ka,v as Ha,w as Qt,x as Zt,y as Ya,W as Ja,z as Qa,E as Za,H as Xa,G as ei,I as ti,J as si,K as Ee,N as ai,O as ii,Q as ri,V as oi,Y as qe,Z as ni,_ as tt,$ as ci}from"./react-core-B8kFjp2k.js";import{c as li}from"./react-dom-BLwj5vIO.js";import{_ as Q}from"./jspdf-rld7HkB6.js";import{L as ot,B as di}from"./router-CKy9yO3R.js";import{bx as ui,by as se,bz as mi,a2 as fi,bA as Ce,bn as ye,bo as Ne,bB as ht,bC as pi,bD as hi,bE as gi,bF as _i,bG as K,bH as Pe}from"./vendor-VlxgVHMv.js";import{u as yi,a as ve,b as he,Q as vi}from"./query-CJ0Bt4ph.js";import{c as Xt}from"./supabase-CwPDIVMD.js";import{r as bi,u as be}from"./xlsx-CBxwqXDA.js";import{o as me,F as Ct,G as we,h as wi,H as xi,I as Si,J as ji,K as Nt}from"./date-utils-YarVESQS.js";import{o as xe,n as Se,s as oe,a as nt,e as Mt,Z as Ci}from"./forms-CESK2FDA.js";import{N as Me,O as es,Q as ts,T as Ni,U as Mi,W as Ai,X as ss,Y as as,Z as is,_ as rs,$ as Ei,a0 as Di,a1 as os,a2 as Ii,a3 as ns,a4 as cs,a5 as ls,a6 as Pi,a7 as ds,a8 as us,a9 as ms,aa as fs,ab as ps,ac as hs,ad as Ti}from"./radix-ui-C2DV4xtt.js";import{O as $e,P as gs,C as Ue,a as gt,T as ze,D as We,R as _s,b as ki}from"./radix-dialogs-CnlmQBMC.js";import{S as ys,a as vs,P as Oi,C as bs,I as ws,b as xs,c as Ss,R as js,L as Cs,d as Ns,e as Ri,T as Fi}from"./radix-menus-CPezQVZk.js";import"./docs-D2Yi4cpO.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const p of n.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&i(p)}).observe(document,{childList:!0,subtree:!0});function s(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(r){if(r.ep)return;r.ep=!0;const n=s(r);fetch(r.href,n)}})();const Bi=new ui({defaultOptions:{queries:{staleTime:1e3*60*5,retry:1,refetchOnWindowFocus:!1}}}),Vi=2,qi=8e3,At={default:6e3,success:5e3,destructive:8e3,warning:7e3,info:5e3,siddig:6e3};let st=0;function Li(){return st=(st+1)%Number.MAX_SAFE_INTEGER,st.toString()}const ke=new Map,Et=(e,t=qi)=>{ke.has(e)&&clearTimeout(ke.get(e));const s=setTimeout(()=>{ke.delete(e),De({type:"REMOVE_TOAST",toastId:e})},t);ke.set(e,s)},$i=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,Vi)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(s=>s.id===t.toast.id?{...s,...t.toast}:s)};case"DISMISS_TOAST":{const{toastId:s}=t;if(s){const i=e.toasts.find(n=>n.id===s),r=i!=null&&i.important?500:100;Et(s,r),i!=null&&i.onDismiss&&i.onDismiss()}else e.toasts.forEach(i=>{Et(i.id,i.important?500:100),i.onDismiss&&i.onDismiss()});return{...e,toasts:e.toasts.map(i=>i.id===s||s===void 0?{...i,open:!1}:i)}}case"REMOVE_TOAST":return t.toastId===void 0?{...e,toasts:[]}:{...e,toasts:e.toasts.filter(s=>s.id!==t.toastId)}}},Oe=[];let Re={toasts:[]};function De(e){Re=$i(Re,e),Oe.forEach(t=>{t(Re)})}function Ui({variant:e,duration:t,action:s,...i}){const r=Li(),n=t||e&&At[e]||At.default,p=v=>De({type:"UPDATE_TOAST",toast:{...v,id:r}}),l=()=>De({type:"DISMISS_TOAST",toastId:r});let g=s;if(!g&&i.description&&typeof i.description=="string"){const v=i.description.toString();(v.includes("Validation completed")||v.includes("Critical issues:")||v.includes("Warnings:"))&&(g={altText:"View details",children:"View Details",onClick:()=>{const T=document.getElementById("validation-results");T&&T.scrollIntoView({behavior:"smooth"});const A=document.querySelector('[data-tab="validation-results"]');A&&A instanceof HTMLElement&&A.click(),l()}})}let u=n;if(i.description){const v=i.description.toString(),b=v.includes("Validation completed")||v.includes("Critical issues:")||v.includes("Warnings:");(typeof i.description=="string"&&i.description.length>100||v.includes("summary")||b)&&(e==="warning"||e==="destructive"?u=Math.min(3e4,n+15e3):u=Math.min(25e3,n+1e4),b&&v.includes("Critical issues:")&&v.includes("Warnings:")&&(u=Math.min(45e3,u+15e3)))}return De({type:"ADD_TOAST",toast:{...i,id:r,variant:e,action:g,duration:u,open:!0,onOpenChange:v=>{v||l()}}}),i.important||setTimeout(l,u),{id:r,dismiss:l,update:p}}function ne(){const[e,t]=o.useState(Re);return o.useEffect(()=>(Oe.push(t),()=>{const s=Oe.indexOf(t);s>-1&&Oe.splice(s,1)}),[e]),{...e,toast:Ui,dismiss:s=>De({type:"DISMISS_TOAST",toastId:s})}}const zi="https://abznugnirnlrqnnfkein.supabase.co",Wi="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiem51Z25pcm5scnFubmZrZWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMzU2OTEsImV4cCI6MjA3NDcxMTY5MX0.eAX9yrtgr05OVjAn_Wr2Koi92rMaV32EFj70DFfIgdM",I=Xt(zi,Wi,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),Wc=Object.freeze(Object.defineProperty({__proto__:null,supabase:I},Symbol.toStringTag,{value:"Module"})),Gi=e=>{const[t,s]=o.useState([]),[i,r]=o.useState(!1),{toast:n}=ne();o.useEffect(()=>{e&&p(e)},[e]);const p=async v=>{r(!0);try{const{data:b,error:T}=await I.from("user_roles").select("role").eq("user_id",v);if(T)throw T;if(b){const A=b.map(F=>F.role).filter(F=>!!F);s(A)}}catch(b){n({title:"Error fetching roles",description:b.message,variant:"destructive"})}finally{r(!1)}};return{roles:t,isLoading:i,hasRole:v=>t.includes(v),addRole:async(v,b)=>(n({title:"Use Role Management",description:"Assign roles from the Role Management screen only."}),!1),removeRole:async(v,b)=>(n({title:"Use Role Management",description:"Remove roles from the Role Management screen only."}),!1)}},Ms=o.createContext(void 0),Ki=({children:e})=>{const[t,s]=o.useState(()=>{const y=localStorage.getItem("PACTCurrentUser");if(y)try{const w=JSON.parse(y);return{...w,availability:w.availability||"online",lastActive:w.lastActive||new Date().toISOString()}}catch{return null}return null}),i=()=>{const y={},w=[];for(let E=0;E<localStorage.length;E++){const h=localStorage.key(E);if(h&&h.startsWith("user-"))try{const c=h.split("user-")[1],d=JSON.parse(localStorage.getItem(h)||"");d.availability||(d.availability="offline"),y[c]=d}catch{}}const R=w.map(E=>y[E.id]?{...E,...y[E.id]}:E);return Object.values(y).forEach(E=>{if(E.id&&!R.some(h=>h.id===E.id)){const h={id:E.id,name:E.name||"Unknown",email:E.email||"",role:E.role||"dataCollector",lastActive:E.lastActive||new Date().toISOString(),availability:E.availability||"offline",...E};R.push(h)}}),R},[r,n]=o.useState(i),[p,l]=o.useState(!1),{toast:g}=ne(),{roles:u,hasRole:v,addRole:b,removeRole:T}=Gi(t==null?void 0:t.id),[A,F]=o.useState({pending:!1}),P=async y=>{try{const w=y||A.email;if(!w)return!1;const{error:R}=await I.auth.resend({type:"signup",email:w});return R?(g({title:"Resend failed",description:R.message||"Failed to send verification link.",variant:"destructive"}),!1):(g({title:"Verification email sent",description:`We sent a verification link to ${w}.`}),!0)}catch(w){return g({title:"Resend failed",description:(w==null?void 0:w.message)||"Unexpected error while resending.",variant:"destructive"}),!1}},B=()=>F({pending:!1,email:void 0}),j=async()=>{try{const{data:{session:y}}=await I.auth.getSession();if(!y){n([]);return}const{data:w,error:R}=await I.from("profiles").select("*");if(R)return;const E={};if(w&&w.length>0){const{data:h,error:c}=await I.from("user_roles").select("*");c||h&&h.forEach(S=>{E[S.user_id]||(E[S.user_id]=[]),S.role&&E[S.user_id].push(S.role)});const M=[...w.map(S=>{const k=`user-${S.id}`;let q={};try{const Z=localStorage.getItem(k);Z&&(q=JSON.parse(Z))}catch{}let z=q.location;if(S.location)try{typeof S.location=="string"?z=JSON.parse(S.location):z=S.location}catch{z=q.location}return{id:S.id,name:S.full_name||S.username||"Unknown",email:S.email||q.email||"",role:S.role||"dataCollector",roles:E[S.id]||[],stateId:S.state_id||q.stateId,hubId:S.hub_id||q.hubId,localityId:S.locality_id||q.localityId,avatar:S.avatar_url||q.avatar,username:S.username||q.username,fullName:S.full_name||q.fullName,phone:S.phone||q.phone,employeeId:S.employee_id||q.employeeId,lastActive:q.lastActive||new Date().toISOString(),isApproved:S.status==="approved"||!1,availability:S.availability||q.availability||"offline",createdAt:S.created_at||q.createdAt||new Date().toISOString(),location:z,performance:q.performance||{rating:0,totalCompletedTasks:0,onTimeCompletion:0}}})];M.forEach(S=>{const k=`user-${S.id}`;localStorage.setItem(k,JSON.stringify(S))}),n(M)}}catch{}};o.useEffect(()=>{j();const y=setInterval(j,3e5);return()=>clearInterval(y)},[]),o.useEffect(()=>{const y=setInterval(()=>{t&&(s(w=>{if(!w)return w;const R={...w,lastActive:new Date().toISOString()};return localStorage.setItem("PACTCurrentUser",JSON.stringify(R)),R}),n(w=>w.map(R=>R.id===t.id?{...R,lastActive:new Date().toISOString()}:R))),n(w=>w.map(R=>{if(R.id===(t==null?void 0:t.id))return R;if(Math.random()>.95){const E=R.availability==="online"?"offline":"online";return{...R,availability:E,lastActive:E==="online"?new Date().toISOString():R.lastActive}}return R}))},6e4);return()=>clearInterval(y)},[t]);const x=async y=>{var w,R;try{const{data:E}=await I.from("profiles").select("*").eq("id",y.id).single(),{data:h}=await I.from("user_roles").select("role").eq("user_id",y.id),c=h?h.map(W=>W.role).filter(W=>!!W):[],d=E||{id:y.id,full_name:((w=y.email)==null?void 0:w.split("@")[0])||"",username:y.email,role:"dataCollector",status:"pending"},M=y.user_metadata||{},S=typeof M=="object"&&M&&M.role||"dataCollector";if(!((E==null?void 0:E.status)==="approved"))return g({title:"Pending approval",description:"Your account is pending approval by an administrator."}),await I.auth.signOut(),!1;let q;if(E!=null&&E.location)try{typeof E.location=="string"?q=JSON.parse(E.location):q=E.location}catch{q=void 0}const z={id:y.id,name:d.full_name||d.username||((R=y.email)==null?void 0:R.split("@")[0])||"User",email:y.email||"",role:d.role||S,roles:c.length>0?c:void 0,stateId:d.state_id,hubId:d.hub_id,localityId:d.locality_id,avatar:d.avatar_url,username:d.username,fullName:d.full_name,phone:d.phone,employeeId:d.employee_id,lastActive:new Date().toISOString(),isApproved:!0,availability:(E==null?void 0:E.availability)||"online",location:q,performance:{rating:0,totalCompletedTasks:0,onTimeCompletion:0}};return s(z),localStorage.setItem("PACTCurrentUser",JSON.stringify(z)),localStorage.setItem(`user-${z.id}`,JSON.stringify(z)),r.some(W=>W.id===z.id)||n(W=>[...W,z]),!0}catch{return!1}};o.useEffect(()=>{let y,w;const R=typeof window<"u"&&(window.location&&typeof window.location.hash=="string"&&window.location.hash.includes("access_token")||window.location&&typeof window.location.search=="string"&&new URLSearchParams(window.location.search).has("code"));return(async()=>{try{const{data:{session:h}}=await I.auth.getSession();if(h!=null&&h.user){const{data:{user:c}}=await I.auth.getUser();c&&await x(c)}else s(null),localStorage.removeItem("PACTCurrentUser")}catch{}const{data:{subscription:E}}=I.auth.onAuthStateChange(async h=>{try{if(h==="SIGNED_IN"||h==="TOKEN_REFRESHED"){const{data:{user:c}}=await I.auth.getUser();c&&await x(c)}else h==="SIGNED_OUT"&&(s(null),localStorage.removeItem("PACTCurrentUser"))}catch{}finally{p||l(!0),w&&clearTimeout(w)}});y=E,R?w=setTimeout(()=>l(!0),2e3):l(!0)})(),()=>{try{y==null||y.unsubscribe()}catch{}w&&clearTimeout(w)}},[]);const N=async(y,w)=>{var R,E,h;try{const{data:c,error:d}=await I.auth.signInWithPassword({email:y,password:w});if(d){const M=((R=d==null?void 0:d.message)==null?void 0:R.toString().toLowerCase())||"";if(/email\s*not\s*confirm|email\s*not\s*verified/.test(M)){F({pending:!0,email:y});try{const{error:k}=await I.auth.resend({type:"signup",email:y});g(k?{title:"Email not verified",description:"Please check your inbox for the verification link. If you don't see it, try again later.",variant:"destructive"}:{title:"Verify your email",description:`We just sent a new verification link to ${y}. Check your inbox and spam folder.`})}catch{g({title:"Email not verified",description:"Please check your inbox for the verification link. If you don't see it, try again later.",variant:"destructive"})}return!1}return g({title:"Login failed",description:"Invalid email or password. Please try again.",variant:"destructive"}),!1}else if(c!=null&&c.user){const{data:M}=await I.from("profiles").select("*").eq("id",c.user.id).single(),{data:S}=await I.from("user_roles").select("role").eq("user_id",c.user.id),k=S?S.map(ee=>ee.role).filter(ee=>!!ee):[],q=M||{id:c.user.id,full_name:((E=c.user.email)==null?void 0:E.split("@")[0])||"",username:c.user.email,role:"dataCollector"},z=c.user.user_metadata||{},Z=typeof z=="object"&&z&&z.role||"dataCollector",W=(M==null?void 0:M.status)==="approved";if(!W)return g({title:"Pending approval",description:"Your account is pending approval by an administrator."}),await I.auth.signOut(),!1;let U;if(M!=null&&M.location)try{typeof M.location=="string"?U=JSON.parse(M.location):U=M.location}catch{}const Y={id:c.user.id,name:q.full_name||q.username||((h=c.user.email)==null?void 0:h.split("@")[0])||"User",email:c.user.email||"",role:q.role||Z,roles:k.length>0?k:void 0,stateId:q.state_id,hubId:q.hub_id,localityId:q.locality_id,avatar:q.avatar_url,username:q.username,fullName:q.full_name,phone:q.phone,employeeId:q.employee_id,lastActive:new Date().toISOString(),isApproved:W,availability:(M==null?void 0:M.availability)||"online",location:U,performance:{rating:0,totalCompletedTasks:0,onTimeCompletion:0}};return Y.role==="admin"&&(!Y.roles||!Y.roles.includes("admin"))&&(Y.roles=[...Y.roles||[],"admin"]),s(Y),localStorage.setItem("PACTCurrentUser",JSON.stringify(Y)),localStorage.setItem(`user-${Y.id}`,JSON.stringify(Y)),r.some(ee=>ee.id===Y.id)||n(ee=>[...ee,Y]),!0}return g({title:"Login failed",description:"Invalid email or password. Please try again.",variant:"destructive"}),!1}catch{return g({title:"Login failed",description:"An unexpected error occurred. Please try again.",variant:"destructive"}),!1}},V=async()=>{try{s(null),localStorage.removeItem("PACTCurrentUser"),await I.auth.signOut(),g({title:"Logout successful",description:"You have been logged out of the system."})}catch{g({title:"Logout error",description:"An error occurred during logout.",variant:"destructive"})}},$=async y=>{try{const{error:w}=await I.auth.signUp({email:y.email||"",password:y.password||"",options:{data:{name:y.name,phone:y.phone,employeeId:y.employeeId,role:y.role,hubId:y.hubId,stateId:y.stateId,localityId:y.localityId,avatar:y.avatar}}});return w?(g({title:"Registration failed",description:"There was a problem creating your account. Please try again.",variant:"destructive"}),!1):(g({title:"Registration successful",description:"Your account is pending approval by an administrator."}),await j(),!0)}catch{return g({title:"Registration error",description:"An unexpected error occurred. Please try again.",variant:"destructive"}),!1}},L=async y=>{try{const{data:w,error:R}=await I.from("profiles").update({status:"approved"}).eq("id",y).select("id");if(R)return g({title:"Approval error",description:"There was an error approving the user in Supabase.",variant:"destructive"}),!1;if(!w||w.length===0)return g({title:"Approval blocked",description:"No user was updated. Check Row Level Security policies for profiles.",variant:"destructive"}),!1;n(h=>h.map(c=>c.id===y?{...c,isApproved:!0}:c));const E=localStorage.getItem(`user-${y}`);if(E)try{const h=JSON.parse(E);localStorage.setItem(`user-${y}`,JSON.stringify({...h,isApproved:!0}))}catch{}return g({title:"User approved",description:"The user can now log in to the system."}),!0}catch{return g({title:"Approval error",description:"An unexpected error occurred.",variant:"destructive"}),!1}},O=async y=>{try{const{data:w,error:R}=await I.from("profiles").delete().eq("id",y).select("id");return R||!w||w.length===0?(g({title:"Rejection blocked",description:"No user was deleted. Check Row Level Security policies for profiles.",variant:"destructive"}),!1):(n(E=>E.filter(h=>h.id!==y)),localStorage.removeItem(`user-${y}`),g({title:"User rejected",description:"The user has been removed from the system."}),!0)}catch{return g({title:"Rejection error",description:"An unexpected error occurred.",variant:"destructive"}),!1}},C=async(y,w)=>{try{if(!t)return!1;const R=new Date().toISOString(),E={...t.location||{},latitude:y,longitude:w,lastUpdated:R,isSharing:!0},{data:h,error:c}=await I.from("profiles").update({location:E,location_sharing:!0}).eq("id",t.id).select("id");if(c||!h||h.length===0)return!1;const d=r.map(S=>S.id===t.id?{...S,location:{...S.location||{},...E}}:S);n(d);const M={...t,location:{...t.location||{},...E}};return s(M),localStorage.setItem(`user-${t.id}`,JSON.stringify(M)),localStorage.setItem("PACTCurrentUser",JSON.stringify(M)),!0}catch{return!1}},m=async y=>{try{if(!t)return!1;const{error:w}=await I.from("profiles").update({availability:y}).eq("id",t.id),R=r.map(h=>h.id===t.id?{...h,availability:y,lastActive:y!=="offline"?new Date().toISOString():h.lastActive}:h);n(R);const E={...t,availability:y,lastActive:y!=="offline"?new Date().toISOString():t.lastActive};return s(E),localStorage.setItem(`user-${t.id}`,JSON.stringify(E)),localStorage.setItem("PACTCurrentUser",JSON.stringify(E)),!0}catch{return!1}},f=async y=>{try{if(!t)return!1;const{error:w}=await I.from("profiles").update({location_sharing:y}).eq("id",t.id),R=r.map(h=>h.id===t.id?{...h,location:{...h.location,isSharing:y}}:h);n(R);const E={...t,location:{...t.location,isSharing:y}};return s(E),localStorage.setItem(`user-${t.id}`,JSON.stringify(E)),localStorage.setItem("PACTCurrentUser",JSON.stringify(E)),g(y?{title:"Location sharing enabled",description:"Your location will be used for site visit assignments."}:{title:"Location sharing disabled",description:"Your location will not be shared with the system."}),!0}catch{return!1}},_=async y=>{try{const w={...y,availability:y.availability||"offline"},{data:R,error:E}=await I.from("profiles").update({full_name:w.fullName||w.name,username:w.username,email:w.email,role:w.role,avatar_url:w.avatar,hub_id:w.hubId,state_id:w.stateId,locality_id:w.localityId,employee_id:w.employeeId,phone:w.phone,bank_account:w.bankAccount,updated_at:new Date().toISOString()}).eq("id",w.id).select("id");return E||!R||R.length===0?(g({title:"Update blocked",description:"No profile was updated. You may not have permission to edit this user.",variant:"destructive"}),!1):(n(h=>h.map(c=>c.id===w.id?w:c)),localStorage.setItem(`user-${w.id}`,JSON.stringify(w)),t&&w.id===t.id&&(s(w),localStorage.setItem("PACTCurrentUser",JSON.stringify(w))),g({title:"User updated",description:`User ${w.name} has been updated successfully and will persist between sessions.`}),!0)}catch{return g({title:"Update user error",description:"An unexpected error occurred. Please try again.",variant:"destructive"}),!1}};return A.pending,A.email,a.jsx(Ms.Provider,{value:{currentUser:t,authReady:p,users:r,login:N,logout:V,registerUser:$,approveUser:L,rejectUser:O,updateUser:_,updateUserLocation:C,updateUserAvailability:m,toggleLocationSharing:f,refreshUsers:j,roles:u,hasRole:v,addRole:b,removeRole:T,emailVerificationPending:A.pending,verificationEmail:A.email,resendVerificationEmail:P,clearEmailVerificationNotice:B},children:e})},ue=()=>{const e=o.useContext(Ms);if(e===void 0)throw new Error("useUser must be used within a UserProvider");return e},Hi=(e,t)=>{const[s,i]=o.useState(null);return{currentMMP:s,setCurrentMMP:i,getMmpById:g=>!g||!(e!=null&&e.length)?void 0:e.find(v=>v.id===g),addMMPFile:g=>{try{t(u=>[...u||[],g]),se.success("MMP file added")}catch{se.error("Failed to add MMP file")}},updateMMPFile:g=>{try{t(b=>(b||[]).map(T=>T.id===g.id?g:T));const v=(b=>{const T={uploadedAt:"uploaded_at",uploadedBy:"uploaded_by",processedEntries:"processed_entries",mmpId:"mmp_id",filePath:"file_path",originalFilename:"original_filename",fileUrl:"file_url",approvalWorkflow:"approval_workflow",siteEntries:"site_entries",projectName:"project_name",cpVerification:"cp_verification",rejectionReason:"rejection_reason",approvedBy:"approved_by",approvedAt:"approved_at",archivedBy:"archived_by",archivedAt:"archived_at",deletedBy:"deleted_by",deletedAt:"deleted_at",expiryDate:"expiry_date",modificationHistory:"modification_history",modifiedAt:"modified_at"},A={updated_at:new Date().toISOString()};return Object.entries(b).forEach(([F,P])=>{const B=T[F]||F;A[B]=P}),A})(g);I.from("mmp_files").update(v).eq("id",g.id).then(({error:b})=>{b?se.error("Database update failed"):se.success("MMP file updated")})}catch{se.error("Failed to update MMP file")}},deleteMMPFile:async g=>{try{const{error:u}=await I.from("mmp_files").delete().eq("id",g);return u?(se.error("Database delete failed. Check permissions/RLS and try again."),!1):(t(v=>(v||[]).filter(b=>b.id!==g)),se.success("MMP file deleted"),!0)}catch{return se.error("Failed to delete MMP file"),!1}}}},Yi=e=>{const t=o.useCallback(async(r,n)=>{try{const p=new Date().toISOString(),{error:l}=await I.from("mmp_files").update({status:"archived",archivedby:n,archivedat:p,updated_at:p}).eq("id",r);if(l)throw se.error("Database update failed"),l;e(g=>(g||[]).map(u=>u.id===r?{...u,status:"archived",archivedBy:n,archivedAt:p}:u)),se.success("MMP file archived successfully")}catch(p){throw se.error("Failed to archive MMP file"),p}},[e]),s=o.useCallback(async(r,n)=>{try{const p=new Date().toISOString(),{error:l}=await I.from("mmp_files").update({status:"approved",approvedby:n,approvedat:p,updated_at:p}).eq("id",r);if(l)throw se.error("Database update failed"),l;e(g=>(g||[]).map(u=>u.id===r?{...u,status:"approved",approvedBy:n,approvedAt:p}:u)),se.success("MMP file approved successfully")}catch(p){throw se.error("Failed to approve MMP file"),p}},[e]),i=o.useCallback(async(r,n)=>{try{const p=new Date().toISOString(),{error:l}=await I.from("mmp_files").update({status:"rejected",rejectionreason:n,updated_at:p}).eq("id",r);if(l)throw se.error("Database update failed"),l;e(g=>(g||[]).map(u=>u.id===r?{...u,status:"rejected",rejectionReason:n,rejectedAt:p}:u)),se.success("MMP file rejected")}catch(p){throw se.error("Failed to reject MMP file"),p}},[e]);return{archiveMMP:t,approveMMP:s,rejectMMP:i}},Ji=e=>({updateMMPVersion:async(s,i)=>{try{let r=!1;return e(n=>(n||[]).map(p=>{var l,g,u,v;if(p.id===s){const b={major:((l=p.version)==null?void 0:l.major)||1,minor:(((g=p.version)==null?void 0:g.minor)||0)+1,updatedAt:new Date().toISOString()},T={...p,version:b,modifiedAt:new Date().toISOString(),modificationHistory:[...p.modificationHistory||[],{timestamp:new Date().toISOString(),modifiedBy:"Current User",changes:i,previousVersion:`${((u=p.version)==null?void 0:u.major)||1}.${((v=p.version)==null?void 0:v.minor)||0}`,newVersion:`${b.major}.${b.minor}`}]};r=!0;try{I.from("mmp_files").update({version:b,updated_at:new Date().toISOString(),modificationhistory:T.modificationHistory}).eq("id",s).then(({error:A})=>{if(A){se.error("Database version update failed, using local storage");const P=JSON.parse(localStorage.getItem("mock_mmp_files")||"[]").map(B=>B.id===s?T:B);localStorage.setItem("mock_mmp_files",JSON.stringify(P))}else se.success("MMP version updated successfully")})}catch{se.error("Database operation failed, using local storage");const P=JSON.parse(localStorage.getItem("mock_mmp_files")||"[]").map(B=>B.id===s?T:B);localStorage.setItem("mock_mmp_files",JSON.stringify(P))}return T}return p})),r||se.warning("MMP file not found"),r}catch{return se.error("Failed to update MMP version"),!1}}}),Gc=e=>{try{const t=e.split("-");if(t.length!==4)return null;const s=t[1].match(/^(\d{2})(\d{4})$/);if(!s)return null;const i=parseInt(s[1],10),r=parseInt(s[2],10),n=t[2].match(/^V(\d+)\.(\d+)$/);if(!n)return null;const p=parseInt(n[1],10),l=parseInt(n[2],10),g=t[3];return{prefix:t[0],month:i,year:r,version:{major:p,minor:l},region:g}}catch{return null}},Qi=e=>/^[A-Z]{2,4}\d{4,}$/.test(e),Dt=["Hub Office","State","Locality","Site Name","CP Name","Activity at Site","Monitoring By","Survey under Master tool","Use Market Diversion Monitoring","Use Warehouse Monitoring","Visit Date","Comments"],Zi=async(e,t)=>{var g;const s=[],i=[],r=[],n=[],p=u=>String(u||"").toLowerCase().replace(/[^a-z0-9]+/g,""),l={hubOffice:["huboffice","hub","office","hubofficename"],state:["state","statename","region","stateprovince"],locality:["locality","localityname","district","county","lga"],siteName:["sitename","site","facilityname","distributionpoint"],siteCode:["sitecode","siteid","code"],cpName:["cpname","cp","partner","partnername","implementingpartner","ipname"],siteActivity:["activityatsite","siteactivity","activitysite","activityatthesite"],mainActivity:["mainactivity","activity","activitydetails"],monitoringBy:["monitoringby","monitoringby:","monitoring by","monitoredby","visitby"],surveyTool:["surveytool","surveyundermastertool","survey under master tool","tooltobeused","tool"]};try{const u=(g=e.name.split(".").pop())==null?void 0:g.toLowerCase();let v=[],b=[];if(u==="xlsx"||u==="xls"){t==null||t({current:0,total:100,stage:"Reading Excel file"});const N=await e.arrayBuffer(),V=bi(N,{type:"array",cellDates:!0,dense:!1}),$=M=>String(M||"").toLowerCase().trim(),L=new Set(Dt.map(M=>$(M))),O=M=>(be.sheet_to_json(M,{header:1,range:"A1:ZZ1"})[0]||[]).map(q=>$(String(q))).reduce((q,z)=>q+(L.has(z)?1:0),0);let C=V.SheetNames[0],m=-1;for(const M of V.SheetNames){const S=V.Sheets[M],k=O(S);k>m&&(m=k,C=M)}const f=V.Sheets[C],_=be.decode_range(f["!ref"]||"A1");let y=_.s.r,w=-1;const R=Math.min(_.e.r,_.s.r+20);for(let M=_.s.r;M<=R;M++){const q=(be.sheet_to_json(f,{header:1,range:`A${M+1}:ZZ${M+1}`})[0]||[]).map(z=>$(String(z))).reduce((z,Z)=>z+(L.has(Z)?1:0),0);q>w&&(w=q,y=M)}if(_.e.r-y<2)return s.push({type:"error",message:"File is empty or contains only headers",category:"file_structure"}),{isValid:!1,errors:s,warnings:i,data:r,hubOffices:n,errorSummary:pe(s),warningSummary:pe(i)};v=(be.sheet_to_json(f,{header:1,range:`A${y+1}:ZZ${y+1}`})[0]||[]).map(M=>String(M??"").trim());const c=100,d=[];for(let M=y+1;M<=_.e.r;M+=c){const S=Math.min(M+c-1,_.e.r),k={s:{r:M,c:0},e:{r:S,c:_.e.c}},q=be.sheet_to_json(f,{header:1,range:be.encode_range(k),raw:!0});d.push(q),t==null||t({current:Math.min(M+c,_.e.r),total:_.e.r,stage:`Reading rows ${M}-${S}`})}b=d.flat().map(M=>v.map((S,k)=>{const q=(M||[])[k];if(q==null)return"";const z=$(String(S));if(z==="visitdate"||z==="date"){if(q instanceof Date)return me(q,"dd-MM-yyyy");if(typeof q=="number"){const Z=Date.UTC(1899,11,30),W=Math.floor(q),U=new Date(Z+W*24*60*60*1e3);return me(U,"dd-MM-yyyy")}}return String(q).trim()})),d.length=0}else{t==null||t({current:0,total:100,stage:"Reading CSV file"});const V=(await e.text()).split(/\r?\n/);if(V.length<2)return s.push({type:"error",message:"File is empty or contains only headers",category:"file_structure"}),{isValid:!1,errors:s,warnings:i,data:r,hubOffices:n,errorSummary:pe(s),warningSummary:pe(i)};v=V[0].trim().split(",").map($=>$.trim()),b=V.slice(1).filter($=>$.trim()!=="").map($=>$.split(",").map(L=>L.trim()))}const T=Dt.filter(N=>!v.find(V=>V===N));T.length>0&&i.push({type:"warning",message:`Missing headers: ${T.join(", ")}`,category:"missing_headers"});const A=new Set,F=50,P=b.length;t==null||t({current:0,total:P,stage:"Validating data"});const B=new Map;for(let N=0;N<P;N+=F){const V=Math.min(N+F,P);for(let $=N;$<V;$++){const L=b[$],O=$+2,C={};v.forEach((h,c)=>{C[h]=L[c]||""});const m={};Object.entries(C).forEach(([h,c])=>{m[p(h)]=String(c??"")});const f=h=>h.map(c=>m[p(c)]).find(c=>c&&c.trim()!=="")||"";if(!(f(l.hubOffice)||f(l.state)||f(l.locality)||f(l.siteName)||f(l.siteCode)||f(l.cpName)||f(l.siteActivity)||f(l.mainActivity)||f(l.monitoringBy)||f(l.surveyTool)))continue;if(C["Hub Office"]&&!n.includes(C["Hub Office"])&&n.push(C["Hub Office"]),!C["Visit Date"]||C["Visit Date"].trim()===""){const h=new Date;C["Visit Date"]=me(h,"dd-MM-yyyy"),C.OriginalDate=me(h,"yyyy-MM-dd"),i.push({type:"warning",message:"No visit date provided, using today's date",row:O,column:"Visit Date",category:"missing_date"})}else{let h=null;if(h=Ct(C["Visit Date"],"dd-MM-yyyy",new Date),we(h)||(h=Ct(C["Visit Date"],"yyyy-MM-dd",new Date)),we(h))C.OriginalDate=me(h,"yyyy-MM-dd"),C["Visit Date"]=me(h,"dd-MM-yyyy");else{const c=new Date;C.OriginalDate=me(c,"yyyy-MM-dd"),C["Visit Date"]=me(c,"dd-MM-yyyy"),i.push({type:"warning",message:"Invalid Visit Date format, using today's date",row:O,column:"Visit Date",category:"invalid_date_format"})}}C["Site Code"]&&(Qi(C["Site Code"])?A.has(C["Site Code"])?i.push({type:"warning",message:`Duplicate Site Code: ${C["Site Code"]}`,row:O,column:"Site Code",category:"duplicate_site_code"}):A.add(C["Site Code"]):i.push({type:"warning",message:"Site Code must follow pattern [HH][SS][YYMMDD]-[0001] (e.g., KOKH230524-0001)",row:O,column:"Site Code",category:"invalid_site_code"}));const y=h=>{for(const c of l[h]){const d=m[c];if(d&&d.trim()!=="")return d}return""};[{label:"Hub Office",key:"hubOffice"},{label:"State",key:"state"},{label:"Locality",key:"locality"},{label:"Site Name",key:"siteName"},{label:"Site ID",key:"siteCode"},{label:"CP Name",key:"cpName"},{label:"Activity at Site",key:"siteActivity"},{label:"Activity Details",key:"mainActivity"},{label:"Visit by",key:"monitoringBy"},{label:"Tool to be used",key:"surveyTool"}].forEach(h=>{y(h.key)||s.push({type:"error",message:`Missing ${h.label}`,row:O,column:h.label,category:"missing_field"})});const R=y("siteCode"),E=R||[y("hubOffice"),y("state"),y("locality"),y("siteName"),y("cpName")].map(h=>h.trim().toLowerCase()).join("|");if(E.trim()!=="")if(B.has(E)){const h=B.get(E);s.push({type:"error",message:`Duplicate site found (matches row ${h})`,row:O,column:R?"Site ID":"Composite Site Fields",category:"duplicate_site"})}else B.set(E,O);if(C["Use Market Diversion Monitoring"]){const h=String(C["Use Market Diversion Monitoring"]).toLowerCase().trim();["yes","no","true","false","1","0",""].includes(h)||i.push({type:"warning",message:"Use Market Diversion Monitoring should be Yes/No",row:O,column:"Use Market Diversion Monitoring",category:"invalid_boolean"})}if(C["Use Warehouse Monitoring"]){const h=String(C["Use Warehouse Monitoring"]).toLowerCase().trim();["yes","no","true","false","1","0",""].includes(h)||i.push({type:"warning",message:"Use Warehouse Monitoring should be Yes/No",row:O,column:"Use Warehouse Monitoring",category:"invalid_boolean"})}r.push(C)}t==null||t({current:V,total:P,stage:`Validated ${V} of ${P} rows`}),await new Promise($=>setTimeout($,0))}const j=pe(s),x=pe(i);if(b.length=0,typeof window<"u"&&window.gc&&window.gc(),i.length>15){const N=i.length-15,V=i.slice(0,15);return V.push({type:"warning",message:`...and ${N} more warnings. See validation results for details.`,category:"summary"}),{isValid:s.length===0,errors:s,warnings:V,data:r,hubOffices:n,errorSummary:j,warningSummary:x}}return{isValid:s.length===0,errors:s,warnings:i,data:r,hubOffices:n,errorSummary:j,warningSummary:x}}catch(u){return s.push({type:"error",message:`Failed to parse CSV file: ${u instanceof Error?u.message:"Unknown error"}`,category:"parse_error"}),{isValid:!1,errors:s,warnings:i,data:r,hubOffices:n,errorSummary:pe(s),warningSummary:pe(i)}}};function pe(e){const t={};return e.forEach(s=>{const i=s.category||"other";t[i]=(t[i]||0)+1}),{total:e.length,categories:t}}const It=e=>{var s;let t=[];return e.mmp_site_entries?t=e.mmp_site_entries.map(i=>({id:i.id,siteCode:i.site_code,hubOffice:i.hub_office,state:i.state,locality:i.locality,siteName:i.site_name,cpName:i.cp_name,visitType:i.visit_type,visitDate:i.visit_date,mainActivity:i.main_activity,siteActivity:i.activity_at_site,monitoringBy:i.monitoring_by,surveyTool:i.survey_tool,useMarketDiversion:i.use_market_diversion,useWarehouseMonitoring:i.use_warehouse_monitoring,comments:i.comments,additionalData:i.additional_data||{},status:i.status})):e.site_entries&&(t=e.site_entries),{id:e.id,name:e.name,hub:e.hub,month:e.month,uploadedBy:e.uploaded_by||"Unknown",uploadedAt:e.uploaded_at,status:e.status,entries:e.entries,processedEntries:e.processed_entries,mmpId:e.mmp_id,rejectionReason:e.rejection_reason,approvedBy:e.approved_by,approvedAt:e.approved_at,archivedAt:e.archived_at,archivedBy:e.archived_by,deletedAt:e.deleted_at,deletedBy:e.deleted_by,expiryDate:e.expiry_date,region:e.region,year:e.year,version:e.version,modificationHistory:e.modification_history,modifiedAt:e.modified_at,description:e.description,type:e.type,filePath:e.file_path,originalFilename:e.original_filename,fileUrl:e.file_url,projectId:e.project_id,projectName:((s=e.project)==null?void 0:s.name)||e.project_name,siteEntries:t,workflow:e.workflow,approvalWorkflow:e.approval_workflow,location:e.location,team:e.team,permits:e.permits,siteVisit:e.site_visit,financial:e.financial,performance:e.performance,cpVerification:e.cp_verification,activities:e.activities}};async function Pt(e){try{const{data:t}=await I.from("profiles").select("id, role, hub_id").in("role",["fom","supervisor"]),s=(t||[]).filter(r=>!e.hub||r.hub_id===e.hub).map(r=>r.id);if(s.length===0)return;const i=s.map(r=>({user_id:r,title:"New MMP uploaded",message:`${e.name} has been uploaded and is ready for verification`,type:"info",link:`/mmp/${e.id}`,related_entity_id:e.id,related_entity_type:"mmpFile"}));await I.from("notifications").insert(i)}catch{}}async function Xi(e){const t=[],s=[],i=[];try{const r=await Zi(e),n=v=>v.row?`${v.message} (Row ${v.row})`:v.message;t.push(...r.errors.map(n)),s.push(...r.warnings.map(n));const p=v=>String(v||"").toLowerCase().replace(/[^a-z0-9]+/g,""),g=Object.entries({huboffice:"hubOffice",hub:"hubOffice",hubofficename:"hubOffice",officename:"hubOffice",office:"hubOffice",sitecode:"siteCode",siteid:"siteCode",code:"siteCode",state:"state",statename:"state",stateprovince:"state",region:"state",locality:"locality",localityname:"locality",district:"locality",county:"locality",lga:"locality",sitename:"siteName",site:"siteName",facilityname:"siteName",distributionpoint:"siteName",cpname:"cpName",cp:"cpName",partner:"cpName",partnername:"cpName",implementingpartner:"cpName",ipname:"cpName",mainactivity:"mainActivity",activity:"mainActivity",visittype:"visitType",typeofvisit:"visitType",type:"visitType",visitdate:"visitDate",date:"visitDate",dateofvisit:"visitDate",comments:"comments",comment:"comments",remarks:"comments",notes:"comments",activityatsite:"siteActivity",siteactivity:"siteActivity",activitysite:"siteActivity",activityatthesite:"siteActivity",monitoringby:"monitoringBy","monitoringby:":"monitoringBy","monitoring by":"monitoringBy",monitoredby:"monitoringBy",surveytool:"surveyTool",surveyundermastertool:"surveyTool","survey under master tool":"surveyTool","survey under master tool:":"surveyTool",usemarketdiversion:"useMarketDiversion","use market diversion monitoring":"useMarketDiversion","use market diversion monitorir":"useMarketDiversion",usewarehousemonitoring:"useWarehouseMonitoring","use warehouse monitoring":"useWarehouseMonitoring","use warehouse monitorin":"useWarehouseMonitoring"}).reduce((v,[b,T])=>(v[p(b)]=T,v),{}),u=Date.now();return r.data.forEach((v,b)=>{if(!Object.values(v).some(P=>String(P??"").trim()!==""))return;const A={id:`site-${u}-${b}`,status:"Pending"};v.OriginalDate&&(A.visitDate=String(v.OriginalDate));for(const[P,B]of Object.entries(v)){const j=p(P);if(j==="originaldate")continue;const x=g[j];if(x){const N=B??"";if(x==="useMarketDiversion"||x==="useWarehouseMonitoring"){const V=String(N).toLowerCase().trim();A[x]=["yes","true","1","y","t"].includes(V)?!0:(["no","false","0","n","f",""].includes(V),!1)}else{if(x==="visitDate"&&v.OriginalDate)continue;A[x]=String(N)}}}const F={};for(const[P,B]of Object.entries(v)){const j=p(P);j!=="originaldate"&&!g[j]&&String(B??"").trim()!==""&&(F[P]=String(B))}if(Object.keys(F).length>0&&(A.additionalData=F),A.additionalData){const P={};Object.entries(A.additionalData).forEach(([x,N])=>{P[p(x)]=String(N)});const B=(x,N)=>{N&&(!A[x]||String(A[x]).trim()==="")&&(A[x]=N)};for(const[x,N]of Object.entries(P)){const V=g[x];V&&B(V,N)}const j=P.month||P["month:"];if(!A.state&&j){const x=j.trim();["jan","january","feb","february","mar","march","apr","april","may","jun","june","jul","july","aug","august","sep","september","oct","october","nov","november","dec","december"].includes(x.toLowerCase())||B("state",x)}if(!A.locality){const x=Object.keys(P).find(N=>/(mon|tue|wed|thu|fri|sat|sun)/.test(N)||/\b\d{4}\b/.test(N));if(x){const N=P[x];N&&N.length>0&&B("locality",N)}}if(!A.visitDate){const x=Object.keys(P).find(N=>N.includes("date")||N.includes("visitdate"));x&&B("visitDate",P[x])}}i.push(A)}),{entries:i,count:i.length,errors:t,warnings:s,rawErrors:r.errors,rawWarnings:r.warnings}}catch(r){const n=`File parsing error: ${r instanceof Error?r.message:"Unknown error"}`;return{entries:[],count:0,errors:[n],warnings:[],rawErrors:[{type:"error",message:n,category:"parse_error"}],rawWarnings:[]}}}async function er(e,t,s){var i;try{s==null||s({current:0,total:100,stage:"Starting upload process"});const r=10*1024*1024;if(e.size>r)return{success:!1,error:`File size (${(e.size/1024/1024).toFixed(2)}MB) exceeds the 10MB limit`};s==null||s({current:5,total:100,stage:"File size validated"});const n=Date.now(),p=e.name.split(".").pop(),l=`${n}_${Math.random().toString(36).substring(2)}.${p}`;s==null||s({current:10,total:100,stage:"Uploading file to storage"});const g=I.storage.from("mmp-files").upload(l,e),u=new Promise((c,d)=>setTimeout(()=>d(new Error("Storage upload timeout after 5 minutes")),3e5)),{data:v,error:b}=await Promise.race([g,u]);if(b)return se.error("Failed to upload file to storage"),{success:!1,error:"Failed to upload file to storage: "+((b==null?void 0:b.message)||JSON.stringify(b))};s==null||s({current:30,total:100,stage:"File uploaded to storage"});const{data:{publicUrl:T}}=I.storage.from("mmp-files").getPublicUrl(l);s==null||s({current:35,total:100,stage:"Parsing file and extracting entries"});const{entries:A,count:F,errors:P,warnings:B,rawErrors:j,rawWarnings:x}=await Xi(e);if(P.length>0){try{await I.storage.from("mmp-files").remove([l])}catch{}const c=`type,row,column,category,message
`,d=k=>'"'+String(k??"").replace(/"/g,'""')+'"',M=j.map(k=>[k.type,k.row??"",k.column??"",k.category??"",k.message].map(d).join(",")),S=c+M.join(`
`);return{success:!1,error:`Validation failed with ${j.length} error(s). Please fix and re-upload.`,validationReport:S,validationErrors:j,validationWarnings:x}}let N="Unknown";try{const{data:{user:c}}=await I.auth.getUser();if(c!=null&&c.id){const{data:d}=await I.from("profiles").select("full_name, username, role, email").eq("id",c.id).single(),M=(d==null?void 0:d.full_name)||(d==null?void 0:d.username)||((i=c.email)==null?void 0:i.split("@")[0])||"User",S=(d==null?void 0:d.role)||"User";N=`${M} (${S})`}}catch{}const V={name:(t==null?void 0:t.name)||e.name.replace(/\.[^/.]+$/,""),hub:t==null?void 0:t.hub,month:t==null?void 0:t.month,uploaded_at:new Date().toISOString(),uploaded_by:N,status:"pending",entries:F,processed_entries:0,mmp_id:`MMP-${n.toString().substring(5)}`,version:{major:1,minor:0,updatedAt:new Date().toISOString()},site_entries:[],workflow:{currentStage:"notStarted",lastUpdated:new Date().toISOString()},file_path:l,original_filename:e.name,file_url:T,...(t==null?void 0:t.projectId)&&{project_id:t.projectId}};if(t!=null&&t.projectId&&(t!=null&&t.hub)&&(t!=null&&t.month)){const{data:c,error:d}=await I.from("mmp_files").select("id,name,status,deleted_at,archived_at").eq("project_id",t.projectId).eq("hub",t.hub).eq("month",t.month).is("deleted_at",null).limit(1);if(!d&&c&&c.length>0){try{await I.storage.from("mmp-files").remove([l])}catch{}return{success:!1,error:`Duplicate MMP exists for selected Project/Hub/Month ("${c[0].name}"). Upload aborted.`}}}const $=I.from("mmp_files").insert(V).select("*").single(),L=new Promise((c,d)=>setTimeout(()=>d(new Error("Database insert timeout after 5 minutes")),3e5)),{data:O,error:C}=await Promise.race([$,L]);if(C){try{await I.storage.from("mmp-files").remove([l])}catch{}return se.error("Failed to save MMP data"),{success:!1,error:"Failed to save MMP data: "+((C==null?void 0:C.message)||JSON.stringify(C))}}let m=O;if(!m){const{data:c,error:d}=await I.from("mmp_files").select("*").eq("file_path",l).single();if(d)return se.error("Failed to confirm saved MMP data"),{success:!1,error:"Failed to confirm saved MMP data: "+d.message};m=c}const f=50,_=m.id,y=Math.ceil(A.length/f);s==null||s({current:50,total:100,stage:"Saving site entries to database"});for(let c=0;c<A.length;c+=f){const d=A.slice(c,c+f),M=Math.floor(c/f)+1,S=d.map(z=>({mmp_file_id:_,site_code:z.siteCode,hub_office:z.hubOffice,state:z.state,locality:z.locality,site_name:z.siteName,cp_name:z.cpName,visit_type:z.visitType,visit_date:z.visitDate,main_activity:z.mainActivity,activity_at_site:z.siteActivity,monitoring_by:z.monitoringBy,survey_tool:z.surveyTool,use_market_diversion:z.useMarketDiversion,use_warehouse_monitoring:z.useWarehouseMonitoring,comments:z.comments,additional_data:z.additionalData||{},status:z.status||"Pending"})),{error:k}=await I.from("mmp_site_entries").insert(S);if(k){try{await I.from("mmp_files").delete().eq("id",_),await I.storage.from("mmp-files").remove([l])}catch{}return{success:!1,error:"Failed to insert site entries: "+k.message}}const q=50+Math.round(M/y*40);s==null||s({current:q,total:100,stage:`Saving site entries (${M}/${y})`})}const{error:w}=await I.from("mmp_files").update({processed_entries:F}).eq("id",_);se.success(`MMP file uploaded successfully with ${F} entries`);const{data:R,error:E}=await I.from("mmp_files").select(`
        *,
        mmp_site_entries (*)
      `).eq("id",_).single();if(E){const c=It(m);return await Pt({id:c.id,name:c.name,hub:c.hub}),{success:!0,mmpData:c}}const h=It(R);return await Pt({id:h.id,name:h.name,hub:h.hub}),{success:!0,mmpData:h}}catch(r){const n=r instanceof Error?r.message:"Unknown error";return se.error("An unexpected error occurred during upload"),{success:!1,error:"An unexpected error occurred during upload: "+n}}}const tr=e=>({uploadMMP:async(s,i,r)=>{try{const n=typeof i=="string"?{projectId:i}:i,{success:p,mmpData:l,error:g,validationReport:u,validationErrors:v,validationWarnings:b}=await er(s,n,r);return!p||g?(se.error(`Error uploading MMP: ${g}`),{success:!1,error:g,validationReport:u,validationErrors:v,validationWarnings:b}):l?(e(l),se.success(`${s.name} uploaded successfully`),{success:!0,id:l.id,mmp:l,validationReport:u,validationErrors:v,validationWarnings:b}):{success:!1,error:"Upload finished without returning data",validationReport:u,validationErrors:v,validationWarnings:b}}catch(n){const p=n instanceof Error?n.message:"Unknown error";return se.error(`Upload failed: ${p}`),{success:!1,error:p}}}}),ct=e=>{const t={...e},s=t.additional_data||t.additionalData||{},i={"Site Code":"site_code",site_code:"site_code",siteCode:"site_code","Hub Office":"hub_office","Hub Office:":"hub_office",hub_office:"hub_office",hubOffice:"hub_office",State:"state","State:":"state",state:"state",state_name:"state",Locality:"locality","Locality:":"locality",locality:"locality",locality_name:"locality","Site Name":"site_name","Site Name:":"site_name",site_name:"site_name",siteName:"site_name","CP Name":"cp_name","CP name":"cp_name","CP Name:":"cp_name",cp_name:"cp_name",cpName:"cp_name","Visit Type":"visit_type",visit_type:"visit_type",visitType:"visit_type","Visit Date":"visit_date",visit_date:"visit_date",visitDate:"visit_date","Main Activity":"main_activity",main_activity:"main_activity",mainActivity:"main_activity","Activity at Site":"activity_at_site","Activity at the site":"activity_at_site","Activity at the site:":"activity_at_site",activity_at_site:"activity_at_site",siteActivity:"activity_at_site","Monitoring By":"monitoring_by","monitoring by":"monitoring_by","monitoring by:":"monitoring_by",monitoring_by:"monitoring_by",monitoringBy:"monitoring_by","Survey Tool":"survey_tool","Survey under Master tool":"survey_tool","Survey under Master tool:":"survey_tool",survey_tool:"survey_tool",surveyTool:"survey_tool","Use Market Diversion Monitoring":"use_market_diversion",use_market_diversion:"use_market_diversion",useMarketDiversion:"use_market_diversion","Use Warehouse Monitoring":"use_warehouse_monitoring",use_warehouse_monitoring:"use_warehouse_monitoring",useWarehouseMonitoring:"use_warehouse_monitoring",Comments:"comments",comments:"comments",Cost:"cost",Price:"cost",Amount:"cost",cost:"cost",price:"cost","Enumerator Fee":"enumerator_fee",enumerator_fee:"enumerator_fee","Transport Fee":"transport_fee",transport_fee:"transport_fee","Verification Notes":"verification_notes","Verification Notes:":"verification_notes",verification_notes:"verification_notes","Verified By":"verified_by","Verified By:":"verified_by",verified_by:"verified_by","Verified At":"verified_at",verified_at:"verified_at","Dispatched By":"dispatched_by",dispatched_by:"dispatched_by","Dispatched At":"dispatched_at",dispatched_at:"dispatched_at",Status:"status","Status:":"status",status:"status"},r=l=>{if(typeof l=="boolean")return l;if(l==null||l==="")return null;const g=String(l).toLowerCase().trim();return g==="yes"||g==="true"||g==="1"||g==="y"},n=l=>{if(l==null||l==="")return null;if(typeof l=="number")return l;const g=String(l).replace(/[^0-9.\-]/g,"");if(!g)return null;const u=parseFloat(g);return isNaN(u)?null:u},p=l=>{if(!l)return null;try{const g=new Date(l);return isNaN(g.getTime())?null:g.toISOString()}catch{return null}};for(const[l,g]of Object.entries(i)){const u=t[g],v=s[l];if((u==null||u==="")&&v!==null&&v!==void 0&&v!=="")if(g==="use_market_diversion"||g==="use_warehouse_monitoring"){const b=r(v);b!==null&&(t[g]=b)}else if(g==="cost"||g==="enumerator_fee"||g==="transport_fee"){const b=n(v);b!==null&&(t[g]=b)}else if(g==="verified_at"||g==="dispatched_at"){const b=p(v);b!==null&&(t[g]=b)}else t[g]=String(v).trim()}return t},sr=e=>{var s;let t=[];return e.mmp_site_entries?t=e.mmp_site_entries.map(i=>{const r=ct(i);return{id:r.id,siteCode:r.site_code,hubOffice:r.hub_office,state:r.state,locality:r.locality,siteName:r.site_name,cpName:r.cp_name,visitType:r.visit_type,visitDate:r.visit_date,mainActivity:r.main_activity,siteActivity:r.activity_at_site,monitoringBy:r.monitoring_by,surveyTool:r.survey_tool,useMarketDiversion:r.use_market_diversion,useWarehouseMonitoring:r.use_warehouse_monitoring,comments:r.comments,cost:r.cost,enumerator_fee:r.enumerator_fee,transport_fee:r.transport_fee,verified_by:r.verified_by,verified_at:r.verified_at,verification_notes:r.verification_notes,dispatched_by:r.dispatched_by,dispatched_at:r.dispatched_at,additionalData:r.additional_data||{},status:r.status}}):e.site_entries&&(t=e.site_entries),{id:e.id,name:e.name,hub:e.hub,month:e.month,uploadedBy:e.uploaded_by||"Unknown",uploadedAt:e.uploaded_at,status:e.status,entries:e.entries,processedEntries:e.processed_entries,mmpId:e.mmp_id,rejectionReason:e.rejection_reason||e.rejectionreason,approvedBy:e.approved_by||e.approvedby,approvedAt:e.approved_at||e.approvedat,verifiedBy:e.verified_by,verifiedAt:e.verified_at,archivedAt:e.archived_at||e.archivedat,archivedBy:e.archived_by||e.archivedby,deletedAt:e.deleted_at||e.deletedat,deletedBy:e.deleted_by||e.deletedby,expiryDate:e.expiry_date||e.expirydate,region:e.region,year:e.year,version:e.version,modificationHistory:e.modification_history||e.modificationhistory,modifiedAt:e.modified_at,description:e.description,type:e.type,filePath:e.file_path,originalFilename:e.original_filename,fileUrl:e.file_url,projectId:e.project_id,projectName:((s=e.project)==null?void 0:s.name)||e.project_name||e.projectname||e.name,siteEntries:t,workflow:e.workflow,approvalWorkflow:e.approval_workflow,location:e.location,team:e.team,permits:e.permits,siteVisit:e.site_visit||e.sitevisit,financial:e.financial,performance:e.performance,cpVerification:e.cp_verification||e.cpverification,comprehensiveVerification:e.comprehensive_verification,activities:e.activities}},As=o.createContext({mmpFiles:[],loading:!0,error:null,currentMMP:null,setCurrentMMP:()=>{},addMMPFile:()=>{},updateMMPFile:()=>{},deleteMMPFile:async()=>!1,getMMPById:()=>{},getMmpById:()=>{},getPermitsByMmpId:async()=>{},archiveMMP:async()=>{},approveMMP:async()=>{},rejectMMP:async()=>{},uploadMMP:async()=>({success:!1}),updateMMP:async()=>!1,updateMMPVersion:async()=>!1,deleteMMP:()=>{},restoreMMP:()=>{},resetMMP:async()=>!1,attachPermitsToMMP:async()=>{}}),ar=()=>{const[e,t]=o.useState([]),[s,i]=o.useState(!0),[r,n]=o.useState(null),{currentMMP:p,setCurrentMMP:l,getMmpById:g,addMMPFile:u,updateMMPFile:v,deleteMMPFile:b}=Hi(e,t),{archiveMMP:T,approveMMP:A,rejectMMP:F}=Yi(t),{updateMMPVersion:P}=Ji(t),{uploadMMP:B}=tr(u),j=async(O,C)=>{if(!O||!C.federal)throw new Error("Federal permit is required");const m=[],f=async(_,y)=>({type:y,fileName:_.name,uploadedAt:new Date().toISOString(),fileUrl:URL.createObjectURL(_)});C.federal&&m.push(await f(C.federal,"federal")),C.state&&m.push(await f(C.state,"state")),C.local&&m.push(await f(C.local,"local")),t(_=>_.map(y=>y.id===O?{...y,permits:{...y.permits,federal:!!C.federal,state:!!C.state,local:!!C.local,documents:m}}:y)),await I.from("mmp_files").update({permits:{federal:!!C.federal,state:!!C.state,local:!!C.local,documents:m}}).eq("id",O)};return o.useEffect(()=>{(async()=>{try{i(!0);const{data:C,error:m}=await I.from("mmp_files").select(`
            *,
            project:projects(
              id,
              name,
              project_code
            ),
            mmp_site_entries (*)
          `).order("created_at",{ascending:!1});let f=C;if(m){const{data:y,error:w}=await I.from("mmp_files").select("*").order("created_at",{ascending:!1});if(w)throw w;f=y}const _=(f||[]).map(sr);t(_)}catch{n("Failed to load MMP files"),t([])}finally{i(!1)}})()},[]),{mmpFiles:e,loading:s,error:r,currentMMP:p,setCurrentMMP:l,addMMPFile:u,updateMMPFile:v,deleteMMPFile:b,getMmpById:g,getMMPById:g,getPermitsByMmpId:async O=>{try{const C=(e||[]).find(_=>_.id===O);if(C&&typeof C.permits<"u")return C.permits;const{data:m,error:f}=await I.from("mmp_files").select("permits").eq("id",O).single();return f||m==null?void 0:m.permits}catch{return}},archiveMMP:T,approveMMP:A,rejectMMP:F,uploadMMP:B,updateMMP:async(O,C)=>{t(f=>f.map(_=>_.id===O?{..._,...C}:_));const m=f=>{const _={uploadedAt:"uploaded_at",uploadedBy:"uploaded_by",hub:"hub",month:"month",processedEntries:"processed_entries",mmpId:"mmp_id",filePath:"file_path",originalFilename:"original_filename",fileUrl:"file_url",projectId:"project_id",projectName:"project_name",approvalWorkflow:"approval_workflow",siteEntries:"site_entries",cpVerification:"cp_verification",comprehensiveVerification:"comprehensive_verification",rejectionReason:"rejectionreason",approvedBy:"approvedby",approvedAt:"approvedat",verifiedBy:"verified_by",verifiedAt:"verified_at",archivedBy:"archivedby",archivedAt:"archivedat",deletedBy:"deletedby",deletedAt:"deletedat",expiryDate:"expirydate",modificationHistory:"modificationhistory",modifiedAt:"modified_at"},y={updated_at:new Date().toISOString()},w={...f};return delete w.comprehensiveVerification,Object.entries(w).forEach(([R,E])=>{const h=_[R]||R;y[h]=E}),y};try{const f=m(C),{error:_}=await I.from("mmp_files").update(f).eq("id",O);if(_)return!1;if(typeof C.siteEntries<"u"){const y=C.siteEntries||[],{data:w,error:R}=await I.from("mmp_site_entries").select("id").eq("mmp_file_id",O);if(R)return!1;const E=(w||[]).map(W=>W.id),h=y.map(W=>W==null?void 0:W.id).filter(Boolean),c=E.filter(W=>!h.includes(W)),d=W=>{if(typeof W=="boolean")return W;const U=String(W??"").toLowerCase();return U==="yes"||U==="true"||U==="1"},M=W=>{if(W===null||typeof W>"u"||W==="")return null;if(typeof W=="number")return W;const U=String(W).replace(/[^0-9.\-]/g,"");if(!U)return null;const Y=parseFloat(U);return isNaN(Y)?null:Y},S=W=>{const U=ct(W);return{...U.id?{id:U.id}:{},mmp_file_id:O,site_code:U.site_code??U.siteCode??null,hub_office:U.hub_office??U.hubOffice??null,state:U.state??U.state_name??null,locality:U.locality??U.locality_name??null,site_name:U.site_name??U.siteName??null,cp_name:U.cp_name??U.cpName??null,visit_type:U.visit_type??U.visitType??null,visit_date:U.visit_date??U.visitDate??null,main_activity:U.main_activity??U.mainActivity??null,activity_at_site:U.activity_at_site??U.siteActivity??U.activity??null,monitoring_by:U.monitoring_by??U.monitoringBy??null,survey_tool:U.survey_tool??U.surveyTool??null,use_market_diversion:d(U.use_market_diversion??U.useMarketDiversion),use_warehouse_monitoring:d(U.use_warehouse_monitoring??U.useWarehouseMonitoring),comments:U.comments??null,cost:M(U.cost??U.price),enumerator_fee:M(U.enumerator_fee),transport_fee:M(U.transport_fee),verification_notes:U.verification_notes??U.verificationNotes??null,verified_by:U.verified_by??U.verifiedBy??null,verified_at:U.verified_at??U.verifiedAt??null,dispatched_by:U.dispatched_by??U.dispatchedBy??null,dispatched_at:U.dispatched_at??U.dispatchedAt??null,additional_data:U.additional_data??U.additionalData??{},status:U.status??"Pending"}},k=y.filter(W=>!!W.id).map(S),q=y.filter(W=>!W.id).map(S);if(c.length){const{error:W}=await I.from("mmp_site_entries").delete().in("id",c);if(W)return!1}if(k.length){const{error:W}=await I.from("mmp_site_entries").upsert(k,{onConflict:"id"});if(W)return!1}if(q.length){const{error:W}=await I.from("mmp_site_entries").insert(q);if(W)return!1}const{data:z,error:Z}=await I.from("mmp_site_entries").select("*").eq("mmp_file_id",O).order("created_at",{ascending:!0});if(!Z){const W=(z||[]).map(U=>{const Y=ct(U);return{id:Y.id,siteCode:Y.site_code,hubOffice:Y.hub_office,state:Y.state,locality:Y.locality,siteName:Y.site_name,cpName:Y.cp_name,visitType:Y.visit_type,visitDate:Y.visit_date,mainActivity:Y.main_activity,siteActivity:Y.activity_at_site,monitoringBy:Y.monitoring_by,surveyTool:Y.survey_tool,useMarketDiversion:Y.use_market_diversion,useWarehouseMonitoring:Y.use_warehouse_monitoring,comments:Y.comments,cost:Y.cost,enumerator_fee:Y.enumerator_fee,transport_fee:Y.transport_fee,verified_by:Y.verified_by,verified_at:Y.verified_at,verification_notes:Y.verification_notes,dispatched_by:Y.dispatched_by,dispatched_at:Y.dispatched_at,additionalData:Y.additional_data||{},status:Y.status}});t(U=>U.map(Y=>Y.id===O?{...Y,siteEntries:W}:Y))}}return!0}catch{return!1}},updateMMPVersion:P,deleteMMP:O=>{const C=new Date().toISOString();t(m=>m.map(f=>f.id===O?{...f,status:"deleted",deletedAt:C}:f));try{I.from("mmp_files").update({status:"deleted",deleted_at:C}).eq("id",O).then(({error:m})=>{})}catch{}},restoreMMP:O=>{t(C=>C.map(m=>m.id===O&&m.status==="deleted"?{...m,status:"pending",deletedAt:void 0,deletedBy:void 0}:m));try{I.from("mmp_files").update({status:"pending",deleted_at:null,deleted_by:null}).eq("id",O).then(({error:C})=>{})}catch{}},resetMMP:async O=>{try{if(l(null),O){t(C=>C.map(m=>m.id===O?{...m,status:"pending",approvalWorkflow:null,rejectionReason:null,approvedAt:null,approvedBy:null,verifiedAt:null,verifiedBy:null}:m));try{await I.from("mmp_files").update({status:"pending",approval_workflow:null,rejection_reason:null,approved_by:null,approved_at:null,verified_by:null,verified_at:null}).eq("id",O)}catch{}}return!0}catch{return!1}},attachPermitsToMMP:j}},ir=({children:e})=>{const t=ar();return a.jsx(As.Provider,{value:t,children:e})},rr=()=>o.useContext(As),or=[],Es=o.createContext(void 0),nr=({children:e})=>{const[t,s]=o.useState(or),[i,r]=o.useState(()=>{try{const b=localStorage.getItem("PACTCurrentUser");if(b)return JSON.parse(b).id||null}catch{}return null});zt.useEffect(()=>{const b=()=>{try{const A=localStorage.getItem("PACTCurrentUser");if(A){const F=JSON.parse(A);r(F.id||null)}else r(null)}catch{r(null)}};window.addEventListener("storage",b);const T=setInterval(b,1e3);return()=>{window.removeEventListener("storage",b),clearInterval(T)}},[]),o.useEffect(()=>{let b;return(async()=>{try{const{data:{user:T}}=await I.auth.getUser();T!=null&&T.id&&r(T.id)}catch{}try{const{data:{subscription:T}}=I.auth.onAuthStateChange(async(A,F)=>{var B;const P=((B=F==null?void 0:F.user)==null?void 0:B.id)||null;r(P)});b=T}catch{}})(),()=>{try{b==null||b.unsubscribe()}catch{}}},[]);const n=o.useCallback(b=>({id:b.id,userId:b.user_id,title:b.title,message:b.message,type:b.type,isRead:!!b.is_read,createdAt:b.created_at,link:b.link||void 0,relatedEntityId:b.related_entity_id||void 0,relatedEntityType:b.related_entity_type||void 0}),[]);o.useEffect(()=>{let b=null,T=!1;const A=async()=>{if(!i){s([]);return}try{const{data:B,error:j}=await I.from("notifications").select("*").eq("user_id",i).order("created_at",{ascending:!1}).limit(50);T||j||B&&s(B.map(n))}catch{}},F=()=>{if(i)try{b=I.channel(`notifications-${i}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${i}`},B=>{const j=n(B.new);s(x=>[j,...x].slice(0,50))}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"notifications",filter:`user_id=eq.${i}`},B=>{const j=n(B.new);s(x=>x.map(N=>N.id===j.id?j:N))}).on("postgres_changes",{event:"DELETE",schema:"public",table:"notifications",filter:`user_id=eq.${i}`},B=>{const j=B.old.id;s(x=>x.filter(N=>N.id!==j))}).subscribe()}catch{}};A(),F();const P=setInterval(A,6e4);return()=>{T=!0;try{b&&I.removeChannel(b)}catch{}clearInterval(P)}},[i,n]);const p=o.useCallback(b=>{const T=Date.now();return t.some(A=>A.userId===b.userId&&A.title===b.title&&A.message===b.message&&A.type===b.type&&!A.isRead&&T-new Date(A.createdAt).getTime()<1e4)},[t]),l=o.useCallback(b=>{if(p(b))return;const T={id:`not${Date.now()}${Math.random().toString(36).substr(2,5)}`,isRead:!1,createdAt:new Date().toISOString(),...b};s(A=>{const F=[T,...A];return F.length>50?F.slice(0,50):F}),(async()=>{try{await I.from("notifications").insert({user_id:b.userId,title:b.title,message:b.message,type:b.type,link:b.link,related_entity_id:b.relatedEntityId,related_entity_type:b.relatedEntityType})}catch{}})()},[p]),g=o.useCallback(async b=>{s(T=>T.map(A=>A.id===b?{...A,isRead:!0}:A));try{await I.from("notifications").update({is_read:!0}).eq("id",b)}catch{}},[]),u=o.useCallback(async()=>{if(i)try{const{data:b,error:T}=await I.from("notifications").delete().eq("user_id",i).select("id");if(T)throw T;s([]);const{data:A,error:F}=await I.from("notifications").select("id").eq("user_id",i).limit(1);F||A&&A.length>0}catch(b){throw b}},[i]),v=o.useCallback(()=>i?t.filter(b=>b.userId===i&&!b.isRead).length:0,[t,i]);return a.jsx(Es.Provider,{value:{notifications:t,addNotification:l,markNotificationAsRead:g,getUnreadNotificationsCount:v,clearAllNotifications:u},children:e})},Te=()=>{const e=o.useContext(Es);if(e===void 0)throw new Error("useNotifications must be used within a NotificationProvider");return e},cr=(e,t)=>{const s=t.filter(r=>r.assignedTo===e&&r.rating!==void 0);return s.length===0?0:s.reduce((r,n)=>r+(n.rating||0),0)/s.length},lr=(e,t,s)=>{const i=s.find(g=>g.id===e);if(!i||!i.performance)return 0;const{totalCompletedTasks:r,onTimeCompletion:n}=i.performance;if(r===0)return 100;const p=r+1;return(n+1)/p*100},Ds=(e,t,s,i)=>{const n=(s-e)*(Math.PI/180),p=(i-t)*(Math.PI/180),l=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*(Math.PI/180))*Math.cos(s*(Math.PI/180))*Math.sin(p/2)*Math.sin(p/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))},dr=(e,t,s=30)=>{var r,n,p,l;return!((r=e.location)!=null&&r.latitude)||!((n=e.location)!=null&&n.longitude)||!((p=t.coordinates)!=null&&p.latitude)||!((l=t.coordinates)!=null&&l.longitude)?!1:Ds(e.location.latitude,e.location.longitude,t.coordinates.latitude,t.coordinates.longitude)<=s},Tt=(e,t)=>t.filter(s=>s.assignedTo===e&&["assigned","inProgress"].includes(s.status)).length,Is=e=>{var s,i,r,n,p,l,g,u,v,b,T,A,F,P,B,j,x,N;const t=e.cost||(e.enumerator_fee||0)+(e.transport_fee||0);return{id:e.id,siteName:e.site_name||"",siteCode:e.site_code||"",status:ur(e.status),locality:e.locality||"",state:e.state||"",activity:e.activity_at_site||e.main_activity||"",priority:"medium",dueDate:e.visit_date||new Date().toISOString(),assignedTo:"",assignedBy:e.dispatched_by,assignedAt:e.dispatched_at,notes:e.comments||"",attachments:[],completedAt:e.status==="Completed"?e.updated_at:void 0,rating:void 0,ratingNotes:void 0,fees:{total:t,currency:"SDG",distanceFee:0,complexityFee:0,urgencyFee:0,baseAmount:e.enumerator_fee||0,baseFee:e.enumerator_fee||0,transportation:e.transport_fee||0},scheduledDate:e.visit_date||new Date().toISOString(),description:e.comments||"",tasks:[],permitDetails:{federal:!1,state:!1,locality:!1,verifiedBy:e.verified_by,verifiedAt:e.verified_at},location:{address:`${e.site_name}, ${e.locality}, ${e.state}`,latitude:((s=e.additional_data)==null?void 0:s.latitude)||0,longitude:((i=e.additional_data)==null?void 0:i.longitude)||0,region:e.state||""},coordinates:{latitude:((r=e.additional_data)==null?void 0:r.latitude)||0,longitude:((n=e.additional_data)==null?void 0:n.longitude)||0},mmpDetails:{mmpId:((p=e.mmp_files)==null?void 0:p.mmp_id)||"",projectId:((l=e.mmp_files)==null?void 0:l.project_id)||"",projectName:((g=e.mmp_files)==null?void 0:g.name)||"",uploadedBy:((u=e.mmp_files)==null?void 0:u.uploaded_by)||"",uploadedAt:((v=e.mmp_files)==null?void 0:v.uploaded_at)||"",region:e.state||"",approvedBy:(b=e.mmp_files)==null?void 0:b.approved_by,approvedAt:(T=e.mmp_files)==null?void 0:T.approved_at},complexity:"medium",visitType:"regular",visitTypeRaw:e.visit_type,mainActivity:e.main_activity||"",projectActivities:[],hub:e.hub_office||((A=e.mmp_files)==null?void 0:A.hub)||"",cpName:e.cp_name||"",team:{},resources:[],risks:"",estimatedDuration:"",visitHistory:[],monitoringType:e.survey_tool,createdAt:e.created_at,projectName:((F=e.mmp_files)==null?void 0:F.name)||"",startTime:void 0,hubOffice:e.hub_office||"",siteActivity:e.activity_at_site||"",monitoringBy:e.monitoring_by||"",surveyTool:e.survey_tool||"",useMarketDiversion:e.use_market_diversion||!1,useWarehouseMonitoring:e.use_warehouse_monitoring||!1,arrivalLatitude:(P=e.additional_data)==null?void 0:P.arrival_latitude,arrivalLongitude:(B=e.additional_data)==null?void 0:B.arrival_longitude,arrivalTimestamp:(j=e.additional_data)==null?void 0:j.arrival_timestamp,journeyPath:((x=e.additional_data)==null?void 0:x.journey_path)||[],arrivalRecorded:((N=e.additional_data)==null?void 0:N.arrival_recorded)||!1,region:e.state,site_code:e.site_code}},ur=e=>({Pending:"pending",Assigned:"assigned","In Progress":"inProgress",Completed:"completed",Cancelled:"cancelled",Canceled:"canceled",Verified:"permitVerified"})[e]||"pending",mr=e=>({pending:"Pending",completed:"Completed",cancelled:"Cancelled",canceled:"Cancelled",permitVerified:"Verified",assigned:"Assigned",inProgress:"In Progress"})[e]||"Pending",fr=async()=>{const{data:e,error:t}=await I.from("mmp_site_entries").select(`
      *,
      mmp_files (
        id,
        mmp_id,
        name,
        uploaded_by,
        uploaded_at,
        approved_by,
        approved_at,
        hub,
        month,
        project_id
      )
    `).order("created_at",{ascending:!1});if(t)throw t;return(e||[]).map(Is)},pr=async()=>{const e="standalone-visits-default",t="Standalone Site Visits (Auto-generated)",{data:s}=await I.from("mmp_files").select("id").eq("mmp_id",e).single();if(s)return s.id;const{data:i,error:r}=await I.from("mmp_files").insert({mmp_id:e,name:t,status:"Approved",month:new Date().toISOString().slice(0,7),hub:"All Hubs",uploaded_by:"system",uploaded_at:new Date().toISOString(),approved_by:"system",approved_at:new Date().toISOString(),file_path:"system/default-standalone-visits"}).select("id").single();if(r)throw r;return i.id},hr=async(e,t)=>{var n,p,l,g,u,v,b,T;const s={mmp_file_id:e,site_code:t.siteCode||"",hub_office:t.hubOffice||t.hub||"",state:t.state||"",locality:t.locality||"",site_name:t.siteName||"",cp_name:t.cpName||"",visit_type:t.visitTypeRaw||t.visitType||"regular",visit_date:t.dueDate||t.scheduledDate||new Date().toISOString(),main_activity:t.mainActivity||t.activity||"",activity_at_site:t.siteActivity||t.activity||"",monitoring_by:t.monitoringBy||"",survey_tool:t.surveyTool||"",use_market_diversion:t.useMarketDiversion||!1,use_warehouse_monitoring:t.useWarehouseMonitoring||!1,comments:t.notes||t.description||"",additional_data:{latitude:((n=t.coordinates)==null?void 0:n.latitude)||((p=t.location)==null?void 0:p.latitude)||0,longitude:((l=t.coordinates)==null?void 0:l.longitude)||((g=t.location)==null?void 0:g.longitude)||0,arrival_latitude:t.arrivalLatitude,arrival_longitude:t.arrivalLongitude,arrival_timestamp:t.arrivalTimestamp,journey_path:t.journeyPath,arrival_recorded:t.arrivalRecorded},status:mr(t.status||"pending"),cost:((u=t.fees)==null?void 0:u.total)||0,enumerator_fee:((v=t.fees)==null?void 0:v.baseFee)||((b=t.fees)==null?void 0:b.baseAmount)||0,transport_fee:((T=t.fees)==null?void 0:T.transportation)||0,dispatched_by:t.assignedBy,dispatched_at:t.assignedAt},{data:i,error:r}=await I.from("mmp_site_entries").insert(s).select(`
      *,
      mmp_files (
        id,
        mmp_id,
        name,
        uploaded_by,
        uploaded_at,
        approved_by,
        approved_at,
        hub,
        month,
        project_id
      )
    `).single();if(r)throw r;return Is(i)},gr=async e=>{const{error:t}=await I.from("mmp_site_entries").delete().eq("id",e);if(t)throw t;return!0},_r=async()=>await fr(),yr=async e=>{var i;let s=e.mmpId||((i=e.mmpDetails)==null?void 0:i.mmpId);if(!s)try{s=await pr()}catch{throw new Error("Unable to create site visit: could not create default MMP file. Please ensure the database is properly initialized.")}return await hr(s,e)},vr=async e=>await gr(e),ge=async(e,t)=>{const{data:s,error:i}=await I.from("mmp_site_entries").select("*").eq("id",e).single();if(i||!s)throw i||new Error("Site entry not found");const r={},n={...s.additional_data||{}};if(t.siteName!==void 0&&(r.site_name=t.siteName),t.siteCode!==void 0&&(r.site_code=t.siteCode),t.status!==void 0&&(r.status=t.status),t.locality!==void 0&&(r.locality=t.locality),t.state!==void 0&&(r.state=t.state),t.mainActivity!==void 0&&(r.main_activity=t.mainActivity),t.siteActivity!==void 0&&(r.activity_at_site=t.siteActivity),t.activity!==void 0&&(r.activity_at_site=t.activity),t.notes!==void 0&&(r.comments=t.notes),t.hubOffice!==void 0&&(r.hub_office=t.hubOffice),t.hub!==void 0&&(r.hub_office=t.hub),t.cpName!==void 0&&(r.cp_name=t.cpName),t.monitoringBy!==void 0&&(r.monitoring_by=t.monitoringBy),t.surveyTool!==void 0&&(r.survey_tool=t.surveyTool),t.useMarketDiversion!==void 0&&(r.use_market_diversion=t.useMarketDiversion),t.useWarehouseMonitoring!==void 0&&(r.use_warehouse_monitoring=t.useWarehouseMonitoring),t.visitType!==void 0&&(r.visit_type=t.visitType),t.dueDate!==void 0){const F=new Date(t.dueDate);r.visit_date=isNaN(F.getTime())?null:F.toISOString().split("T")[0]}t.fees!==void 0&&(r.cost=t.fees.total||0,t.fees.baseAmount!==void 0&&(r.enumerator_fee=t.fees.baseAmount),t.fees.transportation!==void 0&&(r.transport_fee=t.fees.transportation),t.fees.enumerator_fee!==void 0&&(r.enumerator_fee=t.fees.enumerator_fee),t.fees.transport_fee!==void 0&&(r.transport_fee=t.fees.transport_fee)),t.priority!==void 0&&(n.priority=t.priority),t.assignedTo!==void 0&&(n.assigned_to=t.assignedTo),t.assignedBy!==void 0&&(n.assigned_by=t.assignedBy),t.assignedAt!==void 0&&(n.assigned_at=t.assignedAt),t.attachments!==void 0&&(n.attachments=t.attachments),t.completedAt!==void 0&&(n.completed_at=t.completedAt),t.rating!==void 0&&(n.rating=t.rating),t.permitDetails!==void 0&&(n.permitDetails=t.permitDetails),t.complexity!==void 0&&(n.complexity=t.complexity),t.visitTypeRaw!==void 0&&(n.visitTypeRaw=t.visitTypeRaw),t.projectActivities!==void 0&&(n.projectActivities=t.projectActivities),t.mmpDetails!==void 0&&(n.mmpDetails=t.mmpDetails),t.location!==void 0&&(n.location=t.location),t.arrivalLatitude!==void 0&&(n.arrival_latitude=t.arrivalLatitude),t.arrivalLongitude!==void 0&&(n.arrival_longitude=t.arrivalLongitude),t.arrivalTimestamp!==void 0&&(n.arrival_timestamp=t.arrivalTimestamp),t.journeyPath!==void 0&&(n.journey_path=t.journeyPath),t.arrivalRecorded!==void 0&&(n.arrival_recorded=t.arrivalRecorded),r.additional_data=n;const{error:p}=await I.from("mmp_site_entries").update(r).eq("id",e);if(p)throw p;const{data:l,error:g}=await I.from("mmp_site_entries").select("*").eq("id",e).single();if(g)throw g;const u=l.additional_data||{},v=l.enumerator_fee||u.enumerator_fee||20,b=l.transport_fee||u.transport_fee||10,A={total:l.cost||v+b,currency:"SDG",distanceFee:b,complexityFee:0,urgencyFee:0,baseAmount:v,transportation:b};return{id:l.id,siteName:l.site_name,siteCode:l.site_code,status:l.status||"Pending",locality:l.locality,state:l.state,activity:l.activity_at_site||l.main_activity,priority:u.priority||"medium",dueDate:l.visit_date?new Date(l.visit_date).toISOString():void 0,assignedTo:u.assigned_to||void 0,assignedBy:u.assigned_by||void 0,assignedAt:u.assigned_at||void 0,notes:l.comments,attachments:u.attachments||[],completedAt:u.completed_at||void 0,rating:u.rating||void 0,fees:A,scheduledDate:l.visit_date?new Date(l.visit_date).toISOString():void 0,description:l.comments,hub:l.hub_office||"",cpName:l.cp_name,permitDetails:u.permitDetails||{federal:!1,state:!1,locality:!1},location:u.location||{address:"",latitude:0,longitude:0,region:l.state||""},coordinates:u.location?{latitude:u.location.latitude||0,longitude:u.location.longitude||0}:{latitude:0,longitude:0},mmpDetails:{mmpId:l.mmp_file_id||"",projectName:"",uploadedBy:"",uploadedAt:"",region:l.state||""},complexity:u.complexity||"medium",visitType:l.visit_type||"regular",visitTypeRaw:u.visitTypeRaw,mainActivity:l.main_activity||"",projectActivities:u.projectActivities||[],hubOffice:l.hub_office,siteActivity:l.activity_at_site,monitoringBy:l.monitoring_by,surveyTool:l.survey_tool,useMarketDiversion:l.use_market_diversion||!1,useWarehouseMonitoring:l.use_warehouse_monitoring||!1,arrivalLatitude:u.arrival_latitude,arrivalLongitude:u.arrival_longitude,arrivalTimestamp:u.arrival_timestamp,journeyPath:u.journey_path,arrivalRecorded:u.arrival_recorded||!1,createdAt:l.created_at}},Ps=o.createContext(void 0),br=({children:e})=>{const[t,s]=o.useState([]),[i,r]=o.useState(!0),{toast:n}=ne(),{currentUser:p,users:l,updateUser:g}=ue();o.useEffect(()=>{(async()=>{try{r(!0);const N=await _r();s(N)}catch{n({title:"Error loading site visits",description:"Please try refreshing the page.",variant:"destructive"})}finally{r(!1)}})()},[n]);const u=async x=>{var N,V,$,L,O,C,m,f,_,y,w,R,E,h,c,d;try{if(!p){n({title:"Authentication required",description:"You must be logged in to create a site visit.",variant:"destructive"});return}const M=new Date().toISOString(),S=await yr({...x,createdAt:M});s(k=>[...k,S]);try{const k=X=>(X??"").toString().trim().toLowerCase();let q=l.filter(X=>{const ee=(X.role||"").toString(),te=ee==="dataCollector"||ee.toLowerCase()==="datacollector",ae=Array.isArray(X.roles)&&X.roles.some(D=>D==="dataCollector"||typeof D=="string"&&D.toLowerCase()==="datacollector");return te||ae});if(q.length===0)try{const{data:X}=await I.from("profiles").select("id, full_name, role, state_id, locality_id, hub_id, location, availability"),{data:ee}=await I.from("user_roles").select("*"),te={};(ee||[]).forEach(D=>{te[D.user_id]||(te[D.user_id]=[]),D.role&&te[D.user_id].push(D.role)}),q=(X||[]).map(D=>{let J=D.location;try{typeof J=="string"&&(J=JSON.parse(J))}catch{}return{id:D.id,name:D.full_name||"Unknown",role:D.role||"dataCollector",roles:te[D.id]||[],stateId:D.state_id,localityId:D.locality_id,hubId:D.hub_id,availability:D.availability||"offline",location:J}}).filter(D=>{const J=(D.role||"").toString(),ie=J==="dataCollector"||J.toLowerCase()==="datacollector",ce=Array.isArray(D.roles)&&D.roles.some(le=>le==="dataCollector"||typeof le=="string"&&le.toLowerCase()==="datacollector");return ie||ce})}catch{}const z=X=>{if(!X)return!1;const{latitude:ee,longitude:te}=X;return typeof ee=="number"&&typeof te=="number"&&Number.isFinite(ee)&&Number.isFinite(te)&&!(ee===0&&te===0)},Z=z(S.coordinates)?S.coordinates:z(S.location)?S.location:null;let W={};try{const{data:X}=await I.from("mmp_site_entries").select("additional_data, status"),ee={};(X||[]).forEach(te=>{const D=(te.additional_data||{}).assigned_to;D&&(te.status==="assigned"||te.status==="inProgress"||te.status==="in_progress")&&(ee[D]=(ee[D]||0)+1)}),W=ee}catch{}const U=q.map(X=>{var ce,le;const ee=typeof((ce=X.location)==null?void 0:ce.latitude)=="number"&&typeof((le=X.location)==null?void 0:le.longitude)=="number",te=Z&&ee?Ds(X.location.latitude,X.location.longitude,Z.latitude,Z.longitude):999999,ae=!!(X.stateId&&S.state&&k(X.stateId)===k(S.state)),D=!!(X.localityId&&S.locality&&k(X.localityId)===k(S.locality)),J=!!(X.hubId&&S.hub&&k(X.hubId)===k(S.hub)),ie=typeof W[X.id]=="number"?W[X.id]:Tt(X.id,t);return{user:X,distance:te,isStateMatch:ae,isLocalityMatch:D,isHubMatch:J,workload:ie}}),Y=U.filter(X=>X.isStateMatch&&X.isLocalityMatch);if(Y.length>0){Y.sort((te,ae)=>te.workload!==ae.workload?te.workload-ae.workload:te.distance!==ae.distance?te.distance-ae.distance:0);const X=Y[0],ee=await ge(S.id,{status:"assigned",assignedTo:X.user.id,assignedBy:p.id,assignedAt:new Date().toISOString()});s(te=>te.map(ae=>ae.id===S.id?ee:ae)),v({userId:X.user.id,title:"Assigned to Site Visit",message:`You have been assigned to the site visit at ${S.siteName}. Total fee: ${Number(((N=S.fees)==null?void 0:N.total)||0)} ${((V=S.fees)==null?void 0:V.currency)||"SDG"}. Payment schedule: 20% (${(Number((($=S.fees)==null?void 0:$.total)||0)*.2).toFixed(2)}) upfront cleared before start, 80% (${(Number(((L=S.fees)==null?void 0:L.total)||0)*.8).toFixed(2)}) after completion.`,type:"info",link:`/site-visits/${S.id}`,relatedEntityId:S.id,relatedEntityType:"siteVisit"})}else{const X=U.filter(ee=>ee.isStateMatch);if(X.length>0){X.sort((ae,D)=>ae.workload!==D.workload?ae.workload-D.workload:ae.distance!==D.distance?ae.distance-D.distance:0);const ee=X[0],te=await ge(S.id,{status:"assigned",assignedTo:ee.user.id,assignedBy:p.id,assignedAt:new Date().toISOString()});s(ae=>ae.map(D=>D.id===S.id?te:D)),v({userId:ee.user.id,title:"Assigned to Site Visit",message:`You have been assigned to the site visit at ${S.siteName}. Total fee: ${Number(((O=S.fees)==null?void 0:O.total)||0)} ${((C=S.fees)==null?void 0:C.currency)||"SDG"}. Payment schedule: 20% (${(Number(((m=S.fees)==null?void 0:m.total)||0)*.2).toFixed(2)}) upfront cleared before start, 80% (${(Number(((f=S.fees)==null?void 0:f.total)||0)*.8).toFixed(2)}) after completion.`,type:"info",link:`/site-visits/${S.id}`,relatedEntityId:S.id,relatedEntityType:"siteVisit"})}else{const ee=U.filter(te=>te.isHubMatch);if(ee.length>0){ee.sort((D,J)=>D.workload!==J.workload?D.workload-J.workload:D.distance!==J.distance?D.distance-J.distance:0);const te=ee[0],ae=await ge(S.id,{status:"assigned",assignedTo:te.user.id,assignedBy:p.id,assignedAt:new Date().toISOString()});s(D=>D.map(J=>J.id===S.id?ae:J)),v({userId:te.user.id,title:"Assigned to Site Visit",message:`You have been assigned to the site visit at ${S.siteName}. Total fee: ${Number(((_=S.fees)==null?void 0:_.total)||0)} ${((y=S.fees)==null?void 0:y.currency)||"SDG"}. Payment schedule: 20% (${(Number(((w=S.fees)==null?void 0:w.total)||0)*.2).toFixed(2)}) upfront cleared before start, 80% (${(Number(((R=S.fees)==null?void 0:R.total)||0)*.8).toFixed(2)}) after completion.`,type:"info",link:`/site-visits/${S.id}`,relatedEntityId:S.id,relatedEntityType:"siteVisit"})}else if(U.length>0){const ae=[...U].sort((J,ie)=>J.workload!==ie.workload?J.workload-ie.workload:J.distance!==ie.distance?J.distance-ie.distance:0)[0],D=await ge(S.id,{status:"assigned",assignedTo:ae.user.id,assignedBy:p.id,assignedAt:new Date().toISOString()});s(J=>J.map(ie=>ie.id===S.id?D:ie)),v({userId:ae.user.id,title:"Assigned to Site Visit",message:`You have been assigned to the site visit at ${S.siteName}. Total fee: ${Number(((E=S.fees)==null?void 0:E.total)||0)} ${((h=S.fees)==null?void 0:h.currency)||"SDG"}. Payment schedule: 20% (${(Number(((c=S.fees)==null?void 0:c.total)||0)*.2).toFixed(2)}) upfront cleared before start, 80% (${(Number(((d=S.fees)==null?void 0:d.total)||0)*.8).toFixed(2)}) after completion.`,type:"info",link:`/site-visits/${S.id}`,relatedEntityId:S.id,relatedEntityType:"siteVisit"})}}}}catch{}return n({title:"Site visit created",description:"The site visit has been created successfully."}),S.id}catch{n({title:"Error",description:"An unexpected error occurred while creating the site visit.",variant:"destructive"});return}},{addNotification:v}=Te(),b=async x=>{try{if(!p)return!1;const N=t.find(L=>L.id===x);if(!N)return!1;const V=await ge(x,{status:"permitVerified",permitDetails:{...N.permitDetails,verifiedBy:p.id,verifiedAt:new Date().toISOString()}});return s(L=>L.map(O=>O.id===x?V:O)),l.filter(L=>["admin","ict","fom"].includes(L.role)).forEach(L=>{v({userId:L.id,title:"Permits Verified",message:`Permits for site visit #${x} have been verified and it's ready for assignment.`,type:"info",link:`/site-visits/${x}`,relatedEntityId:x,relatedEntityType:"siteVisit"})}),n({title:"Permits verified",description:"Site visit permits have been verified."}),!0}catch{return n({title:"Verification error",description:"An unexpected error occurred.",variant:"destructive"}),!1}},T=async(x,N)=>{var V,$,L,O;try{if(!p)return!1;const C=t.find(_=>_.id===x),m=l.find(_=>_.id===N);if(!C||!m)return n({title:"Assignment error",description:"Site visit or user not found.",variant:"destructive"}),!1;const f=await ge(x,{status:"assigned",assignedTo:N,assignedBy:p.id,assignedAt:new Date().toISOString()});return s(_=>_.map(y=>y.id===x?f:y)),v({userId:N,title:"Assigned to Site Visit",message:`You have been assigned to the site visit at ${f.siteName}. Total fee: ${Number(((V=f.fees)==null?void 0:V.total)||0)} ${(($=f.fees)==null?void 0:$.currency)||"SDG"}. Payment schedule: 20% (${(Number(((L=f.fees)==null?void 0:L.total)||0)*.2).toFixed(2)}) upfront cleared before start, 80% (${(Number(((O=f.fees)==null?void 0:O.total)||0)*.8).toFixed(2)}) after completion.`,type:"info",link:`/site-visits/${x}`,relatedEntityId:x,relatedEntityType:"siteVisit"}),n({title:"Site visit assigned",description:`The site visit has been assigned to ${m.name}.`}),!0}catch{return n({title:"Assignment error",description:"An unexpected error occurred.",variant:"destructive"}),!1}},A=async x=>{try{if(!p)return!1;const N=t.find($=>$.id===x);return N?N.assignedTo!==p.id?(n({title:"Permission denied",description:"You are not assigned to this site visit.",variant:"destructive"}),!1):(s($=>$.map(L=>L.id===x?{...L,status:"inProgress"}:L)),l.filter($=>$.role==="supervisor").forEach($=>{v({userId:$.id,title:"Site Visit Started",message:`${p.name} has started the site visit at ${N.siteName}.`,type:"info",link:`/site-visits/${x}`,relatedEntityId:x,relatedEntityType:"siteVisit"})}),n({title:"Site visit started",description:"You have successfully started the site visit."}),!0):(n({title:"Error",description:"Site visit not found.",variant:"destructive"}),!1)}catch{return n({title:"Error",description:"An unexpected error occurred.",variant:"destructive"}),!1}},F=async(x,N)=>{var V;try{if(!p)return!1;const $=t.find(f=>f.id===x);if(!$)return n({title:"Error",description:"Site visit not found.",variant:"destructive"}),!1;if($.assignedTo!==p.id)return n({title:"Permission denied",description:"You are not assigned to this site visit.",variant:"destructive"}),!1;if($.status!=="inProgress")return n({title:"Error",description:"Site visit must be in progress to complete it.",variant:"destructive"}),!1;const L=new Date().toISOString();s(f=>f.map(_=>_.id===x?{..._,status:"completed",completedAt:L,notes:N.notes||_.notes,attachments:N.attachments||_.attachments}:_));try{await ge(x,{status:"completed",completedAt:L,notes:N.notes,attachments:N.attachments})}catch{}const O=$.assignedTo,C=l.find(f=>f.id===O);if(C){const f=Tt(O,t)-1,_={...C,performance:{...C.performance,totalCompletedTasks:C.performance.totalCompletedTasks+1,onTimeCompletion:lr(C.id,!0,l),currentWorkload:Math.max(0,f)}};g(_)}l.filter(f=>f.role==="supervisor").forEach(f=>{v({userId:f.id,title:"Site Visit Completed",message:`${p.name} has completed the site visit at ${$.siteName}. Please rate the visit.`,type:"success",link:`/site-visits/${x}/rate`,relatedEntityId:x,relatedEntityType:"siteVisit"})});try{const{data:f,error:_}=await I.from("site_visit_costs").select("*").eq("site_visit_id",x).single();if(f&&!_){const y=parseFloat(f.transportation_cost||0)+parseFloat(f.accommodation_cost||0)+parseFloat(f.meal_allowance||0)+parseFloat(f.other_costs||0);if(y>0){const{data:w,error:R}=await I.from("wallets").select("*").eq("user_id",O).single();let E=w==null?void 0:w.id,h=0;if(!w||R){const{data:c,error:d}=await I.from("wallets").insert({user_id:O,balances:{SDG:y},total_earned:y}).select().single();if(d)throw d;E=c.id}else{h=parseFloat(((V=w.balances)==null?void 0:V.SDG)||0);const c=h+y;await I.from("wallets").update({balances:{...w.balances,SDG:c},total_earned:parseFloat(w.total_earned||0)+y,updated_at:new Date().toISOString()}).eq("id",E)}await I.from("wallet_transactions").insert({wallet_id:E,user_id:O,type:"site_visit_completion",amount:y,currency:"SDG",site_visit_id:x,description:`Site visit completed: ${$.siteName}`,balance_before:h,balance_after:h+y,created_by:p.id}),v({userId:O,title:"Payment Received",message:`${y.toFixed(2)} SDG added to your wallet for completing ${$.siteName}`,type:"success",relatedEntityId:x,relatedEntityType:"siteVisit"})}}}catch{}return n({title:"Site visit completed",description:"You have successfully completed the site visit."}),!0}catch{return n({title:"Error",description:"An unexpected error occurred.",variant:"destructive"}),!1}},P=async(x,N)=>{try{if(!p)return!1;const V=t.find(O=>O.id===x);if(!V||!V.assignedTo||V.status!=="completed")return n({title:"Error",description:"Cannot rate this site visit.",variant:"destructive"}),!1;s(O=>O.map(C=>C.id===x?{...C,rating:N.rating,ratingNotes:N.notes}:C));const $=V.assignedTo,L=l.find(O=>O.id===$);if(L){const O={...L,performance:{...L.performance,rating:cr($,t)}};g(O)}return v({userId:$,title:"Site Visit Rated",message:`Your site visit at ${V.siteName} has been rated ${N.rating}/5.`,type:N.rating>=4?"success":"info",link:`/site-visits/${x}`,relatedEntityId:x,relatedEntityType:"siteVisit"}),n({title:"Site visit rated",description:"You have successfully rated the site visit."}),!0}catch{return n({title:"Error",description:"An unexpected error occurred.",variant:"destructive"}),!1}},B=async x=>{try{return await vr(x),s(N=>N.filter(V=>V.id!==x)),n({title:"Site visit deleted",description:"The site visit has been removed."}),!0}catch{return n({title:"Deletion error",description:"An unexpected error occurred while deleting the site visit.",variant:"destructive"}),!1}},j=x=>{const N=t.find(V=>V.id===x);return N?l.filter(V=>(V.role==="dataCollector"||V.role==="datacollector")&&V.status==="active"&&V.availability!=="offline"&&dr(V,N,15)):[]};return a.jsx(Ps.Provider,{value:{siteVisits:t,loading:i,verifySitePermit:b,assignSiteVisit:T,startSiteVisit:A,completeSiteVisit:F,rateSiteVisit:P,getNearbyDataCollectors:j,createSiteVisit:u,deleteSiteVisit:B},children:e})},Ts=()=>{const e=o.useContext(Ps);if(e===void 0)throw new Error("useSiteVisitContext must be used within a SiteVisitProvider");return e},wr=xe({total:Se().min(0),currency:oe().min(1),allocated:Se().min(0),remaining:Se().min(0)}).refine(e=>e.allocated+e.remaining<=e.total,{message:"Allocated and remaining amounts must not exceed total budget"}),xr=xe({country:oe().min(1),region:oe(),state:oe(),selectedStates:nt(oe()).optional(),locality:oe().optional(),coordinates:xe({latitude:Se().optional(),longitude:Se().optional()}).optional()}),Sr=xe({name:oe().min(3,"Project name must be at least 3 characters"),projectCode:oe().min(1,"Project code is required"),description:oe().optional(),projectType:Mt(["infrastructure","survey","compliance","monitoring","training","other"]),status:Mt(["draft","active","onHold","completed","cancelled"]),startDate:oe().refine(e=>!isNaN(Date.parse(e)),{message:"Invalid start date format"}),endDate:oe().refine(e=>!isNaN(Date.parse(e)),{message:"Invalid end date format"}),budget:wr.nullable().optional(),location:xr,team:xe({projectManager:oe().optional(),members:nt(oe()).optional(),teamComposition:nt(xe({userId:oe(),name:oe(),role:oe(),joinedAt:oe(),workload:Se().min(0).max(100).optional()})).optional()}).optional()});function kt(e){try{const t=Sr.parse(e),s=[];if(t.startDate&&t.endDate){const i=new Date(t.startDate);new Date(t.endDate)<=i&&s.push("End date must be after start date")}return t.budget&&t.budget.allocated>t.budget.total&&s.push("Allocated budget cannot exceed total budget"),s.length>0?{success:!1,errors:s}:{success:!0,data:t}}catch(t){return t instanceof Ci?{success:!1,errors:t.errors.map(s=>`${s.path.join(".")}: ${s.message}`)}:{success:!1,errors:["An unexpected validation error occurred"]}}}const ks=o.createContext({projects:[],loading:!1,error:null,currentProject:null,setCurrentProject:()=>{},addProject:async()=>null,updateProject:async()=>{},deleteProject:async()=>{},getProjectById:()=>{},fetchProjects:async()=>{}}),Kc=()=>o.useContext(ks),jr=({children:e})=>{const[t,s]=o.useState([]),[i,r]=o.useState(!0),[n,p]=o.useState(null),[l,g]=o.useState(null),{toast:u}=ne(),v=j=>({id:j.id,name:j.name,projectCode:j.project_code,description:j.description,projectType:j.project_type,status:j.status,startDate:j.start_date,endDate:j.end_date,budget:j.budget,location:j.location,team:j.team,activities:[],createdAt:j.created_at,updatedAt:j.updated_at}),b=j=>({name:j.name,project_code:j.projectCode,description:j.description,project_type:j.projectType,status:j.status,start_date:j.startDate,end_date:j.endDate,budget:j.budget,location:j.location,team:j.team}),T=async()=>{try{r(!0),p(null);const{data:j,error:x}=await I.from("projects").select(`
          id,
          name,
          project_code,
          description,
          project_type,
          status,
          start_date,
          end_date,
          budget,
          location,
          team,
          created_at,
          updated_at,
          project_activities (
            id,
            name,
            description,
            start_date,
            end_date,
            status,
            is_active,
            assigned_to,
            sub_activities (
              id,
              name,
              description,
              status,
              is_active,
              due_date,
              assigned_to
            )
          )
        `);if(x)throw new Error(x.message);const N=(j||[]).map(V=>{const $=v(V),L=(V.project_activities||[]).map(O=>{const C=(O.sub_activities||[]).map(m=>({id:m.id,name:m.name,description:m.description,status:m.status,isActive:m.is_active,dueDate:m.due_date,assignedTo:m.assigned_to}));return{id:O.id,name:O.name,description:O.description,startDate:O.start_date,endDate:O.end_date,status:O.status,isActive:O.is_active,assignedTo:O.assigned_to,subActivities:C}});return{...$,activities:L}});s(N)}catch(j){p(j instanceof Error?j.message:"Failed to fetch projects"),u({title:"Error",description:"Failed to fetch projects. Please try again.",variant:"destructive"})}finally{r(!1)}};o.useEffect(()=>{T()},[]);const A=async j=>{var x;try{r(!0),p(null);const N=kt(j);if(!N.success)throw new Error((x=N.errors)==null?void 0:x.join(`
`));const V=b(j),{data:$,error:L}=await I.from("projects").insert(V).select().single();if(L)throw new Error(L.message);if(!$)throw new Error("No data returned from insert");const O=v($);return await T(),u({title:"Success",description:"Project created successfully!",variant:"success"}),O}catch(N){return p(N instanceof Error?N.message:"Failed to add project"),u({title:"Error",description:N instanceof Error?N.message:"Failed to create project",variant:"destructive"}),null}finally{r(!1)}},F=async j=>{var x;try{r(!0),p(null);const N=kt(j);if(!N.success)throw new Error((x=N.errors)==null?void 0:x.join(`
`));const V={...b(j),updated_at:new Date().toISOString()},{error:$}=await I.from("projects").update(V).eq("id",j.id);if($)throw new Error($.message);if(j.activities&&j.activities.length>0)for(const L of j.activities){const O={name:L.name,description:L.description,start_date:L.startDate,end_date:L.endDate,status:L.status,is_active:L.isActive,assigned_to:L.assignedTo,project_id:j.id};if(L.id.startsWith("new-")){const{data:C,error:m}=await I.from("project_activities").insert(O).select().single();if(m)throw new Error(m.message);const f=C==null?void 0:C.id;if(L.subActivities&&L.subActivities.length>0&&f)for(const _ of L.subActivities){const y={name:_.name,description:_.description,status:_.status,is_active:_.isActive,due_date:_.dueDate,assigned_to:_.assignedTo,activity_id:f};await I.from("sub_activities").insert(y)}}else{const{error:C}=await I.from("project_activities").update(O).eq("id",L.id);if(C)throw new Error(C.message);if(L.subActivities&&L.subActivities.length>0)for(const m of L.subActivities){const f={name:m.name,description:m.description,status:m.status,is_active:m.isActive,due_date:m.dueDate,assigned_to:m.assignedTo,activity_id:L.id};if(m.id.startsWith("new-"))await I.from("sub_activities").insert(f);else{const{error:_}=await I.from("sub_activities").update(f).eq("id",m.id);if(_)throw new Error(_.message)}}}}await T(),(l==null?void 0:l.id)===j.id&&g(j),u({title:"Success",description:"Project updated successfully!",variant:"success"})}catch(N){p(N instanceof Error?N.message:"Failed to update project"),u({title:"Error",description:N instanceof Error?N.message:"Failed to update project",variant:"destructive"})}finally{r(!1)}},P=async j=>{try{r(!0);const{error:x}=await I.from("projects").delete().eq("id",j);if(x)throw new Error(x.message);s(t.filter(N=>N.id!==j)),(l==null?void 0:l.id)===j&&g(null),u({title:"Success",description:"Project deleted successfully!",variant:"success"})}catch(x){p(x instanceof Error?x.message:"Failed to delete project"),u({title:"Error",description:"Failed to delete project. Please try again.",variant:"destructive"})}finally{r(!1)}},B=j=>{const x=t.find(N=>N.id===j);if(x)return x};return a.jsx(ks.Provider,{value:{projects:t,loading:i,error:n,currentProject:l,setCurrentProject:g,addProject:A,updateProject:F,deleteProject:P,getProjectById:B,fetchProjects:T},children:e})};class de{static async createChat(t){var s,i,r;try{const{data:n,error:p}=await I.from("chats").insert(t).select().single();if(p){const l=p==null?void 0:p.code,g=((r=(s=p==null?void 0:p.message)==null?void 0:(i=s.toString()).toLowerCase)==null?void 0:r.call(i))||"";if((l==="23505"||g.includes("duplicate key"))&&t.pair_key&&t.type==="private"){const v=await de.getPrivateChatByPairKey(t.pair_key);if(v)return v}return null}return n}catch{return null}}static async getMyChatByPairKey(t,s){try{const{data:i,error:r}=await I.from("chat_participants").select("chat_id").eq("user_id",t);if(r)return null;const n=(i||[]).map(g=>g.chat_id);if(n.length===0)return null;const{data:p,error:l}=await I.from("chats").select(`
          id,
          name,
          type,
          is_group,
          created_by,
          state_id,
          related_entity_id,
          related_entity_type,
          created_at,
          updated_at,
          pair_key
        `).eq("type","private").eq("pair_key",s).in("id",n).single();return l?null:p}catch{return null}}static async getPrivateChatByPairKey(t){try{const{data:s,error:i}=await I.from("chats").select(`
          id,
          name,
          type,
          is_group,
          created_by,
          state_id,
          related_entity_id,
          related_entity_type,
          created_at,
          updated_at,
          pair_key
        `).eq("type","private").eq("pair_key",t).single();return i?null:s}catch{return null}}static async getUserChats(t){try{const{data:s,error:i}=await I.from("chat_participants").select("chat_id").eq("user_id",t);if(i)return null;const r=(s||[]).map(l=>l.chat_id);if(r.length===0)return[];const{data:n,error:p}=await I.from("chats").select(`
          id,
          name,
          type,
          is_group,
          created_by,
          state_id,
          related_entity_id,
          related_entity_type,
          created_at,
          updated_at,
          pair_key
        `).in("id",r);return p?null:n||[]}catch{return null}}static async getChatParticipants(t){try{const{data:s,error:i}=await I.from("chat_participants").select("*").eq("chat_id",t);return i?null:s}catch{return null}}static async addParticipant(t,s){try{const{error:i}=await I.from("chat_participants").insert({chat_id:t,user_id:s});return!i}catch{return!1}}static async removeParticipant(t,s){try{const{error:i}=await I.from("chat_participants").delete().eq("chat_id",t).eq("user_id",s);return!i}catch{return!1}}static async sendMessage(t){try{const{data:s,error:i}=await I.from("chat_messages").insert(t).select().single();return i?null:s}catch{return null}}static async getChatMessages(t){try{const{data:s,error:i}=await I.from("chat_messages").select("*").eq("chat_id",t).order("created_at",{ascending:!0});return i?null:s}catch{return null}}static async markMessageAsRead(t,s){try{const{error:i}=await I.from("chat_message_reads").insert({message_id:t,user_id:s});return!i}catch{return!1}}static async getMessageReadReceipts(t){try{const{data:s,error:i}=await I.from("chat_message_reads").select("*").eq("message_id",t);return i?null:s}catch{return null}}static async updateChat(t,s){try{const{error:i}=await I.from("chats").update(s).eq("id",t);return!i}catch{return!1}}static async deleteChat(t){try{const{error:s}=await I.from("chats").delete().eq("id",t);return!s}catch{return!1}}static subscribeToChatMessages(t,s){return I.channel(`chat:${t}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`chat_id=eq.${t}`},i=>{s(i)}).subscribe()}static subscribeToMessageReads(t,s){return I.channel(`message-reads:${t}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_message_reads",filter:`message_id=eq.${t}`},i=>{s(i)}).subscribe()}}const Os=o.createContext(void 0),Cr=({children:e})=>{const[t,s]=o.useState([]),[i,r]=o.useState({}),[n,p]=o.useState(null),[l,g]=o.useState(!1),[u,v]=o.useState(!1),[b,T]=o.useState(null),[A,F]=o.useState([]),{currentUser:P}=ue();o.useEffect(()=>()=>{A.forEach(E=>{I.removeChannel(E)})},[A]),o.useEffect(()=>{P!=null&&P.id&&B(P.id)},[P]);const B=async E=>{g(!0),T(null);try{const h=await de.getUserChats(E);if(h){const c=h.map(M=>({id:M.id,name:M.name,type:M.type,isGroup:M.is_group,createdBy:M.created_by,stateId:M.state_id,relatedEntityId:M.related_entity_id,relatedEntityType:M.related_entity_type,createdAt:M.created_at,updatedAt:M.updated_at,participants:[],status:"active"})),d=Array.from(new Map(c.map(M=>[M.id,M])).values());s(d);for(const M of c)await j(M.id)}}catch(h){T(h.message||"Failed to load chats")}finally{g(!1)}},j=async E=>{try{const h=await de.getChatParticipants(E);h&&s(c=>c.map(d=>d.id===E?{...d,participants:h.map(M=>M.user_id)}:d))}catch(h){T(h.message||"Failed to load chat participants")}},x=async E=>{g(!0),T(null);try{const h=await de.getChatMessages(E);if(h){const c=h.map(d=>({id:d.id,chatId:d.chat_id,senderId:d.sender_id,content:d.content,contentType:d.content_type,timestamp:d.created_at,status:d.status,attachments:d.attachments,metadata:d.metadata,readBy:[],read:!1}));r(d=>({...d,[E]:c}))}}catch(h){T(h.message||"Failed to load chat messages")}finally{g(!1)}},N=n&&t.find(E=>E.id===n)||null,V=E=>{p((E==null?void 0:E.id)||null),E!=null&&E.id&&(x(E.id),$(E.id))},$=E=>{if(A.some(d=>d.topic===`chat:${E}`))return;const c=I.channel(`chat:${E}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`chat_id=eq.${E}`},d=>{const M=d.new;r(S=>{const k=S[E]||[];return k.some(q=>q.id===M.id)?S:{...S,[E]:[...k,{id:M.id,chatId:M.chat_id,senderId:M.sender_id,content:M.content,contentType:M.content_type,timestamp:M.created_at,status:M.status,attachments:M.attachments,metadata:M.metadata,readBy:[],read:!1}]}})}).subscribe();F(d=>[...d,c])},L=o.useCallback(E=>t.find(h=>h.id===E),[t]),O=o.useCallback(E=>i[E],[i]),C=o.useCallback(()=>t.reduce((E,h)=>E+(h.unreadCount||0),0),[t]),m=async(E,h,c="text",d=null,M=null)=>{if(!(P!=null&&P.id)){T("No current user");return}v(!0),T(null);try{const S=await de.sendMessage({chat_id:E,sender_id:P.id,content:h,content_type:c,attachments:d,metadata:M});if(S){const k={id:S.id,chatId:S.chat_id,senderId:S.sender_id,content:S.content,contentType:S.content_type,timestamp:S.created_at,status:S.status,attachments:S.attachments,metadata:S.metadata,readBy:[],read:!1};r(q=>{const z=q[E]||[];return z.some(Z=>Z.id===k.id)?q:{...q,[E]:[...z,k]}}),s(q=>q.map(z=>z.id===E?{...z,lastMessage:k}:z))}}catch(S){T(S.message||"Failed to send message")}finally{v(!1)}},f=async(E,h)=>{if(!(P!=null&&P.id)){T("No current user");return}try{await de.markMessageAsRead(h,P.id)&&r(d=>{const M={...d};if(M[E]){const S=M[E].findIndex(k=>k.id===h);S!==-1&&(M[E][S]={...M[E][S],read:!0,readBy:[...M[E][S].readBy||[],P.id]})}return M})}catch(c){T(c.message||"Failed to mark message as read")}},_=async(E,h,c="private")=>{if(!(P!=null&&P.id)){T("No current user");return}g(!0),T(null);try{const d=h||(E.length===1?"Private Chat":"Group Chat"),M=c!=="private";let S;if(c==="private"){const q=E.find(W=>W!==P.id)||E[0],z=[P.id,q].sort();S=`${z[0]}:${z[1]}`;let Z=await de.getMyChatByPairKey(P.id,S);if(Z||(Z=await de.getPrivateChatByPairKey(S)),Z){const W={id:Z.id,name:Z.name,type:Z.type,isGroup:Z.is_group,createdBy:Z.created_by,stateId:Z.state_id,relatedEntityId:Z.related_entity_id,relatedEntityType:Z.related_entity_type,createdAt:Z.created_at,updatedAt:Z.updated_at,participants:[],status:"active"};return s(U=>{const Y=new Map(U.map(X=>[X.id,X]));return Y.set(W.id,W),Array.from(Y.values())}),await j(W.id),W}}const k=await de.createChat({name:d,type:c,is_group:M,created_by:P.id,...S?{pair_key:S}:{}});if(k){const q=[...E,P.id];for(const Z of q)await de.addParticipant(k.id,Z);const z={id:k.id,name:k.name,type:k.type,isGroup:k.is_group,createdBy:k.created_by,stateId:k.state_id,relatedEntityId:k.related_entity_id,relatedEntityType:k.related_entity_type,createdAt:k.created_at,updatedAt:k.updated_at,participants:q,status:"active"};return s(Z=>{const W=new Map(Z.map(U=>[U.id,U]));return W.set(z.id,z),Array.from(W.values())}),z}}catch(d){T(d.message||"Failed to create chat")}finally{g(!1)}},R={chats:t,messages:i,activeChatId:n,activeChat:N,isLoading:l,isSendingMessage:u,error:b,setActiveChat:V,setActiveChatId:p,sendMessage:m,markAsRead:f,getChatById:L,createChat:_,startGroupChat:async(E,h)=>_(E,h,"group"),getChatMessages:O,getUnreadMessagesCount:C,clearError:()=>{T(null)}};return a.jsx(Os.Provider,{value:R,children:e})},Rs=()=>{const e=o.useContext(Os);if(!e)throw new Error("useChat must be used within a ChatProvider");return e},Fs=o.createContext(void 0),Nr=({children:e})=>{const[t,s]=o.useState(!1),[i,r]=o.useState(!1),[n,p]=o.useState({status:"idle",duration:0}),[l,g]=o.useState(null),u=()=>{s($=>!$),t||r(!1)},v=()=>{r($=>!$),i||s(!1)},b=()=>{s(!1),r(!1)},T=($,L,O)=>{p({status:"outgoing",recipient:{id:$,name:L,avatar:O},duration:0})},A=$=>{T($.id,$.name,$.avatar)},F=()=>{p($=>({...$,status:"connected"}))},P=()=>{p({status:"idle",duration:0})},B=()=>{p({status:"idle",duration:0})},j=($,L)=>{},x=$=>{},N=async()=>Promise.resolve(),V=()=>{g(null)};return a.jsx(Fs.Provider,{value:{toggleChatPanel:u,toggleNotificationsPanel:v,isChatPanelOpen:t,isNotificationsPanelOpen:i,closePanels:b,callState:n,startCall:T,acceptCall:F,endCall:P,rejectCall:B,initiateCall:A,openChatForEntity:j,createChatForSiteVisit:x,activeAssignment:l,handleAcceptAssignment:N,handleDeclineAssignment:V},children:e})},Mr=()=>{const e=o.useContext(Fs);if(e===void 0)throw new Error("useCommunication must be used within a CommunicationProvider");return e},at=768;function _t(){const[e,t]=o.useState(void 0);return o.useEffect(()=>{const s=window.matchMedia(`(max-width: ${at-1}px)`),i=()=>{t(window.innerWidth<at)};return s.addEventListener("change",i),t(window.innerWidth<at),()=>s.removeEventListener("change",i)},[]),!!e}const Bs=o.createContext(void 0);function Ar({children:e}){const t=_t(),[s,i]=o.useState(null),r=s||(t?"mobile":"web"),n=s===null,p=()=>{i(l=>l===null?t?"web":"mobile":null)};return o.useEffect(()=>{},[r,n,t]),a.jsx(Bs.Provider,{value:{viewMode:r,toggleViewMode:p,isAutoDetect:n},children:e})}function Vs(){const e=o.useContext(Bs);if(e===void 0)throw new Error("useViewMode must be used within a ViewModeProvider");return e}const qs=o.createContext(void 0),Er=({children:e,currentUser:t})=>{const{toast:s}=ne(),[i,r]=o.useState(!0),[n,p]=o.useState({}),[l,g]=o.useState(),[u,v]=o.useState([]),[b,T]=o.useState([]),[A,F]=o.useState([]),[P,B]=o.useState([]),[j,x]=o.useState({totalMmps:0,totalSiteVisits:0,totalDocuments:0,documentsByCategory:{},mmpStatusCounts:{},monthlyTrends:[]});o.useEffect(()=>{(async()=>{try{r(!0);const{data:f,error:_}=await I.from("mmp_files").select("*").order("created_at",{ascending:!1});if(_)throw _;const{data:y,error:w}=await I.from("mmp_site_entries").select("*").order("created_at",{ascending:!1});if(w)throw w;const R=(y||[]).map(D=>{const J=D.additional_data||{};return{id:D.id,site_name:D.site_name,site_code:D.site_code,status:D.status||"pending",locality:D.locality,state:D.state,activity:D.activity_at_site||D.main_activity,main_activity:D.main_activity||D.activity_at_site,priority:J.priority||"medium",due_date:D.visit_date,assigned_to:J.assigned_to,assigned_by:J.assigned_by,assigned_at:J.assigned_at,notes:D.comments,attachments:J.attachments||[],completed_at:J.completed_at,rating:J.rating,fees:D.fees||{total:D.cost||0,currency:"SDG"},location:J.location||{},created_at:D.created_at,updated_at:D.updated_at}});let E=[];try{const{data:D,error:J}=await I.from("report_photos").select("*").order("created_at",{ascending:!1});!J&&D&&(E=D)}catch{}const h=D=>{const J=D.uploaded_at||D.created_at,ie=J?new Date(J):new Date,ce=ie.getUTCFullYear(),le=ie.getUTCMonth()+1;return{id:D.id,name:D.name||D.original_filename||"MMP File",entries:D.entries??0,uploadedAt:J,uploadedBy:D.uploaded_by||"Unknown",status:D.status||"approved",mmpId:D.mmp_id||"",projectName:D.project_name||"",fileUrl:D.file_url||"",originalFilename:D.original_filename||"",version:D.version,siteEntries:D.site_entries||[],workflow:D.workflow||void 0,archiveId:D.id,archiveDate:J,archiveCategory:"mmp",documents:D.file_url?[{id:`mmpdoc-${D.id}`,fileName:D.original_filename||D.name||"file",fileUrl:D.file_url,fileType:"application/octet-stream",fileSize:0,uploadedBy:D.uploaded_by||"Unknown",uploadedAt:J,category:"mmp",relatedEntityId:D.id,relatedEntityType:"mmp"}]:[],createdAt:D.created_at,updatedAt:D.updated_at,year:ce,month:le}},c=D=>{const J=D.completed_at||D.created_at;return{id:D.id,siteName:D.site_name,siteCode:D.site_code,status:D.status,locality:D.locality,state:D.state,activity:D.activity,priority:D.priority,dueDate:D.due_date,scheduledDate:D.due_date,assignedTo:D.assigned_to,assignedBy:D.assigned_by,assignedAt:D.assigned_at,notes:D.notes,attachments:D.attachments||[],completedAt:D.completed_at,rating:D.rating,fees:D.fees||{},location:D.location,mainActivity:D.main_activity||D.activity,archiveId:D.id,archiveDate:J,archiveCategory:"siteVisit",documents:Array.isArray(D.attachments)?D.attachments.map((ie,ce)=>({id:`svdoc-${D.id}-${ce}`,fileName:(ie||"").split("/").pop()||"attachment",fileUrl:ie,fileType:"application/octet-stream",fileSize:0,uploadedBy:D.assigned_by||"system",uploadedAt:J||D.created_at,category:"siteVisit",relatedEntityId:D.id,relatedEntityType:"siteVisit"})):[]}},d=(f||[]).filter(D=>{const J=(D.status||"").toLowerCase();return J==="approved"||J==="archived"}),M=(R||[]).filter(D=>(D.status||"").toLowerCase()==="completed"),S=d.map(h),k=M.map(c),q=S.flatMap(D=>D.documents),z=k.flatMap(D=>D.documents),Z=(E||[]).map(D=>({id:D.id,fileName:(D.photo_url||"").split("/").pop()||"photo",fileUrl:D.photo_url,fileType:"image/jpeg",fileSize:0,uploadedBy:"system",uploadedAt:D.created_at,category:"report",relatedEntityId:D.report_id,relatedEntityType:"siteVisit"})),W=[...q,...z,...Z],U=new Map,Y=(D,J)=>{if(!D||!J)return;const ie=new Date(D),ce=ie.getUTCFullYear(),le=ie.getUTCMonth()+1,Xe=`${ce}-${le}`;U.has(Xe)||U.set(Xe,{y:ce,m:le,mmps:0,svs:0,docs:0});const St=U.get(Xe);St[J]=St[J]+1};S.forEach(D=>Y(D.uploadedAt,"mmps")),k.forEach(D=>Y(D.completedAt,"svs")),W.forEach(D=>Y(D.uploadedAt,"docs"));const X=[...U.values()].sort((D,J)=>J.y-D.y||J.m-D.m).map(D=>({year:D.y,month:D.m,label:new Date(Date.UTC(D.y,D.m-1,1)).toLocaleString("en",{month:"long",year:"numeric",timeZone:"UTC"}),mmpsCount:D.mmps,siteVisitsCount:D.svs,documentsCount:D.docs})),ee=W.reduce((D,J)=>(D[J.category]=(D[J.category]||0)+1,D),{}),te=S.reduce((D,J)=>{const ie=(J.status||"unknown").toLowerCase();return D[ie]=(D[ie]||0)+1,D},{}),ae=X.map(D=>({year:D.year,month:D.month,mmps:D.mmpsCount,siteVisits:D.siteVisitsCount,documents:D.documentsCount}));T(S),F(k),B(W),v(X),g(X[0]),x({totalMmps:S.length,totalSiteVisits:k.length,totalDocuments:W.length,documentsByCategory:ee,mmpStatusCounts:te,monthlyTrends:ae})}catch{s({title:"Failed to load archive",description:"Please check your internet connection and try again.",variant:"destructive"})}finally{r(!1)}})()},[]);const C={archives:u,currentArchive:l,archivedMMPs:b,archivedSiteVisits:A,documents:P,statistics:j,filters:n,loading:i,setFilters:p,selectMonth:(m,f)=>{const _=u.find(y=>y.year===m&&y.month===f);_&&(g(_),s({title:"Archive Selected",description:`Viewing archive for ${_.label}`}),r(!0),setTimeout(()=>{r(!1)},800))},downloadArchive:async(m,f)=>{try{r(!0),await new Promise(y=>setTimeout(y,1500));const _=m.toUpperCase();return s({title:"Archive Downloaded",description:`The archive has been downloaded in ${_} format.`,variant:"success"}),r(!1),!0}catch{return s({title:"Download Failed",description:"There was an error downloading the archive.",variant:"destructive"}),r(!1),!1}},uploadDocument:async m=>{try{r(!0),await new Promise(y=>setTimeout(y,1e3));const f=`doc-${Date.now()}`,_={...m,id:f};return B(y=>[...y,_]),s({title:"Document Uploaded",description:`${m.fileName} has been added to the archive.`,variant:"success"}),r(!1),f}catch{return s({title:"Upload Failed",description:"There was an error uploading the document.",variant:"destructive"}),r(!1),""}},deleteDocument:async m=>{try{r(!0),await new Promise(_=>setTimeout(_,800)),B(_=>_.filter(y=>y.id!==m));const f=P.find(_=>_.id===m);return s({title:"Document Deleted",description:`${(f==null?void 0:f.fileName)||"Document"} has been removed from the archive.`,variant:"success"}),r(!1),!0}catch{return s({title:"Delete Failed",description:"There was an error deleting the document.",variant:"destructive"}),r(!1),!1}},searchArchives:async m=>{r(!0),await new Promise(R=>setTimeout(R,800));const f=m.toLowerCase(),_=b.filter(R=>R.mmpId.toLowerCase().includes(f)||R.name.toLowerCase().includes(f)||R.description.toLowerCase().includes(f)),y=A.filter(R=>{var E;return R.siteName.toLowerCase().includes(f)||((E=R.description)==null?void 0:E.toLowerCase().includes(f))||R.state.toLowerCase().includes(f)}),w=P.filter(R=>{var E;return R.fileName.toLowerCase().includes(f)||((E=R.description)==null?void 0:E.toLowerCase().includes(f))});return r(!1),{mmps:_,siteVisits:y,documents:w}}};return a.jsx(qs.Provider,{value:C,children:e})},Hc=()=>{const e=o.useContext(qs);if(e===void 0)throw new Error("useArchive must be used within an ArchiveProvider");return e},Ls=o.createContext(void 0),Dr=({children:e})=>{const{toast:t}=ne(),{currentUser:s}=ue(),[i,r]=o.useState(!0),[n,p]=o.useState(null),[l,g]=o.useState(null),[u,v]=o.useState(null),[b,T]=o.useState(null),[A,F]=o.useState({enabled:!0,email:!1,sound:!1}),[P,B]=o.useState({darkMode:!1,theme:"default"});o.useEffect(()=>{if(!(s!=null&&s.id))return;(async()=>{var O;r(!0),p(null);try{const{data:C,error:m}=await I.from("user_settings").select("*").eq("user_id",s.id).limit(1);m&&p("Failed to fetch user settings");const f=C==null?void 0:C[0];f&&(g(f),(O=f.settings)!=null&&O.theme&&B(c=>({...c,darkMode:f.settings.theme==="dark",theme:f.settings.theme==="system"?"default":f.settings.theme})));const{data:_,error:y}=await I.from("data_visibility_settings").select("*").eq("user_id",s.id).limit(1),w=_==null?void 0:_[0];w&&v(w);const{data:R,error:E}=await I.from("dashboard_settings").select("*").eq("user_id",s.id).limit(1),h=R==null?void 0:R[0];h&&T(h)}catch{p("An unexpected error occurred while fetching settings")}finally{r(!1)}})()},[s==null?void 0:s.id]);const j=async L=>{if(s!=null&&s.id)try{const O={...(l==null?void 0:l.settings)||{},...L};if(l!=null&&l.id){const{error:C}=await I.from("user_settings").update({settings:O}).eq("id",l.id);if(C)throw C}else{const{error:C}=await I.from("user_settings").insert([{user_id:s.id,settings:O}]);if(C)throw C}g(C=>({...C||{},settings:O,user_id:s.id})),t({title:"Settings updated",description:"Your settings have been saved successfully",variant:"success"})}catch(O){t({title:"Settings update failed",description:(O==null?void 0:O.message)||"There was a problem saving your settings",variant:"destructive"})}},x=async L=>{F(L),await j({notificationPreferences:L})},N=async L=>{B(L);const O=L.darkMode?"dark":"light";await j({theme:O})},V=async L=>{if(s!=null&&s.id)try{if(u!=null&&u.id){const{error:O}=await I.from("data_visibility_settings").update({options:{...u.options,...L.options||{}}}).eq("id",u.id);if(O)throw O}else{const{error:O}=await I.from("data_visibility_settings").insert([{user_id:s.id,options:L.options||{}}]);if(O)throw O}v(O=>({...O,options:{...(O==null?void 0:O.options)||{},...L.options||{}},user_id:s.id})),t({title:"Visibility settings updated",description:"Your data visibility settings have been saved successfully",variant:"success"})}catch(O){t({title:"Settings update failed",description:O.message||"There was a problem saving your visibility settings",variant:"destructive"})}},$=async L=>{if(s!=null&&s.id)try{if(b!=null&&b.id){const{error:O}=await I.from("dashboard_settings").update({layout:L.layout||b.layout,widget_order:L.widget_order||b.widget_order}).eq("id",b.id);if(O)throw O}else{const{error:O}=await I.from("dashboard_settings").insert([{user_id:s.id,layout:L.layout||{},widget_order:L.widget_order||[]}]);if(O)throw O}T(O=>({...O,...L,user_id:s.id})),t({title:"Dashboard settings updated",description:"Your dashboard layout has been saved successfully",variant:"success"})}catch(O){t({title:"Settings update failed",description:O.message||"There was a problem saving your dashboard settings",variant:"destructive"})}};return a.jsx(Ls.Provider,{value:{userSettings:l,dataVisibilitySettings:u,dashboardSettings:b,notificationSettings:A,appearanceSettings:P,updateUserSettings:j,updateNotificationSettings:x,updateAppearanceSettings:N,updateDataVisibilitySettings:V,updateDashboardSettings:$,loading:i,error:n},children:e})},Yc=()=>{const e=o.useContext(Ls);if(e===void 0)throw new Error("useSettings must be used within a SettingsProvider");return e},Ot=["users","roles","permissions","projects","mmp","site_visits","finances","reports","settings"],Rt=["create","read","update","delete","approve","assign","archive"],$s=o.createContext(void 0),Ir=({children:e})=>{const[t,s]=o.useState([]),[i,r]=o.useState([]),[n,p]=o.useState(!1),{toast:l}=ne(),[g,u]=o.useState({}),v=o.useCallback(async()=>{var C;p(!0);try{const{data:m,error:f}=await I.rpc("get_roles_with_permissions");if(f)throw f;if(m){const _=m.map(w=>({id:w.role_id,name:w.role_name,display_name:w.display_name,description:w.description,is_system_role:w.is_system_role,is_active:w.is_active,created_at:"",updated_at:"",permissions:w.permissions||[]}));s(_);const y=_.find(w=>w.name==="admin");if(y){let w=!1;try{const{data:R}=await I.auth.getUser(),E=(C=R==null?void 0:R.user)==null?void 0:C.id;if(E){const{data:h}=await I.from("profiles").select("role").eq("id",E).single();((h==null?void 0:h.role)==="admin"||(h==null?void 0:h.role)==="ict")&&(w=!0)}}catch{}if(w){const R=new Set(Ot.flatMap(c=>Rt.map(d=>`${c}:${d}`))),E=new Set((y.permissions||[]).map(c=>`${c.resource}:${c.action}`)),h=Array.from(R).filter(c=>!E.has(c)).map(c=>{const[d,M]=c.split(":");return{role_id:y.id,resource:d,action:M,conditions:null}});h.length>0&&await I.from("permissions").upsert(h,{onConflict:"role_id,resource,action"})}}}}catch(m){l({title:"Error fetching roles",description:m.message,variant:"destructive"})}finally{p(!1)}},[l]),b=o.useCallback(async C=>{try{const{data:m,error:f}=await I.rpc("get_user_permissions",{user_uuid:C});if(f)throw f;return u(_=>({..._,[C]:m||[]})),m||[]}catch{return[]}},[]),T=async C=>{p(!0);try{const{data:m,error:f}=await I.from("roles").insert({name:C.name,display_name:C.display_name,description:C.description,is_system_role:!1,is_active:!0}).select().single();if(f)throw f;if(C.permissions&&C.permissions.length>0){const _=C.permissions.map(w=>({role_id:m.id,resource:w.resource,action:w.action,conditions:w.conditions})),{error:y}=await I.from("permissions").insert(_);if(y)throw y}return l({title:"Role created successfully",description:`Role "${C.display_name}" has been created.`}),await v(),m}catch(m){return l({title:"Error creating role",description:m.message,variant:"destructive"}),null}finally{p(!1)}},A=async(C,m)=>{var f;p(!0);try{const _={};if(m.display_name!==void 0&&(_.display_name=m.display_name),m.description!==void 0&&(_.description=m.description),m.is_active!==void 0&&(_.is_active=m.is_active),Object.keys(_).length>0){const{error:R}=await I.from("roles").update(_).eq("id",C);if(R)throw R}const w=((f=t.find(R=>R.id===C))==null?void 0:f.name)==="admin"?Ot.flatMap(R=>Rt.map(E=>({resource:R,action:E}))):m.permissions;if(w){const{data:R,error:E}=await I.from("permissions").select("id, resource, action").eq("role_id",C);if(E)throw E;const h=R||[],c=new Set(w.map(k=>`${k.resource}:${k.action}`)),d=new Set(h.map(k=>`${k.resource}:${k.action}`)),M=h.filter(k=>!c.has(`${k.resource}:${k.action}`)).map(k=>k.id);if(M.length>0){const{error:k}=await I.from("permissions").delete().in("id",M);if(k)throw k}const S=w.filter(k=>!d.has(`${k.resource}:${k.action}`)).map(k=>({role_id:C,resource:k.resource,action:k.action,conditions:k.conditions??null}));if(S.length>0){const{error:k}=await I.from("permissions").insert(S);if(k)throw k}}return l({title:"Role updated",description:"Role was updated successfully."}),v().catch(()=>{}),!0}catch(_){return l({title:"Error updating role",description:_.message,variant:"destructive"}),!1}finally{p(!1)}},F=async C=>{p(!0);try{const{error:m}=await I.from("roles").delete().eq("id",C);if(m)throw m;return l({title:"Role deleted",description:"Role removed successfully."}),await v(),!0}catch(m){return l({title:"Error deleting role",description:m.message,variant:"destructive"}),!1}finally{p(!1)}},P=async C=>{var m;p(!0);try{const{data:f}=await I.auth.getUser(),_=((m=f==null?void 0:f.user)==null?void 0:m.id)??null,y=new Date().toISOString();if(C.role){const{data:w,error:R}=await I.from("user_roles").select("id").eq("user_id",C.user_id).eq("role",C.role).limit(1);if(R)throw R;if(!w||w.length===0){const{error:E}=await I.from("user_roles").insert({user_id:C.user_id,role:C.role,assigned_by:_,assigned_at:y});if(E)throw E}}else if(C.role_id){const{data:w,error:R}=await I.from("user_roles").select("id").eq("user_id",C.user_id).eq("role_id",C.role_id).limit(1);if(R)throw R;if(!w||w.length===0){const{error:E}=await I.from("user_roles").insert({user_id:C.user_id,role_id:C.role_id,assigned_by:_,assigned_at:y});if(E)throw E}}else throw new Error("Either role or role_id must be provided");return l({title:"Role assigned",description:"User role assignment saved."}),await j(),await b(C.user_id),!0}catch(f){return l({title:"Error assigning role",description:f.message,variant:"destructive"}),!1}finally{p(!1)}},B=async(C,m,f)=>{p(!0);try{if(!m&&!f)throw new Error("Specify roleId or role to remove");let _=I.from("user_roles").delete().eq("user_id",C);m&&(_=_.eq("role_id",m)),!m&&f&&(_=_.eq("role",f));const{error:y}=await _;if(y)throw y;return l({title:"Role removed",description:"User role removed."}),await j(),await b(C),!0}catch(_){return l({title:"Error removing role",description:_.message,variant:"destructive"}),!1}finally{p(!1)}},j=async C=>{try{let m=I.from("user_roles").select("id, user_id, role, role_id, assigned_by, assigned_at, created_at");C&&(m=m.eq("user_id",C));const{data:f,error:_}=await m;if(_)throw _;if(f){const y=f.map(w=>({id:w.id,user_id:w.user_id,role:w.role,role_id:w.role_id||void 0,assigned_by:w.assigned_by||void 0,assigned_at:w.assigned_at||void 0,created_at:w.created_at}));r(C?w=>[...w.filter(E=>E.user_id!==C),...y]:y)}}catch{}},x=(C,m,f)=>{const _=g[C];return _?_.some(y=>y.resource===m&&y.action===f):!1},N=C=>g[C]||[],V=C=>t.find(m=>m.id===C),$=C=>t.find(m=>m.name===C),L=C=>i.filter(m=>m.user_id===C);o.useEffect(()=>{v(),j().catch(()=>{}),(async()=>{try{const{data:{user:C}}=await I.auth.getUser();C!=null&&C.id&&await b(C.id)}catch{}})()},[v,b]),o.useEffect(()=>{const C=I.channel("rm_user_roles_changes").on("postgres_changes",{event:"*",schema:"public",table:"user_roles"},m=>{var _,y;j().catch(()=>{});const f=((_=m==null?void 0:m.new)==null?void 0:_.user_id)||((y=m==null?void 0:m.old)==null?void 0:y.user_id);f&&b(f).catch(()=>{})}).subscribe();return()=>{try{I.removeChannel(C)}catch{}}},[b]);const O={roles:t,userRoles:i,isLoading:n,fetchRoles:v,createRole:T,updateRole:A,deleteRole:F,assignRoleToUser:P,removeRoleFromUser:B,fetchUserRoles:j,hasPermission:x,getUserPermissions:N,refreshUserPermissions:b,getRoleById:V,getRoleByName:$,getUserRolesByUserId:L};return a.jsx($s.Provider,{value:O,children:e})},Us=()=>{const e=o.useContext($s);if(e===void 0)throw new Error("useRoleManagement must be used within a RoleManagementProvider");return e},Pr="https://abznugnirnlrqnnfkein.supabase.co",Tr="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiem51Z25pcm5scnFubmZrZWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMzU2OTEsImV4cCI6MjA3NDcxMTY5MX0.eAX9yrtgr05OVjAn_Wr2Koi92rMaV32EFj70DFfIgdM",H=Xt(Pr,Tr),zs=o.createContext(void 0);function Ft(e){return{id:e.id,userId:e.user_id,classificationLevel:e.classification_level,roleScope:e.role_scope,effectiveFrom:e.effective_from,effectiveUntil:e.effective_until,hasRetainer:e.has_retainer,retainerAmountCents:parseInt(e.retainer_amount_cents||0),retainerCurrency:e.retainer_currency,retainerFrequency:e.retainer_frequency,assignedBy:e.assigned_by,changeReason:e.change_reason,notes:e.notes,isActive:e.is_active,createdAt:e.created_at,updatedAt:e.updated_at}}function Bt(e){return{id:e.id,classificationLevel:e.classification_level,roleScope:e.role_scope,siteVisitBaseFeeCents:parseInt(e.site_visit_base_fee_cents||0),complexityMultiplier:parseFloat(e.complexity_multiplier||1),currency:e.currency,validFrom:e.effective_from,validUntil:e.effective_until,metadata:e.metadata,isActive:e.is_active,createdBy:e.created_by,updatedBy:e.updated_by,changeNotes:e.change_notes,createdAt:e.created_at,updatedAt:e.updated_at}}const kr=({children:e})=>{const[t,s]=o.useState([]),[i,r]=o.useState([]),[n,p]=o.useState({}),[l,g]=o.useState(!1),{toast:u}=ne(),{currentUser:v}=ue(),b=o.useCallback(async()=>{try{g(!0);const{data:m,error:f}=await H.from("user_classifications").select("*").order("effective_from",{ascending:!1});if(f)throw f;m&&s(m.map(Ft))}catch{u({title:"Error",description:"Failed to load user classifications",variant:"destructive"})}finally{g(!1)}},[u]),T=o.useCallback(async()=>{try{g(!0);const{data:m,error:f}=await H.from("classification_fee_structures").select("*").order("effective_from",{ascending:!1});if(f)throw f;m&&r(m.map(Bt))}catch{u({title:"Error",description:"Failed to load fee structures",variant:"destructive"})}finally{g(!1)}},[u]);o.useEffect(()=>{b(),T()},[]),o.useEffect(()=>{const m=H.channel("user_classifications_changes").on("postgres_changes",{event:"*",schema:"public",table:"user_classifications"},_=>{b(),u({title:"Classification Updated",description:"A team member classification has been changed"})}).subscribe(),f=H.channel("fee_structures_changes").on("postgres_changes",{event:"*",schema:"public",table:"classification_fee_structures"},_=>{T(),u({title:"Fee Structure Updated",description:"Classification fee structures have been updated"})}).subscribe();return()=>{H.removeChannel(m),H.removeChannel(f)}},[]);const A=o.useCallback(m=>{const f=new Date().toISOString();return t.find(y=>y.userId===m&&y.isActive&&y.effectiveFrom<=f&&(!y.effectiveUntil||y.effectiveUntil>f))||null},[t]),F=o.useCallback(async m=>{try{const f={user_id:m.userId,classification_level:m.classificationLevel,role_scope:m.roleScope,effective_from:m.effectiveFrom||new Date().toISOString(),effective_until:m.effectiveUntil,has_retainer:m.hasRetainer||!1,retainer_amount_cents:m.retainerAmountCents||0,retainer_currency:m.retainerCurrency||"SDG",retainer_frequency:m.retainerFrequency||"monthly",assigned_by:v==null?void 0:v.id,change_reason:m.changeReason,notes:m.notes,is_active:!0},{data:_,error:y}=await H.from("user_classifications").insert(f).select().single();if(y)throw y;const w=Ft(_);return s(R=>[w,...R]),u({title:"Success",description:"Classification assigned successfully"}),w}catch(f){return u({title:"Error",description:f.message||"Failed to create classification",variant:"destructive"}),null}},[v,u]),P=o.useCallback(async(m,f)=>{try{const _={};f.classificationLevel!==void 0&&(_.classification_level=f.classificationLevel),f.roleScope!==void 0&&(_.role_scope=f.roleScope),f.effectiveFrom!==void 0&&(_.effective_from=f.effectiveFrom),f.effectiveUntil!==void 0&&(_.effective_until=f.effectiveUntil),f.hasRetainer!==void 0&&(_.has_retainer=f.hasRetainer),f.retainerAmountCents!==void 0&&(_.retainer_amount_cents=f.retainerAmountCents),f.retainerCurrency!==void 0&&(_.retainer_currency=f.retainerCurrency),f.retainerFrequency!==void 0&&(_.retainer_frequency=f.retainerFrequency),f.changeReason!==void 0&&(_.change_reason=f.changeReason),f.notes!==void 0&&(_.notes=f.notes),f.isActive!==void 0&&(_.is_active=f.isActive);const{error:y}=await H.from("user_classifications").update(_).eq("id",m);if(y)throw y;await b(),u({title:"Success",description:"Classification updated successfully"})}catch(_){throw u({title:"Error",description:_.message||"Failed to update classification",variant:"destructive"}),_}},[b,u]),B=o.useCallback(async(m,f)=>{try{const{error:_}=await H.from("user_classifications").update({is_active:!1,effective_until:new Date().toISOString(),change_reason:f}).eq("id",m);if(_)throw _;await b(),u({title:"Success",description:"Classification deactivated successfully"})}catch(_){throw u({title:"Error",description:_.message||"Failed to deactivate classification",variant:"destructive"}),_}},[b,u]),j=o.useCallback(async m=>{try{const f={classification_level:m.classificationLevel,role_scope:m.roleScope,site_visit_base_fee_cents:m.siteVisitBaseFeeCents,complexity_multiplier:m.complexityMultiplier||1,currency:m.currency||"SDG",valid_from:m.validFrom||new Date().toISOString(),valid_until:m.validUntil,metadata:m.metadata,change_notes:m.changeNotes,created_by:v==null?void 0:v.id,is_active:!0},{data:_,error:y}=await H.from("classification_fee_structures").insert(f).select().single();if(y)throw y;const w=Bt(_);return r(R=>[w,...R]),u({title:"Success",description:"Fee structure created successfully"}),w}catch(f){return u({title:"Error",description:f.message||"Failed to create fee structure",variant:"destructive"}),null}},[v,u]),x=o.useCallback(async(m,f)=>{var _,y;try{const w=(_=v==null?void 0:v.role)==null?void 0:_.toLowerCase(),R=((y=v==null?void 0:v.roles)==null?void 0:y.map(d=>d.toLowerCase()))||[];if(!(w==="admin"||w==="ict"||R.includes("admin")||R.includes("ict"))){const d="Access Denied: Only administrators and ICT staff can edit fee structures";throw u({title:"Authorization Error",description:d,variant:"destructive"}),new Error(d)}const h={updated_by:v==null?void 0:v.id};f.siteVisitBaseFeeCents!==void 0&&(h.site_visit_base_fee_cents=f.siteVisitBaseFeeCents),f.complexityMultiplier!==void 0&&(h.complexity_multiplier=f.complexityMultiplier),f.validFrom!==void 0&&(h.valid_from=f.validFrom),f.validUntil!==void 0&&(h.valid_until=f.validUntil),f.metadata!==void 0&&(h.metadata=f.metadata),f.changeNotes!==void 0&&(h.change_notes=f.changeNotes),f.isActive!==void 0&&(h.is_active=f.isActive);const{error:c}=await H.from("classification_fee_structures").update(h).eq("id",m);if(c)throw c;await T(),u({title:"Success",description:"Fee structure updated successfully"})}catch(w){throw u({title:"Error",description:w.message||"Failed to update fee structure",variant:"destructive"}),w}},[v,T,u]),N=o.useCallback(async(m,f)=>{try{const{error:_}=await H.from("classification_fee_structures").update({is_active:!1,valid_until:new Date().toISOString(),change_notes:f,updated_by:v==null?void 0:v.id}).eq("id",m);if(_)throw _;await T(),u({title:"Success",description:"Fee structure deactivated successfully"})}catch(_){throw u({title:"Error",description:_.message||"Failed to deactivate fee structure",variant:"destructive"}),_}},[v,T,u]),V=o.useCallback((m,f)=>{const _=new Date().toISOString();return i.find(w=>w.classificationLevel===m&&w.roleScope===f&&w.isActive&&w.validFrom<=_&&(!w.validUntil||w.validUntil>_))||null},[i]),$=o.useCallback(async m=>{try{const{data:f,error:_}=await H.from("user_classifications").select(`
          id,
          classification_level,
          role_scope,
          effective_from,
          effective_until,
          assigned_by,
          change_reason,
          created_at
        `).eq("user_id",m).order("effective_from",{ascending:!1});if(_)throw _;const y=(f||[]).map(w=>({id:w.id,classificationLevel:w.classification_level,roleScope:w.role_scope,effectiveFrom:w.effective_from,effectiveUntil:w.effective_until,assignedBy:w.assigned_by,changeReason:w.change_reason,createdAt:w.created_at}));return p(w=>({...w,[m]:y})),y}catch{return[]}},[]),L=o.useCallback(async(m,f)=>{const _=A(m);if(!_)return null;const y=V(_.classificationLevel,_.roleScope);return y?{baseFeeCents:y.siteVisitBaseFeeCents,complexityMultiplier:y.complexityMultiplier}:null},[A,V]),O=o.useCallback(async()=>{try{const{data:m,error:f}=await H.from("user_classifications").select(`
          *,
          profiles!user_classifications_user_id_fkey (
            full_name,
            email,
            role
          )
        `);if(f)throw f;return(m||[]).map(_=>{var y,w,R;return{id:_.id,userId:_.user_id,classificationLevel:_.classification_level,roleScope:_.role_scope,effectiveFrom:_.effective_from,effectiveUntil:_.effective_until,hasRetainer:_.has_retainer,retainerAmountCents:parseInt(_.retainer_amount_cents||0),retainerCurrency:_.retainer_currency,retainerFrequency:_.retainer_frequency,assignedBy:_.assigned_by,changeReason:_.change_reason,notes:_.notes,isActive:_.is_active,createdAt:_.created_at,updatedAt:_.updated_at,fullName:((y=_.profiles)==null?void 0:y.full_name)||"",email:((w=_.profiles)==null?void 0:w.email)||"",userRole:((R=_.profiles)==null?void 0:R.role)||""}})}catch{return[]}},[]),C={userClassifications:t,feeStructures:i,classificationHistory:n,loading:l,refreshUserClassifications:b,getUserClassification:A,createUserClassification:F,updateUserClassification:P,deactivateUserClassification:B,refreshFeeStructures:T,createFeeStructure:j,updateFeeStructure:x,deactivateFeeStructure:N,getActiveFeeStructure:V,getClassificationHistory:$,calculateSiteVisitFee:L,getCurrentUserClassifications:O};return a.jsx(zs.Provider,{value:C,children:e})},Or=()=>{const e=o.useContext(zs);if(!e)throw new Error("useClassification must be used within a ClassificationProvider");return e},Ws=o.createContext(void 0);function it(e){return{id:e.id,userId:e.user_id,balances:e.balances||{SDG:0},totalEarned:parseFloat(e.total_earned||0),totalWithdrawn:parseFloat(e.total_withdrawn||0),createdAt:e.created_at,updatedAt:e.updated_at}}function Rr(e){return{id:e.id,walletId:e.wallet_id,userId:e.user_id,type:e.type,amount:parseFloat(e.amount),currency:e.currency,siteVisitId:e.site_visit_id,withdrawalRequestId:e.withdrawal_request_id,description:e.description,metadata:e.metadata,balanceBefore:e.balance_before?parseFloat(e.balance_before):void 0,balanceAfter:e.balance_after?parseFloat(e.balance_after):void 0,createdBy:e.created_by,createdAt:e.created_at}}function Fr(e){return{id:e.id,userId:e.user_id,walletId:e.wallet_id,amount:parseFloat(e.amount),currency:e.currency,status:e.status,requestReason:e.request_reason,supervisorId:e.supervisor_id,supervisorNotes:e.supervisor_notes,approvedAt:e.approved_at,rejectedAt:e.rejected_at,paymentMethod:e.payment_method,paymentDetails:e.payment_details,createdAt:e.created_at,updatedAt:e.updated_at}}function Br(e){return{id:e.id,siteVisitId:e.site_visit_id,transportationCost:parseFloat(e.transportation_cost||0),accommodationCost:parseFloat(e.accommodation_cost||0),mealAllowance:parseFloat(e.meal_allowance||0),otherCosts:parseFloat(e.other_costs||0),totalCost:parseFloat(e.total_cost||0),currency:e.currency,assignedBy:e.assigned_by,adjustedBy:e.adjusted_by,adjustmentReason:e.adjustment_reason,costNotes:e.cost_notes,createdAt:e.created_at,updatedAt:e.updated_at}}function Vr({children:e}){const{currentUser:t}=ue(),{toast:s}=ne(),{getUserClassification:i,getActiveFeeStructure:r}=Or(),[n,p]=o.useState(null),[l,g]=o.useState([]),[u,v]=o.useState([]),[b,T]=o.useState(null),[A,F]=o.useState(!0),P=async()=>{if(t!=null&&t.id)try{const{data:h,error:c}=await H.from("wallets").select("*").eq("user_id",t.id).single();if(c)if(c.code==="PGRST116"){const{data:d,error:M}=await H.from("wallets").insert({user_id:t.id,balances:{SDG:0}}).select().single();if(M)throw M;p(it(d))}else throw c;else p(it(h))}catch{s({title:"Error",description:"Failed to load wallet information",variant:"destructive"})}},B=async()=>{if(t!=null&&t.id)try{const{data:h,error:c}=await H.from("wallet_transactions").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).limit(100);if(c)throw c;g((h||[]).map(Rr))}catch{}},j=async()=>{if(t!=null&&t.id)try{const{data:h,error:c}=await H.from("withdrawal_requests").select("*").eq("user_id",t.id).order("created_at",{ascending:!1});if(c)throw c;v((h||[]).map(Fr))}catch{}},x=()=>{if(!n||!l||!u)return;const h=u.filter(d=>d.status==="pending").reduce((d,M)=>d+M.amount,0),c=l.filter(d=>d.type==="site_visit_fee").length;T({totalEarned:n.totalEarned,totalWithdrawn:n.totalWithdrawn,pendingWithdrawals:h,currentBalance:n.balances.SDG||0,totalTransactions:l.length,completedSiteVisits:c})},N=async(h,c,d)=>{if(!(t!=null&&t.id)||!n)return;const M=n.balances.SDG||0;if(h>M){s({title:"Insufficient Balance",description:`You only have SDG ${M.toFixed(2)} available`,variant:"destructive"});return}try{const{error:S}=await H.from("withdrawal_requests").insert({user_id:t.id,wallet_id:n.id,amount:h,currency:"SDG",request_reason:c,payment_method:d,status:"pending"});if(S)throw S;s({title:"Withdrawal Request Submitted",description:"Your request is pending supervisor approval"}),await j()}catch{s({title:"Error",description:"Failed to submit withdrawal request",variant:"destructive"})}},V=async h=>{try{const{error:c}=await H.from("withdrawal_requests").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("id",h).eq("status","pending");if(c)throw c;s({title:"Request Cancelled",description:"Your withdrawal request has been cancelled"}),await j()}catch{s({title:"Error",description:"Failed to cancel withdrawal request",variant:"destructive"})}},$=async(h,c)=>{if(t!=null&&t.id)try{const d=u.find(U=>U.id===h);if(!d)throw new Error("Request not found");const{data:M,error:S}=await H.from("wallets").select("*").eq("id",d.walletId).single();if(S)throw S;const k=M.balances[d.currency]||0;if(k<d.amount)throw new Error("Insufficient wallet balance");const q={...M.balances,[d.currency]:k-d.amount},{error:z}=await H.from("wallets").update({balances:q,total_withdrawn:parseFloat(M.total_withdrawn)+d.amount,updated_at:new Date().toISOString()}).eq("id",d.walletId);if(z)throw z;const{error:Z}=await H.from("wallet_transactions").insert({wallet_id:d.walletId,user_id:d.userId,type:"withdrawal",amount:-d.amount,currency:d.currency,withdrawal_request_id:h,description:`Withdrawal approved: ${c||"N/A"}`,balance_before:k,balance_after:k-d.amount,created_by:t.id});if(Z)throw Z;const{error:W}=await H.from("withdrawal_requests").update({status:"approved",supervisor_id:t.id,supervisor_notes:c,approved_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",h);if(W)throw W;s({title:"Withdrawal Approved",description:"The withdrawal request has been approved and processed"}),await Promise.all([P(),B(),j()])}catch(d){s({title:"Error",description:d.message||"Failed to approve withdrawal request",variant:"destructive"})}},L=async(h,c)=>{if(t!=null&&t.id)try{const{error:d}=await H.from("withdrawal_requests").update({status:"rejected",supervisor_id:t.id,supervisor_notes:c,rejected_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",h);if(d)throw d;s({title:"Withdrawal Rejected",description:"The withdrawal request has been rejected"}),await j()}catch{s({title:"Error",description:"Failed to reject withdrawal request",variant:"destructive"})}},O=(h="SDG")=>n&&n.balances[h]||0,C=async h=>{try{const{data:c,error:d}=await H.from("site_visit_costs").select("*").eq("site_visit_id",h).single();if(d){if(d.code==="PGRST116")return null;throw d}return Br(c)}catch{return null}},m=async(h,c)=>{if(t!=null&&t.id)try{const{error:d}=await H.from("site_visit_costs").insert({site_visit_id:h,transportation_cost:c.transportationCost||0,accommodation_cost:c.accommodationCost||0,meal_allowance:c.mealAllowance||0,other_costs:c.otherCosts||0,currency:c.currency||"SDG",cost_notes:c.costNotes,assigned_by:t.id});if(d)throw d;s({title:"Cost Assigned",description:"Site visit cost has been assigned successfully"})}catch{s({title:"Error",description:"Failed to assign site visit cost",variant:"destructive"})}},f=async(h,c)=>{if(t!=null&&t.id)try{const{error:d}=await H.from("site_visit_costs").update({transportation_cost:c.transportationCost,accommodation_cost:c.accommodationCost,meal_allowance:c.mealAllowance,other_costs:c.otherCosts,cost_notes:c.costNotes,adjustment_reason:c.adjustmentReason,adjusted_by:t.id,updated_at:new Date().toISOString()}).eq("id",h);if(d)throw d;s({title:"Cost Updated",description:"Site visit cost has been updated successfully"})}catch{s({title:"Error",description:"Failed to update site visit cost",variant:"destructive"})}},_=async(h,c=1)=>{try{const d=i(h);if(!d)return 50;const M=r(d.classificationLevel,d.roleScope);if(!M)return 50;const S=M.siteVisitBaseFeeCents;return Math.round(S*c)/100}catch{return 50}},y=async(h,c,d=1)=>{try{const M=await _(h,d),{data:S,error:k}=await H.from("wallets").select("*").eq("user_id",h).single();if(k){if(k.code==="PGRST116"){const{data:Y,error:X}=await H.from("wallets").insert({user_id:h,balances:{SDG:M},total_earned:M}).select().single();if(X)throw X;await H.from("wallet_transactions").insert({wallet_id:Y.id,user_id:h,type:"site_visit_fee",amount:M,currency:"SDG",site_visit_id:c,description:`Site visit fee (${d}x complexity)`,balance_before:0,balance_after:M,created_by:t==null?void 0:t.id});return}throw k}const q=S.balances.SDG||0,z=q+M,Z={...S.balances,SDG:z},{error:W}=await H.from("wallets").update({balances:Z,total_earned:parseFloat(S.total_earned)+M,updated_at:new Date().toISOString()}).eq("id",S.id);if(W)throw W;const{error:U}=await H.from("wallet_transactions").insert({wallet_id:S.id,user_id:h,type:"site_visit_fee",amount:M,currency:"SDG",site_visit_id:c,description:`Site visit fee (${d}x complexity)`,balance_before:q,balance_after:z,created_by:t==null?void 0:t.id});if(U)throw U;h===(t==null?void 0:t.id)&&(await P(),await B())}catch(M){throw M}},w=async(h,c,d,M)=>{try{const S=c/100,{data:k,error:q}=await H.from("wallets").select("*").eq("user_id",h).single();if(q){if(q.code==="PGRST116"){const{data:ee,error:te}=await H.from("wallets").insert({user_id:h,balances:{[d]:S},total_earned:S}).select().single();if(te)throw te;await H.from("wallet_transactions").insert({wallet_id:ee.id,user_id:h,type:"retainer",amount:S,currency:d,description:`Monthly retainer - ${M}`,balance_before:0,balance_after:S,created_by:t==null?void 0:t.id});return}throw q}const z=k.balances[d]||0,Z=z+S,W={...k.balances,[d]:Z},U=parseFloat(k.total_earned||0),{error:Y}=await H.from("wallets").update({balances:W,total_earned:U+S,updated_at:new Date().toISOString()}).eq("id",k.id);if(Y)throw Y;const{error:X}=await H.from("wallet_transactions").insert({wallet_id:k.id,user_id:h,type:"retainer",amount:S,currency:d,description:`Monthly retainer - ${M}`,balance_before:z,balance_after:Z,created_by:t==null?void 0:t.id});if(X)throw X;h===(t==null?void 0:t.id)&&(await P(),await B())}catch(S){throw S}},R=async()=>{try{const h=new Date,c=`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,"0")}`,{data:d,error:M}=await H.from("current_user_classifications").select("*").eq("has_retainer",!0).eq("is_active",!0);if(M)throw M;if(!d||d.length===0)return{processed:0,failed:0,total:0};let S=0,k=0;for(const q of d)try{const{data:z,error:Z}=await H.from("wallet_transactions").select("id").eq("user_id",q.user_id).eq("type","retainer").ilike("description",`%${c}%`).maybeSingle();if(Z&&Z.code!=="PGRST116")throw Z;if(z)continue;await w(q.user_id,q.retainer_amount_cents,q.retainer_currency,c),S++}catch{k++}return s({title:"Retainer Processing Complete",description:`Processed ${S} of ${d.length} retainers. ${k} failed.`}),{processed:S,failed:k,total:d.length}}catch(h){throw s({title:"Error",description:"Failed to process monthly retainers",variant:"destructive"}),h}},E=async()=>{try{const{data:h,error:c}=await H.from("wallets").select("*").order("created_at",{ascending:!1});if(c)throw c;return h.map(it)}catch{return[]}};return o.useEffect(()=>{(async()=>{if(!(t!=null&&t.id)){F(!1);return}F(!0),await Promise.all([P(),B(),j()]),F(!1)})()},[t==null?void 0:t.id]),o.useEffect(()=>{x()},[n,l,u]),o.useEffect(()=>{if(!(t!=null&&t.id))return;const h=H.channel("wallet_changes").on("postgres_changes",{event:"*",schema:"public",table:"wallets",filter:`user_id=eq.${t.id}`},()=>{P()}).on("postgres_changes",{event:"*",schema:"public",table:"wallet_transactions",filter:`user_id=eq.${t.id}`},()=>{B()}).on("postgres_changes",{event:"*",schema:"public",table:"withdrawal_requests",filter:`user_id=eq.${t.id}`},()=>{j()}).subscribe();return()=>{H.removeChannel(h)}},[t==null?void 0:t.id]),a.jsx(Ws.Provider,{value:{wallet:n,transactions:l,withdrawalRequests:u,stats:b,loading:A,refreshWallet:P,refreshTransactions:B,refreshWithdrawalRequests:j,createWithdrawalRequest:N,cancelWithdrawalRequest:V,approveWithdrawalRequest:$,rejectWithdrawalRequest:L,getBalance:O,getSiteVisitCost:C,assignSiteVisitCost:m,updateSiteVisitCost:f,addSiteVisitFeeToWallet:y,calculateClassificationFee:_,processMonthlyRetainers:R,addRetainerToWallet:w,listWallets:E},children:e})}function Jc(){const e=o.useContext(Ws);if(e===void 0)throw new Error("useWallet must be used within a WalletProvider");return e}const Gs=o.createContext(void 0);function Vt(e){return{id:e.id,projectId:e.project_id,totalBudgetCents:parseInt(e.total_budget_cents||0),allocatedBudgetCents:parseInt(e.allocated_budget_cents||0),spentBudgetCents:parseInt(e.spent_budget_cents||0),remainingBudgetCents:parseInt(e.remaining_budget_cents||0),budgetPeriod:e.budget_period,periodStartDate:e.period_start_date,periodEndDate:e.period_end_date,categoryAllocations:e.category_allocations||{site_visits:0,transportation:0,accommodation:0,meals:0,equipment:0,other:0},status:e.status,approvedBy:e.approved_by,approvedAt:e.approved_at,fiscalYear:e.fiscal_year,budgetNotes:e.budget_notes,createdBy:e.created_by,updatedBy:e.updated_by,createdAt:e.created_at,updatedAt:e.updated_at}}function qt(e){return{id:e.id,mmpFileId:e.mmp_file_id,projectBudgetId:e.project_budget_id,allocatedBudgetCents:parseInt(e.allocated_budget_cents||0),spentBudgetCents:parseInt(e.spent_budget_cents||0),remainingBudgetCents:parseInt(e.remaining_budget_cents||0),totalSites:e.total_sites||0,budgetedSites:e.budgeted_sites||0,completedSites:e.completed_sites||0,averageCostPerSiteCents:parseInt(e.average_cost_per_site_cents||0),categoryBreakdown:e.category_breakdown||{site_visit_fees:0,transportation:0,accommodation:0,meals:0,other:0},sourceType:e.source_type,parentBudgetId:e.parent_budget_id,status:e.status,budgetNotes:e.budget_notes,allocatedBy:e.allocated_by,createdAt:e.created_at,updatedAt:e.updated_at}}function qr(e){return{id:e.id,projectBudgetId:e.project_budget_id,mmpBudgetId:e.mmp_budget_id,siteVisitId:e.site_visit_id,walletTransactionId:e.wallet_transaction_id,transactionType:e.transaction_type,amountCents:parseInt(e.amount_cents),currency:e.currency,category:e.category,balanceBeforeCents:e.balance_before_cents?parseInt(e.balance_before_cents):void 0,balanceAfterCents:e.balance_after_cents?parseInt(e.balance_after_cents):void 0,description:e.description,metadata:e.metadata,referenceNumber:e.reference_number,requiresApproval:e.requires_approval,approvedBy:e.approved_by,approvedAt:e.approved_at,createdBy:e.created_by,createdAt:e.created_at}}function Lr(e){return{id:e.id,projectBudgetId:e.project_budget_id,mmpBudgetId:e.mmp_budget_id,alertType:e.alert_type,severity:e.severity,thresholdPercentage:e.threshold_percentage,title:e.title,message:e.message,status:e.status,acknowledgedBy:e.acknowledged_by,acknowledgedAt:e.acknowledged_at,metadata:e.metadata,createdAt:e.created_at,resolvedAt:e.resolved_at}}function $r({children:e}){const{currentUser:t}=ue(),{toast:s}=ne(),[i,r]=o.useState([]),[n,p]=o.useState([]),[l,g]=o.useState([]),[u,v]=o.useState([]),[b,T]=o.useState(null),[A,F]=o.useState(!0),P=o.useCallback(async()=>{try{const{data:c,error:d}=await H.from("project_budgets").select("*").order("created_at",{ascending:!1});if(d)throw d;r((c||[]).map(Vt))}catch{}},[]),B=o.useCallback(async()=>{try{const{data:c,error:d}=await H.from("mmp_budgets").select("*").order("created_at",{ascending:!1});if(d)throw d;p((c||[]).map(qt))}catch{}},[]),j=o.useCallback(async()=>{try{const{data:c,error:d}=await H.from("budget_transactions").select("*").order("created_at",{ascending:!1}).limit(100);if(d)throw d;g((c||[]).map(qr))}catch{}},[]),x=o.useCallback(async()=>{try{const{data:c,error:d}=await H.from("budget_alerts").select("*").eq("status","active").order("created_at",{ascending:!1});if(d)throw d;v((c||[]).map(Lr))}catch{}},[]),N=async c=>{try{const{data:d,error:M}=await H.from("project_budgets").insert({project_id:c.projectId,total_budget_cents:c.totalBudgetCents,budget_period:c.budgetPeriod,period_start_date:c.periodStartDate,period_end_date:c.periodEndDate,category_allocations:c.categoryAllocations,fiscal_year:c.fiscalYear,budget_notes:c.budgetNotes,created_by:t==null?void 0:t.id,status:"draft"}).select().single();if(M)throw M;return s({title:"Success",description:"Project budget created successfully"}),await P(),Vt(d)}catch(d){return s({title:"Error",description:d.message||"Failed to create project budget",variant:"destructive"}),null}},V=async(c,d)=>{try{const M={updated_by:t==null?void 0:t.id,updated_at:new Date().toISOString()};d.totalBudgetCents!==void 0&&(M.total_budget_cents=d.totalBudgetCents),d.status&&(M.status=d.status),d.budgetNotes&&(M.budget_notes=d.budgetNotes),d.categoryAllocations&&(M.category_allocations=d.categoryAllocations);const{error:S}=await H.from("project_budgets").update(M).eq("id",c);if(S)throw S;s({title:"Success",description:"Project budget updated successfully"}),await P()}catch(M){s({title:"Error",description:M.message||"Failed to update project budget",variant:"destructive"})}},$=async c=>{try{const{error:d}=await H.from("project_budgets").delete().eq("id",c);if(d)throw d;s({title:"Success",description:"Project budget deleted successfully"}),await P()}catch(d){s({title:"Error",description:d.message||"Failed to delete project budget",variant:"destructive"})}},L=async c=>{try{const{data:d,error:M}=await H.from("mmp_budgets").insert({mmp_file_id:c.mmpFileId,project_budget_id:c.projectBudgetId,allocated_budget_cents:c.allocatedBudgetCents,total_sites:c.totalSites,budgeted_sites:c.totalSites,category_breakdown:c.categoryBreakdown,source_type:c.sourceType||"project_allocation",budget_notes:c.budgetNotes,allocated_by:t==null?void 0:t.id,status:"active"}).select().single();if(M)throw M;if(c.projectBudgetId){const{error:S}=await H.from("budget_transactions").insert({project_budget_id:c.projectBudgetId,mmp_budget_id:d.id,transaction_type:"allocation",amount_cents:c.allocatedBudgetCents,currency:"SDG",description:"Budget allocated to MMP",created_by:t==null?void 0:t.id}),{data:k,error:q}=await H.from("project_budgets").select("allocated_budget_cents").eq("id",c.projectBudgetId).single();if(!q&&k){const{error:z}=await H.from("project_budgets").update({allocated_budget_cents:parseInt(k.allocated_budget_cents)+c.allocatedBudgetCents}).eq("id",c.projectBudgetId)}}return s({title:"Success",description:"MMP budget created successfully"}),await Promise.all([B(),P(),j()]),qt(d)}catch(d){return s({title:"Error",description:d.message||"Failed to create MMP budget",variant:"destructive"}),null}},O=async(c,d)=>{try{const M={updated_at:new Date().toISOString()};d.allocatedBudgetCents!==void 0&&(M.allocated_budget_cents=d.allocatedBudgetCents),d.status&&(M.status=d.status),d.budgetNotes&&(M.budget_notes=d.budgetNotes),d.completedSites!==void 0&&(M.completed_sites=d.completedSites);const{error:S}=await H.from("mmp_budgets").update(M).eq("id",c);if(S)throw S;await B()}catch(M){s({title:"Error",description:M.message||"Failed to update MMP budget",variant:"destructive"})}},C=async c=>{try{const d=n.find(k=>k.id===c.budgetId);if(!d)throw new Error("Budget not found");const{error:M}=await H.from("mmp_budgets").update({allocated_budget_cents:d.allocatedBudgetCents+c.amountCents}).eq("id",c.budgetId);if(M)throw M;const{error:S}=await H.from("budget_transactions").insert({mmp_budget_id:c.budgetId,transaction_type:"top_up",amount_cents:c.amountCents,currency:"SDG",category:c.category,description:c.reason,created_by:t==null?void 0:t.id});if(S)throw S;s({title:"Success",description:"Budget topped up successfully"}),await Promise.all([B(),j()])}catch(d){s({title:"Error",description:d.message||"Failed to top up budget",variant:"destructive"})}},m=async(c,d,M,S)=>{try{const k=n.find(Z=>Z.id===c);if(!k)throw new Error("Budget not found");const{error:q}=await H.from("mmp_budgets").update({spent_budget_cents:k.spentBudgetCents+d}).eq("id",c);if(q)throw q;const{error:z}=await H.from("budget_transactions").insert({mmp_budget_id:c,transaction_type:"spend",amount_cents:d,currency:"SDG",category:M,description:S,balance_before_cents:k.remainingBudgetCents,balance_after_cents:k.remainingBudgetCents-d,created_by:t==null?void 0:t.id});if(z)throw z;await Promise.all([B(),j(),x()])}catch(k){throw k}},f=c=>i.find(d=>d.projectId===c)||null,_=c=>n.find(d=>d.mmpFileId===c)||null,y=async c=>{try{const{data:d,error:M}=await H.from("project_budget_summary").select("*").eq("project_id",c).single();if(M)throw M;return d}catch{return null}},w=async c=>{try{const{data:d,error:M}=await H.from("mmp_budget_summary").select("*").eq("mmp_file_id",c).single();if(M)throw M;return d}catch{return null}},R=async c=>{try{const{error:d}=await H.from("budget_alerts").update({status:"acknowledged",acknowledged_by:t==null?void 0:t.id,acknowledged_at:new Date().toISOString()}).eq("id",c);if(d)throw d;await x()}catch{}},E=async c=>{try{const{error:d}=await H.from("budget_alerts").update({status:"dismissed",acknowledged_by:t==null?void 0:t.id,acknowledged_at:new Date().toISOString()}).eq("id",c);if(d)throw d;await x()}catch{}};o.useEffect(()=>{t&&Promise.all([P(),B(),j(),x()]).finally(()=>F(!1))},[t,P,B,j,x]),o.useEffect(()=>{if(!t)return;const c=H.channel("budget_changes").on("postgres_changes",{event:"*",schema:"public",table:"project_budgets"},()=>{P()}).on("postgres_changes",{event:"*",schema:"public",table:"mmp_budgets"},()=>{B()}).on("postgres_changes",{event:"*",schema:"public",table:"budget_transactions"},()=>{j()}).on("postgres_changes",{event:"*",schema:"public",table:"budget_alerts"},()=>{x()});return c.subscribe(),()=>{H.removeChannel(c)}},[t,P,B,j,x]),o.useEffect(()=>{const c=i.reduce((k,q)=>k+q.totalBudgetCents,0),d=i.reduce((k,q)=>k+q.allocatedBudgetCents,0),M=i.reduce((k,q)=>k+q.spentBudgetCents,0),S=i.reduce((k,q)=>k+q.remainingBudgetCents,0);T({totalBudget:c/100,totalAllocated:d/100,totalSpent:M/100,totalRemaining:S/100,utilizationRate:c>0?M/c*100:0,averageCostPerSite:n.length>0?n.reduce((k,q)=>k+q.averageCostPerSiteCents,0)/n.length/100:0,projectedOverspend:0,burnRate:0})},[i,n]);const h={projectBudgets:i,mmpBudgets:n,budgetTransactions:l,budgetAlerts:u,stats:b,loading:A,refreshProjectBudgets:P,refreshMMPBudgets:B,refreshBudgetTransactions:j,refreshBudgetAlerts:x,createProjectBudget:N,updateProjectBudget:V,deleteProjectBudget:$,createMMPBudget:L,updateMMPBudget:O,topUpMMPBudget:C,getProjectBudget:f,getMMPBudget:_,getProjectBudgetSummary:y,getMMPBudgetSummary:w,recordBudgetSpend:m,acknowledgeAlert:R,dismissAlert:E};return a.jsx(Gs.Provider,{value:h,children:e})}function Qc(){const e=o.useContext(Gs);if(e===void 0)throw new Error("useBudget must be used within a BudgetProvider");return e}const Ur=e=>["pending","under_review","approved","rejected","paid","cancelled"].includes(e)?e:"pending",zr=e=>["submitted","under_review","approved","rejected","adjusted","paid","cancelled"].includes(e)?e:"submitted",Wr=e=>!e||!Array.isArray(e)?[]:e.map(t=>({url:t.url||"",type:t.type||"other",filename:t.filename||"document",uploadedAt:t.uploadedAt||t.uploaded_at||new Date().toISOString(),size:t.size,description:t.description})),fe=e=>({id:e.id,siteVisitId:e.site_visit_id,mmpFileId:e.mmp_file_id,projectId:e.project_id,submittedBy:e.submitted_by,submittedAt:e.submitted_at,transportationCostCents:e.transportation_cost_cents,accommodationCostCents:e.accommodation_cost_cents,mealAllowanceCents:e.meal_allowance_cents,otherCostsCents:e.other_costs_cents,totalCostCents:e.total_cost_cents,currency:e.currency||"SDG",transportationDetails:e.transportation_details,accommodationDetails:e.accommodation_details,mealDetails:e.meal_details,otherCostsDetails:e.other_details,submissionNotes:e.submission_notes,supportingDocuments:Wr(e.supporting_documents),status:Ur(e.status),reviewedBy:e.reviewed_by,reviewedAt:e.reviewed_at,reviewerNotes:e.reviewer_notes,approvalNotes:e.approval_notes,walletTransactionId:e.wallet_transaction_id,paidAt:e.paid_at,paidAmountCents:e.paid_amount_cents,paymentNotes:e.payment_notes,classificationLevel:e.classification_level,roleScope:e.role_scope,createdAt:e.created_at||new Date().toISOString(),updatedAt:e.updated_at||new Date().toISOString()}),Gr=e=>({id:e.id,submissionId:e.submission_id,action:zr(e.action),actorId:e.actor_id,actorRole:e.actor_role,actionTimestamp:e.action_timestamp,previousStatus:e.previous_status,newStatus:e.new_status,previousAmountCents:e.previous_amount_cents,newAmountCents:e.new_amount_cents,notes:e.notes,changes:e.changes,createdAt:e.created_at||e.action_timestamp}),Kr=e=>({...fe(e),submitterName:e.submitter_name,submitterEmail:e.submitter_email,submitterEmployeeId:e.submitter_employee_id,siteName:e.site_name,siteEntryStatus:e.site_entry_status,mmpName:e.mmp_name,projectName:e.project_name,daysPending:e.days_pending}),Hr=e=>({userId:e.user_id,totalSubmissions:e.total_submissions,pendingCount:e.pending_count,approvedCount:e.approved_count,rejectedCount:e.rejected_count,paidCount:0,totalApprovedCents:e.total_approved_amount_cents,totalPaidCents:e.total_paid_amount_cents,avgApprovedCents:e.approved_count>0?Math.round(e.total_approved_amount_cents/e.approved_count):0,lastSubmissionDate:e.last_submission_at}),Yr=e=>({mmpFileId:e.mmp_file_id,totalSubmissions:e.total_submissions,pendingSubmissions:e.pending_count,totalApprovedCostCents:e.total_approved_cents,totalPaidCents:e.total_paid_cents,totalTransportCents:0,totalAccommodationCents:0,totalMealsCents:0,avgCostPerSiteCents:e.total_submissions>0?Math.round(e.total_submitted_cents/e.total_submissions):0}),Jr=async()=>{const{data:e,error:t}=await I.from("site_visit_cost_submissions").select("*").order("submitted_at",{ascending:!1});if(t)throw t;return(e||[]).map(fe)},Qr=async e=>{const{data:t,error:s}=await I.from("site_visit_cost_submissions").select("*").eq("id",e).single();if(s)throw s;return fe(t)},Zr=async e=>{const{data:t,error:s}=await I.from("site_visit_cost_submissions").select("*").eq("submitted_by",e).order("submitted_at",{ascending:!1});if(s)throw s;return(t||[]).map(fe)},Xr=async()=>{const{data:e,error:t}=await I.from("pending_cost_approvals").select("*").order("submitted_at",{ascending:!0});if(t)throw t;return(e||[]).map(Kr)},eo=async e=>{const{data:t,error:s}=await I.from("cost_approval_history").select("*").eq("submission_id",e).order("changed_at",{ascending:!1});if(s)throw s;return(t||[]).map(Gr)},to=async e=>{const{data:t,error:s}=await I.from("user_cost_submission_summary").select("*").eq("user_id",e).single();return s?{userId:e,totalSubmissions:0,pendingCount:0,approvedCount:0,rejectedCount:0,paidCount:0,totalApprovedCents:0,totalPaidCents:0,avgApprovedCents:0}:Hr(t)},so=async e=>{const{data:t,error:s}=await I.from("mmp_cost_submission_summary").select("*").eq("mmp_file_id",e).single();return s?{mmpFileId:e,totalSubmissions:0,pendingSubmissions:0,totalApprovedCostCents:0,totalPaidCents:0,totalTransportCents:0,totalAccommodationCents:0,totalMealsCents:0,avgCostPerSiteCents:0}:Yr(t)},ao=async(e,t)=>{const s=e.transportationCostCents+e.accommodationCostCents+e.mealAllowanceCents+e.otherCostsCents,i={site_visit_id:e.siteVisitId,mmp_file_id:e.mmpFileId,project_id:e.projectId,submitted_by:t,transportation_cost_cents:e.transportationCostCents,accommodation_cost_cents:e.accommodationCostCents,meal_allowance_cents:e.mealAllowanceCents,other_costs_cents:e.otherCostsCents,total_cost_cents:s,currency:e.currency||"SDG",transportation_details:e.transportationDetails,accommodation_details:e.accommodationDetails,meal_details:e.mealDetails,other_details:e.otherCostsDetails,submission_notes:e.submissionNotes,supporting_documents:e.supportingDocuments||[],status:"pending"},{data:r,error:n}=await I.from("site_visit_cost_submissions").insert(i).select().single();if(n)throw n;return fe(r)},io=async(e,t)=>{const{data:s,error:i}=await I.from("site_visit_cost_submissions").select("*").eq("id",e).single();if(i)throw i;const r=t.transportationCostCents??s.transportation_cost_cents,n=t.accommodationCostCents??s.accommodation_cost_cents,p=t.mealAllowanceCents??s.meal_allowance_cents,l=t.otherCostsCents??s.other_costs_cents,g=r+n+p+l,u={updated_at:new Date().toISOString(),total_cost_cents:g};t.transportationCostCents!==void 0&&(u.transportation_cost_cents=t.transportationCostCents),t.accommodationCostCents!==void 0&&(u.accommodation_cost_cents=t.accommodationCostCents),t.mealAllowanceCents!==void 0&&(u.meal_allowance_cents=t.mealAllowanceCents),t.otherCostsCents!==void 0&&(u.other_costs_cents=t.otherCostsCents),t.transportationDetails!==void 0&&(u.transportation_details=t.transportationDetails),t.accommodationDetails!==void 0&&(u.accommodation_details=t.accommodationDetails),t.mealDetails!==void 0&&(u.meal_details=t.mealDetails),t.otherCostsDetails!==void 0&&(u.other_details=t.otherCostsDetails),t.submissionNotes!==void 0&&(u.submission_notes=t.submissionNotes),t.supportingDocuments!==void 0&&(u.supporting_documents=t.supportingDocuments);const{data:v,error:b}=await I.from("site_visit_cost_submissions").update(u).eq("id",e).eq("status","pending").select().single();if(b)throw b;return fe(v)},ro=async(e,t)=>{const s={reviewed_by:t,reviewed_at:new Date().toISOString(),reviewer_notes:e.reviewerNotes,approval_notes:e.approvalNotes,updated_at:new Date().toISOString()};e.action==="approve"?(s.status="approved",e.adjustedAmountCents!==void 0&&(s.paid_amount_cents=e.adjustedAmountCents),e.paymentNotes&&(s.payment_notes=e.paymentNotes)):e.action==="reject"?s.status="rejected":e.action==="request_revision"&&(s.status="under_review");const{data:i,error:r}=await I.from("site_visit_cost_submissions").update(s).eq("id",e.submissionId).in("status",["pending","under_review"]).select().single();if(r)throw r;return fe(i)},oo=async(e,t,s)=>{const{data:i,error:r}=await I.from("site_visit_cost_submissions").select("paid_amount_cents, total_cost_cents").eq("id",e).single();if(r)throw r;const n=s??i.paid_amount_cents??i.total_cost_cents,{data:p,error:l}=await I.from("site_visit_cost_submissions").update({status:"paid",wallet_transaction_id:t,paid_at:new Date().toISOString(),paid_amount_cents:n,updated_at:new Date().toISOString()}).eq("id",e).eq("status","approved").select().single();if(l)throw l;return fe(p)},no=async(e,t)=>{const{data:s,error:i}=await I.from("site_visit_cost_submissions").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("id",e).eq("submitted_by",t).eq("status","pending").select().single();if(i)throw i;return fe(s)},co=async(e,t)=>{const{error:s}=await I.from("site_visit_cost_submissions").delete().eq("id",e).eq("submitted_by",t).eq("status","pending");if(s)throw s},Ks=o.createContext(void 0),yt=()=>{const e=o.useContext(Ks);if(!e)throw new Error("useCostSubmissionContext must be used within CostSubmissionProvider");return e},lo=({children:e})=>{const{toast:t}=ne(),s=yi(),B={useAllSubmissions:(j=!0)=>{const{data:x,isLoading:N,error:V,refetch:$}=he({queryKey:["cost-submissions"],queryFn:Jr,enabled:j,staleTime:3e5});return{submissions:x||[],isLoading:N,error:V,refetch:$}},useSubmissionById:j=>{const{data:x,isLoading:N,error:V}=he({queryKey:["cost-submissions",j],queryFn:()=>Qr(j),enabled:!!j,staleTime:3e5});return{submission:x,isLoading:N,error:V}},useUserSubmissions:j=>{const{data:x,isLoading:N,error:V}=he({queryKey:["cost-submissions","user",j],queryFn:()=>Zr(j),enabled:!!j,staleTime:3e5});return{submissions:x||[],isLoading:N,error:V}},usePendingApprovals:()=>{const{data:j,isLoading:x,error:N,refetch:V}=he({queryKey:["cost-approvals","pending"],queryFn:Xr,staleTime:12e4});return{approvals:j||[],isLoading:x,error:N,refetch:V}},useSubmissionHistory:j=>{const{data:x,isLoading:N,error:V}=he({queryKey:["cost-submissions",j,"history"],queryFn:()=>eo(j),enabled:!!j,staleTime:3e5});return{history:x||[],isLoading:N,error:V}},useUserSummary:j=>{const{data:x,isLoading:N,error:V}=he({queryKey:["cost-submissions","summary","user",j],queryFn:()=>to(j),enabled:!!j,staleTime:6e5});return{summary:x,isLoading:N,error:V}},useMMPSummary:j=>{const{data:x,isLoading:N,error:V}=he({queryKey:["cost-submissions","summary","mmp",j],queryFn:()=>so(j),enabled:!!j,staleTime:6e5});return{summary:x,isLoading:N,error:V}},useCreateSubmission:()=>{const j=ve({mutationFn:async x=>{const N=await s.fetchQuery({queryKey:["user"],staleTime:3e5});if(!(N!=null&&N.id))throw new Error("User not authenticated");await ao(x,N.id)},onSuccess:(x,N)=>{s.invalidateQueries({queryKey:["cost-submissions"]}),s.invalidateQueries({queryKey:["cost-approvals","pending"]}),s.invalidateQueries({queryKey:["cost-submissions","user"]}),s.invalidateQueries({queryKey:["cost-submissions","summary"]}),t({title:"Success",description:"Cost submission created successfully"})},onError:x=>{t({title:"Error",description:x.message||"Failed to create cost submission",variant:"destructive"})}});return{mutate:j.mutateAsync,isPending:j.isPending}},useUpdateSubmission:()=>{const j=ve({mutationFn:async x=>{await io(x.id,x.request)},onSuccess:(x,N)=>{s.invalidateQueries({queryKey:["cost-submissions"]}),s.invalidateQueries({queryKey:["cost-submissions",N.id]}),s.invalidateQueries({queryKey:["cost-approvals","pending"]}),t({title:"Success",description:"Cost submission updated successfully"})},onError:x=>{t({title:"Error",description:x.message||"Failed to update cost submission",variant:"destructive"})}});return{mutate:j.mutateAsync,isPending:j.isPending}},useReviewSubmission:()=>{const j=ve({mutationFn:async x=>{const N=await s.fetchQuery({queryKey:["user"],staleTime:3e5});if(!(N!=null&&N.id))throw new Error("User not authenticated");await ro(x,N.id)},onSuccess:(x,N)=>{s.invalidateQueries({queryKey:["cost-submissions"]}),s.invalidateQueries({queryKey:["cost-submissions",N.submissionId]}),s.invalidateQueries({queryKey:["cost-approvals","pending"]}),s.invalidateQueries({queryKey:["cost-submissions","summary"]}),t({title:"Success",description:"Cost submission reviewed successfully"})},onError:x=>{t({title:"Error",description:x.message||"Failed to review cost submission",variant:"destructive"})}});return{mutate:j.mutateAsync,isPending:j.isPending}},useMarkPaid:()=>{const j=ve({mutationFn:async x=>{await oo(x.submissionId,x.walletTransactionId,x.paidAmountCents)},onSuccess:(x,N)=>{s.invalidateQueries({queryKey:["cost-submissions"]}),s.invalidateQueries({queryKey:["cost-submissions",N.submissionId]}),s.invalidateQueries({queryKey:["cost-approvals","pending"]}),s.invalidateQueries({queryKey:["cost-submissions","summary"]}),s.invalidateQueries({queryKey:["wallet"]}),s.invalidateQueries({queryKey:["walletTransactions"]}),t({title:"Success",description:"Payment processed successfully"})},onError:x=>{t({title:"Error",description:x.message||"Failed to process payment",variant:"destructive"})}});return{mutate:j.mutateAsync,isPending:j.isPending}},useCancelSubmission:()=>{const j=ve({mutationFn:async x=>{const N=await s.fetchQuery({queryKey:["user"],staleTime:3e5});if(!(N!=null&&N.id))throw new Error("User not authenticated");await no(x,N.id)},onSuccess:async(x,N)=>{const V=await s.fetchQuery({queryKey:["user"],staleTime:3e5});s.invalidateQueries({queryKey:["cost-submissions"]}),s.invalidateQueries({queryKey:["cost-submissions",N]}),s.invalidateQueries({queryKey:["cost-approvals","pending"]}),V!=null&&V.id&&(s.invalidateQueries({queryKey:["cost-submissions","user",V.id]}),s.invalidateQueries({queryKey:["cost-submissions","summary","user",V.id]})),t({title:"Success",description:"Cost submission cancelled"})},onError:x=>{t({title:"Error",description:x.message||"Failed to cancel cost submission",variant:"destructive"})}});return{mutate:j.mutateAsync,isPending:j.isPending}},useDeleteSubmission:()=>{const j=ve({mutationFn:async x=>{const N=await s.fetchQuery({queryKey:["user"],staleTime:3e5});if(!(N!=null&&N.id))throw new Error("User not authenticated");await co(x,N.id)},onSuccess:async(x,N)=>{const V=await s.fetchQuery({queryKey:["user"],staleTime:3e5});s.invalidateQueries({queryKey:["cost-submissions"]}),s.invalidateQueries({queryKey:["cost-approvals","pending"]}),V!=null&&V.id&&(s.invalidateQueries({queryKey:["cost-submissions","user",V.id]}),s.invalidateQueries({queryKey:["cost-submissions","summary","user",V.id]})),t({title:"Success",description:"Cost submission deleted"})},onError:x=>{t({title:"Error",description:x.message||"Failed to delete cost submission",variant:"destructive"})}});return{mutate:j.mutateAsync,isPending:j.isPending}}};return a.jsx(Ks.Provider,{value:B,children:e})},Zc=e=>yt().useAllSubmissions(e),Xc=e=>yt().useUserSubmissions(e),el=()=>yt().usePendingApprovals(),Hs=o.createContext(void 0),uo=({children:e})=>{const t=ue(),s=rr(),i=Ts(),r=Te(),n=Us(),g={...t,...s,...i,...r,hasGranularPermission:(u,v)=>t.currentUser?n.hasPermission(t.currentUser.id,u,v):!1,calculateDistanceFee:(u,v)=>{const A=Math.abs(u-15.5007),F=Math.abs(v-32.5599),P=Math.sqrt(A*A+F*F);return Math.round(P*50)},roles:t.roles,hasRole:t.hasRole,addRole:t.addRole,removeRole:t.removeRole,updateMMP:s.updateMMP,deleteMMPFile:s.deleteMMPFile,emailVerificationPending:t.emailVerificationPending,verificationEmail:t.verificationEmail,resendVerificationEmail:t.resendVerificationEmail,clearEmailVerificationNotice:t.clearEmailVerificationNotice};return a.jsx(Hs.Provider,{value:g,children:e})},mo=({children:e})=>a.jsx(Ar,{children:a.jsx(nr,{children:a.jsx(Ki,{children:a.jsx(kr,{children:a.jsx(br,{children:a.jsx(ir,{children:a.jsx(jr,{children:a.jsx(Dr,{children:a.jsx(Er,{children:a.jsx(Ir,{children:a.jsx(uo,{children:a.jsx(Vr,{children:a.jsx($r,{children:a.jsx(lo,{children:a.jsx(Cr,{children:a.jsx(Nr,{children:e})})})})})})})})})})})})})})})}),Ae=()=>{const e=o.useContext(Hs);if(e===void 0)throw new Error("useAppContext must be used within an AppProvider");return e};function G(...e){return mi(fi(e))}const fo=Ce("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),re=o.forwardRef(({className:e,variant:t,size:s,asChild:i=!1,...r},n)=>{const p=i?Me:"button";return a.jsx(p,{className:G(fo({variant:t,size:s,className:e})),ref:n,...r})});re.displayName="Button";const Ys=o.forwardRef(({className:e,type:t,...s},i)=>a.jsx("input",{type:t,className:G("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",e),ref:i,...s}));Ys.displayName="Input";const Js=o.forwardRef(({className:e,orientation:t="horizontal",decorative:s=!0,...i},r)=>a.jsx(es,{ref:r,decorative:s,orientation:t,className:G("shrink-0 bg-border",t==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",e),...i}));Js.displayName=es.displayName;const Qs=_s,po=gs,Zs=o.forwardRef(({className:e,...t},s)=>a.jsx($e,{className:G("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",e),...t,ref:s}));Zs.displayName=$e.displayName;const ho=Ce("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),vt=o.forwardRef(({side:e="right",className:t,children:s,...i},r)=>a.jsxs(po,{children:[a.jsx(Zs,{}),a.jsxs(Ue,{ref:r,className:G(ho({side:e}),t),...i,children:[s,a.jsxs(gt,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[a.jsx(ft,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));vt.displayName=Ue.displayName;const Xs=({className:e,...t})=>a.jsx("div",{className:G("flex flex-col space-y-2 text-center sm:text-left",e),...t});Xs.displayName="SheetHeader";const ea=o.forwardRef(({className:e,...t},s)=>a.jsx(ze,{ref:s,className:G("text-lg font-semibold text-foreground",e),...t}));ea.displayName=ze.displayName;const go=o.forwardRef(({className:e,...t},s)=>a.jsx(We,{ref:s,className:G("text-sm text-muted-foreground",e),...t}));go.displayName=We.displayName;function Lt({className:e,...t}){return a.jsx("div",{className:G("animate-pulse rounded-md bg-muted",e),...t})}const ta=Ni,bt=Mi,wt=Ai,Ge=o.forwardRef(({className:e,sideOffset:t=4,...s},i)=>a.jsx(ts,{ref:i,sideOffset:t,className:G("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...s}));Ge.displayName=ts.displayName;const _o="sidebar:state",yo=60*60*24*7,vo="16rem",bo="18rem",wo="3rem",xo="b",sa=o.createContext(null);function Ke(){const e=o.useContext(sa);if(!e)throw new Error("useSidebar must be used within a SidebarProvider.");return e}const aa=o.forwardRef(({defaultOpen:e=!0,open:t,onOpenChange:s,className:i,style:r,children:n,...p},l)=>{const g=_t(),[u,v]=o.useState(!1),[b,T]=o.useState(e),A=t??b,F=o.useCallback(x=>{const N=typeof x=="function"?x(A):x;s?s(N):T(N),document.cookie=`${_o}=${N}; path=/; max-age=${yo}`},[s,A]),P=o.useCallback(()=>g?v(x=>!x):F(x=>!x),[g,F,v]);o.useEffect(()=>{const x=N=>{N.key===xo&&(N.metaKey||N.ctrlKey)&&(N.preventDefault(),P())};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[P]);const B=A?"expanded":"collapsed",j=o.useMemo(()=>({state:B,open:A,setOpen:F,isMobile:g,openMobile:u,setOpenMobile:v,toggleSidebar:P}),[B,A,F,g,u,v,P]);return a.jsx(sa.Provider,{value:j,children:a.jsx(ta,{delayDuration:0,children:a.jsx("div",{style:{"--sidebar-width":vo,"--sidebar-width-icon":wo,...r},className:G("group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",i),ref:l,...p,children:n})})})});aa.displayName="SidebarProvider";const ia=o.forwardRef(({side:e="left",variant:t="sidebar",collapsible:s="offcanvas",className:i,children:r,...n},p)=>{const{isMobile:l,state:g,openMobile:u,setOpenMobile:v}=Ke();return s==="none"?a.jsx("div",{className:G("flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",i),ref:p,...n,children:r}):l?a.jsx(Qs,{open:u,onOpenChange:v,...n,children:a.jsx(vt,{"data-sidebar":"sidebar","data-mobile":"true",className:"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden",style:{"--sidebar-width":bo},side:e,children:a.jsx("div",{className:"flex h-full w-full flex-col",children:r})})}):a.jsxs("div",{ref:p,className:"group peer hidden md:block text-sidebar-foreground","data-state":g,"data-collapsible":g==="collapsed"?s:"","data-variant":t,"data-side":e,children:[a.jsx("div",{className:G("duration-200 relative h-svh w-[--sidebar-width] bg-transparent transition-[width] ease-linear","group-data-[collapsible=offcanvas]:w-0","group-data-[side=right]:rotate-180",t==="floating"||t==="inset"?"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon]")}),a.jsx("div",{className:G("duration-200 fixed inset-y-0 z-50 hidden h-svh w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex",e==="left"?"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]":"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",t==="floating"||t==="inset"?"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",i),...n,children:a.jsx("div",{"data-sidebar":"sidebar",className:"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow",children:r})})]})});ia.displayName="Sidebar";const ra=o.forwardRef(({className:e,onClick:t,...s},i)=>{const{toggleSidebar:r}=Ke();return a.jsxs(re,{ref:i,"data-sidebar":"trigger",variant:"ghost",size:"icon",className:G("h-7 w-7",e),onClick:n=>{t==null||t(n),r()},...s,children:[a.jsx(Pa,{}),a.jsx("span",{className:"sr-only",children:"Toggle Sidebar"})]})});ra.displayName="SidebarTrigger";const oa=o.forwardRef(({className:e,...t},s)=>{const{toggleSidebar:i}=Ke();return a.jsx("button",{ref:s,"data-sidebar":"rail","aria-label":"Toggle Sidebar",tabIndex:-1,onClick:i,title:"Toggle Sidebar",className:G("absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex","[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize","[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize","group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar","[[data-side=left][data-collapsible=offcanvas]_&]:-right-2","[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",e),...t})});oa.displayName="SidebarRail";const na=o.forwardRef(({className:e,...t},s)=>a.jsx("main",{ref:s,className:G("relative flex min-h-svh flex-1 flex-col bg-background","peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",e),...t}));na.displayName="SidebarInset";const So=o.forwardRef(({className:e,...t},s)=>a.jsx(Ys,{ref:s,"data-sidebar":"input",className:G("h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",e),...t}));So.displayName="SidebarInput";const ca=o.forwardRef(({className:e,...t},s)=>a.jsx("div",{ref:s,"data-sidebar":"header",className:G("flex flex-col gap-2 p-2",e),...t}));ca.displayName="SidebarHeader";const la=o.forwardRef(({className:e,...t},s)=>a.jsx("div",{ref:s,"data-sidebar":"footer",className:G("flex flex-col gap-2 p-2",e),...t}));la.displayName="SidebarFooter";const jo=o.forwardRef(({className:e,...t},s)=>a.jsx(Js,{ref:s,"data-sidebar":"separator",className:G("mx-2 w-auto bg-sidebar-border",e),...t}));jo.displayName="SidebarSeparator";const da=o.forwardRef(({className:e,...t},s)=>a.jsx("div",{ref:s,"data-sidebar":"content",className:G("flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",e),...t}));da.displayName="SidebarContent";const ua=o.forwardRef(({className:e,...t},s)=>a.jsx("div",{ref:s,"data-sidebar":"group",className:G("relative flex w-full min-w-0 flex-col p-2",e),...t}));ua.displayName="SidebarGroup";const ma=o.forwardRef(({className:e,asChild:t=!1,...s},i)=>{const r=t?Me:"div";return a.jsx(r,{ref:i,"data-sidebar":"group-label",className:G("duration-200 flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",e),...s})});ma.displayName="SidebarGroupLabel";const Co=o.forwardRef(({className:e,asChild:t=!1,...s},i)=>{const r=t?Me:"button";return a.jsx(r,{ref:i,"data-sidebar":"group-action",className:G("absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","group-data-[collapsible=icon]:hidden",e),...s})});Co.displayName="SidebarGroupAction";const fa=o.forwardRef(({className:e,...t},s)=>a.jsx("div",{ref:s,"data-sidebar":"group-content",className:G("w-full text-sm",e),...t}));fa.displayName="SidebarGroupContent";const pa=o.forwardRef(({className:e,...t},s)=>a.jsx("ul",{ref:s,"data-sidebar":"menu",className:G("flex w-full min-w-0 flex-col gap-1",e),...t}));pa.displayName="SidebarMenu";const ha=o.forwardRef(({className:e,...t},s)=>a.jsx("li",{ref:s,"data-sidebar":"menu-item",className:G("group/menu-item relative",e),...t}));ha.displayName="SidebarMenuItem";const No=Ce("peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",{variants:{variant:{default:"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",outline:"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]"},size:{default:"h-8 text-sm",sm:"h-7 text-xs",lg:"h-12 text-sm group-data-[collapsible=icon]:!p-0"}},defaultVariants:{variant:"default",size:"default"}}),ga=o.forwardRef(({asChild:e=!1,isActive:t=!1,variant:s="default",size:i="default",tooltip:r,className:n,...p},l)=>{const g=e?Me:"button",{isMobile:u,state:v}=Ke(),b=a.jsx(g,{ref:l,"data-sidebar":"menu-button","data-size":i,"data-active":t,className:G(No({variant:s,size:i}),n),...p});return r?(typeof r=="string"&&(r={children:r}),a.jsxs(bt,{children:[a.jsx(wt,{asChild:!0,children:b}),a.jsx(Ge,{side:"right",align:"center",hidden:v!=="collapsed"||u,...r})]})):b});ga.displayName="SidebarMenuButton";const Mo=o.forwardRef(({className:e,asChild:t=!1,showOnHover:s=!1,...i},r)=>{const n=t?Me:"button";return a.jsx(n,{ref:r,"data-sidebar":"menu-action",className:G("absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",s&&"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",e),...i})});Mo.displayName="SidebarMenuAction";const Ao=o.forwardRef(({className:e,...t},s)=>a.jsx("div",{ref:s,"data-sidebar":"menu-badge",className:G("absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground select-none pointer-events-none","peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",e),...t}));Ao.displayName="SidebarMenuBadge";const Eo=o.forwardRef(({className:e,showIcon:t=!1,...s},i)=>{const r=o.useMemo(()=>`${Math.floor(Math.random()*40)+50}%`,[]);return a.jsxs("div",{ref:i,"data-sidebar":"menu-skeleton",className:G("rounded-md h-8 flex gap-2 px-2 items-center",e),...s,children:[t&&a.jsx(Lt,{className:"size-4 rounded-md","data-sidebar":"menu-skeleton-icon"}),a.jsx(Lt,{className:"h-4 flex-1 max-w-[--skeleton-width]","data-sidebar":"menu-skeleton-text",style:{"--skeleton-width":r}})]})});Eo.displayName="SidebarMenuSkeleton";const Do=o.forwardRef(({className:e,...t},s)=>a.jsx("ul",{ref:s,"data-sidebar":"menu-sub",className:G("mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5","group-data-[collapsible=icon]:hidden",e),...t}));Do.displayName="SidebarMenuSub";const Io=o.forwardRef(({...e},t)=>a.jsx("li",{ref:t,...e}));Io.displayName="SidebarMenuSubItem";const Po=o.forwardRef(({asChild:e=!1,size:t="md",isActive:s,className:i,...r},n)=>{const p=e?Me:"a";return a.jsx(p,{ref:n,"data-sidebar":"menu-sub-button","data-size":t,"data-active":s,className:G("flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground","data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",t==="sm"&&"text-xs",t==="md"&&"text-sm","group-data-[collapsible=icon]:hidden",i),...r})});Po.displayName="SidebarMenuSubButton";const To=()=>{const{toast:e}=ne(),{addNotification:t}=Te();return{sendNotification:({title:i,message:r,type:n="info",link:p,userId:l,entityId:g,entityType:u,showToast:v=!0,important:b=!1,duration:T})=>{l&&t({userId:l,title:i,message:r,type:n==="chat"?"info":n==="error"?"warning":n,link:p,relatedEntityId:g,relatedEntityType:u});const A={info:5e3,success:4e3,warning:6e3,error:8e3,chat:4e3};if(v){let F;switch(n){case"error":F="destructive";break;case"chat":F="info";break;case"success":case"warning":case"info":F=n;break;default:F="default"}e({title:i,description:r,variant:F,duration:T||A[n],important:b})}}}},ko=()=>{const{siteVisits:e,currentUser:t}=Ae(),{toast:s}=ne(),{sendNotification:i}=To(),[r,n]=o.useState(!1),p=o.useRef(!1),l=o.useRef(new Set),g=A=>{if(!A)return null;if(A instanceof Date)return we(A)?A:null;if(typeof A=="string"){try{const B=ji(A);if(we(B))return B}catch{}const P=new Date(A);return we(P)?P:null}const F=new Date(A);return we(F)?F:null},u=o.useMemo(()=>!t||!e?[]:e.filter(A=>A.assignedTo===t.id&&["assigned","permitVerified","inProgress"].includes(A.status)),[e,t]),v=o.useMemo(()=>{if(!u.length)return[];const A=new Date,F=wi(A,3);return u.filter(P=>{const B=g(P.dueDate);return B?xi(B,{start:A,end:F}):!1})},[u]),b=o.useMemo(()=>u.length?u.filter(A=>{const F=g(A.dueDate);return F?Si(F):!1}):[],[u]);o.useEffect(()=>{if(!t)return;const F=setInterval(()=>{const P=new Date;P.getHours()===8&&P.getMinutes()===0&&T()},6e4);return()=>clearInterval(F)},[t,v,b]),o.useEffect(()=>{!t||!v.length||v.forEach(A=>{if(l.current.has(A.id))return;const F=g(A.dueDate);if(!F)return;Math.ceil((F.getTime()-new Date().getTime())/(1e3*3600*24))===3&&(i({title:"Site Visit in 3 Days",message:`You have a scheduled site visit at ${A.siteName} on ${me(F,"MMM dd")}`,type:"info",userId:t.id,entityId:A.id,entityType:"siteVisit",showToast:!0}),l.current.add(A.id))})},[v,t,i]);const T=()=>{!v.length&&!b.length||!t||p.current||(p.current=!0,(v.length>0||b.length>0)&&n(!0),v.length>0&&s({title:`${v.length} site visit${v.length>1?"s":""} due soon`,description:"You have site visits that are due within the next 3 days",variant:"warning",duration:5e3}),b.length>0&&s({title:`${b.length} overdue site visit${b.length>1?"s":""}`,description:"You have site visits that are past their due date",variant:"destructive",duration:5e3}))};return{showDueReminders:T,dueSoonVisits:v,overdueVisits:b,showRemindersModal:r,setShowRemindersModal:n}},Oo="/assets/logo-ChdgqeWF.png",He=o.forwardRef(({className:e,...t},s)=>a.jsx(ss,{ref:s,className:G("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",e),...t}));He.displayName=ss.displayName;const Ye=o.forwardRef(({className:e,...t},s)=>a.jsx(as,{ref:s,className:G("aspect-square h-full w-full",e),...t}));Ye.displayName=as.displayName;const Je=o.forwardRef(({className:e,...t},s)=>a.jsx(is,{ref:s,className:G("flex h-full w-full items-center justify-center rounded-full bg-muted",e),...t}));Je.displayName=is.displayName;const Ro=()=>{const{currentUser:e}=Ae(),{hasPermission:t,getUserPermissions:s}=Us(),i=(B,j)=>e?t(e.id,B,j):!1,r=B=>{if(!e)return!1;const j=e.role,x=Array.isArray(e.roles)?e.roles:[];return B.some(N=>N===j||x.includes(N))};return{checkPermission:i,hasAnyRole:r,hasAllRoles:B=>{if(!e)return!1;const j=e.role,x=Array.isArray(e.roles)?e.roles:[];return B.every(N=>N===j||x.includes(N))},getCurrentUserPermissions:()=>e?s(e.id):[],canManageRoles:()=>i("roles","create")||i("roles","update")||i("roles","delete")||r(["admin"]),canManageUsers:()=>i("users","create")||i("users","update")||i("users","delete")||r(["admin"]),canApproveMMP:()=>i("mmp","approve")||r(["admin"]),canManageFinances:()=>i("finances","update")||i("finances","approve")||r(["admin"]),canViewAllSiteVisits:()=>i("site_visits","read")||r(["admin"]),canCreateProjects:()=>i("projects","create")||r(["admin"]),canEditFeeStructures:()=>r(["admin","Admin","ict","ICT"]),withPermission:(B,j,x)=>N=>i(B,j)?N:x||null,withRole:(B,j)=>x=>r(B)?x:j||null,currentUser:e,isAuthenticated:!!e}},lt=Ri,dt=Fi,Fo=o.forwardRef(({className:e,inset:t,children:s,...i},r)=>a.jsxs(ys,{ref:r,className:G("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-blue-50 data-[state=open]:bg-blue-50",t&&"pl-8",e),...i,children:[s,a.jsx(Ta,{className:"ml-auto h-4 w-4"})]}));Fo.displayName=ys.displayName;const Bo=o.forwardRef(({className:e,...t},s)=>a.jsx(vs,{ref:s,className:G("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-white p-1 text-slate-950 shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...t}));Bo.displayName=vs.displayName;const Qe=o.forwardRef(({className:e,sideOffset:t=4,...s},i)=>a.jsx(Oi,{children:a.jsx(bs,{ref:i,sideOffset:t,className:G("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-white p-1 text-slate-950 shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...s})}));Qe.displayName=bs.displayName;const _e=o.forwardRef(({className:e,inset:t,...s},i)=>a.jsx(ws,{ref:i,className:G("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-blue-50 focus:text-blue-700 data-[disabled]:pointer-events-none data-[disabled]:opacity-50 hover:bg-blue-50",t&&"pl-8",e),...s}));_e.displayName=ws.displayName;const Vo=o.forwardRef(({className:e,children:t,checked:s,...i},r)=>a.jsxs(xs,{ref:r,className:G("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-blue-50 focus:text-blue-700 data-[disabled]:pointer-events-none data-[disabled]:opacity-50 hover:bg-blue-50",e),checked:s,...i,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx(Ss,{children:a.jsx(ka,{className:"h-4 w-4 text-blue-600"})})}),t]}));Vo.displayName=xs.displayName;const qo=o.forwardRef(({className:e,children:t,...s},i)=>a.jsxs(js,{ref:i,className:G("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-blue-50 focus:text-blue-700 data-[disabled]:pointer-events-none data-[disabled]:opacity-50 hover:bg-blue-50",e),...s,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx(Ss,{children:a.jsx(Oa,{className:"h-2 w-2 fill-blue-600"})})}),t]}));qo.displayName=js.displayName;const Ze=o.forwardRef(({className:e,inset:t,...s},i)=>a.jsx(Cs,{ref:i,className:G("px-2 py-1.5 text-sm font-semibold text-slate-700",t&&"pl-8",e),...s}));Ze.displayName=Cs.displayName;const je=o.forwardRef(({className:e,...t},s)=>a.jsx(Ns,{ref:s,className:G("-mx-1 my-1 h-px bg-slate-200",e),...t}));je.displayName=Ns.displayName;const Lo=(e=[],t="dataCollector",s={})=>{const i=e.includes("admin")||t==="admin",r=e.includes("ict")||t==="ict",n=e.includes("financialAdmin")||t==="financialAdmin",p=e.includes("dataCollector")||t==="dataCollector",l=[];(i||r||s.dashboard)&&l.push({title:"Dashboard",url:"/dashboard",icon:Fa}),p&&l.push({title:"My Wallet",url:"/wallet",icon:jt}),(p||i)&&l.push({title:"Cost Submission",url:"/cost-submission",icon:Gt});const g=e.includes("coordinator")||t==="coordinator",u=[];(i||r||s.projects)&&u.push({title:"Projects",url:"/projects",icon:Ba}),(i||r||s.mmp)&&u.push({title:"MMP Management",url:"/mmp",icon:Va}),(i||r||s.siteVisits)&&u.push({title:"Site Visits",url:"/site-visits",icon:et}),(i||s.fieldOpManager)&&u.push({title:"Field Operation Manager",url:"/field-operation-manager",icon:et}),(i||s.archive)&&u.push({title:"Archive",url:"/archive",icon:Kt}),g&&u.push({title:"Site Verification",url:"/coordinator/sites",icon:et});const v=[];(i||s.fieldTeam)&&!r&&v.push({title:"Field Team",url:"/field-team",icon:qa});const b=[];(i||s.dataVisibility)&&!r&&b.push({title:"Data Visibility",url:"/data-visibility",icon:La}),(i||s.reports)&&!r&&b.push({title:"Reports",url:"/reports",icon:Ht});const T=[];(i||r||s.users)&&T.push({title:"User Management",url:"/users",icon:Yt}),(i||s.roleManagement)&&T.push({title:"Role Management",url:"/role-management",icon:$a}),(i||n)&&T.push({title:"Classifications",url:"/classifications",icon:Ua}),s.financialOperations&&T.push({title:"Financial Operations",url:"/financial-operations",icon:za}),(i||s.settings)&&T.push({title:"Settings",url:"/settings",icon:Le}),(i||n)&&T.push({title:"Budget",url:"/budget",icon:Jt}),(i||n)&&T.push({title:"Wallets",url:"/admin/wallets",icon:jt});const A=[];return l.length&&A.push({label:"Overview",items:l}),u.length&&A.push({label:"Projects",items:u}),v.length&&A.push({label:"Team",items:v}),b.length&&A.push({label:"Data & Reports",items:b}),T.length&&A.push({label:"Administration",items:T}),A},$o=()=>{const{pathname:e}=ye(),t=Ne(),{currentUser:s,logout:i,roles:r}=Ae(),{showDueReminders:n}=ko(),{checkPermission:p,hasAnyRole:l,canManageRoles:g}=Ro(),u=l(["admin"]),v={dashboard:!0,projects:p("projects","read")||u||l(["ict"]),mmp:p("mmp","read")||u||l(["ict"]),monitoringPlan:p("mmp","read")||u||l(["ict"]),siteVisits:p("site_visits","read")||u||l(["ict"]),archive:p("reports","read")||u,fieldTeam:p("users","read")||u,dataVisibility:p("reports","read")||u,reports:p("reports","read")||u,users:p("users","read")||u||l(["ict"]),roleManagement:g()||u,settings:p("settings","read")||u,financialOperations:p("finances","update")||p("finances","approve")||u||l(["financialAdmin"])},b=s?Lo(r||[],s.role,v):[],T=P=>P.split(" ").map(B=>B[0]).join("").toUpperCase().substring(0,2),A=()=>s?r&&r.length>0?r.includes("admin")?"Admin":{admin:"Admin",ict:"ICT",fom:"Field Ops Manager",financialAdmin:"Financial Admin",supervisor:"Supervisor",dataCollector:"Data Collector"}[r[0]]||r[0].charAt(0).toUpperCase()+r[0].slice(1):s.role.charAt(0).toUpperCase()+s.role.slice(1):"",F=()=>{n(),setTimeout(async()=>{await i(),t("/auth")},1500)};return a.jsxs(ia,{collapsible:"icon",className:"border-r bg-white dark:bg-gray-900",children:[a.jsx(ca,{className:"border-b",children:a.jsxs("div",{className:"flex h-16 items-center gap-3 px-4",children:[a.jsx("img",{src:Oo,alt:"PACT Logo",className:"h-14 w-14 shrink-0 object-contain"}),a.jsx(ra,{className:"ml-auto"})]})}),a.jsx(da,{className:"px-3 py-4",children:b.map((P,B)=>a.jsxs(ua,{className:B>0?"mt-1":"",children:[a.jsx(ma,{className:"px-2 text-[11px] uppercase tracking-wide font-semibold text-blue-600 dark:text-blue-300",children:P.label}),a.jsx(fa,{children:a.jsx(pa,{className:"space-y-1",children:P.items.map(j=>a.jsx(ha,{children:a.jsx(ga,{asChild:!0,isActive:e===j.url,tooltip:j.title,className:`h-7 px-3 rounded-lg text-sm font-medium transition-all duration-200 
                        ${e===j.url?"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 font-semibold":"hover:bg-blue-50 dark:hover:bg-blue-800"}`,children:a.jsxs(ot,{to:j.url,className:"flex items-center gap-3",children:[a.jsx(j.icon,{className:`h-5 w-5 ${e===j.url?"text-blue-700 dark:text-blue-300":"text-blue-600 dark:text-blue-400"}`}),a.jsx("span",{className:"truncate",children:j.title})]})})},j.title))})})]},P.label))}),a.jsx(la,{className:"border-t p-3",children:s&&a.jsxs(lt,{children:[a.jsx(dt,{asChild:!0,children:a.jsxs(re,{variant:"ghost",className:"w-full justify-start gap-3 px-2 py-2 hover:bg-blue-50 dark:hover:bg-gray-800",children:[a.jsxs(He,{className:"h-9 w-9",children:[a.jsx(Ye,{src:s.avatar,alt:s.name}),a.jsx(Je,{className:"bg-blue-600 text-white text-xs",children:T(s.name)})]}),a.jsxs("div",{className:"flex flex-col items-start text-left text-sm leading-tight group-data-[collapsible=icon]:hidden",children:[a.jsx("span",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s.name}),a.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:A()})]}),a.jsx(Ra,{className:"ml-auto h-4 w-4 text-muted-foreground group-data-[collapsible=icon]:hidden"})]})}),a.jsxs(Qe,{side:"top",align:"end",className:"w-56",children:[a.jsx(Ze,{children:a.jsxs("div",{className:"flex flex-col space-y-1",children:[a.jsx("p",{className:"text-sm font-medium",children:s.name}),a.jsx("p",{className:"text-xs text-muted-foreground",children:s.email})]})}),a.jsx(je,{}),a.jsx(_e,{asChild:!0,children:a.jsxs(ot,{to:"/settings",children:[a.jsx(Le,{className:"mr-2 h-4 w-4"}),a.jsx("span",{children:"Settings"})]})}),a.jsx(je,{}),a.jsxs(_e,{onClick:F,className:"text-red-600 dark:text-red-500 cursor-pointer",children:[a.jsx(Wt,{className:"mr-2 h-4 w-4"}),a.jsx("span",{children:"Log out"})]})]})]})}),a.jsx(oa,{})]})},xt=o.forwardRef(({className:e,children:t,...s},i)=>a.jsxs(rs,{ref:i,className:G("relative overflow-hidden",e),...s,children:[a.jsx(Ei,{className:"h-full w-full rounded-[inherit]",children:t}),a.jsx(_a,{}),a.jsx(Di,{})]}));xt.displayName=rs.displayName;const _a=o.forwardRef(({className:e,orientation:t="vertical",...s},i)=>a.jsx(os,{ref:i,orientation:t,className:G("flex touch-none select-none transition-colors",t==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",t==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",e),...s,children:a.jsx(Ii,{className:"relative flex-1 rounded-full bg-border"})}));_a.displayName=os.displayName;const ya=o.forwardRef(({className:e,...t},s)=>a.jsx("div",{ref:s,className:G("rounded-lg border bg-card text-card-foreground shadow-sm",e),...t}));ya.displayName="Card";const Uo=o.forwardRef(({className:e,...t},s)=>a.jsx("div",{ref:s,className:G("flex flex-col space-y-1.5 p-6",e),...t}));Uo.displayName="CardHeader";const zo=o.forwardRef(({className:e,...t},s)=>a.jsx("h3",{ref:s,className:G("text-2xl font-semibold leading-none tracking-tight",e),...t}));zo.displayName="CardTitle";const Wo=o.forwardRef(({className:e,...t},s)=>a.jsx("p",{ref:s,className:G("text-sm text-muted-foreground",e),...t}));Wo.displayName="CardDescription";const va=o.forwardRef(({className:e,...t},s)=>a.jsx("div",{ref:s,className:G("p-6 pt-0",e),...t}));va.displayName="CardContent";const Go=o.forwardRef(({className:e,...t},s)=>a.jsx("div",{ref:s,className:G("flex items-center p-6 pt-0",e),...t}));Go.displayName="CardFooter";const rt=({title:e,icon:t,notifications:s,onNotificationClick:i,actionButtons:r})=>s.length===0?null:a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center gap-1 px-2 mb-1",children:[t,a.jsx("span",{className:"text-xs font-medium",children:e}),a.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["(",s.length,")"]})]}),a.jsx("div",{className:"space-y-2",children:s.map(n=>a.jsx(ya,{onClick:()=>i(n),className:`cursor-pointer border-l-2 ${n.type==="error"?"border-l-destructive":n.type==="warning"?"border-l-amber-500":n.type==="success"?"border-l-green-500":"border-l-blue-500"} hover:bg-accent transition-colors ${n.isRead?"opacity-70":""}`,children:a.jsxs(va,{className:"p-3",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsx("h4",{className:"text-sm font-medium",children:n.title}),a.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(n.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),a.jsx("p",{className:"text-xs mt-1 text-muted-foreground",children:n.message}),r&&a.jsx("div",{className:"flex gap-2 mt-2",children:r(n)})]})},n.id))})]}),Ko=Pi,ba=o.forwardRef(({className:e,...t},s)=>a.jsx(ns,{ref:s,className:G("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",e),...t}));ba.displayName=ns.displayName;const Fe=o.forwardRef(({className:e,...t},s)=>a.jsx(cs,{ref:s,className:G("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",e),...t}));Fe.displayName=cs.displayName;const Ho=o.forwardRef(({className:e,...t},s)=>a.jsx(ls,{ref:s,className:G("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",e),...t}));Ho.displayName=ls.displayName;const Yo=({activeFilter:e,onFilterChange:t,counts:s})=>a.jsx(Ko,{value:e,onValueChange:t,className:"w-full",children:a.jsxs(ba,{className:"grid grid-cols-3",children:[a.jsxs(Fe,{value:"all",className:"flex items-center gap-1.5",children:[a.jsx(Ie,{className:"h-3.5 w-3.5"}),a.jsxs("span",{className:"text-xs",children:["All (",s.all,")"]})]}),a.jsxs(Fe,{value:"unread",className:"flex items-center gap-1.5",children:[a.jsx(Be,{className:"h-3.5 w-3.5"}),a.jsxs("span",{className:"text-xs",children:["Unread (",s.unread,")"]})]}),a.jsxs(Fe,{value:"today",className:"flex items-center gap-1.5",children:[a.jsx(Wa,{className:"h-3.5 w-3.5"}),a.jsxs("span",{className:"text-xs",children:["Today (",s.today,")"]})]})]})}),Jo=({onClose:e})=>{const{notifications:t,markNotificationAsRead:s,clearAllNotifications:i}=Te(),r=Ne(),[n,p]=o.useState("all"),{users:l}=ue(),{openChatForEntity:g,initiateCall:u}=Mr(),{siteVisits:v}=Ts(),{getUnreadMessagesCount:b}=Rs(),T=o.useRef(null),A=b();o.useEffect(()=>{T.current&&(T.current.setAttribute("tabIndex","-1"),T.current.focus())},[]);const F=m=>{s(m.id),m.relatedEntityType==="chat"?r("/chat"):m.link&&r(m.link),e()},P=(m,f)=>{f==="chat"?r("/chat"):(f==="siteVisit"||f==="mmpFile")&&(g(m,f),r("/chat")),e()},B=(m,f)=>{var _;if(f==="siteVisit"){const y=v.find(w=>w.id===m);if(y&&((_=y.team)!=null&&_.coordinator)){const w=l.find(R=>{var E;return R.id===((E=y.team)==null?void 0:E.coordinator)});if(w){u(w),e();return}}}r("/calls"),e()},j=()=>{t.forEach(m=>{m.isRead||s(m.id)})},x=async()=>{await i()},N=t.filter(m=>n==="unread"?!m.isRead:n==="today"?Nt(new Date(m.createdAt)):!0),V=N.filter(m=>m.type==="error"),$=N.filter(m=>m.type==="warning"),L=N.filter(m=>m.type==="info"||m.type==="success"),O={all:t.length,unread:t.filter(m=>!m.isRead).length,today:t.filter(m=>Nt(new Date(m.createdAt))).length},C=m=>m.relatedEntityType==="siteVisit"?a.jsxs(a.Fragment,{children:[a.jsxs(re,{variant:"outline",size:"sm",className:"h-7",onClick:f=>{f.stopPropagation(),P(m.relatedEntityId,m.relatedEntityType)},children:[a.jsx(Ve,{className:"h-3 w-3 mr-1"}),"Chat"]}),a.jsxs(re,{variant:"outline",size:"sm",className:"h-7",onClick:f=>{f.stopPropagation(),B(m.relatedEntityId,m.relatedEntityType)},children:[a.jsx(Ka,{className:"h-3 w-3 mr-1"}),"Call"]})]}):m.relatedEntityType==="mmpFile"?a.jsxs(re,{variant:"outline",size:"sm",className:"h-7",onClick:f=>{f.stopPropagation(),P(m.relatedEntityId,m.relatedEntityType)},children:[a.jsx(Ve,{className:"h-3 w-3 mr-1"}),"Discuss"]}):null;return a.jsxs(Qe,{className:"w-[380px] p-0 notification-dropdown shadow-lg border border-blue-100 dark:border-blue-800 rounded-xl overflow-hidden",align:"end",ref:T,children:[a.jsxs("div",{className:"flex items-center justify-between p-4 pb-2 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30",children:[a.jsxs(Ze,{className:"text-base p-0 flex items-center gap-1 text-blue-800 dark:text-blue-300",children:[a.jsx(Ie,{className:"h-4 w-4"}),"Notifications",A>0&&a.jsxs("span",{className:"bg-blue-100 text-blue-700 dark:bg-blue-800 dark:text-blue-200 text-xs rounded-full px-2 py-0.5 ml-2",children:["+",A," messages"]})]}),a.jsxs("div",{className:"flex gap-1",children:[a.jsxs(re,{variant:"ghost",size:"sm",onClick:j,className:"h-8 px-2 text-xs text-blue-600 hover:text-blue-800 hover:bg-blue-100/50",children:[a.jsx(Ga,{className:"h-3 w-3 mr-1"}),"Mark all read"]}),a.jsx(re,{variant:"ghost",size:"sm",onClick:x,className:"h-8 px-2 text-xs text-blue-600 hover:text-blue-800 hover:bg-blue-100/50",children:"Clear all"})]})]}),a.jsx(Yo,{activeFilter:n,onFilterChange:p,counts:O}),a.jsx(je,{className:"bg-blue-100 dark:bg-blue-800/30"}),a.jsx(xt,{className:"h-[400px] bg-white dark:bg-slate-900",children:a.jsxs("div",{className:"p-2 space-y-3",children:[a.jsx(rt,{title:"Urgent",icon:a.jsx(Be,{className:"h-4 w-4 text-red-500"}),notifications:V,onNotificationClick:F,actionButtons:C}),a.jsx(rt,{title:"Warnings",icon:a.jsx(Be,{className:"h-4 w-4 text-amber-500"}),notifications:$,onNotificationClick:F,actionButtons:C}),a.jsx(rt,{title:"Information",icon:a.jsx(pt,{className:"h-4 w-4 text-blue-500"}),notifications:L,onNotificationClick:F,actionButtons:C}),N.length===0&&a.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-center",children:[a.jsx(Ie,{className:"h-12 w-12 text-slate-300 dark:text-slate-600"}),a.jsx("p",{className:"mt-2 text-sm text-slate-500 dark:text-slate-400",children:"No notifications to display"})]})]})})]})},Qo=()=>a.jsx(ot,{to:"/dashboard",className:"flex items-center gap-3 group hover:opacity-90 transition-opacity duration-200"}),Zo=[{name:"Dashboard",path:"/dashboard"},{name:"Projects",path:"/projects"},{name:"Create Project",path:"/projects/create"},{name:"Project Archive",path:"/archive"},{name:"MMP Management",path:"/mmp"},{name:"Upload MMP",path:"/mmp/upload"},{name:"Site Visits",path:"/site-visits"},{name:"Schedule Site Visit",path:"/site-visits/schedule"},{name:"Site Visit Calendar",path:"/calendar"},{name:"User Management",path:"/users"},{name:"Register User",path:"/register"},{name:"Role Management",path:"/role-management"},{name:"Finance",path:"/finance"},{name:"Reports",path:"/reports"},{name:"Notifications",path:"/notifications"},{name:"Chat",path:"/chat"},{name:"Settings",path:"/settings"},{name:"Field Team",path:"/field-team"},{name:"Data Visibility",path:"/data-visibility"},{name:"Pending Approvals",path:"/users?tab=pending-approvals"},{name:"Approved Users",path:"/users?tab=approved-users"},{name:"Coordinator Dashboard",path:"/coordinator-dashboard"},{name:"Supervisor Dashboard",path:"/supervisor-dashboard"},{name:"Field Operation Manager",path:"/field-operation-manager"}],Xo=()=>{var F;const{setTheme:e,theme:t}=ht(),s=Ne(),{currentUser:i,logout:r}=ue(),{getUnreadNotificationsCount:n}=Te(),[p,l]=o.useState(""),[g,u]=o.useState(!1),v=p?Zo.filter(P=>P.name.toLowerCase().includes(p.trim().toLowerCase())):[],b=o.useCallback(async()=>{await r(),s("/auth")},[r,s]),T=P=>{P.preventDefault(),p.trim()&&(s(`/search?q=${encodeURIComponent(p.trim())}`),u(!1),l(""))},A=P=>{u(!1),l(""),s(P)};return a.jsx("div",{className:"border-b bg-gradient-to-r from-white to-gray-50 dark:from-gray-950 dark:to-gray-900",children:a.jsxs("div",{className:"flex h-16 items-center px-4 container mx-auto",children:[a.jsx(Qo,{}),a.jsxs("div",{className:"mx-4 flex-1 max-w-md relative",children:[a.jsx("form",{onSubmit:T,children:a.jsxs("div",{className:"relative",children:[a.jsx("input",{type:"search",value:p,onChange:P=>{l(P.target.value),u(!0)},onFocus:()=>u(!0),onBlur:()=>setTimeout(()=>u(!1),150),placeholder:"Search anything",className:"w-full rounded-full border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2 pl-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400","aria-label":"Global search",autoComplete:"off"}),a.jsx(Ha,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"})]})}),g&&p&&a.jsx("div",{className:"absolute z-50 mt-1 w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-60 overflow-auto",children:v.length>0?a.jsx("ul",{children:v.map(P=>a.jsx("li",{children:a.jsx("button",{type:"button",className:"w-full text-left px-4 py-2 hover:bg-blue-50 dark:hover:bg-blue-900 text-gray-900 dark:text-gray-100",onMouseDown:()=>A(P.path),children:P.name})},P.path))}):a.jsx("div",{className:"px-4 py-2 text-muted-foreground text-sm",children:"No features found."})})]}),a.jsxs("div",{className:"ml-auto flex items-center space-x-2",children:[a.jsxs(re,{variant:"ghost",size:"icon",onClick:()=>e(t==="dark"?"light":"dark"),className:"mr-2",children:[t==="dark"?a.jsx(Qt,{className:"h-5 w-5"}):a.jsx(Zt,{className:"h-5 w-5"}),a.jsx("span",{className:"sr-only",children:"Toggle theme"})]}),a.jsxs(lt,{children:[a.jsx(dt,{asChild:!0,children:a.jsxs(re,{variant:"ghost",size:"icon",className:"relative",children:[a.jsx(Ie,{className:"h-5 w-5"}),n()>0&&a.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs",children:n()>9?"9+":n()}),a.jsx("span",{className:"sr-only",children:"Notifications"})]})}),a.jsx(Jo,{onClose:()=>{}})]}),a.jsxs(lt,{children:[a.jsx(dt,{asChild:!0,children:a.jsxs(re,{variant:"ghost",size:"sm",className:"relative h-9 flex items-center gap-2 px-2",children:[a.jsxs(He,{className:"h-8 w-8",children:[a.jsx(Ye,{src:(i==null?void 0:i.avatar)||void 0,alt:"User"}),a.jsx(Je,{className:"bg-purple-100 text-purple-500",children:((F=i==null?void 0:i.name)==null?void 0:F.charAt(0))||"U"})]}),a.jsx("span",{className:"font-medium text-sm hidden md:inline-block",children:(i==null?void 0:i.name)||"User"})]})}),a.jsxs(Qe,{align:"end",className:"w-56",children:[a.jsx(Ze,{children:"My Account"}),a.jsx(je,{}),a.jsxs(_e,{onClick:()=>s(`/users/${i==null?void 0:i.id}`),children:[a.jsx(Ya,{className:"w-4 h-4 mr-2"}),"Profile"]}),a.jsxs(_e,{onClick:()=>s("/chat"),children:[a.jsx(Ve,{className:"w-4 h-4 mr-2"}),"Messages"]}),a.jsxs(_e,{onClick:()=>s("/settings"),children:[a.jsx(Le,{className:"w-4 h-4 mr-2"}),"Settings"]}),a.jsx(je,{}),a.jsxs(_e,{onClick:b,children:[a.jsx(Wt,{className:"w-4 h-4 mr-2"}),"Log out"]})]})]})]})]})})},en=()=>{const e=ye(),t=Ne(),{getUnreadMessagesCount:s}=Rs(),{currentUser:i,roles:r}=Ae(),n=s(),[p,l]=o.useState(!1),g=A=>!A||A.length===0?!0:A.some(F=>(r==null?void 0:r.includes(F))||(i==null?void 0:i.role)===F),u=[{icon:Xa,label:"Home",path:"/dashboard",roles:[]},{icon:ei,label:"Field",path:"/field-team",roles:[]},{icon:ti,label:"MMP",path:"/mmp",roles:[]},{icon:Ve,label:"Chat",path:"/chat",badge:n,roles:[]},{icon:si,label:"More",path:"",roles:[]}],v=[{icon:Jt,label:"Finance",path:"/finance",roles:["admin","financialAdmin","fom"]},{icon:Ja,label:"Wallet",path:"/wallet",roles:[]},{icon:Qa,label:"Projects",path:"/projects",roles:[]},{icon:Za,label:"Reports",path:"/reports",roles:["admin","supervisor","fom","financialAdmin"]},{icon:Gt,label:"Costs",path:"/cost-submission",roles:["dataCollector","admin"]},{icon:Ht,label:"Calendar",path:"/calendar",roles:[]},{icon:Yt,label:"Team",path:"/users",roles:[]},{icon:Le,label:"Settings",path:"/settings",roles:[]},{icon:Kt,label:"Archive",path:"/archive",roles:["admin","supervisor","fom"]}].filter(A=>g(A.roles||[])),b=A=>A?A==="/dashboard"&&e.pathname==="/dashboard"?!0:A!=="/dashboard"&&e.pathname.startsWith(A):!1,T=A=>{A?(t(A),l(!1)):l(!0)};return a.jsxs(a.Fragment,{children:[a.jsx("nav",{className:"fixed bottom-0 left-0 right-0 z-50 shadow-2xl backdrop-blur-lg bg-gradient-to-r from-slate-900/95 via-slate-800/95 to-slate-900/95 dark:from-slate-950/95 dark:via-slate-900/95 dark:to-slate-950/95 border-t border-blue-500/20",children:a.jsx("div",{className:"grid grid-cols-5 h-16 pb-safe",children:u.map((A,F)=>{const P=b(A.path);return a.jsxs("button",{"data-testid":`button-nav-${A.label.toLowerCase()}`,className:`flex flex-col items-center justify-center space-y-1 transition-all duration-200 relative overflow-visible ${P?"bg-gradient-to-br from-blue-500/20 to-purple-500/20 text-white":"text-gray-400 hover:text-white hover:bg-white/5"}`,onClick:()=>T(A.path),children:[a.jsxs("div",{className:"relative",children:[a.jsx(A.icon,{className:`h-5 w-5 ${P?"drop-shadow-[0_0_8px_rgba(59,130,246,0.5)]":""}`}),A.badge&&A.badge>0&&a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"absolute -top-1.5 -right-1.5 bg-gradient-to-br from-red-500 to-red-700 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center shadow-md z-10",children:A.badge>9?"9+":A.badge}),a.jsx(Ee,{className:"absolute -top-2 -right-2 h-3 w-3 text-yellow-400 animate-pulse z-0"})]})]}),a.jsx("span",{className:"text-xs font-medium",children:A.label}),P&&a.jsx("div",{className:"absolute bottom-0 left-1/2 transform -translate-x-1/2 w-12 h-1 bg-gradient-to-r from-blue-500 to-purple-500 rounded-t-full"})]},F)})})}),a.jsx(Qs,{open:p,onOpenChange:l,children:a.jsxs(vt,{side:"bottom",className:"h-[70vh] bg-gradient-to-b from-slate-900 to-slate-950 border-t border-blue-500/30",children:[a.jsx(Xs,{className:"border-b border-blue-500/20 pb-4",children:a.jsxs(ea,{className:"text-xl font-bold text-white flex items-center gap-2",children:[a.jsx(Ee,{className:"h-5 w-5 text-blue-400"}),"More Features"]})}),a.jsx(xt,{className:"h-[calc(70vh-80px)] mt-4",children:a.jsx("div",{className:"grid grid-cols-3 gap-3 p-2",children:v.map((A,F)=>{const P=b(A.path);return a.jsxs("button",{"data-testid":`button-more-${A.label.toLowerCase()}`,className:`flex flex-col items-center justify-center p-4 rounded-xl transition-all duration-200 ${P?"bg-gradient-to-br from-blue-500/30 to-purple-500/30 shadow-lg shadow-blue-500/20 border border-blue-400/30":"bg-slate-800/50 hover:bg-slate-700/50 border border-slate-700"}`,onClick:()=>T(A.path),children:[a.jsxs("div",{className:"relative mb-2",children:[a.jsx(A.icon,{className:`h-7 w-7 ${P?"text-blue-400 drop-shadow-[0_0_10px_rgba(59,130,246,0.6)]":"text-gray-400"}`}),P&&a.jsx(Ee,{className:"absolute -top-1 -right-1 h-3 w-3 text-yellow-400 animate-pulse"})]}),a.jsx("span",{className:`text-xs font-medium text-center ${P?"text-white":"text-gray-300"}`,children:A.label})]},F)})})})]})})]})},tn=Ce("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground",success:"border-transparent bg-green-100 text-green-800 hover:bg-green-200",warning:"border-transparent bg-amber-100 text-amber-800 hover:bg-amber-200",info:"border-transparent bg-blue-100 text-blue-800 hover:bg-blue-200"}},defaultVariants:{variant:"default"}});function ut({className:e,variant:t,...s}){return a.jsx("div",{className:G(tn({variant:t}),e),...s})}const sn=({toggleSidebar:e,title:t="Field Operations",showNotification:s=!0})=>{const i=Ne(),r=ye(),{currentUser:n}=ue(),p=r.pathname==="/field-team",l=g=>g.split(" ").map(u=>u[0]).join("").toUpperCase().substring(0,2);return a.jsxs("header",{className:"px-4 h-16 flex items-center justify-between bg-gradient-to-r from-blue-600 to-purple-600 shadow-md",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[p?a.jsx(re,{variant:"ghost",size:"icon",onClick:e,className:"h-9 w-9 text-white hover:bg-white/10",children:a.jsx(ii,{className:"h-5 w-5"})}):a.jsx(re,{variant:"ghost",size:"icon",onClick:()=>i(-1),className:"h-9 w-9 text-white hover:bg-white/10",children:a.jsx(ai,{className:"h-5 w-5"})}),a.jsx("h1",{className:"text-lg font-semibold text-white truncate max-w-[180px]",children:t})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[s&&a.jsxs(re,{variant:"ghost",size:"icon",className:"relative h-9 w-9 text-white hover:bg-white/10",onClick:()=>i("/notifications"),children:[a.jsx(Ie,{className:"h-5 w-5"}),a.jsx(ut,{className:"absolute -top-1 -right-1 h-4 w-4 p-0 flex items-center justify-center bg-red-500",children:a.jsx("span",{className:"sr-only",children:"New notifications"})})]}),a.jsx(re,{variant:"ghost",size:"icon",className:"rounded-full h-9 w-9 p-1 border border-white/30",onClick:()=>i("/profile"),children:a.jsxs(He,{className:"h-full w-full",children:[a.jsx(Ye,{src:n==null?void 0:n.avatar,alt:(n==null?void 0:n.name)||""}),a.jsx(Je,{className:"bg-gradient-to-br from-blue-500 to-blue-700 text-white",children:n!=null&&n.name?l(n.name):"FO"})]})})]})]})},an=()=>{const{viewMode:e,toggleViewMode:t,isAutoDetect:s}=Vs();return a.jsxs(bt,{children:[a.jsx(wt,{asChild:!0,children:a.jsxs(re,{variant:"outline",size:"icon",className:`rounded-full bg-white dark:bg-gray-800 relative ${s?"":"ring-2 ring-blue-500 ring-offset-2"}`,onClick:t,"aria-label":e==="mobile"?"Switch to desktop view":"Switch to mobile view",title:e==="mobile"?"Desktop view":"Mobile view",children:[e==="mobile"?a.jsx(ri,{className:"h-5 w-5"}):a.jsx(oi,{className:"h-5 w-5"}),!s&&a.jsx(Ee,{className:"absolute -top-1 -right-1 h-3 w-3 text-blue-500 animate-pulse"})]})}),a.jsx(Ge,{children:a.jsxs("div",{className:"text-xs space-y-1",children:[a.jsx("p",{className:"font-semibold",children:s?" Auto-detect mode":" Override active"}),a.jsx("p",{children:s?`Currently: ${e==="mobile"?"Mobile":"Desktop"} (auto)`:`Forced: ${e==="mobile"?"Mobile":"Desktop"} view`}),a.jsxs("p",{className:"text-muted-foreground",children:["Click to ",s?"override":"reset to auto"]})]})})]})};function $t(e,t){const s=e.split(".").map(Number),i=t.split(".").map(Number);for(let r=0;r<Math.max(s.length,i.length);r++){const n=s[r]||0,p=i[r]||0;if(n>p)return 1;if(n<p)return-1}return 0}async function rn(e,t="mobile"){try{const{data:s,error:i}=await I.from("app_versions").select("*").eq("platform",t).single();if(i||!s)return{current:e,minimum_supported:e,latest:e,update_required:!1,update_available:!1};const r=$t(e,s.minimum_supported)<0,n=$t(e,s.latest_version)<0,p=s.force_update===!0,l=r||p;return{current:e,minimum_supported:s.minimum_supported,latest:s.latest_version,update_required:l,update_available:n&&!l,changelog:s.changelog,download_url:s.download_url}}catch{return{current:e,minimum_supported:e,latest:e,update_required:!1,update_available:!1}}}function on(){return"1.0.0"}const nn=_s,tl=ki,cn=gs,sl=gt,wa=o.forwardRef(({className:e,...t},s)=>a.jsx($e,{ref:s,className:G("fixed inset-0 z-50 bg-black/40 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",e),...t}));wa.displayName=$e.displayName;const xa=o.forwardRef(({className:e,children:t,...s},i)=>a.jsxs(cn,{children:[a.jsx(wa,{}),a.jsxs(Ue,{ref:i,className:G("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",e),...s,children:[t,a.jsxs(gt,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[a.jsx(ft,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));xa.displayName=Ue.displayName;const Sa=({className:e,...t})=>a.jsx("div",{className:G("flex flex-col space-y-1.5 text-center sm:text-left",e),...t});Sa.displayName="DialogHeader";const ln=({className:e,...t})=>a.jsx("div",{className:G("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",e),...t});ln.displayName="DialogFooter";const ja=o.forwardRef(({className:e,...t},s)=>a.jsx(ze,{ref:s,className:G("text-lg font-semibold leading-none tracking-tight",e),...t}));ja.displayName=ze.displayName;const Ca=o.forwardRef(({className:e,...t},s)=>a.jsx(We,{ref:s,className:G("text-sm text-muted-foreground",e),...t}));Ca.displayName=We.displayName;function dn(){const[e,t]=o.useState(null),[s,i]=o.useState(!1),[r,n]=o.useState(!1),p=_t();if(o.useEffect(()=>{async function g(){if(!p)return;const v=on(),b=await rn(v,"mobile");t(b),b.update_required?(i(!0),n(!0)):b.update_available&&i(!0)}g();const u=setInterval(g,36e5);return()=>clearInterval(u)},[p]),!e||!p)return null;const l=e.update_required;return a.jsxs(a.Fragment,{children:[r&&a.jsx("div",{className:"fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center",children:a.jsx("div",{className:"max-w-md w-full mx-4"})}),a.jsx(nn,{open:s,onOpenChange:l?void 0:i,children:a.jsxs(xa,{className:"sm:max-w-md z-[10000]",onPointerDownOutside:g=>{l&&g.preventDefault()},onEscapeKeyDown:g=>{l&&g.preventDefault()},children:[a.jsxs(Sa,{children:[a.jsxs("div",{className:"flex items-center gap-2",children:[l?a.jsx(qe,{className:"h-5 w-5 text-destructive"}):a.jsx(Ee,{className:"h-5 w-5 text-primary"}),a.jsx(ja,{children:l?"Update Required":"Update Available"})]}),a.jsx(Ca,{children:l?"You must update to continue using PACT Workflow.":"A new version of PACT Workflow is available with new features and improvements."})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"bg-muted p-4 rounded-md space-y-2",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-sm text-muted-foreground",children:"Current Version"}),a.jsx(ut,{variant:"outline",children:e.current})]}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-sm text-muted-foreground",children:"Latest Version"}),a.jsx(ut,{variant:"default",className:"bg-gradient-to-r from-primary to-blue-600",children:e.latest})]})]}),e.changelog&&a.jsxs("div",{className:"bg-muted p-4 rounded-md",children:[a.jsx("h4",{className:"text-sm font-medium mb-2",children:"What's New"}),a.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-line",children:e.changelog})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(re,{onClick:()=>{const g=e.download_url||"https://play.google.com/store/apps/details?id=com.pact.workflow";window.open(g,"_system")},className:"flex-1 bg-gradient-to-r from-primary to-blue-600 hover:from-primary/90 hover:to-blue-600/90","data-testid":"button-update-now",children:[a.jsx(ni,{className:"w-4 h-4 mr-2"}),"Update Now"]}),!l&&a.jsx(re,{variant:"outline",onClick:()=>i(!1),"data-testid":"button-update-later",children:"Later"})]}),l&&a.jsx("p",{className:"text-xs text-center text-muted-foreground",children:"This update is required to ensure compatibility with the latest features and security improvements."})]})]})})]})}const un=({children:e})=>{const{currentUser:t}=Ae(),s=Ne(),i=ye(),[r,n]=o.useState(!1),[p,l]=o.useState(!1),{viewMode:g}=Vs(),u=g==="mobile",{theme:v,setTheme:b}=ht(),T=()=>{const B=i.pathname;return B==="/dashboard"?"Dashboard":B==="/field-team"?"Field Map":B==="/site-visits"?"Site Visits":B==="/mmp"?"MMP Files":B==="/users"?"Team Members":B.startsWith("/projects")?"Projects":B==="/archive"?"Archives":"PACT Platform"};o.useEffect(()=>{t?n(!0):s("/auth")},[t,s]);const A=()=>{b(v==="dark"?"light":"dark")};if(!r)return null;const F=()=>{l(!p)},P=i.pathname==="/dashboard";return a.jsxs(ta,{children:[a.jsx(dn,{}),a.jsx(aa,{children:a.jsxs("div",{className:"min-h-screen flex w-full",children:[!u&&a.jsx($o,{}),a.jsxs(na,{className:`${u?"bg-gray-50 dark:bg-gray-900":""} relative z-0 flex flex-col min-w-0 overflow-x-hidden`,children:[u?a.jsx(sn,{toggleSidebar:F,title:T(),showNotification:!P}):a.jsx(Xo,{}),a.jsx("div",{className:`flex-1 ${u?"px-3 pb-safe-nav pt-safe":"p-4 md:p-6 lg:p-8"} ${u?"bg-gray-50 dark:bg-gray-900 scroll-container":"bg-slate-50/70 dark:bg-gray-900/70"} overflow-y-auto relative z-0 min-w-0`,children:e||a.jsx(pi,{})}),u&&a.jsx(en,{})]}),a.jsxs("div",{className:"fixed bottom-4 right-4 flex gap-2",children:[a.jsxs(bt,{children:[a.jsx(wt,{asChild:!0,children:a.jsx(re,{variant:"outline",size:"icon",className:"rounded-full bg-white dark:bg-gray-800",onClick:A,children:v==="dark"?a.jsx(Qt,{className:"h-5 w-5"}):a.jsx(Zt,{className:"h-5 w-5"})})}),a.jsx(Ge,{children:a.jsxs("p",{children:["Toggle ",v==="dark"?"light":"dark"," mode"]})})]}),a.jsx(an,{})]})]})})]})},mn=({children:e})=>a.jsx(un,{children:e}),fn=Ti,pn=Ce("fixed z-[100] flex max-h-screen w-full flex-col-reverse gap-2 p-4",{variants:{position:{"top-right":"top-0 right-0 md:max-w-[420px] md:right-4 md:top-4","top-center":"top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 md:max-w-[420px]","bottom-right":"bottom-0 right-0 md:max-w-[420px]","bottom-left":"bottom-0 left-0 md:max-w-[420px]","top-left":"top-0 left-0 md:max-w-[420px]"}},defaultVariants:{position:"top-center"}}),Na=o.forwardRef(({className:e,position:t,...s},i)=>a.jsx(ds,{ref:i,className:G(pn({position:t}),e),...s}));Na.displayName=ds.displayName;const hn=Ce("group pointer-events-auto relative flex w-full items-center justify-between overflow-hidden rounded-lg border p-6 shadow-lg transition-all",{variants:{variant:{default:"border-slate-700 bg-slate-900/95 text-white font-medium shadow-xl backdrop-blur-md border-opacity-60",success:"border-green-700 bg-green-800 text-green-50 font-semibold shadow-xl",destructive:"border-red-700 bg-red-800 text-red-50 font-semibold shadow-xl",warning:"border-amber-700 bg-amber-800 text-amber-50 font-semibold shadow-xl",info:"border-blue-700 bg-blue-800 text-blue-50 font-semibold shadow-xl",siddig:"border-slate-700 bg-slate-900/95 text-white font-medium shadow-xl backdrop-blur-md border-opacity-60"}},defaultVariants:{variant:"default"}}),Ma=o.forwardRef(({className:e,variant:t,...s},i)=>a.jsx(us,{ref:i,className:G(hn({variant:t}),"data-[state=open]:animate-scale-in-center","data-[state=closed]:animate-scale-out-center","transform transition-all duration-500 ease-in-out","origin-center",e),...s}));Ma.displayName=us.displayName;const gn=({variant:e})=>({default:a.jsx(tt,{className:"h-6 w-6 text-white"}),success:a.jsx(pt,{className:"h-6 w-6 text-white"}),destructive:a.jsx(Be,{className:"h-6 w-6 text-white"}),warning:a.jsx(qe,{className:"h-6 w-6 text-white"}),info:a.jsx(tt,{className:"h-6 w-6 text-white"}),siddig:a.jsx(tt,{className:"h-6 w-6 text-white"})})[e||"default"],mt=o.forwardRef(({className:e,...t},s)=>a.jsx(ms,{ref:s,className:G("inline-flex h-8 shrink-0 items-center justify-center rounded-md border px-3 text-sm font-medium transition-colors","border-transparent bg-primary text-primary-foreground hover:bg-primary/90","group-[.success]:bg-green-500 group-[.success]:text-white group-[.success]:hover:bg-green-600","group-[.destructive]:bg-red-500 group-[.destructive]:text-white group-[.destructive]:hover:bg-red-600","group-[.warning]:bg-amber-500 group-[.warning]:text-white group-[.warning]:hover:bg-amber-600","group-[.info]:bg-blue-500 group-[.info]:text-white group-[.info]:hover:bg-blue-600","mt-2 sm:mt-0 cursor-pointer",e),...t}));mt.displayName=ms.displayName;const Aa=o.forwardRef(({className:e,...t},s)=>a.jsx(fs,{ref:s,className:G("absolute right-1 top-1 rounded-md p-1 opacity-0 transition-opacity hover:opacity-100 focus:opacity-100 group-hover:opacity-100","text-gray-300 hover:text-white",e),"toast-close":"",...t,children:a.jsx(ft,{className:"h-4 w-4"})}));Aa.displayName=fs.displayName;const Ea=o.forwardRef(({className:e,...t},s)=>a.jsx(ps,{ref:s,className:G("text-base font-semibold leading-none tracking-tight text-white",e),...t}));Ea.displayName=ps.displayName;const Da=o.forwardRef(({className:e,...t},s)=>a.jsx(hs,{ref:s,className:G("text-sm font-medium text-white/90 mt-1 max-h-[40vh] overflow-y-auto",e),...t}));Da.displayName=hs.displayName;function _n(e){return e!==null&&typeof e=="object"&&"onClick"in e&&"children"in e&&"altText"in e}function yn(){const{toasts:e}=ne();return a.jsxs(fn,{children:[e.map(function({id:t,title:s,description:i,action:r,variant:n,...p}){const l=i&&typeof i=="string"&&(i.includes("Validation completed")||i.includes("Critical issues:")||i.includes("Warnings:")),g=l&&(i==null?void 0:i.toString().split(`
`).length)>3;return a.jsxs(Ma,{...p,variant:n,className:`group flex flex-col gap-4 transform transition-all max-w-md mx-auto drop-shadow-2xl border-2 ${g?"max-h-[40vh]":""}`,children:[a.jsxs("div",{className:"flex items-start gap-4 w-full",children:[a.jsx(gn,{variant:n}),a.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[s&&a.jsx(Ea,{children:s}),i&&a.jsx(Da,{className:`${g?"max-h-[25vh] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-rounded scrollbar-thumb-slate-400":"max-h-60 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-rounded scrollbar-thumb-slate-400"}`,children:l?a.jsx("div",{className:"space-y-2",children:i==null?void 0:i.toString().split(`
`).map((u,v)=>u.includes("Critical issues:")?a.jsxs("div",{className:"font-semibold text-red-400 flex items-center gap-1",children:[a.jsx(qe,{size:14}),u]},v):u.includes("Warnings:")?a.jsxs("div",{className:"font-semibold text-amber-400 flex items-center gap-1",children:[a.jsx(qe,{size:14}),u]},v):u.startsWith("")?a.jsx("div",{className:"ml-1",children:u},v):u.includes("Validation completed successfully")?a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(pt,{size:14,className:"text-green-400"}),u]},v):a.jsx("div",{children:u},v))}):i})]}),a.jsx(Aa,{})]}),r&&o.isValidElement(r)?a.jsx("div",{className:`flex mt-2 sm:mt-0 ${g?"justify-center":"justify-end"}`,children:r}):_n(r)?a.jsx("div",{className:`flex mt-2 sm:mt-0 ${g?"justify-center":"justify-end"}`,children:a.jsx(mt,{altText:r.altText,onClick:r.onClick,children:r.children})}):null,l&&!r&&a.jsx("div",{className:"flex justify-center mt-2",children:a.jsxs(mt,{altText:"View details",className:"flex items-center gap-1",onClick:()=>{const u=document.getElementById("validation-results");u&&u.scrollIntoView({behavior:"smooth"});const v=document.querySelector('[data-tab="validation-results"]');v&&v instanceof HTMLElement&&v.click()},children:[a.jsx(ci,{size:14}),"View Details"]})})]},t)}),a.jsx(Na,{position:"top-center"})]})}const vn=({...e})=>{const{theme:t="system"}=ht();return a.jsx(hi,{theme:t,className:"toaster group",toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"group-[.toast]:text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...e})};class bn extends o.Component{constructor(t){super(t),this.state={hasError:!1}}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,s){}render(){return this.state.hasError?this.props.fallback:this.props.children}}const Ia=async()=>{try{const{data:{user:e},error:t}=await I.auth.getUser(),{data:s,error:i}=await I.from("roles").select("*").limit(1),{data:r,error:n}=await I.from("permissions").select("*").limit(1),{data:p,error:l}=await I.rpc("get_roles_with_permissions"),{data:g}=await I.from("roles").select("id").limit(1).single();if(g){const{error:u}=await I.from("permissions").insert({role_id:g.id,resource:"test",action:"read"});u||await I.from("permissions").delete().eq("role_id",g.id).eq("resource","test").eq("action","read")}}catch{}};typeof window<"u"&&(window.debugDatabase=Ia);const wn=o.lazy(()=>Q(()=>import("./Index-EpS42w__.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]))),xn=o.lazy(()=>Q(()=>import("./Auth-BQzLj073.js"),__vite__mapDeps([15,1,2,3,4,5,16,14,12,17,6,7,8,9,10,11,13]))),Sn=o.lazy(()=>Q(()=>import("./Register-Byw0Ejaq.js"),__vite__mapDeps([18,1,2,3,4,5,7,19,12,20,21,16,14,17,6,8,9,10,11,13]))),jn=o.lazy(()=>Q(()=>import("./RegistrationSuccess-DOQuj4Nz.js"),__vite__mapDeps([22,1,2,3,4,5,7,6,8,9,10,11,12,13,14]))),Cn=o.lazy(()=>Q(()=>import("./ForgotPassword-BnuBQnlJ.js"),__vite__mapDeps([23,1,2,3,4,5,24,12,11,19,6,7,8,9,10,13,14]))),Nn=o.lazy(()=>Q(()=>import("./Dashboard-v9ElgL8V.js"),__vite__mapDeps([25,1,2,3,4,5,26,27,28,29,30,16,14,12,31,7,32,33,34,19,35,36,37,6,8,9,10,11,13]))),Mn=o.lazy(()=>Q(()=>import("./MMP-hOWqGBDk.js"),__vite__mapDeps([38,1,2,3,4,5,39,40,41,12,42,13,43,30,19,16,14,6,7,8,9,10,11]))),An=o.lazy(()=>Q(()=>import("./MMPUpload-BM6cW19x.js"),__vite__mapDeps([44,1,2,3,4,5,19,12,31,24,11,16,14,27,45,42,13,30,6,7,8,9,10]))),En=o.lazy(()=>Q(()=>import("./MMPDetail-C3InfdHM.js"),__vite__mapDeps([46,1,2,3,4,5,31,42,13,12,47,48,27,32,49,19,16,14,17,21,50,41,51,30,52,6,53,54,7,55,8,9,10,11]))),Dn=o.lazy(()=>Q(()=>import("./MMPDetailView-BjkoTVcY.js"),__vite__mapDeps([56,1,2,3,4,5,7,30,51,16,14,12,52,49,6,57,31,53,55,17,58,43,41,45,42,13,40,8,9,10,11]))),In=o.lazy(()=>Q(()=>import("./MMPVerification-CauQ_bcY.js"),__vite__mapDeps([59,1,2,3,4,5,60,55,17,61,16,14,12,39,50,27,24,11,19,54,7,58,62,30,31,6,8,9,10,13]))),Pn=o.lazy(()=>Q(()=>import("./MMPDetailedVerification-Dc0LHvgH.js"),__vite__mapDeps([63,1,2,3,4,5,60,48,31,27,32,49,12,19,16,14,17,21,50,41,61,39,6,7,8,9,10,11,13]))),Tn=o.lazy(()=>Q(()=>import("./MMPVerificationPage-CJOcXSS-.js"),__vite__mapDeps([64,1,2,3,4,5,47,31,48,27,32,49,12,19,16,14,17,21,50,41,6,7,8,9,10,11,13]))),kn=o.lazy(()=>Q(()=>import("./MMPPermitMessagePage-CpVw4iNZ.js"),__vite__mapDeps([65,1,2,3,4,5,6,7,8,9,10,11,12,13,14]))),Ut=o.lazy(()=>Q(()=>import("./EditMMP-CCUYgyyF.js"),__vite__mapDeps([66,1,2,3,4,5,7,54,27,53,55,17,43,30,41,12,67,68,69,11,70,24,19,16,14,32,49,60,6,8,9,10,13]))),On=o.lazy(()=>Q(()=>import("./NotFound-DM8CFhAM.js"),__vite__mapDeps([71,1,2,3,4,5,6,7,8,9,10,11,12,13,14]))),Rn=o.lazy(()=>Q(()=>import("./ReviewAssignCoordinators-DoyAAwSB.js"),__vite__mapDeps([72,1,2,3,4,5,16,14,12,41,17,6,7,8,9,10,11,13]))),Fn=o.lazy(()=>Q(()=>import("./SitesForVerification-CBmdlnLr.js"),__vite__mapDeps([73,1,2,3,4,5,6,7,8,9,10,11,12,13,14]))),Bn=o.lazy(()=>Q(()=>import("./CoordinatorSites-CeEdqgMl.js"),__vite__mapDeps([74,1,2,3,4,5,27,6,7,8,9,10,11,12,13,14]))),Vn=o.lazy(()=>Q(()=>import("./Calls-BrT-AjR7.js"),__vite__mapDeps([75,1,2,3,4,5,28,6,7,8,9,10,11,12,13,14]))),qn=o.lazy(()=>Q(()=>import("./Chat-B4uCYOKt.js"),__vite__mapDeps([76,1,2,3,4,5,26,27,6,7,8,9,10,11,12,13,14]))),Ln=o.lazy(()=>Q(()=>import("./FieldTeam-CEs3n55A.js"),__vite__mapDeps([77,1,2,3,4,5,78,35,36,17,79,6,7,8,9,10,11,12,13,14]))),$n=o.lazy(()=>Q(()=>import("./Finance-BTQ41GZN.js"),__vite__mapDeps([80,1,2,3,4,5,31,81,16,14,12,30,37,20,6,7,8,9,10,11,13]))),Un=o.lazy(()=>Q(()=>import("./Reports-D2DbiN2L.js"),__vite__mapDeps([82,1,2,3,4,5,30,83,32,49,12,10,6,81,7,8,9,11,13,14]))),zn=o.lazy(()=>Q(()=>import("./Projects-D1gJR6I4.js"),__vite__mapDeps([84,1,2,3,4,5,29,16,14,12,6,7,8,9,10,11,13]))),Wn=o.lazy(()=>Q(()=>import("./CreateProject-C37Y1WXb.js"),__vite__mapDeps([85,1,2,3,4,5,86,11,27,24,12,19,16,14,49,32,67,68,69,70,87,30,17,6,7,8,9,10,13]))),Gn=o.lazy(()=>Q(()=>import("./CreateProjectActivity-D9deBytP.js"),__vite__mapDeps([88,1,2,3,4,5,69,11,27,70,12,24,19,16,14,32,49,20,6,7,8,9,10,13]))),Kn=o.lazy(()=>Q(()=>import("./ProjectActivityDetail-d0PeX5GM.js"),__vite__mapDeps([89,1,2,3,4,5,20,6,7,8,9,10,11,12,13,14]))),Hn=o.lazy(()=>Q(()=>import("./ProjectDetail-BYM63hUZ.js"),__vite__mapDeps([90,1,2,3,4,5,31,42,13,12,52,20,6,7,8,9,10,11,14]))),Yn=o.lazy(()=>Q(()=>import("./EditProject-CrDiw484.js"),__vite__mapDeps([91,1,2,3,4,5,86,11,27,24,12,19,16,14,49,32,67,68,69,70,87,30,17,20,6,7,8,9,10,13]))),Jn=o.lazy(()=>Q(()=>import("./ProjectTeamManagement-Dmdri8Xa.js"),__vite__mapDeps([92,1,2,3,4,5,20,87,16,14,12,30,6,7,8,9,10,11,13]))),Qn=o.lazy(()=>Q(()=>import("./Settings-DphP3fCJ.js"),__vite__mapDeps([93,6,2,1,3,4,5,34,12,19,94,95,7,8,9,10,11,13,14]))),Zn=o.lazy(()=>Q(()=>import("./SiteVisits-B9TjmM_w.js"),__vite__mapDeps([96,1,2,3,4,5,7,16,14,12,97,32,49,70,98,35,36,79,17,52,78,6,8,9,10,11,13]))),Xn=o.lazy(()=>Q(()=>import("./SiteVisitDetail-BTXcaQsD.js"),__vite__mapDeps([99,1,2,3,4,5,17,97,20,42,13,12,19,27,6,7,8,9,10,11,14]))),ec=o.lazy(()=>Q(()=>import("./EditSiteVisit-Buu6Wth5.js"),__vite__mapDeps([100,1,2,3,4,5,27,41,12,19,6,7,8,9,10,11,13,14]))),tc=o.lazy(()=>Q(()=>import("./CreateSiteVisit-CepA2DtN.js"),__vite__mapDeps([101,1,2,3,4,5,6,7,8,9,10,11,12,13,14]))),sc=o.lazy(()=>Q(()=>import("./CreateSiteVisitMMP-B-r-X36Q.js"),__vite__mapDeps([102,1,2,3,4,5,58,6,7,8,9,10,11,12,13,14]))),ac=o.lazy(()=>Q(()=>import("./CreateSiteVisitMMPDetail-nGXNdVSj.js"),__vite__mapDeps([103,1,2,3,4,5,21,12,19,41,6,7,8,9,10,11,13,14]))),ic=o.lazy(()=>Q(()=>import("./CreateSiteVisitUrgent-BibhL0Li.js"),__vite__mapDeps([104,1,2,3,4,5,27,11,21,12,19,24,20,16,14,17,6,7,8,9,10,13]))),rc=o.lazy(()=>Q(()=>import("./AdvancedMap-BfGW6yrq.js"),__vite__mapDeps([105,6,2,1,3,4,5,7,8,9,10,11,12,13,14]))),oc=o.lazy(()=>Q(()=>import("./DataVisibility-CZf5fJ27.js"),__vite__mapDeps([106,1,2,3,4,5,16,14,12,30,31,62,98,35,36,79,17,81,6,7,8,9,10,11,13]))),nc=o.lazy(()=>Q(()=>import("./Users-BjXneWci.js"),__vite__mapDeps([107,1,2,3,4,5,17,16,14,12,30,94,95,7,6,8,9,10,11,13]))),cc=o.lazy(()=>Q(()=>import("./UserDetail-CKGKRkrT.js"),__vite__mapDeps([108,1,2,3,4,5,11,24,12,19,17,94,95,27,16,14,34,20,32,49,6,7,8,9,10,13]))),lc=o.lazy(()=>Q(()=>import("./AuditCompliance-BCMsdIl2.js"),__vite__mapDeps([109,1,2,3,4,5,51,30,16,14,12,52,49,6,57,31,7,8,9,10,11,13]))),dc=o.lazy(()=>Q(()=>import("./Archive--k5_vFpd.js"),__vite__mapDeps([110,1,2,3,4,5,16,14,12,19,41,27,32,6,7,8,9,10,11,13]))),uc=o.lazy(()=>Q(()=>import("./Calendar-B2Mptkdf.js"),__vite__mapDeps([111,1,2,3,4,5,32,83,49,12,33,6,7,8,9,10,11,13,14]))),mc=o.lazy(()=>Q(()=>import("./RoleManagement-CleIT7b5.js"),__vite__mapDeps([112,1,2,3,4,5,20,68,12,19,27,41,34,16,14,30,6,7,8,9,10,11,13]))),fc=o.lazy(()=>Q(()=>import("./MonitoringPlanPage-C2O-jEkx.js"),__vite__mapDeps([113,1,2,3,4,5,43,30,41,12,6,7,8,9,10,11,13,14]))),pc=o.lazy(()=>Q(()=>import("./FieldOperationManager-CNOeZyYk.js"),__vite__mapDeps([114,6,2,1,3,4,5,7,8,9,10,11,12,13,14]))),hc=o.lazy(()=>Q(()=>import("./GlobalSearchPage-hvPutsjx.js"),__vite__mapDeps([115,1,2,3,4,5,7]))),gc=o.lazy(()=>Q(()=>import("./Wallet-yqJ6_spG.js"),__vite__mapDeps([116,1,2,3,4,5,30,19,12,27,16,14,31,6,7,8,9,10,11,13]))),_c=o.lazy(()=>Q(()=>import("./AdminWallets-CT_At_Lr.js"),__vite__mapDeps([117,1,2,3,4,5,29,31,30,6,7,8,9,10,11,12,13,14]))),yc=o.lazy(()=>Q(()=>import("./AdminWalletDetail-EKnZzvhw.js"),__vite__mapDeps([118,1,2,3,4,5,30,6,7,8,9,10,11,12,13,14]))),vc=o.lazy(()=>Q(()=>import("./WithdrawalApproval-D1S2j4_i.js"),__vite__mapDeps([119,1,2,3,4,5,30,19,12,27,6,7,8,9,10,11,13,14]))),bc=o.lazy(()=>Q(()=>import("./WalletReports-DzTg0ArL.js"),__vite__mapDeps([120,1,2,3,4,5,30,6,7,8,9,10,11,12,13,14]))),wc=o.lazy(()=>Q(()=>import("./Budget-DZN_XryC.js"),__vite__mapDeps([121,1,2,3,4,5,29,30,31,19,12,16,14,27,6,10,7,8,9,11,13]))),xc=o.lazy(()=>Q(()=>import("./Classifications-w_UAy-y1.js"),__vite__mapDeps([122,1,2,3,4,5,20,16,14,12,11,24,19,27,6,7,8,9,10,13]))),Sc=o.lazy(()=>Q(()=>import("./CostSubmission-Cl5VQ6Xe.js"),__vite__mapDeps([123,1,2,3,4,5,11,24,12,19,27,16,14,6,7,8,9,10,13]))),jc=o.lazy(()=>Q(()=>import("./FinancialOperations-CqL_B5qx.js"),__vite__mapDeps([124,1,2,3,4,5,20,31,95,27,6,7,8,9,10,11,12,13,14]))),Cc=()=>a.jsx("div",{className:"min-h-screen flex items-center justify-center",children:a.jsx("div",{className:"text-sm text-muted-foreground animate-pulse",children:"Loading..."})}),Nc=()=>{const t=ye().pathname.split("/").pop();return a.jsx(Pe,{to:`/mmp/${t}/view`,replace:!0})},Mc=()=>{const t=ye().pathname.split("/"),s=t.indexOf("projects"),i=s>=0?t[s+1]:"";return a.jsx(Pe,{to:`/projects/${i}/team`,replace:!0})},Ac=({children:e})=>{const t=ye(),{currentUser:s,authReady:i}=Ae();return i?!s&&!["/auth","/login","/register","/registration-success","/forgot-password"].includes(t.pathname)?a.jsx(Pe,{to:"/auth",replace:!0}):e:a.jsx("div",{className:"min-h-screen flex items-center justify-center",children:a.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading"})})},Ec=()=>a.jsxs(_i,{children:[a.jsx(K,{path:"/",element:a.jsx(wn,{})}),a.jsx(K,{path:"/auth",element:a.jsx(xn,{})}),a.jsx(K,{path:"/login",element:a.jsx(Pe,{to:"/auth",replace:!0})}),a.jsx(K,{path:"/register",element:a.jsx(Sn,{})}),a.jsx(K,{path:"/registration-success",element:a.jsx(jn,{})}),a.jsx(K,{path:"/forgot-password",element:a.jsx(Cn,{})}),a.jsxs(K,{element:a.jsx(Ac,{children:a.jsx(mn,{})}),children:[a.jsx(K,{path:"/dashboard",element:a.jsx(Nn,{})}),a.jsx(K,{path:"/mmp",element:a.jsx(Mn,{})}),a.jsx(K,{path:"/mmp/upload",element:a.jsx(An,{})}),a.jsx(K,{path:"/mmp/:id",element:a.jsx(En,{})}),a.jsx(K,{path:"/mmp/:id/view",element:a.jsx(Dn,{})}),a.jsx(K,{path:"/mmp/:id/edit",element:a.jsx(Ut,{})}),a.jsx(K,{path:"/mmp/edit/:id",element:a.jsx(Ut,{})}),a.jsx(K,{path:"/mmp/verify/:id",element:a.jsx(In,{})}),a.jsx(K,{path:"/mmp/:id/detailed-verification",element:a.jsx(Pn,{})}),a.jsx(K,{path:"/mmp/:id/verification",element:a.jsx(Tn,{})}),a.jsx(K,{path:"/mmp/:id/permit-message",element:a.jsx(kn,{})}),a.jsx(K,{path:"/mmp/:id/review-assign-coordinators",element:a.jsx(Rn,{})}),a.jsx(K,{path:"/calls",element:a.jsx(Vn,{})}),a.jsx(K,{path:"/field-team",element:a.jsx(Ln,{})}),a.jsx(K,{path:"/finance",element:a.jsx($n,{})}),a.jsx(K,{path:"/financial-operations",element:a.jsx(jc,{})}),a.jsx(K,{path:"/data-visibility",element:a.jsx(oc,{})}),a.jsx(K,{path:"/chat",element:a.jsx(qn,{})}),a.jsx(K,{path:"/projects",element:a.jsx(zn,{})}),a.jsx(K,{path:"/projects/create",element:a.jsx(Wn,{})}),a.jsx(K,{path:"/projects/:id",element:a.jsx(Hn,{})}),a.jsx(K,{path:"/projects/:id/edit",element:a.jsx(Yn,{})}),a.jsx(K,{path:"/projects/:id/activities/create",element:a.jsx(Gn,{})}),a.jsx(K,{path:"/projects/:id/activities/:activityId",element:a.jsx(Kn,{})}),a.jsx(K,{path:"/projects/:id/team",element:a.jsx(Jn,{})}),a.jsx(K,{path:"/reports",element:a.jsx(Un,{})}),a.jsx(K,{path:"/settings",element:a.jsx(Qn,{})}),a.jsx(K,{path:"/wallet",element:a.jsx(gc,{})}),a.jsx(K,{path:"/admin/wallets",element:a.jsx(_c,{})}),a.jsx(K,{path:"/admin/wallets/:userId",element:a.jsx(yc,{})}),a.jsx(K,{path:"/withdrawal-approval",element:a.jsx(vc,{})}),a.jsx(K,{path:"/wallet-reports",element:a.jsx(bc,{})}),a.jsx(K,{path:"/budget",element:a.jsx(wc,{})}),a.jsx(K,{path:"/cost-submission",element:a.jsx(Sc,{})}),a.jsx(K,{path:"/site-visits",element:a.jsx(Zn,{})}),a.jsx(K,{path:"/site-visits/create",element:a.jsx(tc,{})}),a.jsx(K,{path:"/site-visits/create/mmp",element:a.jsx(sc,{})}),a.jsx(K,{path:"/site-visits/create/mmp/:id",element:a.jsx(ac,{})}),a.jsx(K,{path:"/site-visits/create/urgent",element:a.jsx(ic,{})}),a.jsx(K,{path:"/site-visits/:id",element:a.jsx(Xn,{})}),a.jsx(K,{path:"/site-visits/:id/edit",element:a.jsx(ec,{})}),a.jsx(K,{path:"/users",element:a.jsx(nc,{})}),a.jsx(K,{path:"/users/:id",element:a.jsx(cc,{})}),a.jsx(K,{path:"/classifications",element:a.jsx(xc,{})}),a.jsx(K,{path:"/map",element:a.jsx(rc,{})}),a.jsx(K,{path:"/advanced-map",element:a.jsx(Pe,{to:"/map",replace:!0})}),a.jsx(K,{path:"/audit-compliance",element:a.jsx(lc,{})}),a.jsx(K,{path:"/archive",element:a.jsx(dc,{})}),a.jsx(K,{path:"/calendar",element:a.jsx(uc,{})}),a.jsx(K,{path:"/role-management",element:a.jsx(mc,{})}),a.jsx(K,{path:"/monitoring-plan",element:a.jsx(fc,{})}),a.jsx(K,{path:"/field-operation-manager",element:a.jsx(pc,{})}),a.jsx(K,{path:"/search",element:a.jsx(hc,{})}),a.jsx(K,{path:"/coordinator/sites-for-verification",element:a.jsx(Fn,{})}),a.jsx(K,{path:"/coordinator/sites",element:a.jsx(Bn,{})})]}),a.jsx(K,{path:"/mmp/view/:id",element:a.jsx(Nc,{})}),a.jsx(K,{path:"/projects/:id/team/add",element:a.jsx(Mc,{})}),a.jsx(K,{path:"*",element:a.jsx(On,{})})]});function Dc(){const[e,t]=o.useState(!1);return o.useEffect(()=>{t(!0)},[]),o.useEffect(()=>{localStorage.getItem("theme")||(document.documentElement.classList.remove("dark"),document.documentElement.classList.add("light"),localStorage.setItem("theme","light"))},[]),o.useEffect(()=>{typeof window<"u"&&(window.debugDatabase=Ia)},[]),a.jsx(gi,{attribute:"class",defaultTheme:"light",enableSystem:!1,disableTransitionOnChange:!0,children:e&&a.jsx(bn,{fallback:a.jsx("div",{className:"min-h-screen flex items-center justify-center",children:a.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md",children:[a.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Something went wrong"}),a.jsx("p",{className:"mb-4",children:"The application encountered an unexpected error. Please refresh the page to try again."}),a.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-primary text-white rounded hover:bg-primary/90",children:"Refresh Page"})]})}),children:a.jsx(vi,{client:Bi,children:a.jsx(di,{children:a.jsxs(mo,{children:[a.jsx(o.Suspense,{fallback:a.jsx(Cc,{}),children:a.jsx(Ec,{})}),a.jsx(yn,{}),a.jsx(vn,{})]})})})})})}li.createRoot(document.getElementById("root")).render(a.jsx(zt.StrictMode,{children:a.jsx(Dc,{})}));export{tl as $,He as A,ut as B,ya as C,nn as D,ue as E,Kc as F,H as G,G as H,Ys as I,Ts as J,Ds as K,lt as L,dt as M,Qe as N,_e as O,Oo as P,je as Q,Or as R,xt as S,Ko as T,rr as U,ta as V,bt as W,wt as X,Ge as Y,Ro as Z,Qc as _,re as a,Zi as a0,Qi as a1,Gc as a2,Js as a3,Lt as a4,Vs as a5,_t as a6,Tt as a7,Jc as a8,fo as a9,Yc as aa,sl as ab,bn as ac,ge as ad,Ze as ae,Us as af,Hc as ag,Xs as ah,ea as ai,Er as aj,Ot as ak,Rt as al,yt as am,Zc as an,Xc as ao,el as ap,Wc as aq,va as b,Ye as c,Je as d,Ae as e,Uo as f,zo as g,Wo as h,ba as i,Fe as j,Ho as k,xa as l,Sa as m,ja as n,Ca as o,ln as p,To as q,Go as r,I as s,ko as t,ne as u,Rs as v,Te as w,Mr as x,Qs as y,vt as z};
