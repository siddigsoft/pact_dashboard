import{r as g,j as e,J as Se,U as fe,bN as Re,aR as _e,m as L,aG as Pe,C as Ue,aI as xe,Y as ve,a0 as ke,b5 as ie,X as Te,$ as Ae,ag as he,aV as $e,K as se,n as De}from"./react-core-B8kFjp2k.js";import{C as A,f as E,g as F,B as T,h as re,L as Ee,M as Me,a as R,N as Fe,O as ae,b as $,D as X,l as J,m as le,n as ce,o as oe,I as G,ak as q,al as I,p as de,u as Ie,T as Ve,i as ze,j as pe,k as je,A as Be,c as Le,d as qe,e as Ne,af as ye,Z as we,s as te}from"./index-PwDgWEVM.js";import{A as Z,b as Q}from"./alert-BXWNuJnD.js";import{C as Oe,a as He,b as Ye}from"./collapsible-DNmzDQGQ.js";import{L as D}from"./label-C4lDws8j.js";import{T as be}from"./textarea-BpQMf5eL.js";import{C as ne}from"./checkbox-9q2dlFjr.js";import{S as Ke}from"./switch-DFAHzttT.js";import{S as Ge,a as Xe,b as Je,c as Ze,d as Qe}from"./select-CXX5Q_V1.js";import{T as We,a as es,b as ge,c as Y,d as ss,e as K}from"./table-CZ8ZB6wW.js";import"./vendor-VlxgVHMv.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./date-utils-YarVESQS.js";import"./jspdf-rld7HkB6.js";import"./router-CKy9yO3R.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";const as=(r,c)=>{const s={users:"Users",roles:"Roles",permissions:"Permissions",projects:"Projects",mmp:"MMP",site_visits:"Site Visits",finances:"Finances",reports:"Reports",settings:"Settings"};return`${{create:"Create",read:"View",update:"Edit",delete:"Delete",approve:"Approve",assign:"Assign"}[c]} ${s[r]}`},ts=r=>({create:"bg-green-100 text-green-800",read:"bg-blue-100 text-blue-800",update:"bg-yellow-100 text-yellow-800",delete:"bg-red-100 text-red-800",approve:"bg-purple-100 text-purple-800",assign:"bg-indigo-100 text-indigo-800"})[r],is=r=>{const c={};return r.forEach(s=>{c[s.resource]||(c[s.resource]=[]),c[s.resource].push(s)}),c},ue=({role:r,onEdit:c,onDelete:s,onViewUsers:u,userCount:o=0})=>{const[j,v]=g.useState(!1),b=is(r.permissions);return e.jsxs(A,{className:"w-full",children:[e.jsxs(E,{className:"flex flex-row items-start justify-between space-y-0 pb-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(F,{className:"text-base font-medium",children:[r.display_name,r.is_system_role&&e.jsx(T,{variant:"secondary",className:"ml-2 text-xs",children:"System"})]}),e.jsx(re,{className:"text-sm text-gray-500",children:r.description||"No description provided"})]}),e.jsxs(Ee,{children:[e.jsx(Me,{asChild:!0,children:e.jsx(R,{variant:"ghost",className:"h-8 w-8 p-0",children:e.jsx(Se,{className:"h-4 w-4"})})}),e.jsxs(Fe,{align:"end",children:[e.jsxs(ae,{onClick:()=>u(r),children:[e.jsx(fe,{className:"mr-2 h-4 w-4"}),"View Users (",o,")"]}),e.jsxs(ae,{onClick:()=>c(r),children:[e.jsx(Re,{className:"mr-2 h-4 w-4"}),"Edit Role"]}),!r.is_system_role&&e.jsxs(ae,{onClick:()=>s(r.id),className:"text-red-600",children:[e.jsx(_e,{className:"mr-2 h-4 w-4"}),"Delete Role"]})]})]})]}),e.jsx($,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Users assigned:"}),e.jsx("span",{className:"font-medium",children:o})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Status:"}),e.jsx(T,{variant:r.is_active?"default":"secondary",children:r.is_active?"Active":"Inactive"})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsxs(Oe,{open:j,onOpenChange:v,children:[e.jsx(He,{asChild:!0,children:e.jsxs(R,{variant:"ghost",className:"w-full justify-between p-0 h-auto font-medium text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),e.jsxs("span",{children:["Permissions (",r.permissions.length,")"]})]}),j?e.jsx(Pe,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})]})}),e.jsx(Ye,{className:"space-y-3 mt-3",children:Object.keys(b).length===0?e.jsx("div",{className:"text-sm text-gray-500 italic",children:"No permissions assigned"}):e.jsx("div",{className:"space-y-3",children:Object.entries(b).map(([y,f])=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 capitalize",children:y.replace("_"," ")}),e.jsx("div",{className:"flex flex-wrap gap-1",children:f.map((p,C)=>e.jsx(T,{variant:"outline",className:`text-xs ${ts(p.action)}`,children:as(p.resource,p.action)},`${p.resource}-${p.action}-${C}`))})]},y))})})]})})]})})]})},rs=({open:r,onOpenChange:c,onCreateRole:s,isLoading:u})=>{const[o,j]=g.useState({name:"",display_name:"",description:"",permissions:[]}),[v,b]=g.useState({}),[y,f]=g.useState(null),p=(x,t,d)=>{const l=`${x}:${t}`;b(m=>({...m,[l]:!!d}))},C=async x=>{var N;x.preventDefault(),f(null);const t=o.name.trim(),d=o.display_name.trim();if(!t||!d){f("Role name and display name are required.");return}const l=Object.entries(v).filter(([,h])=>h).map(([h])=>{const[w,i]=h.split(":");return{resource:w,action:i}}),m={name:t,display_name:d,description:((N=o.description)==null?void 0:N.trim())||"",permissions:l};try{await s(m)?(c(!1),j({name:"",display_name:"",description:"",permissions:[]}),b({})):f("Failed to create role. You might lack permission or the role name already exists.")}catch(h){f((h==null?void 0:h.message)||"Unexpected error while creating role.")}};return e.jsx(X,{open:r,onOpenChange:c,children:e.jsxs(J,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(le,{children:[e.jsx(ce,{children:"Create Role"}),e.jsx(oe,{children:"Define a new role and assign permissions."})]}),e.jsxs("form",{onSubmit:C,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"name",children:"Role Name"}),e.jsx(G,{id:"name",value:o.name,onChange:x=>j(t=>({...t,name:x.target.value})),placeholder:"e.g., custom_manager",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"display_name",children:"Display Name"}),e.jsx(G,{id:"display_name",value:o.display_name,onChange:x=>j(t=>({...t,display_name:x.target.value})),placeholder:"e.g., Custom Manager",required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"description",children:"Description"}),e.jsx(be,{id:"description",value:o.description,onChange:x=>j(t=>({...t,description:x.target.value})),placeholder:"Describe the role and its responsibilities...",rows:3})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(D,{children:"Permissions"}),e.jsx("div",{className:"grid gap-4",children:q.map(x=>e.jsxs(A,{children:[e.jsx(E,{className:"py-3",children:e.jsx(F,{className:"text-base capitalize",children:x})}),e.jsx($,{className:"pt-0",children:e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:I.map(t=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ne,{id:`${x}:${t}`,checked:v[`${x}:${t}`]||!1,onCheckedChange:d=>p(x,t,d)}),e.jsx(D,{htmlFor:`${x}:${t}`,className:"text-sm capitalize cursor-pointer",children:t})]},`${x}:${t}`))})})]},x))})]}),y&&e.jsx(Z,{variant:"destructive",children:e.jsx(Q,{children:y})}),e.jsxs(de,{children:[e.jsx(R,{type:"button",variant:"outline",onClick:()=>c(!1),children:"Cancel"}),e.jsx(R,{type:"submit",disabled:u,children:u?"Creating...":"Create Role"})]})]})]})})},ns=(r,c)=>{const s={users:"Users",roles:"Roles",permissions:"Permissions",projects:"Projects",mmp:"MMP",site_visits:"Site Visits",finances:"Finances",reports:"Reports",settings:"Settings"};return`${{create:"Create",read:"View",update:"Edit",delete:"Delete",approve:"Approve",assign:"Assign",archive:"Archive"}[c]} ${s[r]}`},ls=r=>({create:"bg-green-100 text-green-800 border-green-200",read:"bg-blue-100 text-blue-800 border-blue-200",update:"bg-yellow-100 text-yellow-800 border-yellow-200",delete:"bg-red-100 text-red-800 border-red-200",approve:"bg-purple-100 text-purple-800 border-purple-200",assign:"bg-indigo-100 text-indigo-800 border-indigo-200",archive:"bg-slate-100 text-slate-800 border-slate-200"})[r],cs=({role:r,onUpdatePermissions:c,isLoading:s=!1})=>{const[u,o]=g.useState(new Set),[j,v]=g.useState(!1),[b,y]=g.useState(!1),{toast:f}=Ie();g.useEffect(()=>{const l=new Set(r.permissions.map(m=>`${m.resource}:${m.action}`));o(l),v(!1)},[r]);const p=(l,m)=>{const N=`${l}:${m}`,h=new Set(u);h.has(N)?h.delete(N):h.add(N),o(h),v(!0)},C=async()=>{y(!0);const l=Array.from(u).map(N=>{const[h,w]=N.split(":");return{resource:h,action:w}});await c(r.id,l)&&(v(!1),f({title:"Permissions updated",description:`Permissions for ${r.display_name} have been updated successfully.`})),y(!1)},x=l=>{const m=I.map(w=>`${l}:${w}`),N=m.every(w=>u.has(w)),h=new Set(u);N?m.forEach(w=>h.delete(w)):m.forEach(w=>h.add(w)),o(h),v(!0)},t=l=>I.filter(m=>u.has(`${l}:${m}`)).length,d=r.is_system_role;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Permission Management"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Manage granular permissions for ",r.display_name]})]}),j&&e.jsxs(R,{onClick:C,disabled:b,size:"sm",children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Save Changes"]})]}),d&&e.jsxs(Z,{children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx(Q,{children:"This is a system role. Modifying permissions may affect core functionality. Changes will be applied to all users with this role."})]}),e.jsx("div",{className:"space-y-4",children:q.map(l=>{const m=t(l),N=I.length,h=m===N,w=m>0&&m<N;return e.jsxs(A,{children:[e.jsx(E,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{id:`${l}-all`,checked:w?"indeterminate":h,onCheckedChange:()=>x(l)}),e.jsx(D,{htmlFor:`${l}-all`,className:"text-sm font-medium",children:l.replace("_"," ").toUpperCase()})]}),e.jsxs(T,{variant:"outline",className:"text-xs",children:[m,"/",N]})]})}),e.jsx($,{className:"pt-0",children:e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:I.map(i=>{const S=`${l}:${i}`,k=u.has(S);return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ne,{id:S,checked:k,onCheckedChange:()=>p(l,i)}),e.jsx(D,{htmlFor:S,className:"text-sm cursor-pointer flex-1",children:e.jsx(T,{variant:"outline",className:`text-xs ${k?ls(i):"bg-gray-50 text-gray-600 border-gray-200"}`,children:ns(l,i)})})]},i)})})})]},l)})}),j&&e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx(R,{variant:"outline",onClick:()=>{const l=new Set(r.permissions.map(m=>`${m.resource}:${m.action}`));o(l),v(!1)},children:"Cancel"}),e.jsxs(R,{onClick:C,disabled:b,children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Save Permissions"]})]})]})},os=({open:r,onOpenChange:c,role:s,onUpdateRole:u,isLoading:o})=>{const[j,v]=g.useState({display_name:"",description:"",is_active:!0}),[b,y]=g.useState([]),[f,p]=g.useState(!1);g.useEffect(()=>{if(s){v({display_name:s.display_name,description:s.description||"",is_active:s.is_active});const t=s.permissions.map(d=>({resource:d.resource,action:d.action}));y(t)}},[s]);const C=async t=>{if(t.preventDefault(),!!s){p(!0);try{await u(s.id,{...j,permissions:b})&&c(!1)}finally{p(!1)}}},x=async(t,d)=>(y(d),await u(t,{...j,permissions:d}));return s?e.jsx(X,{open:r,onOpenChange:c,children:e.jsxs(J,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(le,{children:[e.jsxs(ce,{children:["Edit Role: ",s.display_name]}),e.jsx(oe,{children:"Update role information and permissions."})]}),e.jsxs(Ve,{defaultValue:"general",className:"w-full",children:[e.jsxs(ze,{className:"grid w-full grid-cols-2",children:[e.jsx(pe,{value:"general",children:"General Information"}),e.jsx(pe,{value:"permissions",children:"Permissions"})]}),e.jsx(je,{value:"general",className:"space-y-6",children:e.jsxs("form",{onSubmit:C,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"display_name",children:"Display Name"}),e.jsx(G,{id:"display_name",value:j.display_name,onChange:t=>v(d=>({...d,display_name:t.target.value})),required:!0})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ke,{id:"is_active",checked:j.is_active,onCheckedChange:t=>v(d=>({...d,is_active:t}))}),e.jsx(D,{htmlFor:"is_active",children:"Active"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"description",children:"Description"}),e.jsx(be,{id:"description",value:j.description,onChange:t=>v(d=>({...d,description:t.target.value})),rows:3})]}),e.jsxs(de,{children:[e.jsx(R,{type:"button",variant:"outline",onClick:()=>c(!1),children:"Cancel"}),e.jsx(R,{type:"submit",disabled:f,children:f?"Updating...":"Update Role"})]})]})}),e.jsx(je,{value:"permissions",children:e.jsx(cs,{role:s,onUpdatePermissions:x,isLoading:o})})]})]})}):null},ds=({open:r,onOpenChange:c,role:s,users:u,assignedUsers:o,availableRoles:j,onAssignRole:v,onRemoveRole:b,isLoading:y})=>{const[f,p]=g.useState(""),[C,x]=g.useState(""),[t,d]=g.useState(!1),m=u.filter(i=>!o.some(S=>S.id===i.id)).filter(i=>i.name.toLowerCase().includes(C.toLowerCase())||i.email.toLowerCase().includes(C.toLowerCase())),N=async()=>{if(!(!f||!s||t)){d(!0);try{const i=s.is_system_role?{user_id:f,role:s.name}:{user_id:f,role_id:s.id};await v(i),p(""),x("")}finally{d(!1)}}},h=async i=>{s&&(s.is_system_role?await b(i,void 0,s.name):await b(i,s.id))},w=i=>i.split(" ").map(S=>S[0]).join("").toUpperCase().substring(0,2);return e.jsx(X,{open:r,onOpenChange:c,children:e.jsxs(J,{className:"max-w-4xl max-h-[80vh]",children:[e.jsxs(le,{children:[e.jsxs(ce,{children:["Manage Users for ",s==null?void 0:s.display_name]}),e.jsx(oe,{children:"Assign or remove users from this role."})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Assign New User"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(G,{placeholder:"Search users...",value:C,onChange:i=>x(i.target.value)})}),e.jsxs(Ge,{value:f,onValueChange:p,children:[e.jsx(Xe,{className:"w-64",children:e.jsx(Je,{placeholder:"Select user"})}),e.jsx(Ze,{children:m.map(i=>e.jsxs(Qe,{value:i.id,children:[i.name," (",i.email,")"]},i.id))})]}),e.jsx(R,{onClick:N,disabled:!f||t||y,children:t?e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"h-4 w-4 mr-2 animate-spin"}),"Assigning..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Assign"]})})]})]}),e.jsx("div",{className:"space-y-4",children:o.length===0?e.jsx("p",{className:"text-gray-500 text-center py-8",children:"No users assigned to this role"}):e.jsx("div",{className:"border rounded-lg",children:e.jsxs(We,{children:[e.jsx(es,{children:e.jsxs(ge,{children:[e.jsx(Y,{children:"User"}),e.jsx(Y,{children:"Email"}),e.jsx(Y,{children:"Additional Roles"}),e.jsx(Y,{className:"w-20",children:"Actions"})]})}),e.jsx(ss,{children:o.map(i=>e.jsxs(ge,{children:[e.jsx(K,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Be,{className:"h-8 w-8",children:[e.jsx(Le,{src:i.avatar,alt:i.name}),e.jsx(qe,{className:"text-xs",children:w(i.name)})]}),e.jsx("span",{className:"font-medium",children:i.name})]})}),e.jsx(K,{className:"text-gray-500",children:i.email}),e.jsx(K,{children:e.jsx("div",{className:"flex gap-1 flex-wrap",children:e.jsx(T,{variant:"outline",className:"text-xs",children:"+2 roles"})})}),e.jsx(K,{children:e.jsx(R,{variant:"ghost",size:"sm",onClick:()=>h(i.id),disabled:y,children:e.jsx(Te,{className:"h-4 w-4"})})})]},i.id))})]})})})]}),e.jsx(de,{children:e.jsx(R,{variant:"outline",onClick:()=>c(!1),children:"Close"})})]})})},ms=({selectedUserId:r,selectedRoleId:c})=>{const{currentUser:s,users:u}=Ne(),{roles:o,getUserRolesByUserId:j,hasPermission:v,getUserPermissions:b,refreshUserPermissions:y}=ye(),{checkPermission:f}=we(),[p,C]=g.useState(r||""),[x,t]=g.useState(c||""),[d,l]=g.useState({}),[m,N]=g.useState([]);g.useEffect(()=>{p?(async()=>{const a=await y(p);j(p),N(a);const P={};q.forEach(_=>{I.forEach(M=>{const U=`${_}:${M}`;P[U]=(a||[]).some(V=>V.resource===_&&V.action===M)})}),l(P)})():(N([]),l({}))},[p,o,j,b,v,y]);const h=(a,P)=>{const _={users:"Users",roles:"Roles",permissions:"Permissions",projects:"Projects",mmp:"MMP",site_visits:"Site Visits",finances:"Finances",reports:"Reports",settings:"Settings"};return`${{create:"Create",read:"View",update:"Edit",delete:"Delete",approve:"Approve",assign:"Assign"}[P]} ${_[a]}`},w=a=>a?"bg-green-100 text-green-800 border-green-200":"bg-red-100 text-red-800 border-red-200",i=a=>a?e.jsx(he,{className:"h-4 w-4 text-green-600"}):e.jsx($e,{className:"h-4 w-4 text-red-600"}),S=()=>{s&&C(s.id)},k=u.find(a=>a.id===p);o.find(a=>a.id===x);const W=p?j(p):[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Permission Testing"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Test user permissions and verify access control"})]}),e.jsxs(R,{onClick:S,variant:"outline",size:"sm",children:[e.jsx(Ae,{className:"h-4 w-4 mr-2"}),"Test Current User"]})]}),e.jsxs(A,{children:[e.jsxs(E,{children:[e.jsx(F,{className:"text-base",children:"Select User to Test"}),e.jsx(re,{children:"Choose a user to test their permissions"})]}),e.jsx($,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"User"}),e.jsxs("select",{value:p,onChange:a=>C(a.target.value),className:"w-full mt-1 p-2 border rounded-md",children:[e.jsx("option",{value:"",children:"Select a user..."}),u.map(a=>e.jsxs("option",{value:a.id,children:[a.name," (",a.role,")"]},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Role (for reference)"}),e.jsxs("select",{value:x,onChange:a=>t(a.target.value),className:"w-full mt-1 p-2 border rounded-md",children:[e.jsx("option",{value:"",children:"Select a role..."}),o.map(a=>e.jsxs("option",{value:a.id,children:[a.display_name," (",a.is_system_role?"System":"Custom",")"]},a.id))]})]})]})})]}),k&&e.jsxs(A,{children:[e.jsx(E,{children:e.jsx(F,{className:"text-base",children:"User Information"})}),e.jsxs($,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Name"}),e.jsx("p",{className:"text-sm text-gray-600",children:k.name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Email"}),e.jsx("p",{className:"text-sm text-gray-600",children:k.email})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Primary Role"}),e.jsx(T,{variant:"outline",children:k.role})]})]}),W.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Assigned Roles"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:W.map(a=>e.jsx(T,{variant:"secondary",children:a.role},a.id))})]})]})]}),p&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-5 w-5"}),e.jsx("h4",{className:"text-lg font-semibold",children:"Permission Test Results"})]}),q.map(a=>{const P=I.map(U=>({action:U,key:`${a}:${U}`,hasPermission:d[`${a}:${U}`]||!1})),_=P.filter(U=>U.hasPermission).length,M=P.length;return e.jsxs(A,{children:[e.jsx(E,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(F,{className:"text-base capitalize",children:a.replace("_"," ")}),e.jsxs(T,{variant:"outline",children:[_,"/",M," granted"]})]})}),e.jsx($,{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3",children:P.map(({action:U,key:V,hasPermission:O})=>e.jsxs("div",{className:"flex items-center gap-2 p-2 rounded-md border",children:[i(O),e.jsx(T,{variant:"outline",className:`text-xs ${w(O)}`,children:h(a,U)})]},V))})})]},a)})]}),s&&e.jsxs(A,{children:[e.jsxs(E,{children:[e.jsx(F,{className:"text-base",children:"Current User Permission Summary"}),e.jsx(re,{children:"Your current permissions in the system"})]}),e.jsx($,{children:e.jsx("div",{className:"space-y-2",children:q.map(a=>I.some(_=>f(a,_))?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium capitalize",children:a.replace("_"," ")}),e.jsx("div",{className:"flex gap-1",children:I.map(_=>f(a,_)?e.jsx(T,{variant:"outline",className:"text-xs bg-green-100 text-green-800",children:_},_):null)})]},a):null)})})]}),e.jsxs(Z,{children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsxs(Q,{children:[e.jsx("strong",{children:"Testing Instructions:"}),e.jsx("br",{}),"1. Select a user to test their permissions",e.jsx("br",{}),"2. Verify that the displayed permissions match their assigned roles",e.jsx("br",{}),"3. Try removing permissions from their role and test again",e.jsx("br",{}),"4. Ensure that permission removal immediately revokes access"]})]})]})},Es=()=>{const{currentUser:r,users:c,refreshUsers:s}=Ne(),{canManageRoles:u}=we(),{roles:o,isLoading:j,createRole:v,updateRole:b,deleteRole:y,assignRoleToUser:f,removeRoleFromUser:p,getUserRolesByUserId:C,fetchUserRoles:x}=ye(),[t,d]=g.useState(!1),[l,m]=g.useState(!1),[N,h]=g.useState(!1),[w,i]=g.useState(!1),[S,k]=g.useState(null);if(!u())return e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs(Z,{children:[e.jsx(L,{className:"h-4 w-4"}),e.jsx(Q,{children:"You don't have permission to access role management."})]})});const a=async n=>!!await v(n),P=n=>{k(n),m(!0)},_=async(n,z)=>{const B=await b(n,z);return B&&(m(!1),k(null)),B},M=async n=>{confirm("Are you sure you want to delete this role? This action cannot be undone.")&&await y(n)},U=n=>{k(n),h(!0)},V=n=>c.filter(z=>C(z.id).some(H=>n.is_system_role&&H.role===n.name||!n.is_system_role&&H.role_id===n.id)),O=async n=>{if(!S)return;const{error:z}=await te.from("user_roles").delete().eq("user_id",n.user_id);if(!(z||!await f(n))){if(S.is_system_role){const{error:H}=await te.from("profiles").update({role:S.name}).eq("id",n.user_id)}else{const{error:H}=await te.from("profiles").update({role:"custom"}).eq("id",n.user_id)}await x(),await s()}},Ce=async(n,z,B)=>{await p(n,z,B),await s()},me=o.filter(n=>n.is_system_role),ee=o.filter(n=>!n.is_system_role);return e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-2",children:[e.jsx(L,{className:"h-8 w-8 text-blue-600"}),"Role Management"]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1",children:"Manage roles and permissions for your organization"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsxs(R,{size:"sm",onClick:()=>d(!0),"data-testid":"button-create-role",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Create Role"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs(A,{className:"hover-elevate active-elevate-2 cursor-pointer overflow-hidden relative bg-gradient-to-br from-blue-500 to-blue-700 text-white border-0","data-testid":"card-total-roles",children:[e.jsxs(E,{className:"flex flex-row items-center justify-between gap-2 space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium text-white/90",children:"Total Roles"}),e.jsx(L,{className:"h-5 w-5 text-white/80"})]}),e.jsxs($,{children:[e.jsx("div",{className:"text-3xl font-bold text-white",children:o.length}),e.jsxs("p",{className:"text-xs text-white/80 mt-1",children:[me.length," system + ",ee.length," custom"]})]}),e.jsx(se,{className:"absolute -right-4 -bottom-4 h-24 w-24 text-white/10"})]}),e.jsxs(A,{className:"hover-elevate active-elevate-2 cursor-pointer overflow-hidden relative bg-gradient-to-br from-green-500 to-emerald-700 text-white border-0","data-testid":"card-total-users",children:[e.jsxs(E,{className:"flex flex-row items-center justify-between gap-2 space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium text-white/90",children:"Total Users"}),e.jsx(fe,{className:"h-5 w-5 text-white/80"})]}),e.jsxs($,{children:[e.jsx("div",{className:"text-3xl font-bold text-white",children:c.length}),e.jsx("p",{className:"text-xs text-white/80 mt-1",children:"Across all roles"})]}),e.jsx(se,{className:"absolute -right-4 -bottom-4 h-24 w-24 text-white/10"})]}),e.jsxs(A,{className:"hover-elevate active-elevate-2 cursor-pointer overflow-hidden relative bg-gradient-to-br from-purple-500 to-purple-700 text-white border-0","data-testid":"card-active-roles",children:[e.jsxs(E,{className:"flex flex-row items-center justify-between gap-2 space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium text-white/90",children:"Active Roles"}),e.jsx(De,{className:"h-5 w-5 text-white/80"})]}),e.jsxs($,{children:[e.jsx("div",{className:"text-3xl font-bold text-white",children:o.filter(n=>n.is_active).length}),e.jsx("p",{className:"text-xs text-white/80 mt-1",children:"Currently active"})]}),e.jsx(se,{className:"absolute -right-4 -bottom-4 h-24 w-24 text-white/10"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"System Roles"}),e.jsx("p",{className:"text-gray-500",children:"Built-in roles with predefined permissions"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:me.map(n=>e.jsx(ue,{role:n,onEdit:P,onDelete:M,onViewUsers:U,userCount:V(n).length},n.id))})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Custom Roles"}),e.jsx("p",{className:"text-gray-500",children:"Organization-specific roles with custom permissions"})]}),ee.length===0?e.jsx(A,{children:e.jsxs($,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(L,{className:"h-12 w-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Custom Roles"}),e.jsx("p",{className:"text-gray-500 text-center mb-4",children:"Create custom roles to define specific permissions for your organization."}),e.jsxs(R,{onClick:()=>d(!0),children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Create First Custom Role"]})]})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:ee.map(n=>e.jsx(ue,{role:n,onEdit:P,onDelete:M,onViewUsers:U,userCount:V(n).length},n.id))})]}),e.jsx(rs,{open:t,onOpenChange:d,onCreateRole:a,isLoading:j}),e.jsx(os,{open:l,onOpenChange:m,role:S,onUpdateRole:_,isLoading:j}),e.jsx(ds,{open:N,onOpenChange:h,role:S,users:c,assignedUsers:S?V(S):[],availableRoles:o,onAssignRole:O,onRemoveRole:Ce,isLoading:j}),e.jsx(X,{open:w,onOpenChange:i,children:e.jsx(J,{className:"w-full sm:max-w-2xl md:max-w-3xl lg:max-w-4xl max-h-[85vh] overflow-y-auto p-0",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Permission Testing"}),e.jsx(R,{variant:"outline",onClick:()=>i(!1),children:"Close"})]}),e.jsx(ms,{})]})})})]})};export{Es as default};
