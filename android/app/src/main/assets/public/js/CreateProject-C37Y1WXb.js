import{r as s,j as e,N as O}from"./react-core-B8kFjp2k.js";import{F as Y,_ as $,a as v,D as E,l as V,m as q,n as z,o as H,I as l,p as Q}from"./index-PwDgWEVM.js";import{P as R}from"./ProjectForm-DvLk3ngM.js";import{L as i}from"./label-C4lDws8j.js";import{S as J,a as K,b as U,c as W,d as x}from"./select-CXX5Q_V1.js";import{T as X}from"./textarea-BpQMf5eL.js";import{bo as Z}from"./vendor-VlxgVHMv.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./router-CKy9yO3R.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./date-utils-YarVESQS.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";import"./form-BT_tmI7p.js";import"./popover-BSK_FA51.js";import"./calendar-DEyRSxJX.js";import"./ActivityManager-lZ-YmBoR.js";import"./collapsible-DNmzDQGQ.js";import"./ActivityForm-DxwKkf_I.js";import"./toggle-DVFO8bcr.js";import"./TeamCompositionManager-DL5fiHxh.js";import"./table-CZ8ZB6wW.js";import"./sudanStates-CkkbYUnU.js";const Pe=()=>{const d=Z(),{addProject:S}=Y(),{createProjectBudget:y}=$(),[N,c]=s.useState(!1),[a,C]=s.useState(null),[m,f]=s.useState(!1),[r,F]=s.useState(""),[o,D]=s.useState("annual"),[u,w]=s.useState(new Date().getFullYear().toString()),[b,B]=s.useState(""),[p,P]=s.useState(""),[g,T]=s.useState(""),[h,I]=s.useState(""),_=async t=>{const n=await S(t);n&&(C(n),c(!0))},L=()=>{c(!1),a&&d(`/projects/${a.id}`)},M=t=>{!t&&m||(!t&&a&&d(`/projects/${a.id}`),c(t))},G=async()=>{if(!(!a||!r||parseFloat(r)<=0)){f(!0);try{const t=Math.round(parseFloat(r)*100),n={transportation_and_visit_fees:p?Math.round(parseFloat(p)*100):0,permit_fee:g?Math.round(parseFloat(g)*100):0,internet_and_communication_fees:h?Math.round(parseFloat(h)*100):0},k=o==="annual"?`${u}-01-01`:o==="monthly"?new Date().toISOString().split("T")[0]:void 0,A=o==="annual"?`${u}-12-31`:o==="monthly"?new Date(new Date().setMonth(new Date().getMonth()+1)).toISOString().split("T")[0]:void 0;await y({projectId:a.id,totalBudgetCents:t,budgetPeriod:o,periodStartDate:k,periodEndDate:A,categoryAllocations:n,fiscalYear:parseInt(u),budgetNotes:b}),c(!1),d(`/projects/${a.id}`)}finally{f(!1)}}},j=[p,g,h].reduce((t,n)=>t+(parseFloat(n)||0),0);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx(v,{variant:"ghost",size:"icon",onClick:()=>d("/projects"),className:"hover:bg-muted",children:e.jsx(O,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Create New Project"}),e.jsx("p",{className:"text-muted-foreground",children:"Set up a new project in the planning system"})]})]}),e.jsx(R,{onSubmit:_})]}),e.jsx(E,{open:N,onOpenChange:M,children:e.jsxs(V,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(q,{children:[e.jsxs(z,{children:["Create Budget for ",a==null?void 0:a.name]}),e.jsx(H,{children:"Optionally set up a budget for this project now, or you can add it later from the Budget page."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(i,{htmlFor:"total-budget",children:"Total Budget (SDG)"}),e.jsx(l,{id:"total-budget",type:"number",min:"0",step:"0.01",value:r,onChange:t=>F(t.target.value),placeholder:"500000.00","data-testid":"input-project-total-budget"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(i,{htmlFor:"budget-period",children:"Budget Period"}),e.jsxs(J,{value:o,onValueChange:t=>D(t),children:[e.jsx(K,{id:"budget-period",children:e.jsx(U,{})}),e.jsxs(W,{children:[e.jsx(x,{value:"monthly",children:"Monthly"}),e.jsx(x,{value:"quarterly",children:"Quarterly"}),e.jsx(x,{value:"annual",children:"Annual"}),e.jsx(x,{value:"project_lifetime",children:"Project Lifetime"})]})]})]})]}),(o==="annual"||o==="quarterly")&&e.jsxs("div",{className:"grid gap-2",children:[e.jsx(i,{htmlFor:"fiscal-year",children:"Fiscal Year"}),e.jsx(l,{id:"fiscal-year",type:"number",min:"2020",max:"2050",value:u,onChange:t=>w(t.target.value)})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-medium mb-3",children:"Category Allocations (Optional)"}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(i,{htmlFor:"cat-transport",children:"Transportation and Visit Fees (SDG)"}),e.jsx(l,{id:"cat-transport",type:"number",min:"0",step:"0.01",value:p,onChange:t=>P(t.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(i,{htmlFor:"cat-permit",children:"Permit Fee (SDG)"}),e.jsx(l,{id:"cat-permit",type:"number",min:"0",step:"0.01",value:g,onChange:t=>T(t.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(i,{htmlFor:"cat-internet",children:"Internet & Communication Fees (SDG)"}),e.jsx(l,{id:"cat-internet",type:"number",min:"0",step:"0.01",value:h,onChange:t=>I(t.target.value),placeholder:"0.00"})]})]}),j>0&&e.jsxs("div",{className:"mt-3 p-3 bg-muted rounded-md",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"Total Allocated:"}),e.jsxs("span",{className:"text-sm font-bold",children:["SDG ",j.toLocaleString("en-SD",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),r&&j>parseFloat(r)&&e.jsxs("p",{className:"text-sm text-destructive mt-1",children:["Category total exceeds budget by SDG ",(j-parseFloat(r)).toFixed(2)]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(i,{htmlFor:"budget-notes",children:"Budget Notes"}),e.jsx(X,{id:"budget-notes",value:b,onChange:t=>B(t.target.value),placeholder:"Additional notes about this budget...",rows:3})]})]}),e.jsxs(Q,{className:"gap-2",children:[e.jsx(v,{variant:"outline",onClick:L,disabled:m,children:"Skip for Now"}),e.jsx(v,{onClick:G,disabled:!r||parseFloat(r)<=0||m,"data-testid":"button-create-project-budget",children:m?"Creating...":"Create Budget"})]})]})})]})};export{Pe as default};
