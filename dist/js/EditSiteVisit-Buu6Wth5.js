import{R as D,j as e,r as f}from"./react-core-B8kFjp2k.js";import{I as d,a as g,u as S,C as F,f as b,g as B,b as k,s as A,ad as P}from"./index-PwDgWEVM.js";import{T as N}from"./textarea-BpQMf5eL.js";import{C as y}from"./checkbox-9q2dlFjr.js";import{L as r}from"./label-C4lDws8j.js";import{bI as _,bo as w}from"./vendor-VlxgVHMv.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./router-CKy9yO3R.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./date-utils-YarVESQS.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";const E=({siteEntry:n,onSave:m,onCancel:o})=>{var p,l,i;const[a,x]=D.useState({...n,permitDetails:n.permitDetails||{federal:!1,state:!1,local:!1}}),t=s=>{const{name:v,value:c}=s.target;x(j=>({...j,[v]:c}))},h=(s,v)=>{x(c=>{var j,C;return{...c,permitDetails:{...c.permitDetails,[s]:v,lastVerified:v?new Date().toISOString():(j=c.permitDetails)==null?void 0:j.lastVerified,verifiedBy:v?"current-user":(C=c.permitDetails)==null?void 0:C.verifiedBy}}})},u=s=>{s.preventDefault(),m(n.id,a)};return e.jsxs("form",{onSubmit:u,className:"space-y-4 p-4 border rounded-md bg-background",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"siteCode",children:"Site Code"}),e.jsx(d,{id:"siteCode",name:"siteCode",value:a.siteCode,onChange:t})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"siteName",children:"Site Name"}),e.jsx(d,{id:"siteName",name:"siteName",value:a.siteName,onChange:t})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"mainActivity",children:"Main Activity"}),e.jsx(d,{id:"mainActivity",name:"mainActivity",value:a.mainActivity,onChange:t})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"visitDate",children:"Visit Date"}),e.jsx(d,{id:"visitDate",name:"visitDate",type:"date",value:a.visitDate,onChange:t})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"visitedBy",children:"Visited By"}),e.jsx(d,{id:"visitedBy",name:"visitedBy",value:a.visitedBy,onChange:t})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"status",children:"Status"}),e.jsx(d,{id:"status",name:"status",value:a.status,onChange:t})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{children:"Permit Status"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mt-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(y,{id:"federalPermit",checked:(p=a.permitDetails)==null?void 0:p.federal,onCheckedChange:s=>h("federal",s)}),e.jsx(r,{htmlFor:"federalPermit",children:"Federal"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(y,{id:"statePermit",checked:(l=a.permitDetails)==null?void 0:l.state,onCheckedChange:s=>h("state",s)}),e.jsx(r,{htmlFor:"statePermit",children:"State"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(y,{id:"localPermit",checked:(i=a.permitDetails)==null?void 0:i.local,onCheckedChange:s=>h("local",s)}),e.jsx(r,{htmlFor:"localPermit",children:"Local"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"description",children:"Description"}),e.jsx(N,{id:"description",name:"description",value:a.description||"",onChange:t})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"notes",children:"Notes"}),e.jsx(N,{id:"notes",name:"notes",value:a.notes||"",onChange:t})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-4",children:[e.jsx(g,{type:"button",variant:"outline",onClick:o,children:"Cancel"}),e.jsx(g,{type:"submit",children:"Save Changes"})]})]})},Z=()=>{const{id:n}=_(),m=w(),{toast:o}=S(),[a,x]=f.useState(!0),[t,h]=f.useState(null);f.useEffect(()=>{(async()=>{if(n){x(!0);try{const{data:i,error:s}=await A.from("mmp_site_entries").select("*").eq("id",n).single();if(s)throw s;h(i)}catch{o({title:"Error",description:"Failed to load site visit.",variant:"destructive"})}finally{x(!1)}}})()},[n,o]);const u=f.useMemo(()=>{if(!t)return null;const l=t.visit_data||{},i=t.location||{};return{id:t.id,siteCode:t.site_code||"",siteName:t.site_name||"",inMoDa:!1,visitedBy:"",mainActivity:t.main_activity||l.mainActivity||"",visitDate:l.visitDate||(t.due_date?new Date(t.due_date).toISOString().slice(0,10):""),status:t.status||"assigned",locality:t.locality||"",state:t.state||"",address:i.address||"",coordinates:{latitude:i.latitude,longitude:i.longitude},description:t.notes||"",notes:t.notes||"",permitDetails:l.permitDetails||{federal:!1,state:!1,local:!1}}},[t]),p=async(l,i)=>{if(n)try{await P(n,{siteName:i.siteName,siteCode:i.siteCode,mainActivity:i.mainActivity,state:i.state,locality:i.locality,notes:i.notes??i.description,status:i.status,...i.visitDate?{visitDate:i.visitDate}:{},...i.permitDetails?{permitDetails:i.permitDetails}:{}}),o({title:"Saved",description:"Site visit updated."}),m(-1)}catch{o({title:"Error",description:"Failed to save changes.",variant:"destructive"})}};return a?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"Loadingâ€¦"})}):u?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs(F,{className:"max-w-4xl mx-auto",children:[e.jsx(b,{children:e.jsx(B,{children:"Edit Site Visit"})}),e.jsxs(k,{children:[e.jsx(E,{siteEntry:u,onSave:p,onCancel:()=>m(-1)}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx(g,{variant:"outline",onClick:()=>m(-1),children:"Back"})})]})]})}):e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"Site visit not found."})})};export{Z as default};
