import{r as c,j as e,a2 as Pe,l as O,bB as Me,a3 as U,q as Y,aX as De,p as Q,ag as me,ao as Ve,Y as Te,X as J,bC as Le,at as ze,N as Ue,b5 as Be,v as Ie}from"./react-core-B8kFjp2k.js";import{u as Re,L as ne}from"./router-CKy9yO3R.js";import{B as D,S as xe,C as y,f as G,g as W,b,a as v,H as ue,E as $e,J as he,u as pe,K,r as ge,A as le,c as oe,d as de,e as Ee,Z as He,U as Fe,h as ce,a4 as Ge,I as We}from"./index-PwDgWEVM.js";import{S as Oe,a as Ye,b as Ze,c as _e,d as H}from"./select-CXX5Q_V1.js";import{o as B,G as qe}from"./date-utils-YarVESQS.js";import{i as fe,g as Xe,a as Je,b as Ke}from"./siteVisitUtils-D0TAkk25.js";import{C as Qe}from"./calendar-DEyRSxJX.js";import{P as es,a as ss,b as ts}from"./popover-BSK_FA51.js";import{aD as je,aE as Ne}from"./radix-ui-C2DV4xtt.js";import{t as rs}from"./toggle-DVFO8bcr.js";import{D as as}from"./DynamicFieldTeamMap-CKDMcIOA.js";import{H as is,a as ns,b as ls}from"./hover-card-BltHYp3k.js";import{L as os}from"./LeafletMapContainer-DFENE1lH.js";import{bo as ds}from"./vendor-VlxgVHMv.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./forms-CESK2FDA.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";import"./maps-BzFQ_kYT.js";import"./locationUtils-B4o8Dh43.js";import"./sudanStates-CkkbYUnU.js";const cs=({mmps:r,onSelectMMP:m})=>(c.useEffect(()=>{},[r]),e.jsxs("div",{className:"space-y-4 bg-gradient-to-br from-background/50 to-muted/30 p-6 rounded-lg border border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h3",{className:"text-xl font-semibold bg-gradient-to-r from-primary/90 to-primary/70 bg-clip-text text-transparent",children:"Approved MMPs"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Select an MMP to create site visits"})]}),e.jsxs(D,{variant:"secondary",className:"font-medium px-3 py-1",children:[r.length," Available MMPs"]})]}),e.jsx(xe,{className:"h-[400px] pr-4 -mr-4",children:e.jsxs("div",{className:"grid gap-4 grid-cols-1 lg:grid-cols-2 xl:grid-cols-3",children:[r.map(a=>e.jsxs(y,{className:"hover:shadow-lg transition-all duration-300 bg-gradient-to-br from-card to-muted/50 border-border/50 group",children:[e.jsx(G,{className:"pb-2",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx(W,{className:"text-sm font-medium",children:a.projectName||a.name||"Unnamed Project"}),e.jsxs(D,{className:"bg-green-100 text-green-800 group-hover:bg-green-200 transition-colors",children:[e.jsx(Pe,{className:"h-3 w-3 mr-1"}),"Approved"]})]})}),e.jsx(b,{children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex items-center text-muted-foreground",children:[e.jsx(O,{className:"h-3 w-3 mr-1 text-primary/70"}),e.jsx("span",{children:a.month&&a.year?B(new Date(a.year,a.month-1),"MMMM yyyy"):"N/A"})]}),e.jsxs("div",{className:"flex items-center text-muted-foreground justify-end",children:[e.jsx(Me,{className:"h-3 w-3 mr-1 text-primary/70"}),e.jsxs("span",{children:[a.entries||0," Sites"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex items-center text-muted-foreground",children:[e.jsx(U,{className:"h-3 w-3 mr-1 text-primary/70"}),e.jsx("span",{children:a.region||"N/A"})]}),e.jsxs("div",{className:"flex items-center text-muted-foreground justify-end",children:[e.jsx(Y,{className:"h-3 w-3 mr-1 text-primary/70"}),e.jsx("span",{children:a.approvedAt?B(new Date(a.approvedAt),"dd MMM"):"N/A"})]})]}),e.jsxs("div",{className:"flex items-center text-muted-foreground",children:[e.jsx(De,{className:"h-3 w-3 mr-1 text-primary/70"}),e.jsx("span",{className:"truncate",children:a.uploadedBy||"Unknown User"})]}),e.jsx(v,{onClick:()=>m(a),className:"w-full mt-2 bg-gradient-to-r from-primary/90 to-primary/70 hover:from-primary hover:to-primary/80 text-primary-foreground shadow-sm hover:shadow-md transition-all duration-300",children:"Create Site Visits"})]})})]},a.id)),r.length===0&&e.jsxs("div",{className:"col-span-full text-center py-12 bg-muted/40 rounded-lg border border-border/50",children:[e.jsx(Q,{className:"h-12 w-12 mx-auto text-amber-500 mb-3"}),e.jsx("p",{className:"text-lg font-medium mb-1",children:"No approved MMPs found"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your uploaded MMPs need to be approved before they appear here"}),e.jsx(v,{variant:"outline",className:"mt-4",onClick:()=>window.location.href="/mmp",children:"Go to MMP Management"})]})]})})]})),ms=({visits:r,onStatusClick:m})=>{const a={pending:r.filter(o=>o.status==="pending").length,inProgress:r.filter(o=>o.status==="inProgress").length,completed:r.filter(o=>o.status==="completed").length,scheduled:r.filter(o=>["assigned","permitVerified"].includes(o.status)).length,overdue:r.filter(o=>fe(o.dueDate,o.status)).length},x=o=>{m&&m(o)};return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6",children:[e.jsx(y,{className:"group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 hover:bg-amber-50/50 cursor-pointer",onClick:()=>x("pending"),children:e.jsxs(b,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground group-hover:text-amber-700",children:"Pending"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 text-xs font-medium",children:a.pending})]}),e.jsx("p",{className:"text-2xl font-bold text-amber-600",children:a.pending}),e.jsx("p",{className:"text-xs text-muted-foreground group-hover:text-amber-600",children:"Visits awaiting review and assignment"})]}),e.jsx("div",{className:"h-12 w-12 rounded-full bg-amber-100 flex items-center justify-center group-hover:bg-amber-200 transition-colors",children:e.jsx(Y,{className:"h-6 w-6 text-amber-600"})})]}),e.jsx("div",{className:"mt-3 text-xs text-amber-600 opacity-0 group-hover:opacity-100 transition-opacity",children:"Click to view pending visits →"})]})}),e.jsx(y,{className:"group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 hover:bg-blue-50/50 cursor-pointer",onClick:()=>x("inProgress"),children:e.jsxs(b,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground group-hover:text-blue-700",children:"In Progress"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 text-xs font-medium",children:a.inProgress})]}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:a.inProgress}),e.jsx("p",{className:"text-xs text-muted-foreground group-hover:text-blue-600",children:"Active field team assessments"})]}),e.jsx("div",{className:"h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center group-hover:bg-blue-200 transition-colors",children:e.jsx(Q,{className:"h-6 w-6 text-blue-600"})})]}),e.jsx("div",{className:"mt-3 text-xs text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity",children:"Click to view in progress visits →"})]})}),e.jsx(y,{className:"group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 hover:bg-green-50/50 cursor-pointer",onClick:()=>x("completed"),children:e.jsxs(b,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground group-hover:text-green-700",children:"Completed"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-xs font-medium",children:a.completed})]}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:a.completed}),e.jsx("p",{className:"text-xs text-muted-foreground group-hover:text-green-600",children:"Successfully finalized visits"})]}),e.jsx("div",{className:"h-12 w-12 rounded-full bg-green-100 flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(me,{className:"h-6 w-6 text-green-600"})})]}),e.jsx("div",{className:"mt-3 text-xs text-green-600 opacity-0 group-hover:opacity-100 transition-opacity",children:"Click to view completed visits →"})]})}),e.jsx(y,{className:"group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 hover:bg-purple-50/50 cursor-pointer",onClick:()=>x("scheduled"),children:e.jsxs(b,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground group-hover:text-purple-700",children:"Scheduled"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 text-xs font-medium",children:a.scheduled})]}),e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:a.scheduled}),e.jsx("p",{className:"text-xs text-muted-foreground group-hover:text-purple-600",children:"Assigned and permit verified"})]}),e.jsx("div",{className:"h-12 w-12 rounded-full bg-purple-100 flex items-center justify-center group-hover:bg-purple-200 transition-colors",children:e.jsx(Ve,{className:"h-6 w-6 text-purple-600"})})]}),e.jsx("div",{className:"mt-3 text-xs text-purple-600 opacity-0 group-hover:opacity-100 transition-opacity",children:"Click to view scheduled visits →"})]})}),e.jsx(y,{className:"group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 hover:bg-red-50/50 cursor-pointer",onClick:()=>x("overdue"),children:e.jsxs(b,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground group-hover:text-red-700",children:"Overdue"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-red-100 text-red-700 text-xs font-medium",children:a.overdue})]}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:a.overdue}),e.jsx("p",{className:"text-xs text-muted-foreground group-hover:text-red-600",children:"Past due date visits"})]}),e.jsx("div",{className:"h-12 w-12 rounded-full bg-red-100 flex items-center justify-center group-hover:bg-red-200 transition-colors",children:e.jsx(Te,{className:"h-6 w-6 text-red-600"})})]}),e.jsx("div",{className:"mt-3 text-xs text-red-600 opacity-0 group-hover:opacity-100 transition-opacity",children:"Click to view overdue visits →"})]})})]})},xs=({activeFilters:r,onRemoveFilter:m,onDateSelect:a})=>{const x=o=>{switch(o){case"pending":return"Pending Visits";case"inProgress":return"In Progress";case"completed":return"Completed";case"assigned":return"Assigned";case"permitVerified":return"Permit Verified";case"canceled":return"Canceled";default:return"All Statuses"}};return e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[r.status!=="all"&&e.jsxs(D,{variant:"secondary",className:"px-3 py-1 flex items-center gap-1",children:[x(r.status),e.jsx(J,{className:"h-3 w-3 cursor-pointer",onClick:()=>m("status")})]}),r.priority&&e.jsxs(D,{variant:"secondary",className:"px-3 py-1 flex items-center gap-1",children:[`Priority: ${r.priority}`,e.jsx(J,{className:"h-3 w-3 cursor-pointer",onClick:()=>m("priority")})]}),e.jsxs(es,{children:[e.jsx(ss,{asChild:!0,children:e.jsxs(v,{variant:"outline",className:"h-8 px-2 lg:px-3",children:[e.jsx(O,{className:"mr-2 h-4 w-4"}),r.date?B(r.date,"PPP"):"Pick date"]})}),e.jsx(ts,{className:"w-auto p-0",align:"start",children:e.jsx(Qe,{mode:"single",selected:r.date,onSelect:a,initialFocus:!0})})]}),r.date&&e.jsxs(D,{variant:"secondary",className:"px-3 py-1 flex items-center gap-1",children:[B(r.date,"PPP"),e.jsx(J,{className:"h-3 w-3 cursor-pointer",onClick:()=>m("date")})]})]})},ve=c.createContext({size:"default",variant:"default"}),ye=c.forwardRef(({className:r,variant:m,size:a,children:x,...o},u)=>e.jsx(je,{ref:u,className:ue("flex items-center justify-center gap-1",r),...o,children:e.jsx(ve.Provider,{value:{variant:m,size:a},children:x})}));ye.displayName=je.displayName;const F=c.forwardRef(({className:r,children:m,variant:a,size:x,...o},u)=>{const S=c.useContext(ve);return e.jsx(Ne,{ref:u,className:ue(rs({variant:S.variant||a,size:S.size||x}),r),...o,children:m})});F.displayName=Ne.displayName;const us=({view:r,onViewChange:m})=>e.jsxs(ye,{type:"single",value:r,onValueChange:a=>m(a),children:[e.jsx(F,{value:"grid","aria-label":"Grid view",children:e.jsx(Le,{className:"h-4 w-4"})}),e.jsx(F,{value:"map","aria-label":"Map view",children:e.jsx(U,{className:"h-4 w-4"})}),e.jsx(F,{value:"calendar","aria-label":"Calendar view",children:e.jsx(O,{className:"h-4 w-4"})})]}),hs=({siteVisit:r,onAssignSuccess:m})=>{const{users:a}=$e(),{assignSiteVisit:x,getNearbyDataCollectors:o}=he(),[u,S]=c.useState(null),[j,V]=c.useState(!1),{toast:A}=pe(),T=c.useMemo(()=>a.filter(l=>l.role==="dataCollector"||l.role==="datacollector").sort((l,h)=>{var N,R,$,L;const p=((N=l.location)==null?void 0:N.latitude)&&((R=l.location)==null?void 0:R.longitude),w=(($=h.location)==null?void 0:$.latitude)&&((L=h.location)==null?void 0:L.longitude);if(!p&&!w)return 0;if(!p)return 1;if(!w)return-1;const C=K(l.location.latitude,l.location.longitude,r.coordinates.latitude,r.coordinates.longitude),g=K(h.location.latitude,h.location.longitude,r.coordinates.latitude,r.coordinates.longitude);return C-g}),[a,r.coordinates]),k=c.useCallback(n=>{var C,g,N;const l=((C=n.performance)==null?void 0:C.currentWorkload)||0;if(!((g=n.location)!=null&&g.latitude)||!((N=n.location)!=null&&N.longitude))return{distance:0,eta:"Unknown",workload:l};const h=K(n.location.latitude,n.location.longitude,r.coordinates.latitude,r.coordinates.longitude),p=h/30,w=p<1?`${Math.round(p*60)} mins`:`${Math.round(p*10)/10} hours`;return{distance:h,eta:w,workload:l}},[r]),I=async n=>{V(!0),S(n);try{await x(r.id,n)?(A({title:"Assignment successful",description:"Site visit has been assigned",variant:"success"}),m&&m()):A({title:"Assignment failed",description:"Failed to assign site visit",variant:"destructive"})}catch{A({title:"Error",description:"An error occurred during assignment",variant:"destructive"})}finally{V(!1)}},M={siteVisits:[r],height:"500px",showControls:!0,eligibleCollectors:T,selectedUserId:u,onAssign:I};return e.jsxs(y,{className:"mb-6 border-primary/10",children:[e.jsx(G,{className:"pb-3",children:e.jsxs(W,{className:"text-lg flex items-center",children:[e.jsx(U,{className:"h-5 w-5 mr-2 text-primary"}),"Assignment Map"]})}),e.jsx(b,{className:"p-0",children:e.jsx(as,{...M})}),e.jsx(ge,{className:"p-3 bg-muted/10",children:e.jsxs("div",{className:"w-full",children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"All Data Collectors"}),e.jsx(xe,{className:"h-[200px] w-full pr-4",children:e.jsx("div",{className:"space-y-2",children:T.length>0?T.map(n=>{var w,C,g;const{distance:l,eta:h,workload:p}=k(n);return e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-md ${n.id===u?"bg-primary/10 border border-primary/30":"bg-background hover:bg-accent/30 border border-border"} transition-colors`,children:[e.jsxs(is,{children:[e.jsx(ns,{asChild:!0,children:e.jsxs("div",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsxs(le,{className:"h-8 w-8 border border-border",children:[e.jsx(oe,{src:n.avatar,alt:n.name}),e.jsx(de,{children:e.jsx(ze,{className:"h-5 w-5 text-muted-foreground"})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm",children:n.name}),e.jsx("span",{className:`h-2 w-2 rounded-full ${n.availability==="online"?"bg-green-500":"bg-amber-500"}`})]}),e.jsxs("div",{className:"text-xs text-muted-foreground flex items-center gap-2",children:[l>0?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[l.toFixed(1),"km"]}),e.jsx("span",{className:"text-muted-foreground/60",children:"•"})]}):null,e.jsxs("span",{className:"flex items-center",children:[e.jsx(Y,{className:"h-3 w-3 mr-1"}),h]})]})]})]})}),e.jsx(ls,{className:"w-64",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(le,{children:[e.jsx(oe,{src:n.avatar}),e.jsx(de,{children:n.name.substring(0,2).toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold",children:n.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:n.role})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Rating:"})," ",e.jsxs("span",{className:"font-medium",children:[((w=n.performance)==null?void 0:w.rating)||"N/A","/5"]})]}),e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Completed:"})," ",e.jsx("span",{className:"font-medium",children:((C=n.performance)==null?void 0:C.totalCompletedTasks)||0})]}),e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"On-time:"})," ",e.jsxs("span",{className:"font-medium",children:[((g=n.performance)==null?void 0:g.onTimeCompletion)||0,"%"]})]}),e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Workload:"})," ",e.jsxs("span",{className:"font-medium",children:[p,"/30"]})]})]})]})})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsxs(D,{variant:"outline",className:"mr-3",children:[p,"/30"]}),e.jsx(v,{size:"sm",disabled:j,onClick:()=>I(n.id),variant:n.availability==="online"?"default":"secondary",children:j&&n.id===u?e.jsx("span",{className:"flex items-center",children:"Assigning..."}):e.jsxs("span",{className:"flex items-center",children:[n.id===u?e.jsx(me,{className:"h-3 w-3 mr-1"}):null,n.id===u?"Assigned":"Assign"]})})]})]},n.id)}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(Q,{className:"h-8 w-8 text-muted-foreground mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"No data collectors found"})]})})})]})})]})},Gs=()=>{const{currentUser:r,hasRole:m}=Ee(),{canViewAllSiteVisits:a,checkPermission:x,hasAnyRole:o}=He(),{siteVisits:u}=he(),{mmpFiles:S}=Fe(),[j,V]=Re(),A=ds(),{toast:T}=pe(),[k,I]=c.useState([]),[M,n]=c.useState(""),[l,h]=c.useState(j.get("status")||"all"),[p,w]=c.useState("dueDate"),[C,g]=c.useState({status:l,date:void 0,priority:void 0}),[N,R]=c.useState("grid"),[$,L]=c.useState(!0),[f,z]=c.useState(null),E=(j.get("country")||"").toUpperCase(),Z=j.get("region")||"",_=j.get("hub")||"",q=j.get("month")||"",X={SD:{center:[15.5007,32.5599],zoom:5},SS:{center:[6.8769,31.3069],zoom:5},UG:{center:[1.3733,32.2903],zoom:6},RW:{center:[-1.9403,29.8739],zoom:7},QA:{center:[25.3548,51.1839],zoom:7},US:{center:[39.8283,-98.5795],zoom:4}};let ee=[20,0],se=3;if(E&&X[E]&&(ee=X[E].center,se=X[E].zoom),!(x("site_visits","read")||o(["admin"])))return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs(y,{className:"w-full max-w-md",children:[e.jsxs(G,{children:[e.jsx(W,{className:"text-destructive",children:"Access Denied"}),e.jsx(ce,{children:"You don't have permission to access this page."})]}),e.jsx(b,{children:e.jsx(v,{variant:"outline",onClick:()=>A("/dashboard"),className:"w-full",children:"Return to Dashboard"})})]})});const be=(S==null?void 0:S.filter(t=>t.status==="approved"))||[];c.useEffect(()=>{L(!0);const t=setTimeout(()=>L(!1),1e3);return()=>clearTimeout(t)},[]),c.useEffect(()=>{const t=j.get("status")||"all";t!==l&&(h(t),g(s=>({...s,status:t})))},[j]),c.useEffect(()=>{let s=a()?u:u.filter(i=>i.assignedTo===(r==null?void 0:r.id));if(l!=="all"&&(l==="overdue"?s=s.filter(i=>fe(i.dueDate,i.status)):s=s.filter(i=>i.status===l)),_&&(s=s.filter(i=>(i.hub||"").toLowerCase()===_.toLowerCase())),Z&&(s=s.filter(i=>{var P;return(((P=i.location)==null?void 0:P.region)||i.region||i.state||"").toString().toLowerCase()===Z.toLowerCase()})),q&&(s=s.filter(i=>(i.dueDate||"").startsWith(q))),M){const i=M.toLowerCase();s=s.filter(d=>d.siteName.toLowerCase().includes(i)||d.siteCode&&d.siteCode.toLowerCase().includes(i)||d.locality&&d.locality.toLowerCase().includes(i)||d.state&&d.state.toLowerCase().includes(i))}if(s.sort((i,d)=>{switch(p){case"dueDate":return new Date(i.dueDate).getTime()-new Date(d.dueDate).getTime();case"priority":const P={high:0,medium:1,low:2};return P[i.priority]-P[d.priority];case"siteName":return i.siteName.localeCompare(d.siteName);case"createdAt":return new Date(d.createdAt||"").getTime()-new Date(i.createdAt||"").getTime();default:return 0}}),I(s),N==="map"&&s.length>0){const i=s.find(d=>d.status==="pending");z(i||null)}},[r,u,l,M,p,N,_,Z,q]);const we=t=>{g(s=>({...s,[t]:t==="status"?"all":void 0})),t==="status"&&(h("all"),V({}))},Ce=t=>{g(s=>({...s,date:t}))},te=t=>{t==="scheduled"?(h("assigned"),g(s=>({...s,status:"assigned"})),V({status:"assigned"})):(h(t),g(s=>({...s,status:t})),V({status:t})),setTimeout(()=>{const s=document.querySelector("[data-results-section]");s&&s.scrollIntoView({behavior:"smooth",block:"start"})},100)},Se=t=>{z(t)},Ae=()=>{T({title:"Site visit assigned",description:"Assignment successful. Refreshing visits...",variant:"success"}),setTimeout(()=>{z(null),A("/site-visits")},2e3)};if($)return e.jsx("div",{className:"space-y-8",children:e.jsx("div",{className:"space-y-4",children:Array.from({length:4}).map((t,s)=>e.jsx(Ge,{className:"h-[125px] w-full"},s))})});const ke=()=>{if(N==="map"){const t=k.map(s=>{var P,re,ae,ie;const i=((P=s==null?void 0:s.coordinates)==null?void 0:P.latitude)??((re=s==null?void 0:s.location)==null?void 0:re.latitude),d=((ae=s==null?void 0:s.coordinates)==null?void 0:ae.longitude)??((ie=s==null?void 0:s.location)==null?void 0:ie.longitude);return!i||!d||isNaN(i)||isNaN(d)?null:{id:s.id,name:s.siteName,latitude:i,longitude:d,type:"site",status:s.status}}).filter(Boolean);return e.jsxs("div",{className:"space-y-6",children:[t.length>0&&e.jsx("div",{className:"h-[500px] w-full rounded-lg overflow-hidden",children:e.jsx(os,{locations:t,height:"500px",defaultCenter:ee,defaultZoom:se,onLocationClick:s=>{const i=k.find(d=>d.id===s);i&&z(i)}})}),f?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between bg-muted/30 p-4 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium",children:f.siteName}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[f.locality,", ",f.state]}),f.hub&&e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:["Hub: ",e.jsx("span",{className:"font-medium",children:f.hub})]}),(f.visitTypeRaw||f.visitType)&&e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:["Visit Type: ",e.jsx("span",{className:"font-medium",children:f.visitTypeRaw||f.visitType})]})]}),e.jsx(v,{variant:"outline",size:"sm",onClick:()=>z(null),children:"Change Site"})]}),e.jsx(hs,{siteVisit:f,onAssignSuccess:Ae})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Select a site visit to assign"}),e.jsxs("div",{className:"grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3",children:[k.filter(s=>s.status==="pending").slice(0,6).map(s=>e.jsx(y,{className:"cursor-pointer hover:border-primary transition-colors",onClick:()=>Se(s),children:e.jsxs(b,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h4",{className:"font-medium",children:s.siteName}),e.jsxs(D,{variant:"outline",children:[s.priority," priority"]})]}),e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground mt-2",children:[e.jsx(U,{className:"h-4 w-4 mr-1"}),s.locality,", ",s.state]})]})},s.id)),k.filter(s=>s.status==="pending").length===0&&e.jsx("div",{className:"col-span-full flex items-center justify-center p-8 bg-muted/20 rounded-lg",children:e.jsx("p",{className:"text-muted-foreground",children:"No pending site visits to assign"})})]})]})]})}return e.jsxs("div",{className:"grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3",children:[k.map(t=>{var s;return e.jsxs(y,{className:"overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-2 bg-gradient-to-b from-card to-background border-none group hover:border-primary/30 hover:border hover:scale-[1.02]",children:[e.jsxs(G,{className:"pb-2",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx(W,{className:"text-md font-semibold group-hover:text-primary transition-colors",children:t.siteName}),e.jsx("div",{className:`px-2 py-1 text-xs rounded-full transition-colors ${Je(t.status,t.dueDate)}`,children:Xe(t.status,t.dueDate)})]}),e.jsxs(ce,{className:"flex items-center mt-1",children:[e.jsx(U,{className:"h-3 w-3 mr-1 text-primary/70"}),t.locality||"N/A",", ",t.state||"N/A"]}),e.jsxs("div",{className:"text-xs border-l-2 border-primary/30 pl-2 mt-2 py-2 bg-primary/5 rounded-r-sm group-hover:bg-primary/10 group-hover:border-primary transition-all",children:[e.jsx("div",{className:"font-medium text-muted-foreground",children:"Status Details:"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground",children:Ke(t.status,t.permitDetails)})]})]}),e.jsxs(b,{className:"space-y-3 pb-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex items-center text-muted-foreground",children:[e.jsx(Y,{className:"h-3 w-3 mr-1 text-primary/70"}),"Code: ",t.siteCode||"N/A"]}),e.jsxs("div",{className:"flex items-center text-muted-foreground",children:[e.jsx(O,{className:"h-3 w-3 mr-1 text-primary/70"}),"Due: ",(()=>{const i=new Date(t.dueDate||"");return qe(i)?B(i,"MMM d, yyyy"):"N/A"})()]})]}),e.jsx("div",{className:"mt-2 text-muted-foreground line-clamp-1",children:t.activity||t.mainActivity||"No activity specified"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-2",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Hub: ",e.jsx("span",{className:"font-medium",children:t.hub||"N/A"})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Visit Type: ",e.jsx("span",{className:"font-medium",children:t.visitTypeRaw||t.visitType||"N/A"})]})]}),e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground line-clamp-1",children:["CP: ",e.jsx("span",{className:"font-medium",children:t.cpName||"N/A"})]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-border/50",children:[e.jsxs("div",{className:`text-xs px-2 py-0.5 rounded-full ${t.priority==="high"?"bg-red-100 text-red-800 border border-red-200":t.priority==="medium"?"bg-amber-100 text-amber-800 border border-amber-200":"bg-green-100 text-green-800 border border-green-200"}`,children:[t.priority?t.priority.charAt(0).toUpperCase()+t.priority.slice(1):"Unknown"," Priority"]}),e.jsxs("div",{className:"font-medium",children:["$",((s=t.fees)==null?void 0:s.total)||"N/A"]})]})]}),e.jsx(ge,{className:"bg-muted/20",children:e.jsx(v,{asChild:!0,className:"w-full shadow-sm hover:shadow-md transition-all",variant:["pending","approved"].includes(t.status)?"outline":["inProgress","assigned"].includes(t.status)?"default":"secondary",children:e.jsx(ne,{to:`/site-visits/${t.id}`,children:t.status==="completed"?"View Details":"Manage Visit"})})})]},t.id)}),k.length===0&&e.jsx("div",{className:"text-center py-20 col-span-full",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"h-20 w-20 rounded-full bg-muted/50 backdrop-blur-sm flex items-center justify-center",children:e.jsx(ps,{className:"h-10 w-10 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-medium",children:"No site visits found"}),e.jsx("p",{className:"text-muted-foreground",children:M||l!=="all"?"Try adjusting your filters":"No site visits have been created yet"})]})})]})};return e.jsxs("div",{className:"space-y-8 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 bg-gradient-to-r from-background to-muted p-6 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(v,{variant:"ghost",size:"icon",onClick:()=>A("/dashboard"),className:"hover:bg-background/50",children:e.jsx(Ue,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold bg-gradient-to-r from-primary to-primary/70 bg-clip-text text-transparent",children:"Site Visits"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage and track all site visits"})]})]}),(x("site_visits","create")||o(["admin"]))&&e.jsx(v,{className:"bg-gradient-to-r from-primary to-primary/80 hover:from-primary/90 hover:to-primary/70 text-primary-foreground shadow-lg hover:shadow-xl transition-all duration-300",asChild:!0,children:e.jsxs(ne,{to:"/site-visits/create",className:"gap-2",children:[e.jsx(Be,{className:"h-4 w-4"}),"Create Site Visit"]})})]}),e.jsx(ms,{visits:u,onStatusClick:te}),e.jsx(cs,{mmps:be,onSelectMMP:t=>A(`/site-visits/create/mmp/${t.id}`)}),e.jsxs("div",{className:"flex flex-col gap-4","data-results-section":!0,children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-4 justify-between",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ie,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(We,{placeholder:"Search by site name, code, locality...",value:M,onChange:t=>n(t.target.value),className:"pl-10 w-full bg-background/50 backdrop-blur-sm"})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(us,{view:N,onViewChange:R}),e.jsxs(Oe,{value:p,onValueChange:w,children:[e.jsx(Ye,{className:"w-[180px] bg-background/50 backdrop-blur-sm",children:e.jsx(Ze,{placeholder:"Sort by"})}),e.jsxs(_e,{children:[e.jsx(H,{value:"createdAt",children:"Newest First"}),e.jsx(H,{value:"dueDate",children:"Due Date"}),e.jsx(H,{value:"priority",children:"Priority"}),e.jsx(H,{value:"siteName",children:"Site Name"})]})]})]})]}),e.jsx(xs,{activeFilters:C,onRemoveFilter:we,onDateSelect:Ce}),l!=="all"&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-primary/5 border border-primary/20 rounded-lg",children:[e.jsxs("div",{className:"text-sm font-medium text-primary",children:["Showing ",l==="assigned"?"scheduled":l==="overdue"?"overdue":l," visits"]}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>te("all"),className:"text-primary hover:text-primary/80",children:"Clear filter"})]}),ke()]})]})},ps=({className:r})=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:r,children:[e.jsx("path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"}),e.jsx("rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",ry:"1"})]});export{Gs as default};
