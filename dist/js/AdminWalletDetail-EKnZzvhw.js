import{r as i,j as e}from"./react-core-B8kFjp2k.js";import{u as G,s as u,C as b,f as h,g,b as j,D as M,$ as L,a as v,l as P,m as V,n as J,I as B,p as K}from"./index-PwDgWEVM.js";import{T as Q,a as U,b as A,c as y,d as X,e as f}from"./table-CZ8ZB6wW.js";import{bI as Y}from"./vendor-VlxgVHMv.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./router-CKy9yO3R.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./date-utils-YarVESQS.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";const N=(S,r)=>new Intl.NumberFormat(void 0,{style:"currency",currency:r||"SDG",currencyDisplay:"narrowSymbol"}).format(S),be=()=>{const r=Y().userId,{toast:m}=G(),[l,F]=i.useState(null),[o,W]=i.useState([]),[d,q]=i.useState("SDG"),[R,C]=i.useState(!1),[_,T]=i.useState(""),[I,E]=i.useState(""),[p,k]=i.useState("credit"),[$,H]=i.useState(!0),x=async()=>{if(r)try{const{data:t,error:c}=await u.from("wallets").select("*").eq("user_id",r).single();if(c){m({title:"Error",description:"Failed to load wallet data",variant:"destructive"});return}const s={id:t.id,userId:t.user_id,balances:t.balances||{SDG:0},totalEarned:parseFloat(t.total_earned||0),totalWithdrawn:parseFloat(t.total_withdrawn||0),createdAt:t.created_at,updatedAt:t.updated_at};F(s),q("SDG");const{data:n,error:w}=await u.from("wallet_transactions").select("*").eq("user_id",r).order("created_at",{ascending:!1});if(!w){if(n){const D=n.map(a=>({id:a.id,walletId:a.wallet_id,userId:a.user_id,type:a.type,amount:parseFloat(a.amount),currency:a.currency,siteVisitId:a.site_visit_id,withdrawalRequestId:a.withdrawal_request_id,description:a.description,metadata:a.metadata,balanceBefore:a.balance_before?parseFloat(a.balance_before):void 0,balanceAfter:a.balance_after?parseFloat(a.balance_after):void 0,createdBy:a.created_by,createdAt:a.created_at}));W(D)}}}catch{}finally{H(!1)}};i.useEffect(()=>{x()},[r]),i.useEffect(()=>{if(!r)return;const t=setInterval(x,6e4);return()=>clearInterval(t)},[r]),i.useEffect(()=>{if(!r)return;const t=u.channel(`admin_wallet_detail_${r}`).on("postgres_changes",{event:"*",schema:"public",table:"wallets",filter:`user_id=eq.${r}`},x).on("postgres_changes",{event:"*",schema:"public",table:"wallet_transactions",filter:`user_id=eq.${r}`},x);return t.subscribe(),()=>{try{u.removeChannel(t)}catch{}}},[r]),i.useMemo(()=>{const t=o.filter(s=>["site_visit_fee","bonus","adjustment"].includes(s.type)).reduce((s,n)=>s+(n.type==="adjustment"&&n.amount<0?0:n.amount),0),c=o.filter(s=>s.type==="withdrawal").reduce((s,n)=>s+Math.abs(n.amount),0);return{earned:t,withdrawn:c}},[o]);const O=async()=>{if(!l||!_)return;const t=parseFloat(_);if(isNaN(t)||t<=0){m({title:"Invalid Amount",description:"Please enter a valid positive amount",variant:"destructive"});return}try{const c=p==="credit"?t:-t,s=l.balances[d]||0,n=s+c;if(n<0){m({title:"Invalid Operation",description:"Debit amount would result in negative balance",variant:"destructive"});return}const{error:w}=await u.from("wallet_transactions").insert({wallet_id:l.id,user_id:r,type:"adjustment",amount:c,currency:d,description:I||`Manual ${p} adjustment`,balance_before:s,balance_after:n});if(w)throw w;const D={...l.balances,[d]:n},{error:a}=await u.from("wallets").update({balances:D,updated_at:new Date().toISOString()}).eq("id",l.id);if(a)throw a;m({title:"Success",description:`Balance ${p}ed successfully`}),C(!1),T(""),E(""),await x()}catch(c){m({title:"Error",description:c.message||"Failed to adjust balance",variant:"destructive"})}};if($)return e.jsx("div",{className:"flex items-center justify-center h-64 text-blue-300/70",children:"Synchronizing wallet data..."});if(!l)return e.jsx("div",{className:"flex items-center justify-center h-64 text-red-400",children:"Wallet not found"});const z=l.balances[d]||0;return e.jsxs("div",{className:"relative min-h-screen",children:[e.jsx("div",{className:"fixed inset-0 bg-gradient-to-br from-slate-950 via-blue-950 to-purple-950 -z-10",children:e.jsx("div",{className:"absolute inset-0 bg-[linear-gradient(rgba(59,130,246,0.05)_1px,transparent_1px),linear-gradient(90deg,rgba(59,130,246,0.05)_1px,transparent_1px)] bg-[size:50px_50px] [mask-image:radial-gradient(ellipse_80%_50%_at_50%_0%,#000,transparent)]"})}),e.jsxs("div",{className:"relative space-y-6 p-6","data-testid":"page-admin-wallet-detail",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(b,{className:"bg-gradient-to-br from-slate-900/80 to-blue-900/80 border-blue-500/30 backdrop-blur-xl shadow-[0_0_20px_rgba(59,130,246,0.2)]",children:[e.jsx(h,{children:e.jsxs(g,{className:"text-blue-300 text-sm uppercase tracking-wider",children:["Balance (",d,")"]})}),e.jsx(j,{className:"text-3xl font-bold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent","data-testid":"text-balance",children:N(z,d)})]}),e.jsxs(b,{className:"bg-gradient-to-br from-slate-900/80 to-purple-900/80 border-purple-500/30 backdrop-blur-xl shadow-[0_0_20px_rgba(168,85,247,0.2)]",children:[e.jsx(h,{children:e.jsx(g,{className:"text-purple-300 text-sm uppercase tracking-wider",children:"Total Earned"})}),e.jsx(j,{className:"text-3xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent","data-testid":"text-total-earned",children:N(l.totalEarned,d)})]}),e.jsxs(b,{className:"bg-gradient-to-br from-slate-900/80 to-cyan-900/80 border-cyan-500/30 backdrop-blur-xl shadow-[0_0_20px_rgba(34,211,238,0.2)]",children:[e.jsx(h,{children:e.jsx(g,{className:"text-cyan-300 text-sm uppercase tracking-wider",children:"Total Withdrawn"})}),e.jsx(j,{className:"text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent","data-testid":"text-total-withdrawn",children:N(l.totalWithdrawn,d)})]}),e.jsxs(b,{className:"bg-gradient-to-br from-slate-900/80 to-indigo-900/80 border-indigo-500/30 backdrop-blur-xl shadow-[0_0_20px_rgba(99,102,241,0.2)]",children:[e.jsx(h,{children:e.jsx(g,{className:"text-indigo-300 text-sm uppercase tracking-wider",children:"Transaction Count"})}),e.jsx(j,{className:"text-3xl font-bold bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent","data-testid":"text-transaction-count",children:o.length})]})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs(M,{open:R,onOpenChange:C,children:[e.jsx(L,{asChild:!0,children:e.jsx(v,{"data-testid":"button-adjust-balance",children:"Adjust Balance"})}),e.jsxs(P,{children:[e.jsx(V,{children:e.jsx(J,{children:"Manual Balance Adjustment"})}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Direction"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(v,{variant:p==="credit"?"default":"outline",onClick:()=>k("credit"),"data-testid":"button-direction-credit",children:"Credit (Add)"}),e.jsx(v,{variant:p==="debit"?"default":"outline",onClick:()=>k("debit"),"data-testid":"button-direction-debit",children:"Debit (Subtract)"})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("label",{className:"text-sm font-medium",children:["Amount (",d,")"]}),e.jsx(B,{type:"number",min:"0",step:"0.01",value:_,onChange:t=>T(t.target.value),placeholder:"Enter amount","data-testid":"input-adjustment-amount"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Reason (optional)"}),e.jsx(B,{value:I,onChange:t=>E(t.target.value),placeholder:"Reason for adjustment","data-testid":"input-adjustment-reason"})]})]}),e.jsx(K,{children:e.jsx(v,{onClick:O,disabled:!_,"data-testid":"button-submit-adjustment",children:"Submit Adjustment"})})]})]})}),e.jsxs(b,{children:[e.jsx(h,{children:e.jsx(g,{children:"Transaction History"})}),e.jsx(j,{children:e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(Q,{children:[e.jsx(U,{children:e.jsxs(A,{children:[e.jsx(y,{children:"Date"}),e.jsx(y,{children:"Type"}),e.jsx(y,{children:"Description"}),e.jsx(y,{className:"text-right",children:"Amount"})]})}),e.jsx(X,{children:o.length===0?e.jsx(A,{children:e.jsx(f,{colSpan:4,className:"text-center text-muted-foreground",children:"No transactions yet"})}):o.map(t=>e.jsxs(A,{"data-testid":`row-transaction-${t.id}`,children:[e.jsx(f,{children:new Date(t.createdAt).toLocaleString()}),e.jsx(f,{className:"capitalize",children:t.type.replace("_"," ")}),e.jsx(f,{children:t.description||"-"}),e.jsx(f,{className:"text-right",children:e.jsxs("span",{className:t.amount>=0?"text-green-600":"text-red-600",children:[t.amount>=0?"+":"",N(t.amount,t.currency)]})})]},t.id))})]})})})]})]})]})};export{be as default};
