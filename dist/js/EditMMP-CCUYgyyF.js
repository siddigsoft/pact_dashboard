import{r as d,j as i,ah as I}from"./react-core-B8kFjp2k.js";import{u as L}from"./router-CKy9yO3R.js";import{U as F,Z as H,u as W,C as v,f as b,g as N,h as P,b as M,a as S,T as Y,i as z,j as p,k as f,s as C}from"./index-PwDgWEVM.js";import{M as R}from"./MMPOverallInformation-CT39nI2-.js";import{M as q}from"./MMPVersionHistory-CbgVhy2G.js";import{M as G}from"./MMPSiteInformation-Bke1UQxS.js";import{M as Z}from"./MMPSiteEntriesTable-DBUyVHQg.js";import{A as J}from"./ActivityManager-lZ-YmBoR.js";import{F as K}from"./FieldTeamMapPermissions-Rk88jEyR.js";import{bI as Q,bo as X}from"./vendor-VlxgVHMv.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./date-utils-YarVESQS.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";import"./textarea-BpQMf5eL.js";import"./sudanStates-CkkbYUnU.js";import"./table-CZ8ZB6wW.js";import"./checkbox-9q2dlFjr.js";import"./collapsible-DNmzDQGQ.js";import"./ActivityForm-DxwKkf_I.js";import"./toggle-DVFO8bcr.js";import"./form-BT_tmI7p.js";import"./label-C4lDws8j.js";import"./select-CXX5Q_V1.js";import"./calendar-DEyRSxJX.js";import"./popover-BSK_FA51.js";const Ue=()=>{const{id:r}=Q(),l=X(),[y]=L(),{getMmpById:_,updateMMP:u}=F(),{checkPermission:A,hasAnyRole:h}=H(),{toast:o}=W(),[T,D]=d.useState(!0),[s,m]=d.useState(null),[E,x]=d.useState("details"),k=h(["admin"]),U=h(["fom","Field Operation Manager (FOM)"]),w=h(["coordinator"]);if(!(A("mmp","update")||k||w||U))return i.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:i.jsxs(v,{className:"w-full max-w-md",children:[i.jsxs(b,{children:[i.jsx(N,{className:"text-destructive",children:"Access Denied"}),i.jsx(P,{children:"You don't have permission to edit MMP files."})]}),i.jsx(M,{children:i.jsx(S,{variant:"outline",onClick:()=>l("/mmp"),className:"w-full",children:"Back to MMP List"})})]})});const B=()=>{l("/mmp")};d.useEffect(()=>{const a=y.get("tab");a&&x(a)},[y]),d.useEffect(()=>{if(r){const a=_(r);a?(m(a),D(!1)):(o({title:"MMP Not Found",description:"The MMP you're trying to edit does not exist.",variant:"destructive"}),l("/mmp"))}},[r,_,l,o]);const j=a=>{u&&r&&(u(r,a),m(a),o({title:"MMP Updated",description:"The MMP has been successfully updated."}))},V=a=>{if(s&&u){const n={...s,activities:a};u(r,n),m(n),o({title:"Activities Updated",description:"The activities have been successfully updated."})}},O=async a=>{if(!s||!r)return!1;try{for(const e of a){const t=e.additionalData||e.additional_data||{},c={site_name:e.site_name||e.siteName||t["Site Name"]||t["Site Name:"]||null,site_code:e.site_code||e.siteCode||t["Site Code"]||null,hub_office:e.hub_office||e.hubOffice||t["Hub Office"]||t["Hub Office:"]||null,state:e.state||t.State||t["State:"]||null,locality:e.locality||t.Locality||t["Locality:"]||null,cp_name:e.cp_name||e.cpName||t["CP Name"]||t["CP name"]||t["CP Name:"]||null,activity_at_site:e.activity_at_site||e.siteActivity||t["Activity at Site"]||t["Activity at the site"]||null,monitoring_by:e.monitoring_by||e.monitoringBy||t["Monitoring By"]||t["monitoring by"]||null,survey_tool:e.survey_tool||e.surveyTool||t["Survey Tool"]||t["Survey under Master tool"]||null,use_market_diversion:e.use_market_diversion!==void 0?e.use_market_diversion:e.useMarketDiversion!==void 0?e.useMarketDiversion:t["Use Market Diversion Monitoring"]==="Yes"||t["Use Market Diversion Monitoring"]==="true"||null,use_warehouse_monitoring:e.use_warehouse_monitoring!==void 0?e.use_warehouse_monitoring:e.useWarehouseMonitoring!==void 0?e.useWarehouseMonitoring:t["Use Warehouse Monitoring"]==="Yes"||t["Use Warehouse Monitoring"]==="true"||null,visit_date:e.visit_date||e.visitDate||t["Visit Date"]||null,comments:e.comments||t.Comments||null,cost:e.cost!==void 0?e.cost:t.Cost?Number(t.Cost):null,enumerator_fee:e.enumerator_fee!==void 0?e.enumerator_fee:t["Enumerator Fee"]?Number(t["Enumerator Fee"]):null,transport_fee:e.transport_fee!==void 0?e.transport_fee:t["Transport Fee"]?Number(t["Transport Fee"]):null,status:e.status||t.Status||t["Status:"]||"Pending",verification_notes:e.verification_notes||e.verificationNotes||t["Verification Notes"]||t["Verification Notes:"]||null,verified_by:e.verified_by||e.verifiedBy||t["Verified By"]||t["Verified By:"]||null,verified_at:e.verified_at||e.verifiedAt||(t["Verified At"]?new Date(t["Verified At"]).toISOString():null),dispatched_by:e.dispatched_by||e.dispatchedBy||t["Dispatched By"]||null,dispatched_at:e.dispatched_at||e.dispatchedAt||(t["Dispatched At"]?new Date(t["Dispatched At"]).toISOString():null),additional_data:e.additionalData||e.additional_data||{}};Object.keys(c).forEach(g=>{typeof c[g]>"u"&&delete c[g]}),e.id?await C.from("mmp_site_entries").update(c).eq("id",e.id):await C.from("mmp_site_entries").insert([{...c,mmp_file_id:r}])}const n={...s,siteEntries:a};return m(n),o({title:"Site Entries Updated",description:"Your changes have been saved."}),!0}catch{return o({title:"Save Failed",description:"We could not persist your changes. Please check your permissions or try again.",variant:"destructive"}),!1}};return T?i.jsx("div",{className:"container mx-auto p-4",children:i.jsx(v,{children:i.jsx(M,{className:"p-8",children:i.jsx("div",{className:"flex items-center justify-center",children:"Loading MMP information..."})})})}):i.jsx(K,{resource:"mmp",action:"update",children:i.jsxs("div",{className:"container mx-auto p-4 space-y-6",children:[i.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[i.jsx(S,{variant:"ghost",size:"icon",onClick:B,className:"mr-2",children:i.jsx(I,{className:"h-5 w-5"})}),i.jsxs("div",{children:[i.jsx("h1",{className:"text-2xl font-bold",children:s==null?void 0:s.name}),i.jsx("p",{className:"text-muted-foreground",children:s==null?void 0:s.mmpId})]})]}),i.jsxs(v,{children:[i.jsxs(b,{children:[i.jsx(N,{children:"Edit MMP"}),i.jsxs(P,{children:["Update details for MMP: ",s==null?void 0:s.mmpId]})]}),i.jsx(M,{children:i.jsxs(Y,{value:E,onValueChange:x,className:"space-y-4",children:[i.jsxs(z,{children:[i.jsx(p,{value:"details",children:"MMP Details"}),i.jsx(p,{value:"sites",children:"Sites"}),i.jsx(p,{value:"activities",children:"Activities"}),i.jsx(p,{value:"history",children:"Version History"})]}),i.jsx(f,{value:"details",className:"space-y-4",children:i.jsx(R,{mmpFile:s,onUpdate:j,editable:!0})}),i.jsxs(f,{value:"sites",className:"space-y-4",children:[i.jsx(G,{mmpFile:s,showVerificationButton:!1,onUpdateMMP:j}),i.jsx(Z,{siteEntries:(s==null?void 0:s.siteEntries)||[],editable:!0,onUpdateSites:O})]}),i.jsx(f,{value:"activities",className:"space-y-4",children:i.jsx(J,{activities:s.activities||[],onActivitiesChange:V,projectType:s.type})}),i.jsx(f,{value:"history",className:"space-y-4",children:i.jsx(q,{mmpFile:s})})]})})]})]})})};export{Ue as default};
