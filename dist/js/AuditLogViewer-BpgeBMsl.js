import{r as u,j as e,I as se,v as ae,q as H,y as te,Z as re,_ as ie,Y as ne,m as B,bu as ce,A as le,aR as de,al as oe,bv as me,a9 as ue,X as xe,b as he,be as pe,$ as je,aO as ve,bw as we}from"./react-core-B8kFjp2k.js";import{u as Ne,U as fe,C as F,f as ye,g as Ae,h as ge,b as O,I as be,a as y,S as Ce,B as x,L as De,M as Se,N as Me,O as z}from"./index-PwDgWEVM.js";import{T as Re,a as Te,b as J,c as h,d as ke,e as p}from"./table-CZ8ZB6wW.js";import{S as D,a as S,b as M,c as R,d as r}from"./select-CXX5Q_V1.js";import{H as W,a as q,b as Z}from"./hover-card-BltHYp3k.js";import{P as Q,a as _,b as X}from"./popover-BSK_FA51.js";import{b as Y}from"./docs-D2Yi4cpO.js";import"./jspdf-rld7HkB6.js";import{o as j}from"./date-utils-YarVESQS.js";const Ue=(m,l)=>{const v=["Timestamp","Action","Category","Description","User","User Role","Details","Status"],w=m.map(c=>[j(new Date(c.timestamp),"yyyy-MM-dd HH:mm:ss"),c.action,c.category,c.description,c.user,c.userRole,c.details,c.status].map(N=>`"${String(N||"").replace(/"/g,'""')}"`).join(",")),n=[v.join(","),...w].join(`
`),i=new Blob([n],{type:"text/csv;charset=utf-8"}),d=j(new Date,"yyyy-MM-dd");Y.saveAs(i,l||`audit-report-${d}.csv`)},Le=(m,l)=>{const v=m.map(i=>({timestamp:j(new Date(i.timestamp),"yyyy-MM-dd HH:mm:ss"),action:i.action,category:i.category,description:i.description,user:i.user,userRole:i.userRole,details:i.details,status:i.status,metadata:i.metadata})),w=new Blob([JSON.stringify(v,null,2)],{type:"application/json"}),n=j(new Date,"yyyy-MM-dd");Y.saveAs(w,`audit-report-${n}.json`)},ze=({mmpId:m,standalone:l=!1,actionFilter:v="all",timeFilter:w="all"})=>{const[n,i]=u.useState(""),[d,c]=u.useState(v),[N,T]=u.useState("all"),[g,G]=u.useState(w),[A,k]=u.useState("timeline"),{toast:U}=Ne(),{mmpFiles:L,getMmpById:K}=fe(),b=m?K(m):void 0,ee=s=>{const t=(s||"").trim();if(!t)return{name:"Unknown",role:"User"};const a=t.match(/^(.*)\s*\(([^)]+)\)\s*$/);if(a){const o=a[1].trim()||"Unknown",C=a[2].trim()||"User";return{name:o,role:C}}return{name:t,role:"User"}},I=s=>{switch(s.toLowerCase()){case"upload":return e.jsx(we,{className:"h-4 w-4 text-blue-500"});case"validation":return e.jsx(B,{className:"h-4 w-4 text-amber-500"});case"edit":return e.jsx(ve,{className:"h-4 w-4 text-purple-500"});case"view":return e.jsx(je,{className:"h-4 w-4 text-gray-500"});case"approval request":return e.jsx(pe,{className:"h-4 w-4 text-blue-500"});case"approve":return e.jsx(he,{className:"h-4 w-4 text-green-500"});case"reject":return e.jsx(xe,{className:"h-4 w-4 text-red-500"});case"lock":return e.jsx(ue,{className:"h-4 w-4 text-orange-500"});case"unlock":return e.jsx(me,{className:"h-4 w-4 text-green-500"});case"reset":return e.jsx(oe,{className:"h-4 w-4 text-blue-500"});case"delete":return e.jsx(de,{className:"h-4 w-4 text-red-500"});case"archive":return e.jsx(le,{className:"h-4 w-4 text-gray-500"});case"restore":return e.jsx(ce,{className:"h-4 w-4 text-purple-500"});case"compliance check":return e.jsx(B,{className:"h-4 w-4 text-green-500"});case"security alert":return e.jsx(ne,{className:"h-4 w-4 text-red-500"});default:return e.jsx(ie,{className:"h-4 w-4 text-gray-500"})}},V=s=>{const t=[];if(s.uploadedAt){const a=ee(s.uploadedBy);t.push({id:`upload-${s.id}`,timestamp:s.uploadedAt,action:"Upload",category:"Document",description:`File ${s.originalFilename||s.name} uploaded`,user:a.name||"Unknown",userRole:a.role||"User",details:`Entries: ${s.entries??0}`,status:"success",ipAddress:"N/A",deviceInfo:"N/A"})}return s.modificationHistory&&Array.isArray(s.modificationHistory)&&s.modificationHistory.forEach((a,o)=>{t.push({id:`edit-${s.id}-${o}`,timestamp:a.timestamp,action:"Edit",category:"Data",description:"MMP data modified",user:a.modifiedBy||"Unknown",userRole:"User",details:a.changes,metadata:{previousVersion:a.previousVersion,newVersion:a.newVersion},status:"success",ipAddress:"N/A",deviceInfo:"N/A"})}),s.approvedAt&&t.push({id:`approve-${s.id}`,timestamp:s.approvedAt,action:"Approve",category:"Workflow",description:"MMP approved",user:s.approvedBy||"Unknown",userRole:"Approver",details:"Approval completed",status:"success",ipAddress:"N/A",deviceInfo:"N/A"}),(s.status==="rejected"||s.rejectionReason)&&t.push({id:`reject-${s.id}`,timestamp:s.modifiedAt||s.uploadedAt||new Date().toISOString(),action:"Reject",category:"Workflow",description:"MMP rejected",user:"Reviewer",userRole:"Reviewer",details:s.rejectionReason||"Rejected",status:"error",ipAddress:"N/A",deviceInfo:"N/A"}),s.archivedAt&&t.push({id:`archive-${s.id}`,timestamp:s.archivedAt,action:"Archive",category:"Workflow",description:"MMP archived",user:s.archivedBy||"Unknown",userRole:"User",details:"Archived",status:"success",ipAddress:"N/A",deviceInfo:"N/A"}),s.deletedAt&&t.push({id:`delete-${s.id}`,timestamp:s.deletedAt,action:"Delete",category:"Workflow",description:"MMP deleted",user:s.deletedBy||"Unknown",userRole:"User",details:"Deleted",status:"error",ipAddress:"N/A",deviceInfo:"N/A"}),t.filter(a=>!!a.timestamp).sort((a,o)=>new Date(o.timestamp).getTime()-new Date(a.timestamp).getTime())},$=u.useMemo(()=>b?V(b):l?(L||[]).flatMap(V):[],[b,L,l]),E=s=>{switch(s){case"success":return e.jsx(x,{className:"bg-green-100 text-green-800",children:"Success"});case"warning":return e.jsx(x,{className:"bg-amber-100 text-amber-800",children:"Warning"});case"error":return e.jsx(x,{className:"bg-red-100 text-red-800",children:"Error"});case"info":return e.jsx(x,{className:"bg-blue-100 text-blue-800",children:"Info"});default:return e.jsx(x,{variant:"outline",children:"Unknown"})}},f=$.filter(s=>n===""?!0:s.description.toLowerCase().includes(n.toLowerCase())||s.user.toLowerCase().includes(n.toLowerCase())||s.details.toLowerCase().includes(n.toLowerCase())||s.action.toLowerCase().includes(n.toLowerCase())).filter(s=>{if(d==="all")return!0;const t=s.action.toLowerCase();return d==="approval"?t.includes("approve")||t.includes("reject")||t.includes("approval"):d==="security"?t.includes("security"):t===d.toLowerCase()}).filter(s=>N==="all"||s.category.toLowerCase()===N.toLowerCase()).filter(s=>{if(g==="all")return!0;const t=new Date(s.timestamp),a=new Date;switch(g){case"today":return t.toDateString()===a.toDateString();case"week":const o=new Date(a.getTime()-7*24*60*60*1e3);return t>=o;case"month":const C=new Date(a.getTime()-30*24*60*60*1e3);return t>=C;default:return!0}}),P=s=>{try{s==="csv"?Ue(f):Le(f),U({title:"Export Successful",description:`Audit report successfully exported in ${s.toUpperCase()} format.`})}catch{U({title:"Export Failed",description:"There was an error exporting the audit report.",variant:"destructive"})}};return e.jsxs(F,{className:`${l?"":"mt-6"} w-full max-w-full max-h-80 overflow-y-auto`,children:[e.jsxs(ye,{children:[e.jsxs(Ae,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5"}),l?"Audit Logs":"MMP Audit Trail"]}),e.jsx(ge,{children:"Comprehensive audit trail showing all actions and changes"})]}),e.jsx(O,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{className:"relative flex-grow min-w-0",children:[e.jsx(ae,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(be,{type:"search",placeholder:"Search audit logs...",className:"pl-8 w-full",value:n,onChange:s=>i(s.target.value)})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(D,{value:d,onValueChange:c,children:[e.jsx(S,{className:"w-[140px]",children:e.jsx(M,{placeholder:"Action"})}),e.jsxs(R,{children:[e.jsx(r,{value:"all",children:"All Actions"}),e.jsx(r,{value:"upload",children:"Upload"}),e.jsx(r,{value:"validation",children:"Validation"}),e.jsx(r,{value:"edit",children:"Edit"}),e.jsx(r,{value:"view",children:"View"}),e.jsx(r,{value:"approval",children:"Approval"}),e.jsx(r,{value:"security",children:"Security"})]})]}),e.jsxs(D,{value:N,onValueChange:T,children:[e.jsx(S,{className:"w-[140px]",children:e.jsx(M,{placeholder:"Category"})}),e.jsxs(R,{children:[e.jsx(r,{value:"all",children:"All Categories"}),e.jsx(r,{value:"document",children:"Document"}),e.jsx(r,{value:"system",children:"System"}),e.jsx(r,{value:"data",children:"Data"}),e.jsx(r,{value:"security",children:"Security"}),e.jsx(r,{value:"compliance",children:"Compliance"})]})]}),e.jsxs(D,{value:g,onValueChange:G,children:[e.jsx(S,{className:"w-[140px]",children:e.jsx(M,{placeholder:"Time Range"})}),e.jsxs(R,{children:[e.jsx(r,{value:"all",children:"All Time"}),e.jsx(r,{value:"today",children:"Today"}),e.jsx(r,{value:"week",children:"Last 7 Days"}),e.jsx(r,{value:"month",children:"Last 30 Days"})]})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(y,{variant:A==="timeline"?"default":"outline",size:"sm",onClick:()=>k("timeline"),children:"Timeline View"}),e.jsx(y,{variant:A==="table"?"default":"outline",size:"sm",onClick:()=>k("table"),children:"Table View"})]}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(Ce,{className:"h-[24vh] sm:h-[28vh] lg:h-[32vh] overflow-y-auto",children:[A==="timeline"&&e.jsxs("div",{className:"relative p-4",children:[e.jsx("div",{className:"absolute left-4 top-0 bottom-0 w-px bg-border"}),e.jsx("div",{className:"space-y-6 pl-10",children:f.map(s=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute -left-[34px] p-2 rounded-full bg-background border",children:I(s.action)}),e.jsx(F,{children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:s.action}),E(s.status)]}),e.jsxs(W,{children:[e.jsx(q,{children:e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),j(new Date(s.timestamp),"MMM d, yyyy h:mm a")]})}),e.jsx(Z,{className:"w-80",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Event Details"}),e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"IP Address:"})," ",s.ipAddress]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Device:"})," ",s.deviceInfo]}),s.relatedRecords&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Related Records:"})," ",s.relatedRecords.join(", ")]})]})]})})]})]}),e.jsx("p",{className:"text-sm break-words",children:s.description}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(te,{className:"h-3 w-3"}),e.jsx("span",{children:s.user}),e.jsx(x,{variant:"outline",className:"text-xs",children:s.userRole})]}),s.metadata&&e.jsxs(Q,{children:[e.jsx(_,{asChild:!0,children:e.jsx(y,{variant:"outline",size:"sm",className:"mt-2",children:"View Details"})}),e.jsx(X,{className:"w-80",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Detailed Information"}),e.jsx("div",{className:"text-sm space-y-1",children:Object.entries(s.metadata).map(([t,a])=>e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium capitalize",children:[t.replace(/([A-Z])/g," $1").trim(),":"]}),e.jsx("span",{className:"ml-1",children:Array.isArray(a)?a.join(", "):typeof a=="object"?JSON.stringify(a,null,2):String(a)})]},t))})]})})]})]})})})]},s.id))})]}),A==="table"&&e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsxs(Re,{children:[e.jsx(Te,{children:e.jsxs(J,{children:[e.jsx(h,{children:"Action"}),e.jsx(h,{children:"Description"}),e.jsx(h,{children:"User"}),e.jsx(h,{children:"Timestamp"}),e.jsx(h,{children:"Status"}),e.jsx(h,{children:"Details"})]})}),e.jsx(ke,{children:f.map(s=>e.jsxs(J,{children:[e.jsx(p,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[I(s.action),e.jsx("span",{children:s.action})]})}),e.jsx(p,{children:s.description}),e.jsx(p,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:s.user}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.userRole})]})}),e.jsx(p,{children:e.jsxs(W,{children:[e.jsx(q,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(H,{className:"h-3 w-3 text-muted-foreground"}),j(new Date(s.timestamp),"MMM d, yyyy h:mm a")]})}),e.jsx(Z,{className:"w-80",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Event Details"}),e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"IP Address:"})," ",s.ipAddress]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Device:"})," ",s.deviceInfo]}),s.relatedRecords&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Related Records:"})," ",s.relatedRecords.join(", ")]})]})]})})]})}),e.jsx(p,{children:E(s.status)}),e.jsx(p,{children:e.jsxs("div",{className:"max-w-[300px]",children:[e.jsx("p",{className:"truncate",children:s.details}),s.metadata&&e.jsxs(Q,{children:[e.jsx(_,{asChild:!0,children:e.jsx(y,{variant:"link",size:"sm",className:"h-auto p-0",children:"View Details"})}),e.jsx(X,{className:"w-80",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Detailed Information"}),e.jsx("div",{className:"text-sm space-y-1",children:Object.entries(s.metadata).map(([t,a])=>e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium capitalize",children:[t.replace(/([A-Z])/g," $1").trim(),":"]}),e.jsx("span",{className:"ml-1",children:Array.isArray(a)?a.join(", "):typeof a=="object"?JSON.stringify(a,null,2):String(a)})]},t))})]})})]})]})})]},s.id))})]})})]})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Showing ",f.length," of ",$.length," logs"]}),e.jsxs(De,{children:[e.jsx(Se,{asChild:!0,children:e.jsxs(y,{variant:"outline",children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Export Audit Report"]})}),e.jsxs(Me,{align:"end",children:[e.jsx(z,{onClick:()=>P("csv"),children:"Export as CSV"}),e.jsx(z,{onClick:()=>P("json"),children:"Export as JSON"})]})]})]})]})})]})};export{ze as A,Ue as e};
