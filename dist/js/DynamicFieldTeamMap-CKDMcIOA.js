import{j as t,a3 as L,r as l,R as S,a0 as $}from"./react-core-B8kFjp2k.js";import{a as N,B as w,C,b as z,e as B,ac as R}from"./index-PwDgWEVM.js";import{L as d}from"./maps-BzFQ_kYT.js";import{g as I,i as y}from"./locationUtils-B4o8Dh43.js";const T=({selectedFilter:o,setSelectedFilter:s,showSiteStatus:m=!0})=>t.jsxs("div",{className:"p-2 bg-muted/20 border-b flex flex-col md:flex-row justify-between gap-4",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx(N,{size:"sm",variant:o==="all"?"default":"outline",onClick:()=>s("all"),children:"All Staff"}),t.jsxs(N,{size:"sm",variant:o==="online"?"default":"outline",onClick:()=>s("online"),className:"text-green-600",children:[t.jsx("span",{className:"h-2 w-2 rounded-full bg-green-500 mr-1"}),"Available"]}),t.jsxs(N,{size:"sm",variant:o==="busy"?"default":"outline",onClick:()=>s("busy"),className:"text-amber-600",children:[t.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500 mr-1"}),"Busy"]}),t.jsxs(N,{size:"sm",variant:o==="offline"?"default":"outline",onClick:()=>s("offline"),className:"text-gray-600",children:[t.jsx("span",{className:"h-2 w-2 rounded-full bg-gray-500 mr-1"}),"Offline"]})]}),m&&t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[t.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[t.jsx(L,{className:"h-3 w-3 text-primary"}),t.jsx("span",{children:"Sites:"})]}),t.jsxs(w,{variant:"outline",className:"text-green-600 bg-green-50",children:[t.jsx("span",{className:"h-2 w-2 rounded-full bg-green-500 mr-1"}),"Completed"]}),t.jsxs(w,{variant:"outline",className:"text-indigo-600 bg-indigo-50",children:[t.jsx("span",{className:"h-2 w-2 rounded-full bg-indigo-500 mr-1"}),"In Progress"]}),t.jsxs(w,{variant:"outline",className:"text-amber-600 bg-amber-50",children:[t.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500 mr-1"}),"Assigned"]}),t.jsxs(w,{variant:"outline",className:"text-red-600 bg-red-50",children:[t.jsx("span",{className:"h-2 w-2 rounded-full bg-red-500 mr-1"}),"Pending"]})]})]});delete d.Icon.Default.prototype._getIconUrl;d.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png"});const A=({collectors:o=[],siteVisits:s=[],assignments:m=[],center:h=[20,0],zoom:f=3,onMapReady:g,onMarkerClick:b,showAssignmentLines:v=!0,height:E="500px"})=>{const j=l.useRef(null),r=l.useRef(null),u=l.useRef({}),p=l.useRef([]),n=e=>{const a=e==="available"?"#10b981":e==="busy"?"#f59e0b":"#6b7280";return d.divIcon({className:"custom-div-icon",html:`
        <div style="
          background-color: ${a};
          width: 16px;
          height: 16px;
          border-radius: 50%;
          border: 2px solid white;
          box-shadow: 0 0 0 2px ${a}40;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 8px;
          color: white;
          font-weight: bold;
        ">üë§</div>
      `,iconSize:[16,16],iconAnchor:[8,8]})},i=e=>{const a=e==="completed"?"#10b981":e==="inProgress"?"#6366f1":e==="assigned"?"#f59e0b":"#ef4444";return d.divIcon({className:"custom-div-icon",html:`
        <div style="
          background-color: ${a};
          width: 16px;
          height: 16px;
          border-radius: 2px;
          border: 2px solid white;
          box-shadow: 0 0 0 2px ${a}40;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 8px;
          color: white;
          font-weight: bold;
        ">üè¢</div>
      `,iconSize:[16,16],iconAnchor:[8,8]})};return l.useEffect(()=>{if(!(!j.current||r.current))return r.current=d.map(j.current,{minZoom:2,maxBounds:[[-90,-180],[90,180]]}).setView(h,f),d.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap contributors"}).addTo(r.current),r.current.addControl(d.control.zoom({position:"topright"})),g&&r.current&&g(r.current),()=>{r.current&&(r.current.remove(),r.current=null)}},[]),l.useEffect(()=>{if(!r.current)return;const e=[];if(o.forEach(a=>{var c,x;((c=a.location)==null?void 0:c.latitude)!==void 0&&((x=a.location)==null?void 0:x.longitude)!==void 0&&e.push([a.location.latitude,a.location.longitude])}),s.forEach(a=>{var c,x;((c=a.location)==null?void 0:c.latitude)!==void 0&&((x=a.location)==null?void 0:x.longitude)!==void 0&&e.push([a.location.latitude,a.location.longitude])}),e.length>0)try{const a=d.latLngBounds(e);r.current.fitBounds(a,{padding:[40,40]})}catch{}else r.current.setView(h,f)},[o,s,h,f]),l.useEffect(()=>{r.current&&(Object.keys(u.current).forEach(e=>{e.startsWith("collector-")&&(u.current[e].remove(),delete u.current[e])}),o.forEach(e=>{if(!e.location)return;const a=d.marker([e.location.latitude,e.location.longitude],{icon:n(e.status)}).addTo(r.current);a.bindPopup(`
        <div class="p-2">
          <strong>${e.name}</strong>
          <div class="text-xs mt-1">${e.status}</div>
        </div>
      `),b&&a.on("click",()=>b("collector",e.id)),u.current[`collector-${e.id}`]=a}))},[o,r.current]),l.useEffect(()=>{r.current&&(Object.keys(u.current).forEach(e=>{e.startsWith("site-")&&(u.current[e].remove(),delete u.current[e])}),s.forEach(e=>{if(!e.location)return;const a=d.marker([e.location.latitude,e.location.longitude],{icon:i(e.status)}).addTo(r.current);a.bindPopup(`
        <div class="p-2">
          <strong>${e.name}</strong>
          <div class="text-xs mt-1">${e.status}</div>
        </div>
      `),b&&a.on("click",()=>b("site",e.id)),u.current[`site-${e.id}`]=a}))},[s,r.current]),l.useEffect(()=>{if(!r.current||!v){p.current.forEach(e=>e.remove()),p.current=[];return}p.current.forEach(e=>e.remove()),p.current=[],m.forEach(e=>{const a=o.find(k=>k.id===e.collectorId),c=s.find(k=>k.id===e.siteVisitId);if(!(a!=null&&a.location)||!(c!=null&&c.location))return;const x=d.polyline([[a.location.latitude,a.location.longitude],[c.location.latitude,c.location.longitude]],{color:e.status==="completed"?"#10b981":"#6366f1",weight:2,opacity:.6,dashArray:"5, 10"}).addTo(r.current);p.current.push(x)})},[m,o,s,v,r.current]),t.jsx(C,{className:"w-full overflow-hidden relative z-0",children:t.jsx(z,{className:"p-0 overflow-hidden",children:t.jsx("div",{className:"relative z-0 w-full overflow-hidden",style:{height:E},children:t.jsx("div",{ref:j,className:"absolute inset-0 rounded-lg z-0"})})})})},D=o=>{const{hasRole:s}=B(),{siteVisits:m=[],height:h="500px",eligibleCollectors:f=[]}=o,[g,b]=l.useState("all"),[v,E]=l.useState(!0);S.useMemo(()=>{const n=[];return m&&m.forEach(i=>{const e=I(i);if(e){const a=!y(i.location);n.push({id:i.id,name:i.siteName,latitude:e.latitude,longitude:e.longitude,type:"site",status:i.status,isFallbackLocation:a,locality:i.locality,state:i.state})}}),(s("admin")||s("supervisor")||s("coordinator")||s("fom"))&&f.forEach(i=>{y(i.location)&&n.push({id:i.id,name:i.name,latitude:i.location.latitude,longitude:i.location.longitude,type:"user",status:i.availability||"active"})}),n},[m,f,s]),l.useEffect(()=>{const n=setTimeout(()=>{E(!1)},500);return()=>clearTimeout(n)},[]);const j=()=>t.jsx(C,{className:"w-full h-full",children:t.jsxs(z,{className:"p-6 flex flex-col items-center justify-center h-full",children:[t.jsx(L,{className:"h-12 w-12 text-muted-foreground mb-4 animate-pulse"}),t.jsx("p",{className:"text-muted-foreground text-center",children:"Failed to load map component"})]})}),r=f.filter(n=>y(n.location)).map(n=>({id:n.id,name:n.name,location:{latitude:n.location.latitude,longitude:n.location.longitude},status:n.availability==="online"?"available":n.availability||"offline"})),u=m.map(n=>{const i=I(n);return i?{id:n.id,name:n.siteName,location:{latitude:i.latitude,longitude:i.longitude},status:n.status,isFallbackLocation:!y(n.location),locality:n.locality,state:n.state}:null}).filter(Boolean),p=g==="all"?r:r.filter(n=>n.status===g);return t.jsx(R,{fallback:t.jsx(j,{}),children:t.jsx(C,{className:"w-full",children:t.jsxs(z,{className:"p-0",children:[t.jsx(T,{selectedFilter:g,setSelectedFilter:b}),t.jsx("div",{className:"relative",children:v?t.jsx("div",{style:{height:h},className:"flex items-center justify-center bg-slate-100/50 backdrop-blur-sm rounded-lg transition-all duration-300",children:t.jsxs("div",{className:"text-center p-4",children:[t.jsx($,{className:"h-12 w-12 mx-auto mb-2 text-primary animate-spin"}),t.jsx("p",{className:"text-muted-foreground",children:"Loading map..."})]})}):t.jsx(A,{collectors:p,siteVisits:u,assignments:[],center:[20,0],zoom:3,onMarkerClick:(n,i)=>{n==="collector"&&o.onUserSelect&&o.onUserSelect(i)},showAssignmentLines:!1,height:h})})]})})})};export{D};
