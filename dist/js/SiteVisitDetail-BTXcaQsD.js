import{j as e,N as oe,bD as de,bo as me,Y as te,U as J,a3 as Q,m as P,t as _,I as ee,l as z,r as d,v as xe,a0 as Y,bs as he,B as ue,q as pe,o as q,_ as ge,bE as fe,bF as je,bG as Ne,aR as be,a4 as ye,a1 as R}from"./react-core-B8kFjp2k.js";import{a as b,E as K,C as A,f as T,g as F,b as k,B,s as ve,K as we,a7 as se,D as ae,l as re,I as O,S as le,A as Ce,c as De,d as Se,J as ne,u as ie,w as Ae,a8 as ke,m as Me,n as Te,o as Fe,a3 as Le,p as Ie,Z as Ue}from"./index-PwDgWEVM.js";import{bo as ce,bI as Be}from"./vendor-VlxgVHMv.js";import{a as He,b as $e}from"./sudanStates-CkkbYUnU.js";import{g as Ee,i as $,c as Oe}from"./siteVisitUtils-D0TAkk25.js";import{o as W}from"./date-utils-YarVESQS.js";import{A as Pe,a as Ge,b as _e}from"./alert-BXWNuJnD.js";import{A as ze,h as Re,a as We,b as Je,c as Qe,d as Ye,e as qe,f as Ke,g as Ze}from"./alert-dialog-D6avgrWz.js";import{L as E}from"./label-C4lDws8j.js";import{T as Xe}from"./textarea-BpQMf5eL.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./router-CKy9yO3R.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";const Ve=()=>{const s=ce(),c=()=>{s("/site-visits")};return e.jsxs("div",{className:"flex items-center gap-4 bg-gradient-to-r from-background to-muted p-4 rounded-lg shadow-sm",children:[e.jsxs(b,{variant:"ghost",size:"sm",onClick:c,className:"mr-2",children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold bg-gradient-to-r from-primary to-primary/70 bg-clip-text text-transparent",children:"Site Visit Details"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"View site visit information"})]})]})},es=({siteVisit:s})=>{var f;const{users:c}=K(),w=s.state?He(s.state):"Not specified",N=s.state&&s.locality?$e(s.state,s.locality):"Not specified",i=j=>{if(!j)return;const l=(c||[]).find(y=>y.id===j);return(l==null?void 0:l.name)||(l==null?void 0:l.fullName)||(l==null?void 0:l.username)},g=((j,l)=>{if($(l,j))return{variant:"outline",className:"bg-red-50 text-red-700 border-red-300"};switch(j==null?void 0:j.toLowerCase()){case"pending":return{variant:"outline",className:"bg-yellow-50 text-yellow-700 border-yellow-300"};case"completed":return{variant:"outline",className:"bg-green-50 text-green-700 border-green-300"};case"cancelled":return{variant:"outline",className:"bg-red-50 text-red-700 border-red-300"};case"permitVerified":return{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-300"};case"assigned":return{variant:"outline",className:"bg-purple-50 text-purple-700 border-purple-300"};case"inProgress":return{variant:"outline",className:"bg-indigo-50 text-indigo-700 border-indigo-300"};default:return{variant:"outline",className:"bg-gray-50 text-gray-700 border-gray-300"}}})(s.status,s.dueDate);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(A,{children:[e.jsx(T,{className:"bg-muted/30",children:e.jsxs(F,{className:"text-xl flex items-center gap-2",children:[e.jsx(de,{className:"h-5 w-5 text-primary"}),"Essential Information"]})}),e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-medium text-lg flex items-center gap-2",children:[e.jsx(me,{className:"h-4 w-4"}),"Site Info"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Name:"}),e.jsx("span",{className:"font-semibold",children:s.siteName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Code:"}),e.jsx("span",{className:"font-semibold",children:s.siteCode})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Hub:"}),e.jsx("span",{className:"font-semibold",children:s.hub||"Not specified"})]}),s.cpName&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"CP Name:"}),e.jsx("span",{className:"font-semibold",children:s.cpName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Visit Type:"}),e.jsx("span",{className:"font-semibold",children:s.visitTypeRaw||s.visitType||"Not specified"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-medium text-lg flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4"}),"Status"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(B,{className:g.className,variant:g.variant,children:Ee(s.status,s.dueDate)}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Priority:"}),e.jsx(B,{variant:"outline",className:"capitalize",children:s.priority||"Not set"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Activity:"}),e.jsx("span",{className:"font-semibold",children:s.activity||"Not specified"})]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-medium text-lg flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),"Assignment"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Assigned to:"}),e.jsx("span",{className:"font-semibold",children:i(s.assignedTo)||"Not assigned"})]}),s.assignedBy&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Assigned by:"}),e.jsx("span",{className:"font-semibold",children:i(s.assignedBy)||"Unknown"})]}),s.scheduledDate&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Scheduled for:"}),e.jsx("span",{className:"font-semibold",children:new Date(s.scheduledDate).toLocaleDateString()})]})]})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(A,{children:[e.jsx(T,{className:"bg-muted/30",children:e.jsxs(F,{className:"text-lg flex items-center gap-2",children:[e.jsx(Q,{className:"h-5 w-5 text-primary"}),"Location Details"]})}),e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-muted/50 p-3 rounded-md",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"State"}),e.jsx("p",{className:"font-medium",children:w})]}),e.jsxs("div",{className:"bg-muted/50 p-3 rounded-md",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Locality"}),e.jsx("p",{className:"font-medium",children:N})]})]})}),((f=s.location)==null?void 0:f.address)&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-1",children:"Address"}),e.jsx("p",{className:"text-sm",children:s.location.address})]}),s.coordinates&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-1",children:"GPS Coordinates"}),e.jsxs("p",{className:"text-sm flex items-center gap-2",children:[e.jsx(Q,{className:"h-3.5 w-3.5 text-primary"}),s.coordinates.latitude,", ",s.coordinates.longitude]})]})]})})]}),s.permitDetails?e.jsxs(A,{children:[e.jsx(T,{className:"bg-muted/30",children:e.jsxs(F,{className:"text-lg flex items-center gap-2",children:[e.jsx(P,{className:"h-5 w-5 text-primary"}),"Permit Status"]})}),e.jsxs(k,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"flex flex-col items-center p-3 border rounded-md",children:[e.jsx(P,{className:`h-5 w-5 ${s.permitDetails.federal?"text-green-500":"text-muted-foreground"}`}),e.jsx("p",{className:"text-sm font-medium mt-1",children:"Federal"}),e.jsx(_,{className:`h-3.5 w-3.5 mt-1 ${s.permitDetails.federal?"text-green-500":"text-muted-foreground opacity-30"}`})]}),e.jsxs("div",{className:"flex flex-col items-center p-3 border rounded-md",children:[e.jsx(P,{className:`h-5 w-5 ${s.permitDetails.state?"text-green-500":"text-muted-foreground"}`}),e.jsx("p",{className:"text-sm font-medium mt-1",children:"State"}),e.jsx(_,{className:`h-3.5 w-3.5 mt-1 ${s.permitDetails.state?"text-green-500":"text-muted-foreground opacity-30"}`})]}),e.jsxs("div",{className:"flex flex-col items-center p-3 border rounded-md",children:[e.jsx(P,{className:`h-5 w-5 ${s.permitDetails.locality?"text-green-500":"text-muted-foreground"}`}),e.jsx("p",{className:"text-sm font-medium mt-1",children:"Local"}),e.jsx(_,{className:`h-3.5 w-3.5 mt-1 ${s.permitDetails.locality?"text-green-500":"text-muted-foreground opacity-30"}`})]})]}),s.permitDetails.verifiedBy&&e.jsxs("div",{className:"mt-3 text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Verified by:"}),e.jsx("span",{className:"font-medium ml-2",children:s.permitDetails.verifiedBy})]})]})]}):e.jsxs(A,{children:[e.jsx(T,{className:"bg-muted/30",children:e.jsxs(F,{className:"text-lg flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5 text-primary"}),"Description"]})}),e.jsx(k,{className:"p-6",children:e.jsx("p",{className:"text-sm",children:s.description||"No description provided"})})]})]}),s.permitDetails&&e.jsxs(A,{children:[e.jsx(T,{className:"bg-muted/30",children:e.jsxs(F,{className:"text-lg flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5 text-primary"}),"Description"]})}),e.jsx(k,{className:"p-6",children:e.jsx("p",{className:"text-sm",children:s.description||"No description provided"})})]})]})},ss=({siteVisit:s})=>e.jsxs(A,{className:"p-6 mt-6 hover:shadow-lg transition-shadow border-none bg-gradient-to-br from-primary/5 via-primary/10 to-background",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-primary",children:"Important Dates"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-md bg-white/50 hover:bg-white/80 transition-colors",children:[e.jsx(z,{className:"h-5 w-5 text-primary mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Visit Date"}),e.jsx("p",{className:"font-semibold",children:s.scheduledDate?W(new Date(s.scheduledDate),"MMM d, yyyy"):"Not scheduled"})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-md bg-white/50 hover:bg-white/80 transition-colors",children:[e.jsx(z,{className:"h-5 w-5 text-primary mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Distribution Date"}),e.jsx("p",{className:"font-semibold",children:s.scheduledDate?W(new Date(s.scheduledDate),"MMM d, yyyy"):"Not scheduled"})]})]}),e.jsxs("div",{className:`flex items-start gap-3 p-3 rounded-md transition-colors ${$(s.dueDate,s.status)?"bg-red-50 hover:bg-red-100 border border-red-200":"bg-white/50 hover:bg-white/80"}`,children:[$(s.dueDate,s.status)?e.jsx(te,{className:"h-5 w-5 text-red-600 mt-0.5"}):e.jsx(z,{className:"h-5 w-5 text-primary mt-0.5"}),e.jsxs("div",{children:[e.jsxs("p",{className:`text-sm font-medium ${$(s.dueDate,s.status)?"text-red-700":"text-muted-foreground"}`,children:["Due Date ",$(s.dueDate,s.status)&&`(${Oe(s.dueDate,s.status)} days overdue)`]}),e.jsx("p",{className:`font-semibold ${$(s.dueDate,s.status)?"text-red-800":""}`,children:W(new Date(s.dueDate||new Date),"MMM d, yyyy")})]})]})]})]}),ts=({siteVisit:s,users:c,onAssign:w,onClose:N,isOpen:i,allSiteVisits:p=[]})=>{const[g,f]=d.useState([]),[j,l]=d.useState(null),[y,u]=d.useState(!1),[v,L]=d.useState({}),[C,I]=d.useState("");d.useEffect(()=>{let r=!1;return(async()=>{try{const{data:x}=await ve.from("mmp_site_entries").select("additional_data, status"),o={};(x||[]).forEach(a=>{var h;const t=(h=a.additional_data)==null?void 0:h.assigned_to;t&&(a.status==="Dispatched"||a.status==="Assigned"||a.status==="In Progress")&&(o[t]=(o[t]||0)+1)}),r||L(o)}catch{}})(),()=>{r=!0}},[p]);const D=r=>{if(!r)return!1;const{latitude:x,longitude:o}=r;return typeof x=="number"&&typeof o=="number"&&Number.isFinite(x)&&Number.isFinite(o)&&!(x===0&&o===0)},U=()=>D(s.coordinates)?s.coordinates:D(s.location)?s.location:null;if(d.useEffect(()=>{const r=c.filter(t=>{const h=(t.role||"").toString(),M=h==="dataCollector"||h.toLowerCase()==="datacollector",S=Array.isArray(t.roles)&&t.roles.some(m=>m==="dataCollector"||typeof m=="string"&&m.toLowerCase()==="datacollector");return M||S}),x=U(),o=t=>(t??"").toString().trim().toLowerCase(),a=r.map(t=>{var X,V;const h=typeof((X=t.location)==null?void 0:X.latitude)=="number"&&typeof((V=t.location)==null?void 0:V.longitude)=="number",M=x&&h?we(t.location.latitude,t.location.longitude,x.latitude,x.longitude):999999,S=!!(t.hubId&&s.hub&&o(t.hubId)===o(s.hub)),m=!!(t.stateId&&s.state&&o(t.stateId)===o(s.state)),H=!!(t.localityId&&s.locality&&o(t.localityId)===o(s.locality)),G=(typeof v[t.id]=="number"?v[t.id]:se(t.id,p))>=20;return{...t,distance:M,overloaded:G,isHubMatch:S,isStateMatch:m,isLocalityMatch:H}});a.sort((t,h)=>t.isHubMatch!==h.isHubMatch?t.isHubMatch?-1:1:t.isStateMatch!==h.isStateMatch?t.isStateMatch?-1:1:t.isLocalityMatch!==h.isLocalityMatch?t.isLocalityMatch?-1:1:(t.distance||0)-(h.distance||0)),f(a)},[c,s,p]),i!==void 0)return e.jsx(ae,{open:i,onOpenChange:r=>!r&&N(),children:e.jsx(re,{className:"sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:e.jsx("div",{className:"p-4",children:n()})})});return n();function n(){const r=c.filter(a=>{const t=(a.role||"").toString(),h=t==="dataCollector"||t.toLowerCase()==="datacollector",M=Array.isArray(a.roles)&&a.roles.some(S=>S==="dataCollector"||typeof S=="string"&&S.toLowerCase()==="datacollector");return h||M}),x=g.length>0?g:r,o=C.trim()===""?x:x.filter(a=>{var t;return a.name.toLowerCase().includes(C.toLowerCase())||((t=a.email)==null?void 0:t.toLowerCase().includes(C.toLowerCase()))});return e.jsxs("div",{className:"p-4",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Smart Collector Assignment"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"The system prioritizes by hub, then state, then locality, then distance."}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(O,{type:"text",placeholder:"Search collectors by name or email...",value:C,onChange:a=>I(a.target.value),className:"pl-10"})]}),e.jsx("div",{className:"mb-3 flex justify-end",children:e.jsx(b,{onClick:async()=>{if(y)return;const a=o.map(m=>({u:m,workload:typeof v[m.id]=="number"?v[m.id]:se(m.id,p)})),t=a.filter(m=>m.u.isStateMatch&&m.u.isLocalityMatch),h=a.filter(m=>m.u.isStateMatch&&!m.u.isLocalityMatch),M=(m,H)=>{if(m.workload!==H.workload)return m.workload-H.workload;const Z=typeof m.u.distance=="number"?m.u.distance:999999,G=typeof H.u.distance=="number"?H.u.distance:999999;return Z-G};let S=null;if(t.length>0?(t.sort(M),S=t[0].u):h.length>0&&(h.sort(M),S=h[0].u),S){u(!0);try{await w(S.id)}finally{u(!1)}}},disabled:y||o.length===0,children:y?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"mr-2 h-4 w-4 animate-spin"}),"Assigning best..."]}):"Assign Best"})}),e.jsx(le,{className:"h-[300px] pr-4",children:e.jsxs("div",{className:"space-y-3",children:[o.map(a=>{const t=a.availability==="online"?"bg-green-500":a.availability==="busy"?"bg-amber-500":"bg-gray-500";return e.jsx(A,{className:"hover:shadow-md transition-all",children:e.jsx(k,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(Ce,{className:"h-12 w-12 border-2 border-muted",children:[e.jsx(De,{src:a.avatar,alt:a.name}),e.jsx(Se,{children:a.name.substring(0,2).toUpperCase()})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:a.name}),e.jsx("span",{className:`h-2 w-2 rounded-full ${t}`}),e.jsx("span",{className:"text-xs text-muted-foreground",children:a.availability==="online"?"Available":a.availability==="busy"?"Busy":"Offline"})]}),e.jsxs("div",{className:"flex gap-2 mt-1 flex-wrap",children:[a.distance!==void 0&&a.distance<1e5&&e.jsxs(B,{variant:"outline",className:"text-xs",children:[a.distance.toFixed(1),"km away"]}),a.isHubMatch&&e.jsx(B,{variant:"secondary",className:"text-xs",children:"Hub match"}),a.isStateMatch&&e.jsx(B,{variant:"secondary",className:"text-xs",children:"State match"}),a.isLocalityMatch&&e.jsx(B,{variant:"secondary",className:"text-xs",children:"Locality match"}),a.overloaded&&e.jsx(B,{variant:"destructive",className:"text-xs",children:"High workload"})]})]}),e.jsx(b,{onClick:async()=>{l(a.id);try{await w(a.id)}finally{l(null)}},disabled:j!==null||y,children:j===a.id?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"mr-2 h-4 w-4 animate-spin"}),"Assigning..."]}):"Assign"})]})})},a.id)}),o.length===0&&e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"No available collectors found"})})]})}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx(b,{variant:"outline",onClick:N,children:"Cancel"})})]})}},as=({siteVisit:s,onSuccess:c})=>{const[w,N]=d.useState(!1),[i,p]=d.useState(null),[g,f]=d.useState(0),[j,l]=d.useState(!1),{assignSiteVisit:y,siteVisits:u}=ne(),{users:v,refreshUsers:L}=K(),{toast:C}=ie(),{addNotification:I}=Ae();d.useEffect(()=>{let a;return i&&g>0&&(a=window.setTimeout(()=>{f(t=>t-1)},1e3),g===1&&r()),()=>{a&&clearTimeout(a)}},[i,g]);const D=()=>{try{L()}catch{}N(!0),p(null),f(0),l(!1)},U=()=>{N(!1),p(null),f(0),l(!1)},n=async a=>{p(a),await y(s.id,a)&&(I({userId:a,title:"Assigned to Site Visit",message:`You have been assigned to the site visit at ${s.siteName}.`,type:"info",link:`/site-visits/${s.id}`,relatedEntityId:s.id,relatedEntityType:"siteVisit"}),l(!1),f(0),N(!1),c&&c())},r=()=>{p(null),f(0),l(!1),C({title:"Assignment timed out",description:"The collector did not accept in time. Please select another collector.",variant:"destructive"})},x=async()=>{if(!i)return;if(await y(s.id,i)){const t=v.find(h=>h.id===i);C({title:"Site visit assigned",description:`The site visit has been assigned to ${(t==null?void 0:t.name)||"the collector"}.`}),l(!1),p(null),f(0),c&&c(),setTimeout(()=>{N(!1)},1500)}},o=()=>{x()};return e.jsxs(e.Fragment,{children:[e.jsxs(b,{onClick:D,className:"gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"Smart Assign"]}),j&&i&&e.jsxs(Pe,{className:"mt-4 bg-blue-50 border-blue-200",children:[e.jsx(ue,{className:"h-4 w-4 text-blue-500"}),e.jsx(Ge,{className:"text-blue-700",children:"Assignment in progress"}),e.jsxs(_e,{className:"flex items-center justify-between",children:[e.jsxs("span",{children:["Waiting for collector to accept...",e.jsxs("div",{className:"flex items-center mt-1",children:[e.jsx(pe,{className:"h-4 w-4 text-blue-500 mr-1"}),e.jsxs("span",{className:"text-blue-700",children:[g,"s remaining"]})]})]}),e.jsx(b,{size:"sm",variant:"outline",className:"bg-green-50 text-green-700 border-green-200 hover:bg-green-100",onClick:o,children:"Simulate Acceptance"})]})]}),e.jsx(ts,{isOpen:w,onClose:U,siteVisit:s,users:v,allSiteVisits:u,onAssign:n})]})};function rs({open:s,onOpenChange:c,siteVisitId:w,siteName:N}){const{assignSiteVisitCost:i,updateSiteVisitCost:p,getSiteVisitCost:g}=ke(),[f,j]=d.useState(!1),[l,y]=d.useState(null),[u,v]=d.useState({transportationCost:0,accommodationCost:0,mealAllowance:0,otherCosts:0,costNotes:""});d.useEffect(()=>{s&&w&&L()},[s,w]);const L=async()=>{const n=await g(w);n?(y(n),v({transportationCost:n.transportationCost,accommodationCost:n.accommodationCost,mealAllowance:n.mealAllowance,otherCosts:n.otherCosts,costNotes:n.costNotes||""})):(y(null),v({transportationCost:0,accommodationCost:0,mealAllowance:0,otherCosts:0,costNotes:""}))},C=()=>u.transportationCost+u.accommodationCost+u.mealAllowance+u.otherCosts,I=async()=>{j(!0);try{l?await p(l.id,{...u,currency:"SDG"}):await i(w,{...u,currency:"SDG"}),c(!1)}finally{j(!1)}},D=(n,r)=>{v(x=>({...x,[n]:r}))},U=n=>new Intl.NumberFormat("en-SD",{style:"currency",currency:"SDG",minimumFractionDigits:2}).format(n);return e.jsx(ae,{open:s,onOpenChange:c,children:e.jsxs(re,{className:"max-w-2xl",children:[e.jsxs(Me,{children:[e.jsxs(Te,{className:"text-xl flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5 text-primary"}),l?"Update":"Assign"," Site Visit Cost"]}),e.jsxs(Fe,{children:[N&&e.jsx("span",{className:"font-medium text-foreground",children:N})," ","Set the cost breakdown for this site visit. All amounts are in SDG."]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx(A,{className:"bg-muted/50",children:e.jsx(k,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(ge,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("p",{children:"These costs will be automatically added to the enumerator's wallet when the site visit is marked as completed."})]})})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(E,{htmlFor:"transportation",className:"flex items-center gap-2",children:[e.jsx(fe,{className:"w-4 h-4"}),"Transportation Cost"]}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-sm text-muted-foreground",children:"SDG"}),e.jsx(O,{id:"transportation",type:"number",min:"0",step:"0.01",value:u.transportationCost,onChange:n=>D("transportationCost",parseFloat(n.target.value)||0),className:"pl-14","data-testid":"input-transportation-cost"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(E,{htmlFor:"accommodation",className:"flex items-center gap-2",children:[e.jsx(je,{className:"w-4 h-4"}),"Accommodation Cost"]}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-sm text-muted-foreground",children:"SDG"}),e.jsx(O,{id:"accommodation",type:"number",min:"0",step:"0.01",value:u.accommodationCost,onChange:n=>D("accommodationCost",parseFloat(n.target.value)||0),className:"pl-14","data-testid":"input-accommodation-cost"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(E,{htmlFor:"meals",className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4"}),"Meal Allowance"]}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-sm text-muted-foreground",children:"SDG"}),e.jsx(O,{id:"meals",type:"number",min:"0",step:"0.01",value:u.mealAllowance,onChange:n=>D("mealAllowance",parseFloat(n.target.value)||0),className:"pl-14","data-testid":"input-meal-allowance"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(E,{htmlFor:"other",className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4"}),"Other Costs"]}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-sm text-muted-foreground",children:"SDG"}),e.jsx(O,{id:"other",type:"number",min:"0",step:"0.01",value:u.otherCosts,onChange:n=>D("otherCosts",parseFloat(n.target.value)||0),className:"pl-14","data-testid":"input-other-costs"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"notes",children:"Cost Notes (Optional)"}),e.jsx(Xe,{id:"notes",placeholder:"Add any relevant notes about these costs...",value:u.costNotes,onChange:n=>D("costNotes",n.target.value),rows:3,"data-testid":"input-cost-notes"})]}),e.jsx(Le,{}),e.jsx(A,{children:e.jsxs(k,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium uppercase tracking-wide text-muted-foreground",children:"Total Cost"}),e.jsx("span",{className:"text-2xl font-bold tabular-nums text-primary",children:U(C())})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"This amount will be added to the enumerator's wallet upon completion"})]})})]}),e.jsxs(Ie,{children:[e.jsx(b,{variant:"outline",onClick:()=>c(!1),disabled:f,"data-testid":"button-cancel",children:"Cancel"}),e.jsxs(b,{onClick:I,disabled:f||C()===0,"data-testid":"button-save-cost",children:[f&&e.jsx(Y,{className:"mr-2 w-4 h-4 animate-spin"}),l?"Update":"Assign"," Cost"]})]})]})})}const Ss=()=>{const s=ce(),{id:c}=Be();ie();const[w,N]=d.useState(!0),[i,p]=d.useState(null),{siteVisits:g,deleteSiteVisit:f}=ne(),{users:j}=K(),[l,y]=d.useState(!0),[u,v]=d.useState(!1),[L,C]=d.useState(!1),{hasAnyRole:I}=Ue();d.useEffect(()=>{(()=>{if(c&&g.length>0){const o=g.find(a=>a.id===c);if(o){p(o),N(!1);return}}const x=setTimeout(()=>{p({id:c||"",siteName:"Sample Site",siteCode:"SC-001",status:"pending",locality:"Al-Fashir",state:"North Darfur",activity:"Food Distribution",priority:"medium",dueDate:new Date().toISOString(),assignedTo:"",fees:{total:500,currency:"SDG",distanceFee:100,complexityFee:50,urgencyFee:0},scheduledDate:new Date().toISOString(),description:"Sample description",permitDetails:{federal:!0,state:!0,locality:!1,verifiedBy:"Authorization Team"},location:{address:"123 Distribution Center, North Darfur",latitude:13.6295,longitude:25.3517,region:"North Darfur"},coordinates:{latitude:13.6295,longitude:25.3517},mmpDetails:{mmpId:"MMP-2025-001",projectName:"Emergency Response 2025",uploadedBy:"System Admin",uploadedAt:new Date().toISOString(),region:"North Darfur",approvedBy:"Regional Manager",approvedAt:new Date().toISOString()},complexity:"medium",visitType:"regular",mainActivity:"Food Distribution",projectActivities:["Food Distribution","Health Assessment"],hub:"Al-Fashir Hub",team:{coordinator:"Jane Smith",supervisor:"Mike Johnson",fieldOfficer:"Ahmed Hassan"},resources:["Vehicle","GPS Device","Camera"],risks:"Medium security risk in the area",estimatedDuration:"4 hours",visitHistory:[{date:new Date().toISOString(),status:"created",by:"Previous Team"}]}),N(!1)},500);return()=>clearTimeout(x)})()},[c,g]);const D=()=>{if(c){const r=g.find(x=>x.id===c);r&&p(r)}},U=async()=>{if(i)try{v(!0),await f(i.id)&&s("/site-visits")}finally{v(!1)}},n=()=>i?j.filter(r=>r.role==="dataCollector"||r.role==="datacollector"):[];return w?e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs("div",{className:"relative w-16 h-16 mx-auto",children:[e.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-primary/20 animate-[spin_3s_linear_infinite]"}),e.jsx("div",{className:"absolute inset-[6px] rounded-full border-4 border-t-primary animate-[spin_2s_linear_infinite]"})]}),e.jsx("p",{className:"text-muted-foreground animate-pulse",children:"Loading site visit details..."})]})}):e.jsxs("div",{className:"space-y-6 animate-fade-in pb-8",children:[e.jsx("div",{className:"bg-gradient-to-r from-background to-muted p-6 rounded-lg shadow-sm",children:e.jsx(Ve,{})}),i&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap gap-3 justify-end",children:[I(["admin","ict"])&&e.jsxs(b,{variant:"outline",size:"sm",className:"gap-2",onClick:()=>C(!0),"data-testid":"button-assign-cost",children:[e.jsx(q,{className:"h-4 w-4"}),"Assign Cost"]}),i.status==="pending"||i.status==="permitVerified"?e.jsx(as,{siteVisit:i,onSuccess:D}):null,e.jsxs(ze,{children:[e.jsx(Re,{asChild:!0,children:e.jsxs(b,{variant:"destructive",size:"sm",className:"gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),"Delete"]})}),e.jsxs(We,{children:[e.jsxs(Je,{children:[e.jsx(Qe,{children:"Delete this site visit?"}),e.jsx(Ye,{children:"This action cannot be undone. The site visit and its related data will be permanently removed."})]}),e.jsxs(qe,{children:[e.jsx(Ke,{children:"Cancel"}),e.jsx(Ze,{onClick:U,disabled:u,children:u?"Deleting...":"Delete"})]})]})]})]}),c&&e.jsx(rs,{open:L,onOpenChange:C,siteVisitId:c,siteName:i.siteName}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"md:col-span-2 space-y-6",children:[e.jsx("div",{className:"bg-card rounded-lg p-6 shadow-sm border",children:e.jsx(es,{siteVisit:i})}),e.jsx("div",{className:"bg-card rounded-lg p-6 shadow-sm border",children:e.jsx(ss,{siteVisit:i})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(A,{className:"border-none shadow-md bg-gradient-to-br from-card to-muted",children:[e.jsx(T,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(F,{className:"text-sm flex items-center gap-2",children:[e.jsx(Q,{className:"h-4 w-4 text-primary"}),"Location Map"]}),e.jsx(b,{variant:"ghost",size:"sm",className:"h-8 px-2 text-xs hover:bg-background/50",onClick:()=>y(!l),children:l?"Hide":"Show"})]})}),e.jsx(k,{className:"p-0",children:l?e.jsx("div",{className:"h-[250px] bg-muted/30 flex items-center justify-center rounded-b-lg backdrop-blur-sm",children:e.jsx("p",{className:"text-muted-foreground",children:"Map view is temporarily unavailable"})}):e.jsx("div",{className:"flex items-center justify-center p-4 h-[100px] text-center text-muted-foreground",children:"Map view is hidden"})})]}),e.jsxs(A,{className:"border-none shadow-md bg-gradient-to-br from-card to-muted",children:[e.jsx(T,{className:"pb-2",children:e.jsxs(F,{className:"text-sm flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4 text-primary"}),"Nearby Collectors"]})}),e.jsx(k,{children:e.jsx(le,{className:"h-[200px] pr-4",children:e.jsxs("div",{className:"space-y-3",children:[n().map(r=>e.jsxs("div",{className:"flex justify-between items-center p-3 rounded-lg bg-background/50 backdrop-blur-sm border border-border/50 hover:bg-background/80 transition-colors",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:r.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:r.availability==="online"?e.jsxs("span",{className:"flex items-center",children:[e.jsx("span",{className:"h-2 w-2 bg-green-500 rounded-full mr-1"}),"Available"]}):e.jsxs("span",{className:"flex items-center",children:[e.jsx("span",{className:"h-2 w-2 bg-amber-500 rounded-full mr-1"}),"Busy"]})})]}),e.jsx(b,{variant:"secondary",size:"sm",className:"text-xs",onClick:()=>s(`/users/${r.id}`),children:"View Profile"})]},r.id)),n().length===0&&e.jsxs("div",{className:"text-center text-sm text-muted-foreground py-6",children:[e.jsx(J,{className:"h-12 w-12 text-muted-foreground/50 mx-auto mb-2"}),"No available collectors nearby"]})]})})})]}),e.jsxs(A,{className:"border-none shadow-md bg-gradient-to-br from-card to-muted",children:[e.jsx(T,{className:"pb-2",children:e.jsxs(F,{className:"text-sm flex items-center gap-2",children:[e.jsx(ye,{className:"h-4 w-4 text-primary"}),"Related Documents"]})}),e.jsx(k,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{variant:"secondary",className:"w-full justify-start text-sm hover:bg-background/50",onClick:()=>s(`/mmp/${i.mmpDetails.mmpId}`),children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"View MMP Details"]}),e.jsxs(b,{variant:"secondary",className:"w-full justify-start text-sm hover:bg-background/50",onClick:()=>{},children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Financial Reports"]}),e.jsxs(b,{variant:"secondary",className:"w-full justify-start text-sm hover:bg-background/50",onClick:()=>s(`/reports?siteVisit=${i.id}`),children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Generate Reports"]})]})})]})]})]})]})]})};export{Ss as default};
