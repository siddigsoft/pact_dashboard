import{j as e,r as c,a0 as O,N as xe,b as he}from"./react-core-B8kFjp2k.js";import{u as me,e as je,Z as ge,U as ve,J as pe,C as F,f as S,g as b,h as A,b as w,a as j,r as ye,I as m,a3 as fe}from"./index-PwDgWEVM.js";import{R as Ne,a as M}from"./radio-group-CC4lGE1V.js";import{L as a}from"./label-C4lDws8j.js";import{C as Ce}from"./checkbox-9q2dlFjr.js";import{bI as Fe,bo as Se}from"./vendor-VlxgVHMv.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./router-CKy9yO3R.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./date-utils-YarVESQS.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";const be=({site:r,isSelected:d,onToggle:x})=>e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-md ${d?"bg-primary/10 border border-primary/30":"bg-muted/50"}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ce,{id:`site-${r.id}`,checked:d,onCheckedChange:()=>x(r.id)}),e.jsxs("div",{children:[e.jsx(a,{htmlFor:`site-${r.id}`,className:"font-medium cursor-pointer",children:r.siteName}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[r.siteCode," • ",r.mainActivity||"No activity specified"]})]})]}),e.jsx("div",{className:`text-xs px-2 py-1 rounded-full ${r.inMoDa?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"}`,children:r.inMoDa?"In MoDa":"Not in MoDa"})]}),Je=()=>{var I,R,U,B;const{id:r}=Fe(),d=Se(),{toast:x}=me(),{currentUser:Ae,calculateDistanceFee:P}=je(),{checkPermission:H,hasAnyRole:q}=ge(),{getMmpById:J}=ve(),{createSiteVisit:Y}=pe(),[Z,E]=c.useState(!0),[s,K]=c.useState(null),[l,g]=c.useState([]),[k,Q]=c.useState("medium"),[v,W]=c.useState(new Date(Date.now()+7*24*60*60*1e3).toISOString().split("T")[0]),[T,V]=c.useState(!1),[p,X]=c.useState("SDG"),[y,L]=c.useState(""),[f,D]=c.useState("0"),[N,ee]=c.useState("0"),h=t=>{const n=typeof t=="string"?parseFloat(t):Number(t||0);return isNaN(n)?0:n};if(c.useEffect(()=>{if(!r){E(!1),x({title:"Invalid URL",description:"Missing MMP id in the URL.",variant:"destructive"}),d("/site-visits/create/mmp");return}const t=J(r);if(t){K(t);const n=(t==null?void 0:t.location)||{},u=P(Number(n.latitude)||0,Number(n.longitude)||0)||0;L(String(u))}else x({title:"MMP not found",description:"The requested MMP could not be found.",variant:"destructive"}),d("/site-visits/create/mmp");E(!1)},[r]),!(H("site_visits","create")||q(["admin"])))return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs(F,{className:"w-full max-w-md",children:[e.jsxs(S,{children:[e.jsx(b,{className:"text-destructive",children:"Access Denied"}),e.jsx(A,{children:"You don't have permission to access this page."})]}),e.jsx(w,{children:e.jsx(j,{variant:"outline",onClick:()=>d("/site-visits"),className:"w-full",children:"Return to Site Visits"})})]})});if(Z)return e.jsxs("div",{className:"flex items-center justify-center h-[60vh]",children:[e.jsx(O,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("span",{className:"ml-2",children:"Loading MMP data..."})]});const se=t=>{g(n=>n.includes(t)?n.filter(u=>u!==t):[...n,t])},te=()=>{var t,n;((t=s==null?void 0:s.siteEntries)==null?void 0:t.length)===l.length?g([]):g(((n=s==null?void 0:s.siteEntries)==null?void 0:n.map(u=>u.id))||[])},ie=async()=>{if(l.length===0){x({title:"No sites selected",description:"Please select at least one site to create visits.",variant:"destructive"});return}try{V(!0);const t=((s==null?void 0:s.siteEntries)||[]).filter(i=>l.includes(i.id)),u=(await Promise.all(t.map(async i=>{const o=(s==null?void 0:s.location)||{address:"",latitude:0,longitude:0,region:(s==null?void 0:s.region)||""},ne=P(Number(o.latitude)||0,Number(o.longitude)||0)||0,$=i.hubOffice||i.siteCode||i.site_code||"",re=i.cpName||"",ce=i.siteActivity||i.activity||"",ae=i.visitType||"regular",le=i.comments||"",_=h(y)||ne,z=h(f),G=h(N),oe=_+z+G,de={siteName:i.siteName||i.site_name||i.name||i.site||"Unknown Site",siteCode:$||i.siteCode||i.site_code||i.id,status:"pending",locality:i.locality||(o==null?void 0:o.locality)||"",state:i.state||(o==null?void 0:o.region)||"",activity:ce,priority:k,dueDate:(()=>{const C=i.visitDate;if(C){const ue=new Date(C);return isNaN(ue.getTime())?v:C}return v})(),notes:le,mainActivity:i.mainActivity||"",hub:$,cpName:re,visitType:ae,projectActivities:[],permitDetails:{federal:!1,state:!1,locality:!1},complexity:"medium",location:o,fees:{total:oe,currency:p,distanceFee:_,complexityFee:z,urgencyFee:G},mmpDetails:{mmpId:s==null?void 0:s.id,projectName:(s==null?void 0:s.projectName)||"",uploadedBy:(s==null?void 0:s.uploadedBy)||"",uploadedAt:(s==null?void 0:s.uploadedAt)||"",region:(s==null?void 0:s.region)||""},mmpId:s==null?void 0:s.id};return Y(de)}))).filter(Boolean).length;x({title:"Site visits created",description:`Successfully created ${u} site visit${u!==1?"s":""}.`}),d("/site-visits")}catch{x({title:"Creation failed",description:"There was a problem creating the site visits.",variant:"destructive"})}finally{V(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(j,{variant:"ghost",size:"sm",onClick:()=>d("/site-visits/create/mmp"),className:"mr-2",children:[e.jsx(xe,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:s==null?void 0:s.name}),e.jsxs("p",{className:"text-muted-foreground",children:[(s==null?void 0:s.mmpId)||"MMP"," • ",((I=s==null?void 0:s.siteEntries)==null?void 0:I.length)||0," sites"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(F,{className:"lg:col-span-2",children:[e.jsxs(S,{children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(b,{children:"Site Selection"}),e.jsx(j,{variant:"outline",size:"sm",onClick:te,children:((R=s==null?void 0:s.siteEntries)==null?void 0:R.length)===l.length?"Deselect All":"Select All"})]}),e.jsx(A,{children:"Choose which sites to include in the site visits"})]}),e.jsx(w,{children:((U=s==null?void 0:s.siteEntries)==null?void 0:U.length)>0?e.jsx("div",{className:"space-y-4",children:s.siteEntries.map(t=>e.jsx(be,{site:t,isSelected:l.includes(t.id),onToggle:se},t.id))}):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"No sites found in this MMP"})})}),e.jsx(ye,{className:"flex justify-between border-t pt-6",children:e.jsxs("div",{className:"text-sm text-muted-foreground",children:[l.length," of ",((B=s==null?void 0:s.siteEntries)==null?void 0:B.length)||0," sites selected"]})})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(F,{children:[e.jsxs(S,{children:[e.jsx(b,{children:"Visit Details"}),e.jsx(A,{children:"Configure site visit parameters"})]}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(a,{htmlFor:"priority",children:"Priority"}),e.jsxs(Ne,{value:k,onValueChange:t=>Q(t),className:"flex space-x-2",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(M,{value:"low",id:"low"}),e.jsx(a,{htmlFor:"low",className:"text-green-600",children:"Low"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(M,{value:"medium",id:"medium"}),e.jsx(a,{htmlFor:"medium",className:"text-amber-600",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(M,{value:"high",id:"high"}),e.jsx(a,{htmlFor:"high",className:"text-red-600",children:"High"})]})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(a,{htmlFor:"dueDate",children:"Due Date"}),e.jsx(m,{id:"dueDate",type:"date",value:v,onChange:t=>W(t.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(a,{children:"Fees"}),e.jsxs("div",{children:[e.jsx(a,{htmlFor:"feeCurrency",className:"text-xs",children:"Currency"}),e.jsx(m,{id:"feeCurrency",value:p,onChange:t=>X(t.target.value)})]}),e.jsxs("div",{children:[e.jsx(a,{htmlFor:"distanceFee",className:"text-xs",children:"Distance Fee"}),e.jsx(m,{id:"distanceFee",type:"number",value:y,onChange:t=>L(t.target.value)})]}),e.jsxs("div",{children:[e.jsx(a,{htmlFor:"complexityFee",className:"text-xs",children:"Complexity Fee"}),e.jsx(m,{id:"complexityFee",type:"number",value:f,onChange:t=>D(t.target.value)})]}),e.jsxs("div",{children:[e.jsx(a,{htmlFor:"urgencyFee",className:"text-xs",children:"Urgency Fee"}),e.jsx(m,{id:"urgencyFee",type:"number",value:N,onChange:t=>ee(t.target.value)})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-2",children:["Total: ",(h(y)+h(f)+h(N)).toLocaleString()," ",p]})]}),e.jsx(fe,{}),e.jsx("div",{className:"pt-2",children:e.jsx(j,{className:"w-full",disabled:l.length===0||T,onClick:ie,children:T?e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"mr-2 h-4 w-4 animate-spin"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"mr-2 h-4 w-4"}),"Create ",l.length," Site Visit",l.length!==1?"s":""]})})})]})]})})]})]})};export{Je as default};
