import{j as e,ah as ze,aO as Ce,Z as Ye,aP as We,R as V,r as f,aM as Ke,aQ as ee,ag as Qe}from"./react-core-B8kFjp2k.js";import{L as we}from"./router-CKy9yO3R.js";import{a as d,C as D,f as te,g as ie,b as T,B as Y,u as ke,D as ae,l as re,m as ne,n as de,o as Ze,I as Ge,p as oe,s as E,e as Je,U as Xe,Z as es,h as ss,T as ts,i as is,j as _,k as F}from"./index-PwDgWEVM.js";import{T as as,a as rs,b as se,c as $,d as ns,e as I}from"./table-CZ8ZB6wW.js";import{A as Me}from"./AuditLogViewer-BpgeBMsl.js";import{C as ds}from"./ComplianceTracker-C7U1JwwF.js";import{M as os}from"./MMPVersionHistory-CbgVhy2G.js";import{M as ls}from"./MMPSiteInformation-Bke1UQxS.js";import{bo as Se,bI as cs}from"./vendor-VlxgVHMv.js";import{o as Pe}from"./date-utils-YarVESQS.js";import{g as ms,a as xs}from"./mmpUtils-CTST1Zxt.js";import{M as hs}from"./MMPSiteEntriesTable-DBUyVHQg.js";import{M as us}from"./MMPFileManagement-CII7tC-1.js";import{F as fs}from"./ForwardToFOMDialog-B8pCS6SJ.js";import{C as ps}from"./checkbox-9q2dlFjr.js";import"./docs-D2Yi4cpO.js";import"./react-dom-BLwj5vIO.js";import"./jspdf-rld7HkB6.js";import"./query-CJ0Bt4ph.js";import"./supabase-CwPDIVMD.js";import"./xlsx-CBxwqXDA.js";import"./forms-CESK2FDA.js";import"./radix-ui-C2DV4xtt.js";import"./radix-dialogs-CnlmQBMC.js";import"./radix-menus-CPezQVZk.js";import"./select-CXX5Q_V1.js";import"./hover-card-BltHYp3k.js";import"./popover-BSK_FA51.js";import"./progress-vMwTbqUI.js";import"./sudanStates-CkkbYUnU.js";import"./alert-dialog-D6avgrWz.js";const js=({mmpFile:i,canEdit:m,onProceedToVerification:r,onEditMMP:x,onDownload:w,onShowAuditTrail:j})=>{const v=Se();return e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>v("/mmp"),className:"hover:bg-muted",children:e.jsx(ze,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:i.name}),e.jsxs("p",{className:"text-muted-foreground",children:["Uploaded on ",Pe(new Date(i.uploadedAt),"MMMM d, yyyy")," by ",i.uploadedBy]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[m&&e.jsxs(d,{variant:"outline",onClick:x,children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Edit MMP"]}),e.jsxs(d,{variant:"outline",onClick:w,children:[e.jsx(Ye,{className:"h-4 w-4 mr-2"}),"Export"]}),e.jsxs(d,{onClick:j,children:[e.jsx(We,{className:"h-4 w-4 mr-2"}),"Activity Log"]})]})]})})},gs=({mmpFile:i,siteEntries:m=[],onProceedToVerification:r,onEditMMP:x})=>{const w=ms(i),j=xs(i),v=(i==null?void 0:i.processedEntries)||0,M=i.approvedAt||i.uploadedAt||void 0;return e.jsxs(D,{className:"border-l-4 border-l-blue-500",children:[e.jsxs(te,{className:"bg-gradient-to-r from-blue-50 to-transparent",children:[e.jsx(ie,{children:"MMP Overview"}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Total entries: ",j," • Site entries: ",w," • Processed: ",v]})]}),e.jsxs(T,{className:"space-y-6 p-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium mb-3",children:"Site Distribution by State"}),m&&m.length>0?(()=>{const p={};return m.forEach(l=>{const h=l.state||l.state_name||l.location&&l.location.state||"Unknown State",u=l.locality||l.locality_name||"Unknown Locality";p[h]=p[h]||{},p[h][u]=(p[h][u]||0)+1}),Object.keys(p).sort().map(l=>{const h=Object.keys(p[l]).sort(),u=h.reduce((N,C)=>N+p[l][C],0);return e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 mb-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h4",{className:"font-medium text-blue-700",children:l}),e.jsxs(Y,{variant:"secondary",className:"bg-blue-100 text-blue-800",children:[u," sites"]})]}),e.jsx("div",{className:"space-y-2",children:h.map(N=>e.jsxs("div",{className:"flex justify-between text-sm p-2 bg-white rounded",children:[e.jsx("span",{children:N}),e.jsxs("span",{className:"text-muted-foreground",children:[p[l][N]," sites"]})]},N))})]},l)})})():e.jsx("div",{className:"bg-amber-50 p-4 rounded-lg text-center",children:"No site entries available for distribution display"})]}),e.jsxs("div",{className:"pt-4 border-t mt-4 flex justify-between",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:M?`Last: ${Pe(new Date(M),"MMM d, yyyy")}`:"No date available"}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(d,{variant:"outline",size:"sm",onClick:x,children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Edit MMP Data"]})})]})]})]})},vs=({open:i,onOpenChange:m,mmpId:r,mmpName:x,onForwarded:w})=>{const[j,v]=V.useState(!1),[M,p]=V.useState([]),[l,h]=V.useState(""),[u,N]=V.useState(new Set),{toast:C}=ke();V.useEffect(()=>{if(!i)return;let n=!1;return(async()=>{v(!0);try{const{data:b,error:o}=await E.from("profiles").select("id, full_name, username, email, hub_id, state_id, locality_id").eq("role","coordinator").order("full_name",{ascending:!0});n||p(o?[]:b)}finally{n||v(!1)}})(),()=>{n=!0}},[i]);const U=V.useMemo(()=>{const n=l.trim().toLowerCase();return n?M.filter(c=>(c.full_name||"").toLowerCase().includes(n)||(c.username||"").toLowerCase().includes(n)||(c.email||"").toLowerCase().includes(n)):M},[M,l]),q=n=>{N(c=>{const b=new Set(c);return b.has(n)?b.delete(n):b.add(n),b})},W=async()=>{var n;if(u.size!==0){v(!0);try{const c=Array.from(u),b=c.map(S=>({user_id:S,title:"MMP forwarded to you",message:`${x||"MMP"} has been forwarded to you for verification`,type:"info",link:`/mmp/${r}`,related_entity_id:r,related_entity_type:"mmpFile"})),{error:o}=await E.from("notifications").insert(b);if(o)throw o;try{const{data:S}=await E.auth.getUser(),O=(n=S==null?void 0:S.user)==null?void 0:n.id;O&&await E.from("notifications").insert({user_id:O,title:"MMP forwarded",message:`You forwarded ${x||"MMP"} to ${c.length} Coordinator(s)`,type:"success",link:`/mmp/${r}`,related_entity_id:r,related_entity_type:"mmpFile"})}catch{}const{data:L}=await E.from("mmp_files").select("workflow").eq("id",r).single(),H=new Date().toISOString(),k=(L==null?void 0:L.workflow)||{},K=Array.isArray(k.forwardedToCoordinatorIds)?k.forwardedToCoordinatorIds:[],z=Array.from(new Set([...K,...c])),Q={...k,currentStage:"awaitingCoordinatorVerification",forwardedToCoordinatorIds:z,forwardedToCoordinators:!0,forwardedAt:H,lastUpdated:H};await E.from("mmp_files").update({workflow:Q}).eq("id",r),C({title:"MMP forwarded",description:`Forwarded to ${c.length} Coordinator(s)`});try{w==null||w(c)}catch{}m(!1),N(new Set)}catch(c){C({title:"Forward failed",description:(c==null?void 0:c.message)||"Unexpected error",variant:"destructive"})}finally{v(!1)}}};return e.jsx(ae,{open:i,onOpenChange:m,children:e.jsxs(re,{className:"sm:max-w-lg",children:[e.jsxs(ne,{children:[e.jsx(de,{children:"Forward to Coordinators"}),e.jsx(Ze,{children:"Select one or more Coordinators to forward this MMP. They will get a notification to review and verify the sites."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ge,{placeholder:"Search by name, username, or email",value:l,onChange:n=>h(n.target.value)}),e.jsxs("div",{className:"max-h-64 overflow-auto border rounded-md p-2",children:[j&&e.jsx("div",{className:"text-sm text-muted-foreground p-2",children:"Loading Coordinators…"}),!j&&U.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground p-2",children:"No Coordinators found"}),!j&&U.map(n=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-muted cursor-pointer",children:[e.jsx(ps,{checked:u.has(n.id),onCheckedChange:()=>q(n.id)}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium",children:n.full_name||n.username||n.email||n.id}),e.jsx("span",{className:"text-xs text-muted-foreground",children:n.email})]})]},n.id))]})]}),e.jsxs(oe,{children:[e.jsx(d,{variant:"outline",onClick:()=>m(!1),disabled:j,children:"Cancel"}),e.jsx(d,{onClick:W,disabled:j||u.size===0,children:j?"Forwarding…":"Forward"})]})]})})},Gs=()=>{var ge,ve,Ne,be;const{id:i}=cs(),m=Se(),{toast:r}=ke(),{currentUser:x,archiveMMP:w,deleteMMPFile:j,approveMMP:v}=Je(),{resetMMP:M,getMmpById:p,updateMMP:l}=Xe(),{checkPermission:h,hasAnyRole:u}=es(),[N,C]=f.useState(!1),[U,q]=f.useState(0),[W,n]=f.useState(!0),[c,b]=f.useState(!1),[o,L]=f.useState(null),[H,k]=f.useState(!1),[K,z]=f.useState([]),[Q,S]=f.useState(!1),[O,le]=f.useState(!1),[ce,me]=f.useState(null),[De,xe]=f.useState(!1),s=i?p(i):void 0;f.useEffect(()=>{const t=setTimeout(()=>{!s&&i&&(b(!0),r({title:"MMP File Not Found",description:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{children:["No MMP found with ID: ",i]}),e.jsxs("p",{children:["Try accessing another MMP from the ",e.jsx(we,{to:"/mmp",className:"text-blue-500 underline",children:"MMP List"})]})]}),variant:"destructive"})),n(!1)},1e3);return()=>clearTimeout(t)},[i,s,r]);const B=u(["admin"]),Z=u(["fom"]),G=u(["coordinator"]),Te=h("mmp","read")||B||Z||G,Ae=!!(h("mmp","update")||B||G),he=!!(h("mmp","delete")||B),ue=!!(h("mmp","archive")||B),fe=(h("mmp","approve")||B)&&(s==null?void 0:s.status)==="pending",Ee=u(["admin","ict"]);if(!Te)return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs(D,{className:"w-full max-w-md",children:[e.jsxs(te,{children:[e.jsx(ie,{className:"text-destructive",children:"Access Denied"}),e.jsx(ss,{children:"You don't have permission to view this MMP."})]}),e.jsx(T,{children:e.jsx(d,{variant:"outline",onClick:()=>m("/mmp"),className:"w-full",children:"Back to MMP List"})})]})});const J=f.useMemo(()=>{var y;if(O)return!0;const t=(y=s==null?void 0:s.workflow)==null?void 0:y.forwardedToFomIds;return Array.isArray(t)&&t.length>0},[O,s]),A=s!=null&&s.siteEntries&&Array.isArray(s.siteEntries)&&s.siteEntries.length>0?s.siteEntries:K;f.useEffect(()=>{(async()=>{if(!i)return;if(s!=null&&s.siteEntries&&s.siteEntries.length>0){z([]);return}const{data:y,error:X}=await E.from("mmp_site_entries").select("*").eq("mmp_file_id",i);X||z(y||[])})()},[i,(ge=s==null?void 0:s.siteEntries)==null?void 0:ge.length]);const Ve=async()=>{if(i)try{await w(i,(x==null?void 0:x.username)||"Unknown User"),r({title:"MMP File Archived",description:"The MMP file has been archived successfully."}),m("/mmp")}catch{r({title:"Archive Failed",description:"There was a problem archiving the MMP file.",variant:"destructive"})}},_e=async()=>{if(i)try{await j(i)?(r({title:"MMP File Deleted",description:"The MMP file has been permanently deleted."}),m("/mmp")):r({title:"Deletion Failed",description:"Could not delete from database. Please check permissions/RLS and try again.",variant:"destructive"})}catch{r({title:"Deletion Failed",description:"Unexpected error deleting the MMP file.",variant:"destructive"})}},Fe=()=>{r({description:"MMP file download started"})},Ie=async()=>{i&&(await M(i)?(q(y=>y+1),r({title:"Reset Successful",description:"The MMP approval status has been reset successfully."})):r({title:"Reset Failed",description:"Failed to reset MMP approval status",variant:"destructive"}))},Le=async()=>{if(i&&x)try{await v(i,x.username||"Unknown User"),q(t=>t+1),r({title:"MMP Approved",description:"The MMP file has been approved successfully."})}catch{r({title:"Approval Failed",description:"There was a problem approving the MMP file.",variant:"destructive"})}},pe=()=>{s?m(`/mmp/${s.id}/verification`):r({title:"Cannot Proceed",description:"MMP file not found or access denied.",variant:"destructive"})},je=()=>{s?m(`/mmp/${s.id}/edit`):r({title:"Cannot Edit",description:"MMP file not found or access denied.",variant:"destructive"})},Oe=t=>{L(t),k(!0)},Be=()=>{xe(!0)},Re=async()=>{if(!(!s||!x))try{await l(s.id,{workflow:{...s.workflow,coordinatorVerified:!0,coordinatorVerifiedAt:new Date().toISOString(),coordinatorVerifiedBy:x.username||x.fullName||x.email||"Unknown"}}),r({title:"MMP Verified",description:"MMP has been marked as verified by coordinator."}),m("/mmp")}catch{r({title:"Verification Failed",description:"There was a problem marking the MMP as verified.",variant:"destructive"})}};return W?e.jsxs("div",{className:"flex flex-col items-center justify-center h-96",children:[e.jsxs("div",{className:"relative w-16 h-16 mx-auto",children:[e.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-blue-200 animate-[spin_3s_linear_infinite]"}),e.jsx("div",{className:"absolute inset-[6px] rounded-full border-4 border-t-blue-500 animate-[spin_2s_linear_infinite]"})]}),e.jsx("p",{className:"mt-4 text-muted-foreground",children:"Loading MMP file..."})]}):!s||c?e.jsxs("div",{className:"flex flex-col items-center justify-center h-96",children:[e.jsx(Ke,{className:"h-16 w-16 text-gray-300 mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"MMP File Not Found"}),e.jsxs("p",{className:"text-muted-foreground mb-4",children:["The requested MMP file could not be found. ID: ",i]}),e.jsx(d,{asChild:!0,children:e.jsx(we,{to:"/mmp",children:"Back to MMP List"})})]}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsx(js,{mmpFile:s,canEdit:Ae,onProceedToVerification:pe,onEditMMP:je,onDownload:Fe,onShowAuditTrail:()=>C(!0)}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-12 gap-6 overflow-x-auto",children:[e.jsx("div",{className:"xl:col-span-5 space-y-6",children:e.jsx(gs,{mmpFile:s,siteEntries:A,onProceedToVerification:pe,onEditMMP:je})}),e.jsxs("div",{className:"xl:col-span-7 space-y-6",children:[Ee&&e.jsxs("div",{children:[e.jsxs(d,{onClick:()=>S(!0),className:"bg-blue-600 hover:bg-blue-700 disabled:opacity-80 disabled:cursor-not-allowed",disabled:J,children:[e.jsx(ee,{className:"mr-2 h-4 w-4"}),J?"Forwarded":"Forward to FOMs"]}),J&&ce!==null&&e.jsxs("span",{className:"ml-3 text-sm text-muted-foreground",children:["to ",ce," FOM(s)"]})]}),Z&&((ve=s==null?void 0:s.permits)==null?void 0:ve.federal)&&e.jsx("div",{children:e.jsxs(d,{onClick:Be,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(ee,{className:"mr-2 h-4 w-4"}),"Forward Sites to Coordinators"]})}),Z&&((Ne=s==null?void 0:s.permits)==null?void 0:Ne.federal)&&e.jsx("div",{children:e.jsxs(d,{onClick:()=>m(`/mmp/${s.id}/review-assign-coordinators`),className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(ee,{className:"mr-2 h-4 w-4"}),"Review & Assign Coordinators"]})}),G&&((be=s==null?void 0:s.workflow)==null?void 0:be.forwardedToCoordinators)&&e.jsx("div",{children:e.jsxs(d,{onClick:Re,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(Qe,{className:"mr-2 h-4 w-4"}),"Mark as Verified"]})}),e.jsx(fs,{open:Q,onOpenChange:S,mmpId:s.id,mmpName:s.name,onForwarded:t=>{le(!0),me(t.length)}}),e.jsx(vs,{open:De,onOpenChange:xe,mmpId:s.id,mmpName:s.name,onForwarded:t=>{le(!0),me(t.length)}}),e.jsx(ls,{mmpFile:s,showVerificationButton:!1})]})]}),e.jsxs(D,{className:"shadow-md",children:[e.jsx(te,{className:"pb-4",children:e.jsx(ie,{className:"text-xl font-semibold",children:"Site Data & Analysis"})}),e.jsx(T,{children:e.jsxs(ts,{defaultValue:"list",className:"w-full",children:[e.jsxs(is,{className:"grid grid-cols-2 md:grid-cols-6 w-full bg-muted/50",children:[e.jsxs(_,{value:"list",className:"data-[state=active]:bg-blue-600 data-[state=active]:text-white dark:data-[state=active]:bg-blue-700 transition-all",children:[e.jsx("span",{className:"hidden sm:inline",children:"Site Entries"}),e.jsx("span",{className:"sm:hidden",children:"List"}),e.jsx(Y,{variant:"secondary",className:"ml-2 bg-white/20",children:A.length})]}),e.jsx(_,{value:"detail",className:"data-[state=active]:bg-blue-600 data-[state=active]:text-white dark:data-[state=active]:bg-blue-700 transition-all",children:"Details"}),e.jsx(_,{value:"validation",className:"data-[state=active]:bg-blue-600 data-[state=active]:text-white dark:data-[state=active]:bg-blue-700 transition-all",children:"Validation"}),e.jsx(_,{value:"audit",className:"data-[state=active]:bg-blue-600 data-[state=active]:text-white dark:data-[state=active]:bg-blue-700 transition-all",children:"Audit"}),e.jsx(_,{value:"compliance",className:"data-[state=active]:bg-blue-600 data-[state=active]:text-white dark:data-[state=active]:bg-blue-700 transition-all",children:"Compliance"}),e.jsxs(_,{value:"version-history",className:"data-[state=active]:bg-blue-600 data-[state=active]:text-white dark:data-[state=active]:bg-blue-700 transition-all",children:[e.jsx("span",{className:"hidden sm:inline",children:"Version History"}),e.jsx("span",{className:"sm:hidden",children:"Versions"})]})]}),e.jsx(F,{value:"list",className:"mt-6",children:e.jsx(hs,{siteEntries:A,onViewSiteDetail:Oe})}),e.jsx(F,{value:"detail",className:"mt-6",children:e.jsx("div",{className:"space-y-4",children:A.map(t=>e.jsx(D,{className:"overflow-hidden hover:shadow-md transition-shadow",children:e.jsxs(T,{className:"pt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Site Code"}),e.jsx("p",{children:t.siteCode})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Site Name"}),e.jsx("p",{children:t.siteName})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"In MoDa"}),e.jsx("p",{children:t.inMoDa?"Yes":"No"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Visited By"}),e.jsx("p",{children:t.visitedBy})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Main Activity"}),e.jsx("p",{children:t.mainActivity})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Visit Date"}),e.jsx("p",{children:t.visitDate})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Distribution by CP"}),e.jsx("p",{children:t.distributionByCP?"Yes":"No"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Submitted to MoDa"}),e.jsx("p",{children:t.submittedToMoDa?"Yes":"No"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Questions Submitted"}),e.jsx("p",{children:t.questionsSubmitted})]}),t.findings&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Findings"}),e.jsx("p",{children:t.findings})]}),t.flaggedIssues&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Flagged Issues"}),e.jsx("p",{children:t.flaggedIssues})]}),t.additionalComments&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Additional Comments"}),e.jsx("p",{children:t.additionalComments})]})]})},t.id))})}),e.jsx(F,{value:"validation",className:"mt-6",children:e.jsx("div",{className:"space-y-6",children:(()=>{const t=A.length,y={};A.forEach(a=>{a.siteCode&&(y[a.siteCode]=(y[a.siteCode]||0)+1)});const X=Object.entries(y).filter(([a,g])=>g>1).map(([a])=>a),P=[],R=new Set;A.forEach(a=>{const g=a.id||a.siteCode||"",ye=!a.siteCode||!a.siteName||!a.visitDate;ye&&(P.push({site:a.siteCode||a.siteName||g,issueType:"Missing Data",description:"siteCode, siteName and visitDate are required",severity:"Error"}),R.add(g));const He=!a.visitDate||isNaN(Date.parse(String(a.visitDate)));!ye&&He&&(P.push({site:a.siteCode||a.siteName||g,issueType:"Format Error",description:"Invalid visitDate format",severity:"Error"}),R.add(g)),X.includes(a.siteCode)&&(P.push({site:a.siteCode||g,issueType:"Duplicate",description:"Duplicate siteCode in this MMP",severity:"Error"}),R.add(g)),(!a.visitedBy||!a.mainActivity)&&(P.push({site:a.siteCode||a.siteName||g,issueType:"Missing Optional",description:"visitedBy or mainActivity missing",severity:"Warning"}),R.add(g))});const $e=P.filter(a=>a.severity==="Error").length,Ue=P.filter(a=>a.severity==="Warning").length,qe=t-R.size;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(D,{children:e.jsx(T,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:qe}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Valid Entries"})]})})}),e.jsx(D,{children:e.jsx(T,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-amber-600",children:Ue}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Warnings"})]})})}),e.jsx(D,{children:e.jsx(T,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:$e}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Errors"})]})})}),e.jsx(D,{children:e.jsx(T,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold",children:t}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Total Entries"})]})})})]}),e.jsx("div",{className:"rounded-md border mt-6",children:e.jsxs(as,{children:[e.jsx(rs,{children:e.jsxs(se,{children:[e.jsx($,{children:"Site"}),e.jsx($,{children:"Issue Type"}),e.jsx($,{children:"Description"}),e.jsx($,{children:"Severity"}),e.jsx($,{children:"Action"})]})}),e.jsxs(ns,{children:[P.length===0&&e.jsx(se,{children:e.jsx(I,{colSpan:5,className:"text-center text-muted-foreground",children:"No issues detected"})}),P.slice(0,50).map((a,g)=>e.jsxs(se,{children:[e.jsx(I,{children:a.site}),e.jsx(I,{children:a.issueType}),e.jsx(I,{children:a.description}),e.jsx(I,{children:a.severity==="Error"?e.jsx(Y,{className:"bg-red-100 text-red-800",children:"Error"}):e.jsx(Y,{className:"bg-amber-100 text-amber-800",children:"Warning"})}),e.jsx(I,{children:e.jsx(d,{size:"sm",variant:"outline",onClick:()=>r({description:"Open site for fixing (coming soon)"}),children:"Fix"})})]},`${a.site}-${a.issueType}-${g}`))]})]})}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsx("div",{children:e.jsx(d,{variant:"outline",onClick:()=>r({description:"This would attempt to auto-fix validation issues"}),children:"Auto-Fix Issues"})}),e.jsxs("div",{className:"space-x-2",children:[e.jsx(d,{variant:"outline",onClick:()=>r({description:"Retrying upload process"}),children:"Re-Upload File"}),e.jsx(d,{onClick:()=>r({description:"This would re-run validation checks"}),children:"Re-Run Validation"})]})]})]})})()})}),e.jsx(F,{value:"audit",className:"mt-6",children:e.jsx(Me,{mmpId:i})}),e.jsx(F,{value:"compliance",className:"mt-6",children:e.jsx(ds,{mmpId:i})}),e.jsx(F,{value:"version-history",className:"mt-6",children:e.jsx(os,{mmpFile:s,mmpId:s.mmpId||`MMP-${s.id}`})})]})})]}),(ue||he||fe)&&e.jsx("div",{className:"mb-6",children:e.jsx(us,{mmpFile:s,canArchive:ue,canDelete:he,canApprove:fe,onArchive:Ve,onDelete:_e,onResetApproval:Ie,onApprove:Le})}),e.jsx(ae,{open:N,onOpenChange:C,children:e.jsxs(re,{className:"max-w-3xl",children:[e.jsx(ne,{children:e.jsx(de,{children:"Activity Log"})}),e.jsx(Me,{mmpId:i}),e.jsx(oe,{children:e.jsx(d,{variant:"outline",onClick:()=>C(!1),children:"Close"})})]})}),e.jsx(ae,{open:H,onOpenChange:k,children:e.jsxs(re,{className:"max-w-3xl",children:[e.jsx(ne,{children:e.jsx(de,{children:(o==null?void 0:o.siteName)||"Site Details"})}),o&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-3 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Site Code"}),e.jsx("p",{className:"font-mono",children:o.siteCode})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-3 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Visit Date"}),e.jsx("p",{children:o.visitDate})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-3 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Main Activity"}),e.jsx("p",{children:o.mainActivity})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-3 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Visited By"}),e.jsx("p",{children:o.visitedBy})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-3 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Site Visited"}),e.jsx("p",{children:o.siteVisited?"Yes":"No"})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-3 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"In MoDa"}),e.jsx("p",{children:o.inMoDa?"Yes":"No"})]})]}),o.findings&&e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-3 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Findings"}),e.jsx("p",{children:o.findings})]}),o.flaggedIssues&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-100 dark:border-amber-800 p-3 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-amber-800 dark:text-amber-400",children:"Flagged Issues"}),e.jsx("p",{className:"text-amber-700 dark:text-amber-300",children:o.flaggedIssues})]})]}),e.jsxs(oe,{children:[e.jsx(d,{variant:"outline",onClick:()=>k(!1),children:"Close"}),e.jsx(d,{onClick:()=>{k(!1),r({description:"Site visit details would open in full view"})},children:"View Full Details"})]})]})})]},U)};export{Gs as default};
