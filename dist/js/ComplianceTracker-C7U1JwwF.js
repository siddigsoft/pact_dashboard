import{r as N,j as e,m as se,Y as M,Z as T,ag as te,aV as I,q as ae}from"./react-core-B8kFjp2k.js";import{u as ie,U as le,C as v,f as w,g as y,h as ne,B as p,b as C,T as re,i as ce,j as A,k as $,a as f,r as de}from"./index-PwDgWEVM.js";import{T as q,a as O,b as k,c as o,d as _,e as m}from"./table-CZ8ZB6wW.js";import{P as oe}from"./progress-vMwTbqUI.js";import{o as x}from"./date-utils-YarVESQS.js";const je=({mmpId:U,standalone:g=!1})=>{const[W,Y]=N.useState("compliance-checks"),{toast:b}=ie(),{mmpFiles:E,getMmpById:z}=le(),t=U?z(U):void 0,u=N.useMemo(()=>t!=null&&t.siteEntries&&Array.isArray(t.siteEntries)?t.siteEntries:g?(E||[]).flatMap(s=>s.siteEntries||[]):[],[t,E,g]),n=N.useMemo(()=>{var j,H;const s=new Date().toISOString(),a=u.length,r=u.filter(l=>!l.siteCode||!l.siteName||!l.visitDate),h=u.filter(l=>!l.visitDate||isNaN(Date.parse(String(l.visitDate)))),d=u.filter(l=>l.inMoDa===!1);u.filter(l=>!l.visitedBy),u.filter(l=>!l.mainActivity);const i=t?t.status==="approved"?"passed":t.status==="rejected"?"failed":"pending":"pending";return[{id:"c1",rule:"Complete Site Information",description:"Required fields present: siteCode, siteName, visitDate",status:r.length===0?"passed":r.length/(a||1)>.1?"failed":"warning",details:`${a-r.length}/${a} entries have required fields`+(r.length?`; Missing in ${Math.min(5,r.length)}+ entries`:""),critical:!0,lastChecked:s},{id:"c2",rule:"Valid Date Formats",description:"visitDate must be a valid date",status:h.length===0?"passed":h.length/(a||1)>.05?"failed":"warning",details:h.length?`${h.length} entries with invalid dates`:"All dates valid",critical:!0,lastChecked:s},{id:"c3",rule:"MoDa Integration",description:"Sites verified in MoDa",status:d.length===0?"passed":d.length/(a||1)>.2?"failed":"warning",details:d.length?`${d.length} site(s) not found/marked in MoDa`:"All sites verified in MoDa",critical:!1,lastChecked:s},{id:"c4",rule:"Required Approvals",description:"MMP approval workflow completion",status:i,details:t?`Current status: ${t.status}`:"Multiple MMPs selected",critical:!0,lastChecked:s},{id:"c5",rule:"Data Volume Consistency",description:"Entries count matches uploaded data",status:t?(t.entries??0)===(((j=t.siteEntries)==null?void 0:j.length)??0)?"passed":"warning":"pending",details:t?`${((H=t.siteEntries)==null?void 0:H.length)??0}/${t.entries??0} entries present`:"Not applicable in aggregate view",critical:!1,lastChecked:s}]},[u,t,g]),P=N.useMemo(()=>{const s=(t==null?void 0:t.modifiedAt)||(t==null?void 0:t.uploadedAt)||new Date().toISOString();return[{id:"p1",name:"Required Fields Policy",status:"active",lastUpdated:s},{id:"p2",name:"Approval Workflow Policy",status:"active",lastUpdated:s}]},[t]),G=n.length,L=n.filter(s=>s.status==="passed").length,R=n.filter(s=>s.status==="warning").length,S=n.filter(s=>s.status==="failed").length,B=n.filter(s=>s.status==="pending").length,F=Math.round(L/G*100),X=()=>n.filter(a=>a.critical&&a.status==="failed").length>0?{label:"Non-Compliant",color:"bg-red-100 text-red-800"}:S>0||R>0?{label:"Needs Attention",color:"bg-amber-100 text-amber-800"}:B>0?{label:"Pending Verification",color:"bg-blue-100 text-blue-800"}:{label:"Fully Compliant",color:"bg-green-100 text-green-800"},Z=s=>{switch(s){case"passed":return e.jsx(p,{className:"bg-green-100 text-green-800",children:"Passed"});case"warning":return e.jsx(p,{className:"bg-amber-100 text-amber-800",children:"Warning"});case"failed":return e.jsx(p,{className:"bg-red-100 text-red-800",children:"Failed"});case"pending":return e.jsx(p,{className:"bg-blue-100 text-blue-800",children:"Pending"});default:return e.jsx(p,{variant:"outline",children:"Unknown"})}},J=()=>{b({description:"Compliance check started. This may take a few moments."}),setTimeout(()=>{b({title:"Compliance Check Complete",description:"All compliance rules have been verified."})},2e3)},K=()=>{const a=`compliance_report_${x(new Date,"yyyy-MM-dd_HH-mm")}.csv`;let r=`Rule,Description,Status,Critical,Last Verified,Details
`;n.forEach(c=>{const j=[`"${c.rule}"`,`"${c.description}"`,`"${c.status}"`,`"${c.critical?"Yes":"No"}"`,`"${x(new Date(c.lastChecked),"MMM d, yyyy h:mm a")}"`,`"${c.details.replace(/"/g,'""')}"`];r+=j.join(",")+`
`});const h=new Blob([r],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(h),i=document.createElement("a");i.setAttribute("href",d),i.setAttribute("download",a),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(d),b({title:"Report Downloaded",description:`Compliance report has been downloaded as ${a}`})},Q=()=>{const a=`policy_report_${x(new Date,"yyyy-MM-dd_HH-mm")}.csv`;let r=`Policy Name,Status,Last Updated
`;P.forEach(c=>{const j=[`"${c.name}"`,`"${c.status}"`,`"${x(new Date(c.lastUpdated),"MMM d, yyyy")}"`];r+=j.join(",")+`
`});const h=new Blob([r],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(h),i=document.createElement("a");i.setAttribute("href",d),i.setAttribute("download",a),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(d),b({title:"Policy Report Downloaded",description:`Policy report has been downloaded as ${a}`})},ee=()=>{x(new Date,"yyyy-MM-dd_HH-mm"),b({title:"Summary Report Generated",description:"The PDF report would be downloaded in a real application."})},V=X(),D=N.useMemo(()=>{const s=n.map(a=>new Date(a.lastChecked).getTime());return s.length?new Date(Math.max(...s)):null},[n]);return e.jsxs(v,{className:g?"":"mt-6",children:[e.jsx(w,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[e.jsxs("div",{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5"}),"Compliance Tracking"]}),e.jsx(ne,{children:"Verification of regulatory compliance and policy adherence"})]}),e.jsx(p,{className:V.color,children:V.label})]})}),e.jsx(C,{children:e.jsxs(re,{value:W,onValueChange:Y,className:"w-full",children:[e.jsxs(ce,{className:"grid grid-cols-3 mb-4",children:[e.jsx(A,{value:"compliance-checks",children:"Compliance Checks"}),e.jsx(A,{value:"policies",children:"Policies"}),e.jsx(A,{value:"summary",children:"Summary"})]}),e.jsxs($,{value:"compliance-checks",children:[e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(q,{children:[e.jsx(O,{children:e.jsxs(k,{children:[e.jsx(o,{children:"Rule"}),e.jsx(o,{children:"Description"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Critical"}),e.jsx(o,{children:"Last Verified"}),e.jsx(o,{children:"Details"})]})}),e.jsx(_,{children:n.map(s=>e.jsxs(k,{children:[e.jsx(m,{className:"font-medium",children:s.rule}),e.jsx(m,{children:s.description}),e.jsx(m,{children:Z(s.status)}),e.jsx(m,{children:s.critical?e.jsxs("span",{className:"flex items-center text-red-600",children:[e.jsx(M,{className:"h-4 w-4 mr-1"})," Yes"]}):e.jsx("span",{className:"text-muted-foreground",children:"No"})}),e.jsx(m,{children:x(new Date(s.lastChecked),"MMM d, h:mm a")}),e.jsx(m,{className:"max-w-[250px] break-words",children:s.details})]},s.id))})]})}),e.jsxs("div",{className:"mt-4 flex justify-between",children:[e.jsx(f,{variant:"outline",onClick:()=>J(),children:"Re-Run Compliance Checks"}),e.jsxs(f,{variant:"outline",onClick:K,children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Export Report"]})]})]}),e.jsxs($,{value:"policies",children:[e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(q,{children:[e.jsx(O,{children:e.jsxs(k,{children:[e.jsx(o,{children:"Policy Name"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Last Updated"}),e.jsx(o,{children:"Actions"})]})}),e.jsx(_,{children:P.map(s=>e.jsxs(k,{children:[e.jsx(m,{className:"font-medium",children:s.name}),e.jsx(m,{children:e.jsx(p,{variant:"outline",className:"bg-green-50 text-green-800",children:s.status.charAt(0).toUpperCase()+s.status.slice(1)})}),e.jsx(m,{children:x(new Date(s.lastUpdated),"MMM d, yyyy")}),e.jsx(m,{children:e.jsx(f,{variant:"ghost",size:"sm",children:"View Details"})})]},s.id))})]})}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsxs(f,{variant:"outline",onClick:Q,children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Export Policy Report"]})})]}),e.jsx($,{value:"summary",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(v,{className:"col-span-2",children:[e.jsx(w,{className:"pb-2",children:e.jsx(y,{className:"text-lg",children:"Compliance Score"})}),e.jsx(C,{children:e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsxs("div",{className:"text-4xl font-bold",children:[F,"%"]}),e.jsx(oe,{value:F,className:"w-full h-2"})]})})]}),e.jsxs(v,{children:[e.jsx(w,{className:"pb-2",children:e.jsx(y,{className:"text-lg",children:"Check Status"})}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(te,{className:"h-4 w-4 text-green-500 mr-1"})," Passed"]}),e.jsx("span",{children:L})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(M,{className:"h-4 w-4 text-amber-500 mr-1"})," Warnings"]}),e.jsx("span",{children:R})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(I,{className:"h-4 w-4 text-red-500 mr-1"})," Failed"]}),e.jsx("span",{children:S})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ae,{className:"h-4 w-4 text-blue-500 mr-1"})," Pending"]}),e.jsx("span",{children:B})]})]})})]}),e.jsxs(v,{children:[e.jsx(w,{className:"pb-2",children:e.jsx(y,{className:"text-lg",children:"Last Verified"})}),e.jsx(C,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-lg",children:D?x(D,"MMM d, yyyy"):"N/A"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:D?x(D,"h:mm a"):""}),e.jsx("span",{className:"text-xs text-muted-foreground mt-1",children:"By: System Automation"})]})})]})]}),(S>0||R>0)&&e.jsxs(v,{className:"border-amber-200 bg-amber-50",children:[e.jsx(w,{className:"pb-2",children:e.jsxs(y,{className:"text-amber-800 flex items-center",children:[e.jsx(M,{className:"h-5 w-5 mr-2"}),"Issues Requiring Attention"]})}),e.jsx(C,{children:e.jsx("ul",{className:"space-y-2",children:n.filter(s=>s.status==="failed"||s.status==="warning").map(s=>e.jsxs("li",{className:"flex items-start gap-2",children:[s.status==="failed"?e.jsx(I,{className:"h-4 w-4 text-red-500 mt-0.5"}):e.jsx(M,{className:"h-4 w-4 text-amber-500 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.rule}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.details})]})]},s.id))})}),e.jsx(de,{className:"border-t border-amber-200 bg-amber-50/50 flex justify-end",children:e.jsx(f,{size:"sm",variant:"outline",className:"text-amber-800 border-amber-300",children:"Fix Issues"})})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(f,{onClick:ee,variant:"outline",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Download Summary Report"]})})]})})]})})]})};export{je as C};
